

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tasks and Datasets in ParlAI &mdash; ParlAI  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/parlai_theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Data Handling, Batching, and Hogwild" href="tutorial_worlds.html" />
    <link rel="prev" title="Intro to ParlAI" href="tutorial_basic.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> ParlAI
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="tutorial_quick.html">ParlAI Quick-start</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_basic.html">Intro to ParlAI</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tasks and Datasets in ParlAI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#getting-a-new-dataset-into-parlai-the-simplest-way">Getting a New Dataset Into ParlAI: <em>the simplest way</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-a-new-task-the-more-complete-way">Creating a New Task: <em>the more complete way</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="#part-1-building-the-data">Part 1: Building the Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#part-2-creating-the-teacher">Part 2: Creating the Teacher</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#parlaidialogteacher">ParlAIDialogTeacher</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dialogteacher">DialogTeacher</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fixeddialogteacher">FixedDialogTeacher</a></li>
<li class="toctree-l3"><a class="reference internal" href="#task-from-scratch">Task from Scratch</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#part-3-add-task-to-task-list">Part 3: Add Task to Task List</a></li>
<li class="toctree-l2"><a class="reference internal" href="#part-4-executing-the-task">Part 4: Executing the Task</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_worlds.html">Data Handling, Batching, and Hogwild</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_seq2seq.html">Creating an Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_torch_ranker_agent.html">Using Torch Ranker Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_tipsntricks.html">Tips and Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_mturk.html">Using Mechanical Turk</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_messenger.html">Using Facebook Messenger</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_tensorboard.html">Using tensorboard for metric tracking</a></li>
</ul>
<p class="caption"><span class="caption-text">Tasks &amp; Model Zoo</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="zoo.html">Model Zoo</a></li>
</ul>
<p class="caption"><span class="caption-text">Core Library</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="observations.html">observations</a></li>
<li class="toctree-l1"><a class="reference internal" href="agents.html">core.agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="torch_agent.html">core.torch_agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_data.html">core.build_data</a></li>
<li class="toctree-l1"><a class="reference internal" href="dict.html">core.dict</a></li>
<li class="toctree-l1"><a class="reference internal" href="metrics.html">core.metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="params.html">core.params</a></li>
<li class="toctree-l1"><a class="reference internal" href="teachers.html">core.teachers</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils.html">core.utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="thread_utils.html">core.thread_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="worlds.html">core.worlds</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="repeat_label.html">agents.repeat_label</a></li>
<li class="toctree-l1"><a class="reference internal" href="unigram_agent.html">agents.unigram</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_seq2seq.html">agents.example_seq2seq</a></li>
</ul>
<p class="caption"><span class="caption-text">Scripts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cli_usage.html">Command Line Usage</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">ParlAI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Tasks and Datasets in ParlAI</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/tutorial_task.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tasks-and-datasets-in-parlai">
<h1>Tasks and Datasets in ParlAI<a class="headerlink" href="#tasks-and-datasets-in-parlai" title="Permalink to this headline">¶</a></h1>
<p><strong>Authors</strong>: Alexander Holden Miller, Filipe de Avila Belbute Peres, Jason Weston</p>
<p>ParlAI can support fixed dialogue data for supervised learning (which we call a dataset) or even dynamic tasks involving an environment, agents and possibly rewards (we refer to the general case  as a task).</p>
<p>In this tutorial we will go over the different ways a new task (or dataset) can be created.</p>
<p>All setups are handled in pretty much the same way, with the same API, but there are less steps of course to make a basic dataset.</p>
<div class="section" id="getting-a-new-dataset-into-parlai-the-simplest-way">
<h2>Getting a New Dataset Into ParlAI: <em>the simplest way</em><a class="headerlink" href="#getting-a-new-dataset-into-parlai-the-simplest-way" title="Permalink to this headline">¶</a></h2>
<p>Let’s look at the easiest way of getting a new dataset into ParlAI first.</p>
<p>If you have a dialogue, QA or other text-only dataset that you can put
in a text file in the format we will now describe, you can just load it directly from
there, with no extra code!</p>
<p>Here’s an example dataset with a single episode with 2 examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>text:hello how are you today?   labels:i&#39;m great thanks! what are you doing?
text:i&#39;ve just been biking.     labels:oh nice, i haven&#39;t got on a bike in years!       episode_done:True
</pre></div>
</div>
<p>Suppose that data is in the file /tmp/data.txt</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are tabs between each field above which are rendered in the browser as four spaces.
Be sure to change them to tabs for the command below to work.</p>
</div>
<p>We could look at that data using the usual display data script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>python parlai/scripts/display_data.py -t fromfile:parlaiformat --fromfile_datapath /tmp/data.txt
&lt;.. snip ..&gt;
[creating task(s): fromfile:parlaiformat]
[loading parlAI text data:/tmp/data.txt]
[/tmp/data.txt]: hello how are you today?
[labels: i&#39;m great thanks! what are you doing?]
   [RepeatLabelAgent]: i&#39;m great thanks! what are you doing?
~~
[/tmp/data.txt]: i&#39;ve just been biking.
[labels: oh nice, i haven&#39;t got on a bike in years!]
   [RepeatLabelAgent]: oh nice, i haven&#39;t got on a bike in years!
- - - - - - - - - - - - - - - - - - - - -
~~
EPOCH DONE
[ loaded 1 episodes with a total of 2 examples ]
</pre></div>
</div>
<p>The text file data format is called ParlAI Dialog format, and is described
in the <a class="reference internal" href="teachers.html"><span class="doc">teachers documentation</span></a> (parlai.core.teachers.ParlAIDialogTeacher)
and
in the <a class="reference external" href="https://github.com/facebookresearch/ParlAI/blob/master/parlai/core/teachers.py#L1098">core/teachers.py file</a>.
Essentially, there is one training example every line, and each field in a
ParlAI message is tab separated with the name of the field, followed by a colon.
E.g. the usual fields like ‘text’, ‘labels’, ‘label_candidates’ etc. can all
be used, or you can add your own fields too if you have a special use for them.</p>
</div>
<div class="section" id="creating-a-new-task-the-more-complete-way">
<h2>Creating a New Task: <em>the more complete way</em><a class="headerlink" href="#creating-a-new-task-the-more-complete-way" title="Permalink to this headline">¶</a></h2>
<p>Of course after your first hacking around you may want to actually check this code in so that you can share it with others!</p>
<p>Tasks code is located in the <code class="docutils literal notranslate"><span class="pre">parlai/tasks</span></code> directory.</p>
<p>You will need to create a directory for your new task there.</p>
<p>If your data is in the ParlAI format, you effectively only need a tiny bit of boilerplate to load it, see e.g. the code for the <a class="reference external" href="https://github.com/facebookresearch/ParlAI/tree/master/parlai/tasks/fromfile">fromfile task agent we just used</a>.</p>
<p>But right now, let’s go through all the steps. You will need to:</p>
<ol class="arabic simple" start="0">
<li><p>Add an <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file to make sure imports work correctly.</p></li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">build.py</span></code> to download and build any needed data (see <a class="reference internal" href="#part-1-building-the-data">Part 1: Building the Data</a>).</p></li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">agents.py</span></code>, with at least a <code class="docutils literal notranslate"><span class="pre">DefaultTeacher</span></code> which extends <code class="docutils literal notranslate"><span class="pre">Teacher</span></code> or one of its children (see <a class="reference internal" href="#part-2-creating-the-teacher">Part 2: Creating the Teacher</a>).</p></li>
<li><p>Add the task to the the task list (see <a class="reference internal" href="#part-3-add-task-to-task-list">Part 3: Add Task to Task List</a>).</p></li>
</ol>
<p>Below we go into more details for each of these steps.</p>
</div>
<div class="section" id="part-1-building-the-data">
<h2>Part 1: Building the Data<a class="headerlink" href="#part-1-building-the-data" title="Permalink to this headline">¶</a></h2>
<p>We first need to create functionality for downloading and setting up the dataset
that is going to be used for the task. This is done in the <code class="docutils literal notranslate"><span class="pre">build.py</span></code> file.
Useful functionality for setting up data can be found in <code class="docutils literal notranslate"><span class="pre">parlai.core.build_data</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">parlai.core.build_data</span> <span class="kn">as</span> <span class="nn">build_data</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
<p>Now we define our build method, which takes in the argument <code class="docutils literal notranslate"><span class="pre">opt</span></code>,
which contains parsed arguments from the command line (or their default),
including the path to the data directory. We can also define a version string,
so that the data is removed and updated automatically for other ParlAI users
if we make changes to this task (here it was just left it as <code class="docutils literal notranslate"><span class="pre">None</span></code>).
We then use the build_data utilities to check if this data hasn’t been
previously built or if the version is outdated. If not, we proceed to creating
the directory for the data, and then downloading and uncompressing it.
Finally, we mark the build as done, so that <code class="docutils literal notranslate"><span class="pre">build_data.built()</span></code> returns
true from now on. Below is an example of setting up the MNIST dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
    <span class="c1"># get path to data directory</span>
    <span class="n">dpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">],</span> <span class="s1">&#39;mnist&#39;</span><span class="p">)</span>
    <span class="c1"># define version if any</span>
    <span class="n">version</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># check if data had been previously built</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">build_data</span><span class="o">.</span><span class="n">built</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">version_string</span><span class="o">=</span><span class="n">version</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[building data: &#39;</span> <span class="o">+</span> <span class="n">dpath</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>

        <span class="c1"># make a clean directory if needed</span>
        <span class="k">if</span> <span class="n">build_data</span><span class="o">.</span><span class="n">built</span><span class="p">(</span><span class="n">dpath</span><span class="p">):</span>
            <span class="c1"># an older version exists, so remove these outdated files.</span>
            <span class="n">build_data</span><span class="o">.</span><span class="n">remove_dir</span><span class="p">(</span><span class="n">dpath</span><span class="p">)</span>
        <span class="n">build_data</span><span class="o">.</span><span class="n">make_dir</span><span class="p">(</span><span class="n">dpath</span><span class="p">)</span>

        <span class="c1"># download the data.</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;mnist.tar.gz&#39;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://parl.ai/downloads/mnist/&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="c1"># dataset URL</span>
        <span class="n">build_data</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

        <span class="c1"># uncompress it</span>
        <span class="n">build_data</span><span class="o">.</span><span class="n">untar</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

        <span class="c1"># mark the data as built</span>
        <span class="n">build_data</span><span class="o">.</span><span class="n">mark_done</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">version_string</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="part-2-creating-the-teacher">
<h2>Part 2: Creating the Teacher<a class="headerlink" href="#part-2-creating-the-teacher" title="Permalink to this headline">¶</a></h2>
<p>Now that we have our data, we need an agent that understand the task’s structure
and is able to present it. In other words, we need a <code class="docutils literal notranslate"><span class="pre">Teacher</span></code>.
Every task requires an <code class="docutils literal notranslate"><span class="pre">agents.py</span></code> file in which we define the agents for the task.
It is there that we will define our teacher.</p>
<p>Teachers already in the ParlAI system use a series of subclasses, each with
additional functionality (and fewer methods to implement). These follow the path
<code class="docutils literal notranslate"><span class="pre">Agent</span></code> =&gt; <code class="docutils literal notranslate"><span class="pre">Teacher</span></code> =&gt; <code class="docutils literal notranslate"><span class="pre">FixedDialogTeacher</span></code> =&gt; <code class="docutils literal notranslate"><span class="pre">DialogTeacher</span></code> =&gt; <code class="docutils literal notranslate"><span class="pre">ParlAIDialogTeacher</span></code>.</p>
<p>(Note there is also a FbDialogTeacher, but this is deprecated – although some datasets in ParlAI still currently use it.)</p>
<p>The simplest method available for creating a teacher is to use the
<code class="docutils literal notranslate"><span class="pre">ParlAIDialogTeacher</span></code> class, which makes the process very simple if the text
data is already formatted in the ParlAI Dialog format.
(In fact, even if your text data is not in the ParlAI Dialog format, it might
be simpler to parse it into this format and use the <code class="docutils literal notranslate"><span class="pre">ParlAIDialogTeacher</span></code>.)
This is shown in the section <a class="reference internal" href="#parlaidialogteacher">ParlAIDialogTeacher</a>.</p>
<p>If the data is not in this format, one can still use the <code class="docutils literal notranslate"><span class="pre">DialogTeacher</span></code>
which automates much of the work in setting up a dialog task,
but gives the user more flexibility in loading the data from the disk.
This is shown in the section <a class="reference internal" href="#dialogteacher">DialogTeacher</a>.</p>
<p>If the data is still a fixed set (e.g. is not dynamic, is based on fixed files)
and even more functionality is needed, such as providing extra information
like the answer indices for the SQuAD dataset, one can use the
<code class="docutils literal notranslate"><span class="pre">FixedDialogTeacher</span></code> class. This is shown in the section <a class="reference internal" href="#fixeddialogteacher">FixedDialogTeacher</a>.</p>
<p>Finally, if the requirements for the task do not fit any of the above,
one can still write a task from scratch without much trouble.
This is shown in the section <a class="reference internal" href="#task-from-scratch">Task from Scratch</a>. For example, a dynamic task
which adjusts its response based on the received input rather than using fixed
logs is better suited to this approach.</p>
<p>The methods for a teacher to implement for each class are as follows:</p>
<dl class="field-list simple">
<dt class="field-odd">class Teacher</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">__init__()</span></code>, <code class="docutils literal notranslate"><span class="pre">observe()</span></code>, <code class="docutils literal notranslate"><span class="pre">act()</span></code></p>
</dd>
<dt class="field-even">class FixedDialogTeacher</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">__init__()</span></code>, <code class="docutils literal notranslate"><span class="pre">get()</span></code>, <code class="docutils literal notranslate"><span class="pre">num_examples()</span></code>, <code class="docutils literal notranslate"><span class="pre">num_episodes()</span></code></p>
</dd>
<dt class="field-odd">class DialogTeacher</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">__init__()</span></code>, <code class="docutils literal notranslate"><span class="pre">setup_data()</span></code></p>
</dd>
<dt class="field-even">class ParlAIDialogTeacher</dt>
<dd class="field-even"><p><code class="docutils literal notranslate"><span class="pre">__init__()</span></code></p>
</dd>
</dl>
<div class="section" id="parlaidialogteacher">
<h3>ParlAIDialogTeacher<a class="headerlink" href="#parlaidialogteacher" title="Permalink to this headline">¶</a></h3>
<p>For this class, the user must implement at least an <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> function, and
often only that.</p>
<p>In this section we will illustrate the process of using the <code class="docutils literal notranslate"><span class="pre">ParlAIDialogTeacher</span></code>
class by adding the Twitter dataset.
This task has data in textual form and has been formatted to follow the ParlAI Dialog format.
It is thus very simple to implement it using <code class="docutils literal notranslate"><span class="pre">ParlAIDialogTeacher</span></code>.
More information on this class and the dialog format can be found in the <a class="reference internal" href="teachers.html"><span class="doc">teachers documentation</span></a>.</p>
<p>In this task, the agent is presented with questions about movies that are answerable from Wikipedia.
A sample dialog is demonstrated below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[twitter]: burton is a fave of mine,even his average films are better than most directors.
[labels: keeping my fingers crossed that he still has another ed wood in him before he retires.]
- - - - - - - - - - - - - - - - - - - - -
~~
[twitter]: i saw someone say that we should use glass straws..
[labels: glass or paper straws - preferably no &#39;straw&#39; waste. ban !]
</pre></div>
</div>
<p>Every task requires a <code class="docutils literal notranslate"><span class="pre">DefaultTeacher</span></code>. Since we are subclassing <code class="docutils literal notranslate"><span class="pre">ParlAIDialogTeacher</span></code>,
we only have to initialize the class and set a few option parameters, as shown below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DefaultTeacher</span><span class="p">(</span><span class="n">ParlAIDialogTeacher</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">shared</span><span class="p">)</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

        <span class="c1"># get datafile</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;datafile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_path</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can notice there was a call to a <code class="docutils literal notranslate"><span class="pre">_path()</span></code> method, which returns the path to the correct datafile.
The path to the file is then stored in the options dictionary under the <code class="docutils literal notranslate"><span class="pre">datafile</span></code> key.
This item is passed to <code class="docutils literal notranslate"><span class="pre">setup_data()</span></code> so that subclasses can just override the path instead of the function.
We still need to implement this <code class="docutils literal notranslate"><span class="pre">_path()</span></code> method. The version for this example is presented below.
It first ensures the data is built by calling the <code class="docutils literal notranslate"><span class="pre">build()</span></code> method described in Part 1.
It then sets up the paths for the built data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.build</span> <span class="kn">import</span> <span class="n">build</span>

<span class="k">def</span> <span class="nf">_path</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">filtered</span><span class="p">):</span>
    <span class="c1"># build the data if it does not exist</span>
    <span class="n">build</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

    <span class="c1"># set up path to data (specific to each dataset)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">],</span> <span class="s1">&#39;Twitter&#39;</span><span class="p">,</span> <span class="n">dt</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>And this is all that needs to be done to create a teacher for our task using <code class="docutils literal notranslate"><span class="pre">ParlAIDialogTeacher</span></code>.</p>
<p>To access this data, we can now use the <code class="docutils literal notranslate"><span class="pre">display_data.py</span></code> file in the <code class="docutils literal notranslate"><span class="pre">examples</span></code> directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python examples/display_data.py -t twitter
</pre></div>
</div>
</div>
<div class="section" id="dialogteacher">
<h3>DialogTeacher<a class="headerlink" href="#dialogteacher" title="Permalink to this headline">¶</a></h3>
<p>For this class, the user must also implement their own <code class="docutils literal notranslate"><span class="pre">setup_data()</span></code> function,
but the rest of the work of supporting hogwild or batching, streaming data from
disk, processing images, and more is taken care of for them.</p>
<p>In this section we will demonstrate the process of using the <code class="docutils literal notranslate"><span class="pre">DialogTeacher</span></code>
class by adding a simple question-answering task based on the MNIST dataset.
This task depends on visual data and so does not fit the basic <code class="docutils literal notranslate"><span class="pre">ParlAIDialogTeacher</span></code>
class described above. Still, using <code class="docutils literal notranslate"><span class="pre">DialogTeacher</span></code> makes it easy to
implement dialog tasks such as this one.</p>
<p>In this task, the agent is presented with the image of a digit and then asked to
answer which number it is seeing. A sample episode is demonstrated below.
Note that we display an ASCII rendition here for human-viewing,
and while you could try to train a model on the ASCII,
the pixel values and several preprocessing options are available instead.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[mnist_qa]: Which number is in the image?
@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@83 c@@@@@@@@@@
@@@@@@@@@@@@@h:  ,@@@@@@@@@@
@@@@@@@@@@@@c    .&amp;@@@@@@@@@
@@@@@@@@@@@:  .,  :@@@@@@@@@
@@@@@@@@@@A  c&amp;@2  8@@@@@@@@
@@@@@@@@@H  ;@@@H  h@@@@@@@@
@@@@@@@@9: ,&amp;@@G.  #@@@@@@@@
@@@@@@@@h ,&amp;@@A    @@@@@@@@@
@@@@@@@@; H@&amp;s    r@@@@@@@@@
@@@@@@@@: ::.     #@@@@@@@@@
@@@@@@@@h        ;@@@@@@@@@@
@@@@@@@@h        G@@@@@@@@@@
@@@@@@@@@A,:2c  :@@@@@@@@@@@
@@@@@@@@@@@@@:  3@@@@@@@@@@@
@@@@@@@@@@@@&amp;, r@@@@@@@@@@@@
@@@@@@@@@@@@:  A@@@@@@@@@@@@
@@@@@@@@@@@@   2@@@@@@@@@@@@
@@@@@@@@@@@@  ,@@@@@@@@@@@@@
@@@@@@@@@@@@  3@@@@@@@@@@@@@
@@@@@@@@@@@@ ,&amp;@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@

[labels: 9|nine]
[cands: seven|six|one|8|two| ...and 15 more]
   [Agent]: nine
</pre></div>
</div>
<p>We will call our teacher <code class="docutils literal notranslate"><span class="pre">MnistQATeacher</span></code>. Let’s initialize this class first.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MnistQATeacher</span><span class="p">(</span><span class="n">DialogTeacher</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># store datatype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># store identifier for the teacher in the dialog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;mnist_qa&#39;</span>

        <span class="c1"># strings for the labels in the class (digits)</span>
        <span class="c1"># (information specific to this task)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_strs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">,</span> <span class="s1">&#39;four&#39;</span><span class="p">,</span> <span class="s1">&#39;five&#39;</span><span class="p">,</span>
                <span class="s1">&#39;six&#39;</span><span class="p">,</span> <span class="s1">&#39;seven&#39;</span><span class="p">,</span> <span class="s1">&#39;eight&#39;</span><span class="p">,</span> <span class="s1">&#39;nine&#39;</span><span class="p">]</span>

        <span class="c1"># store paths to images and labels</span>
        <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;datafile&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_path</span> <span class="o">=</span> <span class="n">_path</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">shared</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">id</span></code> field names the teacher in the dialog. The <code class="docutils literal notranslate"><span class="pre">num_strs</span></code> field is
specific to this example task. It is being used simply to store the text
version of the digits.</p>
<p>We also call our <code class="docutils literal notranslate"><span class="pre">_path()</span></code> method (defined below). The <code class="docutils literal notranslate"><span class="pre">opt['datafile']</span></code> item
is passed to <code class="docutils literal notranslate"><span class="pre">setup_data()</span></code> when it is called by DialogTeacher, which we will
also define below.</p>
<p>The version of <code class="docutils literal notranslate"><span class="pre">_path()</span></code> for this example is presented below.
It first ensures the data is built by calling the <code class="docutils literal notranslate"><span class="pre">build()</span></code> method described above.
It then sets up the paths for the built data. This should be specific to the dataset being used.
If your dataset does not use images, the <code class="docutils literal notranslate"><span class="pre">image_path</span></code> is not necessary, for example.
Or if your task will use data other than labels, the path to the file containing this information can also be returned.
You do not need to put this in a separate function like we do here, but could also encode directly in the class.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_path</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
    <span class="c1"># ensure data is built</span>
    <span class="n">build</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

    <span class="c1"># set up paths to data (specific to each dataset)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">labels_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">],</span> <span class="s1">&#39;mnist&#39;</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;labels.json&#39;</span><span class="p">)</span>
    <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">],</span> <span class="s1">&#39;mnist&#39;</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">labels_path</span><span class="p">,</span> <span class="n">image_path</span>
</pre></div>
</div>
<p>By creating <code class="docutils literal notranslate"><span class="pre">MnistQATeacher</span></code> as a subclass of <code class="docutils literal notranslate"><span class="pre">DialogTeacher</span></code>,
the job of creating a teacher for this task becomes much simpler:
most of the work that needs to be done will limit itself to defining a <code class="docutils literal notranslate"><span class="pre">setup_data</span></code> method.
This method is a generator that will take in a path to the data and yield a
pair of elements for each call.
The first element of the pair is a tuple containing the following information:
<code class="docutils literal notranslate"><span class="pre">(query,</span> <span class="pre">labels,</span> <span class="pre">reward,</span> <span class="pre">label_candidates,</span> <span class="pre">path_to_image)</span></code>.
The second is a boolean flag <code class="docutils literal notranslate"><span class="pre">new_episode?</span></code> which indicates if the current
query starts a new episode or not.</p>
<p>More information on this format can be found in the documentation under <code class="docutils literal notranslate"><span class="pre">DialogData</span></code>
in the <a class="reference internal" href="teachers.html"><span class="doc">teachers documentation</span></a>
(<code class="docutils literal notranslate"><span class="pre">setup_data</span></code> is provided as a data_loader to <code class="docutils literal notranslate"><span class="pre">DialogData</span></code>).</p>
<p>The sample <code class="docutils literal notranslate"><span class="pre">setup_data</span></code> method for our task is presented below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">setup_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;loading: &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>

    <span class="c1"># open data file with labels</span>
    <span class="c1"># (path will be provided to setup_data from opt[&#39;datafile&#39;] defined above)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">labels_file</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">labels_file</span><span class="p">)</span>

    <span class="c1"># define standard question, since it doesn&#39;t change for this task</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="s1">&#39;Which number is in the image?&#39;</span>
    <span class="c1"># every episode consists of only one query in this task</span>
    <span class="n">new_episode</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c1"># define iterator over all queries</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)):</span>
        <span class="c1"># set up path to curent image</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%05d</span><span class="s1">.bmp&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
        <span class="c1"># get current label, both as a digit and as a text</span>
        <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_strs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])]]</span>
        <span class="c1"># yield tuple with information and new_episode? flag (always True)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">img_path</span><span class="p">),</span> <span class="n">new_episode</span>
</pre></div>
</div>
<p>As we can see from the code above, for this specific task the question is always the same,
and thus it is fixed. For different tasks, this would likely change at each iteration.
Similarly, for this task, each episode consists of only one query, thus
<code class="docutils literal notranslate"><span class="pre">new_episode?</span></code> is always true (<em>i.e.</em>, each query is the start of its episode).
This could also vary depending on the task.</p>
<p>Looking at the tuple provided by the iterator at each yield,
we can see that we defined a query, a label and an image path.
When working with <code class="docutils literal notranslate"><span class="pre">DialogTeacher</span></code> in visual tasks, we provide the path to the
image on disk so that the dialog teacher can automatically load and process it.
The “image-mode” command line argument allows for a number of post-processing
options, including returning the raw pixels, extracting features using
pre-trained image models (which are cached and loaded from file the next time)
or as above converted to ASCII.</p>
<p>Finally, one might notice that no reward or label candidates were provided in
the tuple (both are set to <code class="docutils literal notranslate"><span class="pre">None</span></code>). The reward is not specified because it is
not useful for this supervised-learning task. The label candidates, however,
were not specified per-example for this task because we instead use a single set
of universal candidates for every example in this task (the digits from ‘0’ to ‘9’).
For cases like this, with fixed label candidates, one can simply define a method
<code class="docutils literal notranslate"><span class="pre">label_candidates()</span></code> that returns the unchanging candidates, as demonstrated below.
For cases where the label candidates vary for each query, the field in the tuple can be used.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">label_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_strs</span>
</pre></div>
</div>
<p>The only thing left to be done for this part is to define a <code class="docutils literal notranslate"><span class="pre">DefaultTeacher</span></code> class.
This is a requirement for any task, as the <code class="docutils literal notranslate"><span class="pre">create_agent</span></code> method looks for a teacher named this.
We can simply default to the class we have built so far.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DefaultTeacher</span><span class="p">(</span><span class="n">MnistQATeacher</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>And we have finished building our task.</p>
</div>
<div class="section" id="fixeddialogteacher">
<h3>FixedDialogTeacher<a class="headerlink" href="#fixeddialogteacher" title="Permalink to this headline">¶</a></h3>
<p>For this class the user must define at least <code class="docutils literal notranslate"><span class="pre">__init__()</span></code>, a <code class="docutils literal notranslate"><span class="pre">get()</span></code> function,
and <code class="docutils literal notranslate"><span class="pre">num_examples()</span></code> and <code class="docutils literal notranslate"><span class="pre">num_episodes()</span></code>. The user must also handle data
loading and storage on their own, which can be done during intialization.
However, like with its child DialogTeacher, batching and hogwild will still be
handled automatically, as well as metric updating and reporting, example iteration,
and more.</p>
<p>In this section we will demonstrate the use of this class with the VQAv2
visual question-answering task. Since we want to return additional fields apart
from the standard ones used in DialogTeacher (text, labels, reward, candidates,
an image, and whether the episode is done), we’ll extend FixedDialogTeacher instead.
We’ll also demonstrate the use of the multithreaded loader that is available,
which can be helpful for speeding up image loading by beginning to load the next
example while the current one is being looked at by the model.</p>
<p>In this task, the agent is presented with an image of a scene and then asked
to answer a question about that scene. A sample episode is demonstrated below.</p>
<img alt="_images/task_tutorial_skateboard.jpg" src="_images/task_tutorial_skateboard.jpg" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[vqa_v2]: What is this man holding?
[labels: skateboard]
   [Agent]: skateboard
</pre></div>
</div>
<p>We will call our teacher <code class="docutils literal notranslate"><span class="pre">OeTeacher</span></code> (for open-ended teacher, since it doesn’t provide the agent with label candidates).
Let’s initialize this class first.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OeTeacher</span><span class="p">(</span><span class="n">FixedDialogTeacher</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;VQA v2.0 Open-Ended teacher, which loads the json VQA data and</span>
<span class="sd">    implements the ``get`` method to return additional metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_mode</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;image_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shared</span> <span class="ow">and</span> <span class="s1">&#39;ques&#39;</span> <span class="ow">in</span> <span class="n">shared</span><span class="p">:</span>
            <span class="c1"># another instance was set up already, just reference its data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ques</span> <span class="o">=</span> <span class="n">shared</span><span class="p">[</span><span class="s1">&#39;ques&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;annotation&#39;</span> <span class="ow">in</span> <span class="n">shared</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">shared</span><span class="p">[</span><span class="s1">&#39;annotation&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_loader</span> <span class="o">=</span> <span class="n">shared</span><span class="p">[</span><span class="s1">&#39;image_loader&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># need to set up data from scratch</span>
            <span class="n">data_path</span><span class="p">,</span> <span class="n">annotation_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_path</span> <span class="o">=</span> <span class="n">_path</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_data</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">annotation_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_loader</span> <span class="o">=</span> <span class="n">ImageLoader</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</pre></div>
</div>
<p>There are a few parts to this initialization.
First, we store the image mode so the we know how to preprocess images.
Then, we check if this teacher is being initialized with a <code class="docutils literal notranslate"><span class="pre">shared</span></code> parameter.
This is used during hogwild or batching to share data within a batch or between
threads without each instance having to initialize from scratch. See the
<strong>Batching and Hogwild</strong> tutorial for more information on this.
If <code class="docutils literal notranslate"><span class="pre">shared</span></code> is empty, then we’ll move on to loading our data.</p>
<p>Finally we’ll reset the class so parents can initialize class fields to
support threaded loading, metrics, and more.</p>
<p>Let’s take a quick look at the fucntions which set up the data and share it
between instances just so we see how those are set up.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_setup_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">annotation_path</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;loading: &#39;</span> <span class="o">+</span> <span class="n">data_path</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">data_file</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ques</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;loading: &#39;</span> <span class="o">+</span> <span class="n">annotation_path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">annotation_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">data_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">share</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">shared</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">share</span><span class="p">()</span>
    <span class="n">shared</span><span class="p">[</span><span class="s1">&#39;ques&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ques</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;annotation&#39;</span><span class="p">):</span>
        <span class="n">shared</span><span class="p">[</span><span class="s1">&#39;annotation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span>
    <span class="n">shared</span><span class="p">[</span><span class="s1">&#39;image_loader&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_loader</span>
    <span class="k">return</span> <span class="n">shared</span>
</pre></div>
</div>
<p>Next up, we need to implement <code class="docutils literal notranslate"><span class="pre">num_examples()</span></code> and <code class="docutils literal notranslate"><span class="pre">num_episodes</span></code> for the
FixedDialogTeacher teacher to work correctly. These are very straightforward,
and we only have one question per episode, so we can reuse that definition.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">num_examples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ques</span><span class="p">[</span><span class="s1">&#39;questions&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">num_episodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_examples</span><span class="p">()</span>
</pre></div>
</div>
<p>Next we need to implement the <code class="docutils literal notranslate"><span class="pre">get()</span></code> function. This has two arguments: which
episode we want to pull from, and then the index within that episode of the
specific example we want. Since every episode has only one entry in this dataset,
we provide a default for the keyword and ignore it.</p>
<p>We also define the DefaultTeacher class to refer to this one.
This task also includes another teacher which includes multiple choice candidates,
but we don’t include that in this tutorial.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">episode_idx</span><span class="p">,</span> <span class="n">entry_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">qa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ques</span><span class="p">[</span><span class="s1">&#39;questions&#39;</span><span class="p">][</span><span class="n">episode_idx</span><span class="p">]</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">qa</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span>

    <span class="n">action</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span>
        <span class="s1">&#39;image_id&#39;</span><span class="p">:</span> <span class="n">qa</span><span class="p">[</span><span class="s1">&#39;image_id&#39;</span><span class="p">],</span>
        <span class="s1">&#39;episode_done&#39;</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">):</span>
        <span class="c1"># test set annotations are not available for this dataset</span>
        <span class="n">anno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">][</span><span class="n">episode_idx</span><span class="p">]</span>
        <span class="n">action</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ans</span><span class="p">[</span><span class="s1">&#39;answer&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ans</span> <span class="ow">in</span> <span class="n">anno</span><span class="p">[</span><span class="s1">&#39;answers&#39;</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">action</span>


<span class="k">class</span> <span class="nc">DefaultTeacher</span><span class="p">(</span><span class="n">OeTeacher</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>At this point, the class is done! However, we’ll extend it a little further to
take advantage of a few utility methods that allow for loading the next image
in the background by overriding the <code class="docutils literal notranslate"><span class="pre">next_example()</span></code> method of FixedDialogTeacher
(the method that calls our <code class="docutils literal notranslate"><span class="pre">get()</span></code> method).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>  <span class="c1"># call parent reset so other fields can be set up</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">example</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># set up caching fields</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">next_example</span><span class="p">()</span>  <span class="c1"># call this once to get the cache moving</span>

<span class="k">def</span> <span class="nf">next_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the next example from this dataset after starting to queue</span>
<span class="sd">    up the next example.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ready</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># pull up the currently queued example</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">example</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_mode</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="c1"># move the image we loaded in the background into the example</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span>
        <span class="n">ready</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">example</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochDone</span><span class="p">)</span>
    <span class="c1"># get the next base example: super().next_example() calls self.get()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">example</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochDone</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">next_example</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_mode</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span> <span class="ow">and</span> <span class="s1">&#39;image_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">example</span><span class="p">:</span>
        <span class="c1"># load the next image in the background</span>
        <span class="n">image_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;image_id&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submit_load_request</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
    <span class="c1"># return the previously cached example</span>
    <span class="k">return</span> <span class="n">ready</span>
</pre></div>
</div>
<p>This method uses the <code class="docutils literal notranslate"><span class="pre">submit_load_request()</span></code> method to start a background
thread loading the next image, loading previously finished work with with
<code class="docutils literal notranslate"><span class="pre">self.data_queue.get()</span></code>. It calls <code class="docutils literal notranslate"><span class="pre">super().next_example()</span></code> to prepare the
next example it’s going to return, which calls the <code class="docutils literal notranslate"><span class="pre">get()</span></code> method we defined,
and then returns the previously cached example. Note that here we also call
<code class="docutils literal notranslate"><span class="pre">next_example()</span></code> in the <code class="docutils literal notranslate"><span class="pre">reset()</span></code> function to start filling the cache.</p>
<p>This extra functionality helps in particular with loading images–for this task,
adding the threading helped a model to process an epoch approximately 2.5x faster.
Further speedups can be accomplished with the Pytorch dataloader, adding another
6.5x speedup. A tutorial on how to use this dataloader is forthcoming.</p>
</div>
<div class="section" id="task-from-scratch">
<h3>Task from Scratch<a class="headerlink" href="#task-from-scratch" title="Permalink to this headline">¶</a></h3>
<p>In this case, one would inherit from the Teacher class.
For this class, at least the <code class="docutils literal notranslate"><span class="pre">act()</span></code> method and probably the <code class="docutils literal notranslate"><span class="pre">observe()</span></code>
method must be overriden. Quite a bit of functinoality will not be built in,
such as a support for hogwild and batching, but metrics will be set up and
can be used to track stats like the number of correctly answered examples.</p>
<p>In general, extending Teacher directly is not recommended unless the above
classes definitely do not fit your task. We still have a few remnants which
do this in our code base instead of using FixedDialogTeacher, but this will
require one to do extra work to support batching and hogwild if desired.</p>
<p>However, extending teacher directly is necessary for non-fixed data.
For example, one might have a like the full negotiation version of the
<code class="docutils literal notranslate"><span class="pre">dealnodeal</span></code> task, where episodes are variable-length (it continues until one
player ends the discussion).</p>
<p>In this case, just implement the <code class="docutils literal notranslate"><span class="pre">observe()</span></code> function to handle seeing the
text from the other agent, and the <code class="docutils literal notranslate"><span class="pre">act()</span></code> function to take an action
(such as sending text or other fields such as reward to the other agent).</p>
</div>
</div>
<div class="section" id="part-3-add-task-to-task-list">
<h2>Part 3: Add Task to Task List<a class="headerlink" href="#part-3-add-task-to-task-list" title="Permalink to this headline">¶</a></h2>
<p>Now that our task is complete, we must add an entry to the <code class="docutils literal notranslate"><span class="pre">task_list.py</span></code> file in <code class="docutils literal notranslate"><span class="pre">parlai/tasks</span></code>.
This file just contains a json-formatted list of all tasks, with each task represented as a dictionary.
Sample entries for our tasks are presented below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="c1"># other tasks...</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;MTurkWikiMovies&quot;</span><span class="p">,</span>
        <span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;MTurk WikiMovies&quot;</span><span class="p">,</span>
        <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;mturkwikimovies&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>  <span class="s2">&quot;QA&quot;</span> <span class="p">],</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Closed-domain QA dataset asking MTurk-derived questions about movies, answerable from Wikipedia. From Li et al. &#39;16. Link: https://arxiv.org/abs/1611.09823&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;MNIST_QA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;MNIST_QA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;mnist_qa&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;Visual&quot;</span> <span class="p">],</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Task which requires agents to identify which number they are seeing. From the MNIST dataset.&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;VQAv2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;VQAv2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;vqa_v2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;Visual&quot;</span> <span class="p">],</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Bigger, more balanced version of the original VQA dataset. From Goyal et al. &#39;16. Link: https://arxiv.org/abs/1612.00837&quot;</span>
    <span class="p">},</span>
    <span class="c1"># other tasks...</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="part-4-executing-the-task">
<h2>Part 4: Executing the Task<a class="headerlink" href="#part-4-executing-the-task" title="Permalink to this headline">¶</a></h2>
<p>A simple way of testing the basic functionality in a task is to run the
<code class="docutils literal notranslate"><span class="pre">display_data.py</span></code> example in the <code class="docutils literal notranslate"><span class="pre">examples</span></code> directory.
Now that the work is done, we can pass it to ParlAI by using the <code class="docutils literal notranslate"><span class="pre">-t</span></code> flag.
For example, to execute the MTurk WikiMovies task we should call:</p>
<p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">display_data.py</span> <span class="pre">-t</span> <span class="pre">mturkwikimovies</span></code></p>
<p>To run the MNIST_QA task, while displaying the images in ascii format, we could call:</p>
<p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">display_data.py</span> <span class="pre">-t</span> <span class="pre">mnist_qa</span> <span class="pre">-im</span> <span class="pre">ascii</span></code></p>
<p>And for VQAv2:</p>
<p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">display_data.py</span> <span class="pre">-t</span> <span class="pre">vqa_v2</span></code></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tutorial_worlds.html" class="btn btn-neutral float-right" title="Data Handling, Batching, and Hogwild" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorial_basic.html" class="btn btn-neutral float-left" title="Intro to ParlAI" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Facebook AI Research

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>