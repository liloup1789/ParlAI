<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ParlAI: docs/source/tutorial_chat_service.md Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ParlAI
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">docs/source/tutorial_chat_service.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d9/d71/tutorial__chat__service_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# Using Chat Services</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;This is a tutorial for connecting your trained ParlAI agents to various chat services in order to allow your models to talk to humans. Humans using chat services (like Facebook Messenger) can be viewed as another type of agent in ParlAI and communicate in the standard observation/act dict format.</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;We currently support the following chat services:</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;1. **Browser**</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;2. **Facebook Messenger**</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;3. **Terminal**</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;4. **Web Sockets**</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;You can find more information on how to set up these services below.</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;Please read here [here](https://github.com/facebookresearch/ParlAI/tree/master/parlai/chat_service) for information on how to set up a new chat service.</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;## Overview</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;As stated, humans messaging on chat services can be viewed as a type of agent in ParlAI, communicating with models via observations and action dicts. See [here](https://github.com/facebookresearch/ParlAI/blob/master/parlai/chat_service/core/agents.py) for the basic implementation. Human agents are placed in worlds with ParlAI agent(s) and possibly other humans, and the world defines how each of these agents interacts.</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;The chat environment is defined by the **task**. A task typically consists of an `Overworld`, which can spawn subtasks (subworlds) or serve as a &quot;main menu&quot;, allowing people to pick from multiple conversation options. The task definition resides in a config file, `config.yml`, in which all all available worlds and any additional commandline arguments.</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;Here is an example config file for a Messenger chatbot:</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;```</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;tasks:</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;  default:</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;    onboard_world: MessengerBotChatOnboardWorld</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    task_world: MessengerBotChatTaskWorld</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    timeout: 1800</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    agents_required: 1</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;task_name: chatbot</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;world_module: parlai.chat_service.tasks.chatbot.worlds</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;overworld: MessengerOverworld</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;page_id: 1 # Configure Your Own Page</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;max_workers: 30</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;opt:  # Additional model opts go here</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  debug: True</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  model: legacy:seq2seq:0</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  model_file: models:convai2/seq2seq/convai2_self_seq2seq_model</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  override:</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    model: legacy:seq2seq:0</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;```</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;After following the set-up instructions (detailed below), this task could be run with the following command from the `parlai/chat_service/services/messenger` directory:</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;```</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;python run.py --config-path ../../tasks/chatbot/config.yml</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;```</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;## Example Tasks</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;As an example, the [Overworld Demo](https://github.com/facebookresearch/ParlAI/blob/master/parlai/chat_service/tasks/overworld_demo/) displays three separate tasks connected together by an overworld.</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;- The `echo` task is a simple example of an echo bot, and shows the functionality and flow of a simple single-person world.</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;- The `onboard data` task is an example that shows how an onboarding world can collect information that is later exposed in the active task world.</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;- The `chat` task is an example of a task that requires multiple users, and shows how many people can be connected together in an instance of a world and then returned to the overworld upon completion of a task.</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;In addition to the overworld demo, the following example tasks are provided:</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;- [Generic Chatbot](https://github.com/facebookresearch/ParlAI/blob/master/parlai/chat_service/tasks/chatbot/): Allow conversations with any ParlAI models, for instance the [PersonaChat](https://github.com/facebookresearch/ParlAI/tree/master/projects/personachat) model.</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;- [QA Data Collection](https://github.com/facebookresearch/ParlAI/blob/master/parlai/chat_service/tasks/qa_data_collection/): collect questions and answers from people, given a random Wikipedia paragraph from SQuAD.</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;### Creating your Own Task</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;To create your own task, start with reading the tutorials on the provided examples, and then copy and modify the example `worlds.py` and `config.yml` files to create your task.</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;**A few things to keep in mind:**</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;1. A conversation ends when a call between `parley` calls to `episode_done` returns True.</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;2. Tasks with an overworld should return the name of the world that they want to queue a user into from the ``parley`` call in which the user makes that selection to enter a world.</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;3. Tasks with no overworld will immediately attempt to put a user into the queue for the default task onboarding world or actual task world (if no onboarding world exists), and will do so again following the completion of a world (via `episode_done`).</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;3. To collect the conversation, data should be collected during every `parley` and saved during the `world.shutdown` call. You must inform the user of the fact that the data is being collected as well as your intended use.</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;4. Finally, if you wish to use and command line arguments as you would in ParlAI, specify those in the `opt` section of the config file.</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;## Available Chat Services</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;### Browser</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;This allows you to participate in a ParlAI world as an agent using a local browser.</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;This extends the `websocket` chat service implementation to run a server locally,</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;which you can send and receive messages using a browser.</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;#### Setup</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;1. Run: `python parlai/chat_service/services/browser_chat/run.py --config-path path/to/config.yml --port PORT_NUMBER`</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;2. Run: `python client.py --port PORT_NUMBER`</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;3. Interact</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;**Example command:** `python parlai/chat_service/services/browser_chat/run.py --config-path parlai/chat_service/tasks/chatbot/config.yml --port 10001`</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;If no port number is specified in `--port` then the default port used will be `34596`. If specifying, ensure both port numbers match on client and server side.</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;### Facebook Messenger</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;This allows you to chat with a ParlAI model on Facebook Messenger.</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;&lt;p align=&quot;center&quot;&gt;&lt;img width=&quot;80%&quot; src=&quot;_static/img/messenger-example.png&quot; /&gt;&lt;/p&gt;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;#### Setup</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;- ParlAI&#39;s Messenger functionality requires a free heroku account which can be obtained [here](https://signup.heroku.com/). Running any ParlAI Messenger operation will walk you through linking the two.</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;- Running and testing a bot on the [Facebook Messenger Platform](https://developers.facebook.com/docs/messenger-platform) for yourself will require following the guide to set up a [Facebook App](https://developers.facebook.com/docs/messenger-platform/getting-started/app-setup) for Messenger. Skip the set up your webhook step, as ParlAI will do it for you.</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;- When the guide asks you to configure your webhook URL, you&#39;re ready to run the task. This can be done by running the `run.py` file in with python.</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;- After the heroku server is setup, the script will print out your webhook URL to the console, this should be used to continue the tutorial. The default verify token is `Messenger4ParlAI`. This URL should be added in the Webhook section. The webhook subscription fields should also be edited to subscribe to the `messages` field.</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;- On the first run, the page will ask you for a &quot;Page Access Token,&quot; which is also referred to on the messenger setup page. Paste this in to finish the setup. You should now be able to communicate with your ParlAI world by messaging your page.</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;- To open up your bot for the world to use, you&#39;ll need to submit your bot for approval from the [Developer Dashboard](https://developers.facebook.com/apps/).</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;**Note:** When running a new task from a different directory, the webhook url will change. You will need to update this in the developer console from the webhook settings using &quot;edit subscription.&quot; Your Page Access token should not need to be changed unless you want to use a different page.</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;Additional flags can be used (you can also specify these in the `config.yml` file):</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;- `--password &lt;value&gt;` requires that a user sends the message contained in `value` to the bot in order to access the rest of the communications.</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;- `--force-page-token` forces the script to request a new page token from you, allowing you to switch what page you&#39;re running your bot on.</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;- `--verbose` and `--debug` should be used before reporting problems that arise that appear unrelated to your world, as they expose more of the internal state of the messenger manager.</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;**Other things to keep in mind when creating your Messenger tasks:**</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;- Your world can utilize the complete set of [Facebook Messenger Templates](https://developers.facebook.com/docs/messenger-platform/send-messages/templates) by putting the formatted data in the &#39;payload&#39; field of the observed action.</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;- Quick replies can be attached to any action, the `MessengerOverworld` of the [Overworld Demo](https://github.com/facebookresearch/ParlAI/blob/master/parlai/chat_service/tasks/overworld_demo/) displays this functionality.</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;### Terminal</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;This allows you to participate in a ParlAI world as an agent using the terminal.</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;This extends the `websocket` chat service implementation to run a server locally,</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;which you can send and receive messages from using the terminal.</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;#### Setup</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;1. Run: `python parlai/chat_service/services/terminal_chat/run.py --config-path path/to/config.yml --port PORT_NUMBER`</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;2. Run: `python client.py --port PORT_NUMBER`</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;3. Interact</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;**Example command:** `python parlai/chat_service/services/terminal_chat/run.py --config-path parlai/chat_service/tasks/chatbot/config.yml --port 10001`</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;If no port number is specified in `--port` then the default port used will be `34596`. If specifying, ensure both port numbers match on client and server side.</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;### Web Sockets</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;See **Browser** above for an example implementation of a websockets-based chat service. You can view the code [here](https://github.com/facebookresearch/ParlAI/tree/master/parlai/chat_service/services/browser_chat).</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;### Adding a New Chat Service</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;For full instructions on adding a new chat service to ParlAI, please read [here](https://github.com/facebookresearch/ParlAI/tree/master/parlai/chat_service/README.md).</div></div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
