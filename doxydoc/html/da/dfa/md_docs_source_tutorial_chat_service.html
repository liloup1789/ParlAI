<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ParlAI: Using Chat Services</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ParlAI
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Using Chat Services </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is a tutorial for connecting your trained ParlAI agents to various chat services in order to allow your models to talk to humans. Humans using chat services (like Facebook Messenger) can be viewed as another type of agent in ParlAI and communicate in the standard observation/act dict format.</p>
<p>We currently support the following chat services:</p>
<ol type="1">
<li><b>Browser</b></li>
<li><b>Facebook Messenger</b></li>
<li><b>Terminal</b></li>
<li><b>Web Sockets</b></li>
</ol>
<p>You can find more information on how to set up these services below.</p>
<p>Please read here <a href="https://github.com/facebookresearch/ParlAI/tree/master/parlai/chat_service">here</a> for information on how to set up a new chat service.</p>
<h2>Overview</h2>
<p>As stated, humans messaging on chat services can be viewed as a type of agent in ParlAI, communicating with models via observations and action dicts. See <a href="https://github.com/facebookresearch/ParlAI/blob/master/parlai/chat_service/core/agents.py">here</a> for the basic implementation. Human agents are placed in worlds with ParlAI agent(s) and possibly other humans, and the world defines how each of these agents interacts.</p>
<p>The chat environment is defined by the <b>task</b>. A task typically consists of an <code>Overworld</code>, which can spawn subtasks (subworlds) or serve as a "main menu", allowing people to pick from multiple conversation options. The task definition resides in a config file, <code>config.yml</code>, in which all all available worlds and any additional commandline arguments.</p>
<p>Here is an example config file for a Messenger chatbot:</p>
<div class="fragment"><div class="line">tasks:</div><div class="line">  default:</div><div class="line">    onboard_world: MessengerBotChatOnboardWorld</div><div class="line">    task_world: MessengerBotChatTaskWorld</div><div class="line">    timeout: 1800</div><div class="line">    agents_required: 1</div><div class="line">task_name: chatbot</div><div class="line">world_module: parlai.chat_service.tasks.chatbot.worlds</div><div class="line">overworld: MessengerOverworld</div><div class="line">page_id: 1 # Configure Your Own Page</div><div class="line">max_workers: 30</div><div class="line">opt:  # Additional model opts go here</div><div class="line">  debug: True</div><div class="line">  model: legacy:seq2seq:0</div><div class="line">  model_file: models:convai2/seq2seq/convai2_self_seq2seq_model</div><div class="line">  override:</div><div class="line">    model: legacy:seq2seq:0</div></div><!-- fragment --><p>After following the set-up instructions (detailed below), this task could be run with the following command from the <code>parlai/chat_service/services/messenger</code> directory: </p><div class="fragment"><div class="line">python run.py --config-path ../../tasks/chatbot/config.yml</div></div><!-- fragment --><h2>Example Tasks</h2>
<p>As an example, the <a href="https://github.com/facebookresearch/ParlAI/blob/master/parlai/chat_service/tasks/overworld_demo/">Overworld Demo</a> displays three separate tasks connected together by an overworld.</p>
<ul>
<li>The <code>echo</code> task is a simple example of an echo bot, and shows the functionality and flow of a simple single-person world.</li>
<li>The <code>onboard data</code> task is an example that shows how an onboarding world can collect information that is later exposed in the active task world.</li>
<li>The <code>chat</code> task is an example of a task that requires multiple users, and shows how many people can be connected together in an instance of a world and then returned to the overworld upon completion of a task.</li>
</ul>
<p>In addition to the overworld demo, the following example tasks are provided:</p>
<ul>
<li><a href="https://github.com/facebookresearch/ParlAI/blob/master/parlai/chat_service/tasks/chatbot/">Generic Chatbot</a>: Allow conversations with any ParlAI models, for instance the <a href="https://github.com/facebookresearch/ParlAI/tree/master/projects/personachat">PersonaChat</a> model.</li>
<li><a href="https://github.com/facebookresearch/ParlAI/blob/master/parlai/chat_service/tasks/qa_data_collection/">QA Data Collection</a>: collect questions and answers from people, given a random Wikipedia paragraph from SQuAD.</li>
</ul>
<h3>Creating your Own Task</h3>
<p>To create your own task, start with reading the tutorials on the provided examples, and then copy and modify the example <code>worlds.py</code> and <code>config.yml</code> files to create your task.</p>
<p><b>A few things to keep in mind:</b></p>
<ol type="1">
<li>A conversation ends when a call between <code>parley</code> calls to <code>episode_done</code> returns True.</li>
<li>Tasks with an overworld should return the name of the world that they want to queue a user into from the <code>parley</code> call in which the user makes that selection to enter a world.</li>
<li>Tasks with no overworld will immediately attempt to put a user into the queue for the default task onboarding world or actual task world (if no onboarding world exists), and will do so again following the completion of a world (via <code>episode_done</code>).</li>
</ol>
<ol type="1">
<li>To collect the conversation, data should be collected during every <code>parley</code> and saved during the <code>world.shutdown</code> call. You must inform the user of the fact that the data is being collected as well as your intended use.</li>
<li>Finally, if you wish to use and command line arguments as you would in ParlAI, specify those in the <code>opt</code> section of the config file.</li>
</ol>
<h2>Available Chat Services</h2>
<h3>Browser</h3>
<p>This allows you to participate in a ParlAI world as an agent using a local browser. This extends the <code>websocket</code> chat service implementation to run a server locally, which you can send and receive messages using a browser.</p>
<h4>Setup</h4>
<ol type="1">
<li>Run: <code>python <a class="el" href="../../d6/d1b/parlai_2chat__service_2services_2browser__chat_2run_8py.html">parlai/chat_service/services/browser_chat/run.py</a> --config-path path/to/config.yml --port PORT_NUMBER</code></li>
<li>Run: <code>python client.py --port PORT_NUMBER</code></li>
<li>Interact</li>
</ol>
<p><b>Example command:</b> <code>python <a class="el" href="../../d6/d1b/parlai_2chat__service_2services_2browser__chat_2run_8py.html">parlai/chat_service/services/browser_chat/run.py</a> --config-path parlai/chat_service/tasks/chatbot/config.yml --port 10001</code></p>
<p>If no port number is specified in <code>--port</code> then the default port used will be <code>34596</code>. If specifying, ensure both port numbers match on client and server side.</p>
<h3>Facebook Messenger</h3>
<p>This allows you to chat with a ParlAI model on Facebook Messenger.</p>
<div class="image">
<img src="../../_static/img/messenger-example.png" width="80%"/>
</div>
<h4>Setup</h4>
<ul>
<li>ParlAI's Messenger functionality requires a free heroku account which can be obtained <a href="https://signup.heroku.com/">here</a>. Running any ParlAI Messenger operation will walk you through linking the two.</li>
<li>Running and testing a bot on the <a href="https://developers.facebook.com/docs/messenger-platform">Facebook Messenger Platform</a> for yourself will require following the guide to set up a <a href="https://developers.facebook.com/docs/messenger-platform/getting-started/app-setup">Facebook App</a> for Messenger. Skip the set up your webhook step, as ParlAI will do it for you.</li>
<li>When the guide asks you to configure your webhook URL, you're ready to run the task. This can be done by running the <code>run.py</code> file in with python.</li>
<li>After the heroku server is setup, the script will print out your webhook URL to the console, this should be used to continue the tutorial. The default verify token is <code>Messenger4ParlAI</code>. This URL should be added in the Webhook section. The webhook subscription fields should also be edited to subscribe to the <code>messages</code> field.</li>
<li>On the first run, the page will ask you for a "Page Access Token," which is also referred to on the messenger setup page. Paste this in to finish the setup. You should now be able to communicate with your ParlAI world by messaging your page.</li>
<li>To open up your bot for the world to use, you'll need to submit your bot for approval from the <a href="https://developers.facebook.com/apps/">Developer Dashboard</a>.</li>
</ul>
<p><b>Note:</b> When running a new task from a different directory, the webhook url will change. You will need to update this in the developer console from the webhook settings using "edit subscription." Your Page Access token should not need to be changed unless you want to use a different page.</p>
<p>Additional flags can be used (you can also specify these in the <code>config.yml</code> file):</p>
<ul>
<li><code>--password &lt;value&gt;</code> requires that a user sends the message contained in <code>value</code> to the bot in order to access the rest of the communications.</li>
<li><code>--force-page-token</code> forces the script to request a new page token from you, allowing you to switch what page you're running your bot on.</li>
<li><code>--verbose</code> and <code>--debug</code> should be used before reporting problems that arise that appear unrelated to your world, as they expose more of the internal state of the messenger manager.</li>
</ul>
<p><b>Other things to keep in mind when creating your Messenger tasks:</b></p><ul>
<li>Your world can utilize the complete set of <a href="https://developers.facebook.com/docs/messenger-platform/send-messages/templates">Facebook Messenger Templates</a> by putting the formatted data in the 'payload' field of the observed action.</li>
<li>Quick replies can be attached to any action, the <code>MessengerOverworld</code> of the <a href="https://github.com/facebookresearch/ParlAI/blob/master/parlai/chat_service/tasks/overworld_demo/">Overworld Demo</a> displays this functionality.</li>
</ul>
<h3>Terminal</h3>
<p>This allows you to participate in a ParlAI world as an agent using the terminal. This extends the <code>websocket</code> chat service implementation to run a server locally, which you can send and receive messages from using the terminal.</p>
<h4>Setup</h4>
<ol type="1">
<li>Run: <code>python <a class="el" href="../../d7/d67/parlai_2chat__service_2services_2terminal__chat_2run_8py.html">parlai/chat_service/services/terminal_chat/run.py</a> --config-path path/to/config.yml --port PORT_NUMBER</code></li>
<li>Run: <code>python client.py --port PORT_NUMBER</code></li>
<li>Interact</li>
</ol>
<p><b>Example command:</b> <code>python <a class="el" href="../../d7/d67/parlai_2chat__service_2services_2terminal__chat_2run_8py.html">parlai/chat_service/services/terminal_chat/run.py</a> --config-path parlai/chat_service/tasks/chatbot/config.yml --port 10001</code></p>
<p>If no port number is specified in <code>--port</code> then the default port used will be <code>34596</code>. If specifying, ensure both port numbers match on client and server side.</p>
<h3>Web Sockets</h3>
<p>See <b>Browser</b> above for an example implementation of a websockets-based chat service. You can view the code <a href="https://github.com/facebookresearch/ParlAI/tree/master/parlai/chat_service/services/browser_chat">here</a>.</p>
<h3>Adding a New Chat Service</h3>
<p>For full instructions on adding a new chat service to ParlAI, please read https://github.com/facebookresearch/ParlAI/tree/master/parlai/chat_service/README.md "here". </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
