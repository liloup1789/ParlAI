<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ParlAI: Setting up ParlAI for a custom chat-service</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ParlAI
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Setting up ParlAI for a custom chat-service </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is an instruction manual to be used as reference on how to configure ParlAI for an arbitrary chat service.</p>
<h2>Message Format</h2>
<p>To maintain consistency we are trying to enforce a deterministic message format throughout this task. If a particular chat service doesn't adhere to this format, one must use <code>restructure_message()</code> to adapt the messages to this format before the messages are used. The message format is defined below: </p><div class="fragment"><div class="line">{</div><div class="line">  mid: # ID of this message</div><div class="line">  recipient: {</div><div class="line">    id: #id of message recipient</div><div class="line">  }</div><div class="line">  sender: {</div><div class="line">    id: #id of message sender</div><div class="line">  }</div><div class="line">  text: # text of the message</div><div class="line">  attachment: # attachment of the message</div><div class="line">}</div></div><!-- fragment --> <h3>Additional Message fields</h3>
<p>These define a non-exhaustive list of keys that one could use in the message dict for ease-of-use</p><ul>
<li>messaging_type: whether the message is a text message or an image upload [RESPONSE, UPDATE]</li>
<li>quickreplies: Auto-suggested replies</li>
<li>persona_id: id of the persona that is interacting</li>
<li>name: Display name of the user</li>
<li>profile_picture_url: URL to the profile picture of the user</li>
</ul>
<h2>Config</h2>
<p>Below is the standard config format and hierarchy to be followed across all chat services:</p>
<p>```config</p><ul>
<li>tasks: # List of available tasks/worlds for a user to enter<ul>
<li>&lt;task 1 name&gt;<ul>
<li>onboard_world: # World in which user is first send upon selecting the task. Can collect necessary data from user in this world, as well as provide instructions etc.</li>
<li>task_world: # Actual task world</li>
<li>timeout: # Agent message timeout - how long to wait for the agent to send a message before assuming they have disconnected.</li>
<li>agents_required: # Number of agents required to run the task world, e.g. 2 for a two player game, 1 for a one-player experience, etc.</li>
</ul>
</li>
<li>&lt;task 2 name&gt;<ul>
<li>onboard_world:</li>
<li>task_world:</li>
<li>timeout:</li>
<li>agents_required:</li>
</ul>
</li>
</ul>
</li>
<li>task_name: # name of the overall task</li>
<li>world_module: # module in which all of the worlds exist (relative path i.e. <code><a class="el" href="../../d3/d54/namespaceparlai_1_1chat__service.html">parlai.chat_service</a>....</code></li>
<li>overworld: # Name of the overworld; where the agent is first sent upon messaging the service</li>
<li>max_workers: # Maximum number of workers that can be in task worlds at any given moment</li>
<li>opt: # Additional model opts go here. Below are example opts that one could normally pass to parlai<ul>
<li>password: # Password for messaging service, if this is wanted</li>
<li>debug: # whether to set debug mode</li>
<li>model: # Name of model, if you want to load a model</li>
<li>model_file: # path to model file, if you want to load a model</li>
<li>override:<ul>
<li>model: # overrides for model</li>
</ul>
</li>
</ul>
</li>
<li>additional_args: # Additional chat service specific args go here<ul>
<li>service_reference_id: 1 # Facebook Page id (if Messenger, else don't include this field)</li>
<li><em>any other args needed by &lt;chat_service&gt;</em> ```</li>
</ul>
</li>
</ul>
<p>As one can notice, most of the format is the same as how it already exists for messenger with the exception of having <code>additional_args:</code> as a field in our config. This has been introduced to provide flexibility of parsing any additional arguments a chat service may need whilst preserving the previously existing necessary args. Note however that <code>page_id</code> has been shifted to this section to maintain coherence.</p>
<h2>Manager</h2>
<p>To implement your own service, you will need to subclass the <code>ChatServiceManager</code> in <code><a class="el" href="../../dc/de8/chat__service__manager_8py.html">chat_service/core/chat_service_manager.py</a></code>. The <code>ChatServiceManager</code> handles a lot of the abstraction for you, so you'll only need to subclass a few of the methods in there when implementing your own service.</p>
<p>Some notable essentials below (note not all abstract methods are specified):</p>
<ol type="1">
<li><code>ChatServiceMessageSender</code> - The message sender is useful for wrapping requests with additional functions. E.g., in the Messenger service, the <code>MessageSender</code> implements <code>send_read</code> and <code>typing_on</code> functions which are called upon message sends.</li>
<li><code>parse_additional_args</code> - This is the function for parsing the additional args from the config specified above</li>
<li><code>_complete_setup</code> - Complete any additional setup items; should be called in initialization.</li>
<li><code>_load_model</code> - This function should load the model, if necessary. This varies per chat service.</li>
<li><code>restructure_message</code> - If messages in your service are not the same format as specified in <em>Message Format</em> above, please use this method to restructure the message.</li>
<li><code>setup_server</code> - sets up the chat service server.</li>
<li><code>setup_socket</code> - sets up the socket to start communicating with users.</li>
<li><code>observe_message</code> - Send a message thru the message manager to a corresponding user/agent.</li>
</ol>
<h2>Manager Utils</h2>
<h3>Socket</h3>
<p>The <code>ChatServiceMessageSocket</code> is a wrapper around websockets to forward messages from a remote server to a <code>ChatServiceManager</code>.</p>
<h3>Runner</h3>
<p>The <code>ChatServiceWorldRunner</code> is the actual class for handling running worlds, overworlds, etc.</p>
<h2>Agents</h2>
<p>Finally, once you have implemented your <code>ChatServiceManager</code>, you will need to implement a <code>ChatServiceAgent</code>, which is specific for each chat service. The following are notable functions to implement in your own <code>ChatServiceAgent</code>.</p>
<ol type="1">
<li><code>observe</code> - Implement this function to receive messages from the manager.</li>
<li><code>put_data</code> - Puts data into the Agent's message queue if it hasn't already been seen. </li>
</ol>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
