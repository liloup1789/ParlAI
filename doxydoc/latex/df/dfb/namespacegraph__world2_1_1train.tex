\hypertarget{namespacegraph__world2_1_1train}{}\section{graph\+\_\+world2.\+train Namespace Reference}
\label{namespacegraph__world2_1_1train}\index{graph\+\_\+world2.\+train@{graph\+\_\+world2.\+train}}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{namespacegraph__world2_1_1train_ac238655ccbc748146d1cbaaac96433a5}{prepro} (\hyperlink{namespacegraph__world2_1_1train_a286634b8300deedee0924d4ecac34fa6}{opt})
\item 
def \hyperlink{namespacegraph__world2_1_1train_aa00e41e1619128901ea053170fedef0b}{validate} (\hyperlink{namespacegraph__world2_1_1train_a286634b8300deedee0924d4ecac34fa6}{opt}, agent)
\item 
def \hyperlink{namespacegraph__world2_1_1train_ab3ba8ae63848a00ac638b31329041f6b}{get\+\_\+metrics} (actions, gt\+\_\+actions)
\item 
def \hyperlink{namespacegraph__world2_1_1train_a8bb8c5ab11be91db36eb268e1c2088a8}{get\+\_\+accuracy} (actions, gt\+\_\+actions, graph)
\item 
def \hyperlink{namespacegraph__world2_1_1train_aaff96a1b7f0cafac9dab96cbc02ae4d0}{additional\+\_\+validate} (\hyperlink{namespacegraph__world2_1_1train_a286634b8300deedee0924d4ecac34fa6}{opt}, model, data\+\_\+agent, valid\+\_\+data\+\_\+file, constrain\+\_\+=True, no\+\_\+hits=False)
\item 
def \hyperlink{namespacegraph__world2_1_1train_a145007eac2c8c1c128ec06f4477c943e}{log\+\_\+print} (s, out\+\_\+file)
\item 
def \hyperlink{namespacegraph__world2_1_1train_af3dec887619817c1a7a38930ffcfd1cb}{main} (\hyperlink{namespacegraph__world2_1_1train_a286634b8300deedee0924d4ecac34fa6}{opt}, return\+\_\+full=False, out\+\_\+file=None)
\item 
def \hyperlink{namespacegraph__world2_1_1train_a8f5e91b9cb92f65b8b096d7eb5dbf2e7}{online\+\_\+exp} (\hyperlink{namespacegraph__world2_1_1train_a286634b8300deedee0924d4ecac34fa6}{opt}, \hyperlink{namespacegraph__world2_1_1train_ab4fed977b76754e4f0d9b2593205e54b}{log\+\_\+file}=None)
\item 
def \hyperlink{namespacegraph__world2_1_1train_a4a2155646856189e143dbc828baef945}{ablation\+\_\+exp} (\hyperlink{namespacegraph__world2_1_1train_a286634b8300deedee0924d4ecac34fa6}{opt})
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{namespacegraph__world2_1_1train_a28914dc685301ea70d35554dc0293486}{argparser}
\item 
\hyperlink{namespacegraph__world2_1_1train_a5483dc050b195034e046160fcc2155c5}{type}
\item 
\hyperlink{namespacegraph__world2_1_1train_ae777b30e4de8f0cdfc26bfda0c01b316}{int}
\item 
\hyperlink{namespacegraph__world2_1_1train_aa15c4b5001beb863ac4144ec68b832a9}{default}
\item 
\hyperlink{namespacegraph__world2_1_1train_adcfd197260a746eeb73a295520831582}{bool}
\item 
\hyperlink{namespacegraph__world2_1_1train_a9843eaa25215aba91f3f4b223dbb2049}{float}
\item 
\hyperlink{namespacegraph__world2_1_1train_ad6e658a468af9626e8b47490972d33a4}{str}
\item 
\hyperlink{namespacegraph__world2_1_1train_a286634b8300deedee0924d4ecac34fa6}{opt}
\item 
\hyperlink{namespacegraph__world2_1_1train_af8a4335a70104bebca62cb53adba47f9}{job\+\_\+num}
\item 
\hyperlink{namespacegraph__world2_1_1train_a3881ea088d1a9bfa45c2a1e496b84fe4}{input\+\_\+file}
\item 
\hyperlink{namespacegraph__world2_1_1train_aaa28465c643e1e44899c580e3cb09469}{output\+\_\+file}
\item 
\hyperlink{namespacegraph__world2_1_1train_ab4fed977b76754e4f0d9b2593205e54b}{log\+\_\+file}
\item 
\hyperlink{namespacegraph__world2_1_1train_a0dbc2533a58165ecd79f668f2889cf3e}{job\+\_\+in\+\_\+opt}
\item 
\hyperlink{namespacegraph__world2_1_1train_a87df49e5955f1677c3d285abb83ad60d}{new\+\_\+opt}
\item 
\hyperlink{namespacegraph__world2_1_1train_a098927108f0006868a4f333d6ce02443}{fout}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\mbox{\Hypertarget{namespacegraph__world2_1_1train_a4a2155646856189e143dbc828baef945}\label{namespacegraph__world2_1_1train_a4a2155646856189e143dbc828baef945}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!ablation\+\_\+exp@{ablation\+\_\+exp}}
\index{ablation\+\_\+exp@{ablation\+\_\+exp}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{ablation\+\_\+exp()}{ablation\_exp()}}
{\footnotesize\ttfamily def graph\+\_\+world2.\+train.\+ablation\+\_\+exp (\begin{DoxyParamCaption}\item[{}]{opt }\end{DoxyParamCaption})}



Definition at line 365 of file train.\+py.


\begin{DoxyCode}
365 \textcolor{keyword}{def }\hyperlink{namespacegraph__world2_1_1train_a4a2155646856189e143dbc828baef945}{ablation\_exp}(opt):
366     max\_acc, cur\_model\_dict, cur\_data\_agent, cur\_wrong\_data, cur\_max\_acc\_len = 
      \hyperlink{namespacegraph__world2_1_1train_af3dec887619817c1a7a38930ffcfd1cb}{main}(
367         opt, \textcolor{keyword}{True}, \textcolor{keywordtype}{None}
368     )
369     \textcolor{keywordflow}{return} \hyperlink{namespacegraph__world2_1_1train_aaff96a1b7f0cafac9dab96cbc02ae4d0}{additional\_validate}(
370         opt,
371         cur\_model\_dict,
372         cur\_data\_agent,
373         opt[\textcolor{stringliteral}{'valid\_data\_file'}],
374         constrain\_=\textcolor{keyword}{True},
375         no\_hits=\textcolor{keyword}{True},
376     )
377 
378 
\end{DoxyCode}
\mbox{\Hypertarget{namespacegraph__world2_1_1train_aaff96a1b7f0cafac9dab96cbc02ae4d0}\label{namespacegraph__world2_1_1train_aaff96a1b7f0cafac9dab96cbc02ae4d0}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!additional\+\_\+validate@{additional\+\_\+validate}}
\index{additional\+\_\+validate@{additional\+\_\+validate}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{additional\+\_\+validate()}{additional\_validate()}}
{\footnotesize\ttfamily def graph\+\_\+world2.\+train.\+additional\+\_\+validate (\begin{DoxyParamCaption}\item[{}]{opt,  }\item[{}]{model,  }\item[{}]{data\+\_\+agent,  }\item[{}]{valid\+\_\+data\+\_\+file,  }\item[{}]{constrain\+\_\+ = {\ttfamily True},  }\item[{}]{no\+\_\+hits = {\ttfamily False} }\end{DoxyParamCaption})}



Definition at line 102 of file train.\+py.


\begin{DoxyCode}
102 ):
103     seq2seq = isinstance(model, Seq2SeqModel)
104 
105     \textcolor{keyword}{def }\_get\_actions(inst, symb\_points):
106         ret = []
107         \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(len(symb\_points) - 1):
108             ret.append(\textcolor{stringliteral}{' '}.join(inst[symb\_points[i] : symb\_points[i + 1]]))
109         \textcolor{keywordflow}{return} ret
110 
111     \textcolor{keyword}{def }\_get\_variable(np\_a, volatile=False):
112         \textcolor{keywordflow}{if} opt[\textcolor{stringliteral}{'cuda'}]:
113             \textcolor{keywordflow}{return} Variable(torch.from\_numpy(np\_a), volatile=volatile).cuda()
114         \textcolor{keywordflow}{return} Variable(torch.from\_numpy(np\_a), volatile=volatile)
115 
116     \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} seq2seq:
117         check\_mapping = \_get\_variable(data\_agent.get\_check\_mapping(), \textcolor{keyword}{True})
118     valid\_data = pickle.load(open(valid\_data\_file, \textcolor{stringliteral}{'rb'}))
119 
120     all\_f1 = 0
121     all\_gt\_actions = []
122     all\_accuracy = 0
123 
124     \textcolor{keywordflow}{for} example \textcolor{keywordflow}{in} valid\_data:
125         exp\_dict = \{\textcolor{stringliteral}{'text'}: example[2], \textcolor{stringliteral}{'actions'}: example[3], \textcolor{stringliteral}{'graph'}: example[1]\}
126         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} seq2seq:
127             (
128                 x,
129                 action\_key,
130                 second\_action\_key,
131                 action\_type,
132                 current\_room,
133                 checked,
134                 y,
135                 y\_mask,
136                 counter\_feat,
137             ) = data\_agent.get\_data([exp\_dict], \textcolor{stringliteral}{'valid'})
138             x, action\_key, second\_action\_key, action\_type, checked = (
139                 \_get\_variable(x, \textcolor{keyword}{True}),
140                 \_get\_variable(action\_key, \textcolor{keyword}{True}),
141                 \_get\_variable(second\_action\_key, \textcolor{keyword}{True}),
142                 \_get\_variable(action\_type, \textcolor{keyword}{True}),
143                 \_get\_variable(checked, \textcolor{keyword}{True}),
144             )
145             text\_out = model.forward\_predict(
146                 x,
147                 action\_key,
148                 second\_action\_key,
149                 action\_type,
150                 check\_mapping,
151                 checked,
152                 [example[1]],
153                 data\_agent,
154                 constrain\_=constrain\_,
155             )[0]
156         \textcolor{keywordflow}{else}:
157             x, y = data\_agent.get\_data([exp\_dict], \textcolor{stringliteral}{'valid'})
158             x, y = \_get\_variable(x, \textcolor{keyword}{True}), \_get\_variable(y, \textcolor{keyword}{True})
159             text\_out = model.forward\_predict(
160                 x, [example[1]], data\_agent, constrain\_=constrain\_
161             )[0]
162         actions = text\_out[:-1]
163         gt\_actions = \_get\_actions(*Graph.parse\_static(example[3]))
164         cur\_f1 = \hyperlink{namespacegraph__world2_1_1train_ab3ba8ae63848a00ac638b31329041f6b}{get\_metrics}(actions, gt\_actions)
165         all\_f1 += cur\_f1
166         all\_accuracy += \hyperlink{namespacegraph__world2_1_1train_a8bb8c5ab11be91db36eb268e1c2088a8}{get\_accuracy}(actions, gt\_actions, example[1])
167 
168         all\_gt\_actions.append(gt\_actions)
169 
170     \textcolor{keywordflow}{if} constrain\_ \textcolor{keywordflow}{and} \textcolor{keywordflow}{not} no\_hits:
171         random.seed(13)
172         hits1, hits5, hits10 = 0, 0, 0
173         \textcolor{keywordflow}{for} i, example \textcolor{keywordflow}{in} enumerate(valid\_data):
174             all\_dicts = []
175             \textcolor{keywordflow}{for} j \textcolor{keywordflow}{in} range(100):
176                 idx = i \textcolor{keywordflow}{if} j == 99 \textcolor{keywordflow}{else} random.randint(0, len(valid\_data) - 1)
177                 exp\_dict = \{
178                     \textcolor{stringliteral}{'text'}: example[2],
179                     \textcolor{stringliteral}{'actions'}: \textcolor{stringliteral}{' '}.join(all\_gt\_actions[idx]),
180                     \textcolor{stringliteral}{'graph'}: example[1],
181                 \}
182                 all\_dicts.append(exp\_dict)
183             \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} seq2seq:
184                 (
185                     x,
186                     action\_key,
187                     second\_action\_key,
188                     action\_type,
189                     current\_room,
190                     checked,
191                     y,
192                     y\_mask,
193                     counter\_feat,
194                 ) = data\_agent.get\_data(all\_dicts, \textcolor{stringliteral}{'train'}, assert\_=\textcolor{keyword}{False})
195                 (
196                     x,
197                     action\_key,
198                     second\_action\_key,
199                     action\_type,
200                     current\_room,
201                     checked,
202                     y,
203                     y\_mask,
204                     counter\_feat,
205                 ) = (
206                     \_get\_variable(x, \textcolor{keyword}{True}),
207                     \_get\_variable(action\_key, \textcolor{keyword}{True}),
208                     \_get\_variable(second\_action\_key, \textcolor{keyword}{True}),
209                     \_get\_variable(action\_type, \textcolor{keyword}{True}),
210                     \_get\_variable(current\_room, \textcolor{keyword}{True}),
211                     \_get\_variable(checked, \textcolor{keyword}{True}),
212                     \_get\_variable(y, \textcolor{keyword}{True}),
213                     \_get\_variable(y\_mask, \textcolor{keyword}{True}),
214                     \_get\_variable(counter\_feat, \textcolor{keyword}{True}),
215                 )
216                 all\_losses = (
217                     model.forward\_loss(
218                         x,
219                         action\_key,
220                         second\_action\_key,
221                         action\_type,
222                         current\_room,
223                         checked,
224                         y,
225                         y\_mask,
226                         counter\_feat,
227                         average\_=\textcolor{keyword}{False},
228                     )
229                     .data.cpu()
230                     .numpy()
231                 )
232             \textcolor{keywordflow}{else}:
233                 x, y = data\_agent.get\_data(all\_dicts, \textcolor{stringliteral}{'train'}, assert\_=\textcolor{keyword}{False})
234                 x, y = \_get\_variable(x, \textcolor{keyword}{True}), \_get\_variable(y, \textcolor{keyword}{True})
235                 all\_losses = model.forward\_loss(x, y, average\_=\textcolor{keyword}{False}).data.cpu().numpy()
236             ranks = ss.rankdata(all\_losses, method=\textcolor{stringliteral}{'ordinal'})
237             \textcolor{keywordflow}{if} ranks[-1] == 1:
238                 hits1 += 1
239             \textcolor{keywordflow}{if} ranks[-1] <= 5:
240                 hits5 += 1
241             \textcolor{keywordflow}{if} ranks[-1] <= 10:
242                 hits10 += 1
243 
244     N = len(valid\_data)
245     \textcolor{keywordflow}{if} constrain\_ \textcolor{keywordflow}{and} \textcolor{keywordflow}{not} no\_hits:
246         \textcolor{keywordflow}{return} \{
247             \textcolor{stringliteral}{'accuracy'}: all\_accuracy / N,
248             \textcolor{stringliteral}{'f1'}: all\_f1 / N,
249             \textcolor{stringliteral}{'hits1'}: hits1 / N,
250             \textcolor{stringliteral}{'hits5'}: hits5 / N,
251             \textcolor{stringliteral}{'hits10'}: hits10 / N,
252         \}
253     \textcolor{keywordflow}{return} \{\textcolor{stringliteral}{'f1'}: all\_f1 / N, \textcolor{stringliteral}{'accuracy'}: all\_accuracy / N\}
254 
255 
\end{DoxyCode}
\mbox{\Hypertarget{namespacegraph__world2_1_1train_a8bb8c5ab11be91db36eb268e1c2088a8}\label{namespacegraph__world2_1_1train_a8bb8c5ab11be91db36eb268e1c2088a8}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!get\+\_\+accuracy@{get\+\_\+accuracy}}
\index{get\+\_\+accuracy@{get\+\_\+accuracy}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{get\+\_\+accuracy()}{get\_accuracy()}}
{\footnotesize\ttfamily def graph\+\_\+world2.\+train.\+get\+\_\+accuracy (\begin{DoxyParamCaption}\item[{}]{actions,  }\item[{}]{gt\+\_\+actions,  }\item[{}]{graph }\end{DoxyParamCaption})}



Definition at line 93 of file train.\+py.


\begin{DoxyCode}
93 \textcolor{keyword}{def }\hyperlink{namespacegraph__world2_1_1train_a8bb8c5ab11be91db36eb268e1c2088a8}{get\_accuracy}(actions, gt\_actions, graph):
94     graph\_a, graph\_b = graph.copy(), graph.copy()
95     graph\_a.parse\_exec(\textcolor{stringliteral}{' '}.join(actions))
96     graph\_b.parse\_exec(\textcolor{stringliteral}{' '}.join(gt\_actions))
97     \textcolor{keywordflow}{return} \hyperlink{namespacegraph__world2_1_1train_a9843eaa25215aba91f3f4b223dbb2049}{float}(graph\_a == graph\_b)
98 
99 
\end{DoxyCode}
\mbox{\Hypertarget{namespacegraph__world2_1_1train_ab3ba8ae63848a00ac638b31329041f6b}\label{namespacegraph__world2_1_1train_ab3ba8ae63848a00ac638b31329041f6b}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!get\+\_\+metrics@{get\+\_\+metrics}}
\index{get\+\_\+metrics@{get\+\_\+metrics}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{get\+\_\+metrics()}{get\_metrics()}}
{\footnotesize\ttfamily def graph\+\_\+world2.\+train.\+get\+\_\+metrics (\begin{DoxyParamCaption}\item[{}]{actions,  }\item[{}]{gt\+\_\+actions }\end{DoxyParamCaption})}



Definition at line 76 of file train.\+py.


\begin{DoxyCode}
76 \textcolor{keyword}{def }\hyperlink{namespacegraph__world2_1_1train_ab3ba8ae63848a00ac638b31329041f6b}{get\_metrics}(actions, gt\_actions):
77     tp, fp, fn = 0, 0, 0
78     action\_set, gt\_action\_set = set(actions), set(gt\_actions)
79     \textcolor{keywordflow}{for} action \textcolor{keywordflow}{in} action\_set:
80         \textcolor{keywordflow}{if} action \textcolor{keywordflow}{in} gt\_action\_set:
81             tp += 1
82         \textcolor{keywordflow}{else}:
83             fp += 1
84     \textcolor{keywordflow}{for} action \textcolor{keywordflow}{in} gt\_action\_set:
85         \textcolor{keywordflow}{if} action \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} action\_set:
86             fn += 1
87     prec = tp / (tp + fp) \textcolor{keywordflow}{if} tp + fp > 0 \textcolor{keywordflow}{else} 0.0
88     recall = tp / (tp + fn) \textcolor{keywordflow}{if} tp + fn > 0 \textcolor{keywordflow}{else} 0.0
89     f1 = 2.0 * prec * recall / (prec + recall) \textcolor{keywordflow}{if} prec + recall > 0 \textcolor{keywordflow}{else} 0.0
90     \textcolor{keywordflow}{return} f1
91 
92 
\end{DoxyCode}
\mbox{\Hypertarget{namespacegraph__world2_1_1train_a145007eac2c8c1c128ec06f4477c943e}\label{namespacegraph__world2_1_1train_a145007eac2c8c1c128ec06f4477c943e}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!log\+\_\+print@{log\+\_\+print}}
\index{log\+\_\+print@{log\+\_\+print}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{log\+\_\+print()}{log\_print()}}
{\footnotesize\ttfamily def graph\+\_\+world2.\+train.\+log\+\_\+print (\begin{DoxyParamCaption}\item[{}]{s,  }\item[{}]{out\+\_\+file }\end{DoxyParamCaption})}



Definition at line 256 of file train.\+py.


\begin{DoxyCode}
256 \textcolor{keyword}{def }\hyperlink{namespacegraph__world2_1_1train_a145007eac2c8c1c128ec06f4477c943e}{log\_print}(s, out\_file):
257     print(s)
258     \textcolor{keywordflow}{if} out\_file \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
259         \textcolor{keywordflow}{return}
260     f\_log = open(out\_file, \textcolor{stringliteral}{'a+'})
261     f\_log.write(s + \textcolor{stringliteral}{'\(\backslash\)n'})
262     f\_log.close()
263 
264 
\end{DoxyCode}
\mbox{\Hypertarget{namespacegraph__world2_1_1train_af3dec887619817c1a7a38930ffcfd1cb}\label{namespacegraph__world2_1_1train_af3dec887619817c1a7a38930ffcfd1cb}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!main@{main}}
\index{main@{main}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{main()}{main()}}
{\footnotesize\ttfamily def graph\+\_\+world2.\+train.\+main (\begin{DoxyParamCaption}\item[{}]{opt,  }\item[{}]{return\+\_\+full = {\ttfamily False},  }\item[{}]{out\+\_\+file = {\ttfamily None} }\end{DoxyParamCaption})}



Definition at line 265 of file train.\+py.


\begin{DoxyCode}
265 \textcolor{keyword}{def }\hyperlink{namespacegraph__world2_1_1train_af3dec887619817c1a7a38930ffcfd1cb}{main}(opt, return\_full=False, out\_file=None):
266     data\_agent = \hyperlink{namespacegraph__world2_1_1train_ac238655ccbc748146d1cbaaac96433a5}{prepro}(opt)
267     model\_agent = (
268         ObjectChecklistModelAgent(opt, data\_agent=data\_agent)
269         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} opt[\textcolor{stringliteral}{'seq2seq'}]
270         \textcolor{keywordflow}{else} Seq2SeqModelAgent(opt, data\_agent=data\_agent)
271     )
272 
273     train\_world = \hyperlink{namespaceparlai_1_1core_1_1worlds_a79969c7ba76d4b3c500f5bb776444dc6}{create\_task}(opt, model\_agent)
274 
275     max\_dict = model\_agent.model.state\_dict()
276 
277     max\_acc, max\_f1, max\_data, last\_max, max\_acc\_len = -1, 0, \textcolor{keywordtype}{None}, 0, \textcolor{keywordtype}{None}
278     \textcolor{keywordflow}{for} iter \textcolor{keywordflow}{in} range(opt[\textcolor{stringliteral}{'max\_iter'}]):
279         \textcolor{keywordflow}{if} iter - last\_max > opt[\textcolor{stringliteral}{'exit\_iter'}]:
280             \textcolor{keywordflow}{break}
281 
282         \textcolor{keywordflow}{if} \textcolor{stringliteral}{'inc\_ratio'} \textcolor{keywordflow}{in} opt \textcolor{keywordflow}{and} opt[\textcolor{stringliteral}{'inc\_ratio'}] > 0 \textcolor{keywordflow}{and} iter == opt[\textcolor{stringliteral}{'inc\_pre\_iters'}]:
283             print(\textcolor{stringliteral}{'resetting best model for finetuning'})
284             model\_agent.model.load\_state\_dict(max\_dict)
285             max\_acc = 0
286 
287         train\_world.parley()
288         train\_report = train\_world.report()
289 
290         \textcolor{keywordflow}{if} iter % opt[\textcolor{stringliteral}{'eval\_period'}] == 0:
291             stats = \hyperlink{namespacegraph__world2_1_1train_aa00e41e1619128901ea053170fedef0b}{validate}(opt, model\_agent)
292             cur\_acc, cur\_f1 = stats[\textcolor{stringliteral}{'acc'}] / stats[\textcolor{stringliteral}{'cnt'}], stats[\textcolor{stringliteral}{'f1'}] / stats[\textcolor{stringliteral}{'cnt'}]
293             \textcolor{keywordflow}{if} cur\_acc > max\_acc:
294                 max\_acc = cur\_acc
295                 max\_data = (stats[\textcolor{stringliteral}{'correct\_data'}], stats[\textcolor{stringliteral}{'wrong\_data'}])
296                 max\_dict = deepcopy(model\_agent.model)
297                 last\_max = iter
298                 max\_acc\_len = []
299                 \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(1, 5):
300                     max\_acc\_len.append(stats[\textcolor{stringliteral}{'acc\_len'}][i] / stats[\textcolor{stringliteral}{'cnt\_len'}][i])
301             max\_f1 = max(max\_f1, cur\_f1)
302             s = \textcolor{stringliteral}{'#\{\} train \{:.4f\} valid \{:.4f\} acc \{:.4f\} f1 \{:.4f\} max\_acc \{:.4f\} max\_f1 \{:.4f\} acc\_len'}.
      \hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
303                 iter,
304                 train\_report[\textcolor{stringliteral}{'loss'}],
305                 stats[\textcolor{stringliteral}{'loss'}] / stats[\textcolor{stringliteral}{'cnt'}],
306                 cur\_acc,
307                 cur\_f1,
308                 max\_acc,
309                 max\_f1,
310             )
311             \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(1, 5):
312                 s += \textcolor{stringliteral}{' \{:.4f\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(stats[\textcolor{stringliteral}{'acc\_len'}][i] / stats[\textcolor{stringliteral}{'cnt\_len'}][i])
313             s += \textcolor{stringliteral}{' cnt\_len'}
314             \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(1, 5):
315                 s += \textcolor{stringliteral}{' \{:d\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(\hyperlink{namespacegraph__world2_1_1train_ae777b30e4de8f0cdfc26bfda0c01b316}{int}(stats[\textcolor{stringliteral}{'cnt\_len'}][i]))
316             \hyperlink{namespacegraph__world2_1_1train_a145007eac2c8c1c128ec06f4477c943e}{log\_print}(s, out\_file)
317 
318     wrong\_data = max\_data[1]
319 
320     \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} return\_full:
321         \textcolor{keywordflow}{return} max\_acc
322     \textcolor{keywordflow}{else}:
323         \textcolor{keywordflow}{return} max\_acc, max\_dict, model\_agent.data\_agent, wrong\_data, max\_acc\_len
324 
325 
\end{DoxyCode}
\mbox{\Hypertarget{namespacegraph__world2_1_1train_a8f5e91b9cb92f65b8b096d7eb5dbf2e7}\label{namespacegraph__world2_1_1train_a8f5e91b9cb92f65b8b096d7eb5dbf2e7}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!online\+\_\+exp@{online\+\_\+exp}}
\index{online\+\_\+exp@{online\+\_\+exp}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{online\+\_\+exp()}{online\_exp()}}
{\footnotesize\ttfamily def graph\+\_\+world2.\+train.\+online\+\_\+exp (\begin{DoxyParamCaption}\item[{}]{opt,  }\item[{}]{log\+\_\+file = {\ttfamily None} }\end{DoxyParamCaption})}



Definition at line 326 of file train.\+py.


\begin{DoxyCode}
326 \textcolor{keyword}{def }\hyperlink{namespacegraph__world2_1_1train_a8f5e91b9cb92f65b8b096d7eb5dbf2e7}{online\_exp}(opt, log\_file=None):
327     model\_dict, data\_agent, wrong\_data, max\_acc\_len = \textcolor{keywordtype}{None}, \textcolor{keywordtype}{None}, \textcolor{keywordtype}{None}, \textcolor{keywordtype}{None}
328     max\_accs = []
329     record = -1.0
330     \textcolor{keywordflow}{for} \_ \textcolor{keywordflow}{in} range(opt[\textcolor{stringliteral}{'num\_runs'}]):
331         max\_acc, cur\_model\_dict, cur\_data\_agent, cur\_wrong\_data, cur\_max\_acc\_len = 
      \hyperlink{namespacegraph__world2_1_1train_af3dec887619817c1a7a38930ffcfd1cb}{main}(
332             opt, \textcolor{keyword}{True}, log\_file
333         )
334         max\_accs.append(max\_acc)
335         \textcolor{keywordflow}{if} max\_acc > record:
336             record = max\_acc
337             model\_dict, data\_agent, wrong\_data = (
338                 cur\_model\_dict,
339                 cur\_data\_agent,
340                 cur\_wrong\_data,
341             )
342         \textcolor{keywordflow}{if} max\_acc\_len \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
343             max\_acc\_len = cur\_max\_acc\_len
344         \textcolor{keywordflow}{else}:
345             \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(len(max\_acc\_len)):
346                 max\_acc\_len[i] += cur\_max\_acc\_len[i]
347     \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(len(max\_acc\_len)):
348         max\_acc\_len[i] /= opt[\textcolor{stringliteral}{'num\_runs'}]
349 
350     \textcolor{keywordflow}{if} opt[\textcolor{stringliteral}{'perf\_out\_file'}] != \textcolor{stringliteral}{''}:
351         fout = open(opt[\textcolor{stringliteral}{'perf\_out\_file'}], \textcolor{stringliteral}{'w'})
352         fout.write(\textcolor{stringliteral}{'\{\}\(\backslash\)n'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(statistics.mean(max\_accs)))
353         fout.close()
354         fout = open(opt[\textcolor{stringliteral}{'perf\_out\_file'}] + \textcolor{stringliteral}{'.len'}, \textcolor{stringliteral}{'w'})
355         fout.write(\textcolor{stringliteral}{'\{\}\(\backslash\)n'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(\textcolor{stringliteral}{' '}.join(list(map(str, max\_acc\_len)))))
356         fout.close()
357     \textcolor{keywordflow}{if} opt[\textcolor{stringliteral}{'model\_file'}] != \textcolor{stringliteral}{''}:
358         pickle.dump(model\_dict, open(opt[\textcolor{stringliteral}{'model\_file'}], \textcolor{stringliteral}{'wb'}))
359     \textcolor{keywordflow}{if} opt[\textcolor{stringliteral}{'data\_agent\_file'}] != \textcolor{stringliteral}{''}:
360         pickle.dump(data\_agent, open(opt[\textcolor{stringliteral}{'data\_agent\_file'}], \textcolor{stringliteral}{'wb'}))
361     \textcolor{keywordflow}{if} opt[\textcolor{stringliteral}{'wrong\_data\_file'}] != \textcolor{stringliteral}{''}:
362         pickle.dump(wrong\_data, open(opt[\textcolor{stringliteral}{'wrong\_data\_file'}], \textcolor{stringliteral}{'wb'}))
363 
364 
\end{DoxyCode}
\mbox{\Hypertarget{namespacegraph__world2_1_1train_ac238655ccbc748146d1cbaaac96433a5}\label{namespacegraph__world2_1_1train_ac238655ccbc748146d1cbaaac96433a5}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!prepro@{prepro}}
\index{prepro@{prepro}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{prepro()}{prepro()}}
{\footnotesize\ttfamily def graph\+\_\+world2.\+train.\+prepro (\begin{DoxyParamCaption}\item[{}]{opt }\end{DoxyParamCaption})}



Definition at line 36 of file train.\+py.


\begin{DoxyCode}
36 \textcolor{keyword}{def }\hyperlink{namespacegraph__world2_1_1train_ac238655ccbc748146d1cbaaac96433a5}{prepro}(opt):
37     agent = (
38         ObjectChecklistDataAgent(opt) \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} opt[\textcolor{stringliteral}{'seq2seq'}] \textcolor{keywordflow}{else} Seq2SeqDataAgent(opt)
39     )
40 
41     opt = deepcopy(opt)
42     opt[\textcolor{stringliteral}{'datatype'}] = \textcolor{stringliteral}{'train'}
43     opt[\textcolor{stringliteral}{'terminate'}] = \textcolor{keyword}{True}
44     opt[\textcolor{stringliteral}{'batchsize'}] = 1
45     world = \hyperlink{namespaceparlai_1_1core_1_1worlds_a79969c7ba76d4b3c500f5bb776444dc6}{create\_task}(opt, agent)
46 
47     \textcolor{keywordflow}{for} \_ \textcolor{keywordflow}{in} world:
48         world.parley()
49 
50     agent.build()
51     \textcolor{keywordflow}{return} agent
52 
53 
\end{DoxyCode}
\mbox{\Hypertarget{namespacegraph__world2_1_1train_aa00e41e1619128901ea053170fedef0b}\label{namespacegraph__world2_1_1train_aa00e41e1619128901ea053170fedef0b}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!validate@{validate}}
\index{validate@{validate}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{validate()}{validate()}}
{\footnotesize\ttfamily def graph\+\_\+world2.\+train.\+validate (\begin{DoxyParamCaption}\item[{}]{opt,  }\item[{}]{agent }\end{DoxyParamCaption})}



Definition at line 54 of file train.\+py.


\begin{DoxyCode}
54 \textcolor{keyword}{def }\hyperlink{namespacegraph__world2_1_1train_aa00e41e1619128901ea053170fedef0b}{validate}(opt, agent):
55     old\_datatype = agent.opt[\textcolor{stringliteral}{'datatype'}]
56     agent.opt[\textcolor{stringliteral}{'datatype'}] = \textcolor{stringliteral}{'valid'}
57 
58     opt = deepcopy(opt)
59     opt[\textcolor{stringliteral}{'datatype'}] = \textcolor{stringliteral}{'valid'}
60     opt[\textcolor{stringliteral}{'terminate'}] = \textcolor{keyword}{True}
61     opt[\textcolor{stringliteral}{'batchsize'}] = 1
62 
63     old\_stdout = sys.stdout
64     sys.stdout = open(os.devnull, \textcolor{stringliteral}{'w'})
65     valid\_world = \hyperlink{namespaceparlai_1_1core_1_1worlds_a79969c7ba76d4b3c500f5bb776444dc6}{create\_task}(opt, agent)
66     sys.stdout = old\_stdout
67 
68     \textcolor{keywordflow}{for} \_ \textcolor{keywordflow}{in} valid\_world:
69         valid\_world.parley()
70 
71     stats = valid\_world.report()
72     agent.opt[\textcolor{stringliteral}{'datatype'}] = old\_datatype
73     \textcolor{keywordflow}{return} stats
74 
75 
\end{DoxyCode}


\subsection{Variable Documentation}
\mbox{\Hypertarget{namespacegraph__world2_1_1train_a28914dc685301ea70d35554dc0293486}\label{namespacegraph__world2_1_1train_a28914dc685301ea70d35554dc0293486}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!argparser@{argparser}}
\index{argparser@{argparser}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{argparser}{argparser}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+argparser}



Definition at line 383 of file train.\+py.

\mbox{\Hypertarget{namespacegraph__world2_1_1train_adcfd197260a746eeb73a295520831582}\label{namespacegraph__world2_1_1train_adcfd197260a746eeb73a295520831582}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!bool@{bool}}
\index{bool@{bool}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{bool}{bool}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+bool}



Definition at line 385 of file train.\+py.

\mbox{\Hypertarget{namespacegraph__world2_1_1train_aa15c4b5001beb863ac4144ec68b832a9}\label{namespacegraph__world2_1_1train_aa15c4b5001beb863ac4144ec68b832a9}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!default@{default}}
\index{default@{default}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{default}{default}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+default}



Definition at line 384 of file train.\+py.

\mbox{\Hypertarget{namespacegraph__world2_1_1train_a9843eaa25215aba91f3f4b223dbb2049}\label{namespacegraph__world2_1_1train_a9843eaa25215aba91f3f4b223dbb2049}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!float@{float}}
\index{float@{float}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{float}{float}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+float}



Definition at line 386 of file train.\+py.

\mbox{\Hypertarget{namespacegraph__world2_1_1train_a098927108f0006868a4f333d6ce02443}\label{namespacegraph__world2_1_1train_a098927108f0006868a4f333d6ce02443}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!fout@{fout}}
\index{fout@{fout}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{fout}{fout}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+fout}



Definition at line 442 of file train.\+py.

\mbox{\Hypertarget{namespacegraph__world2_1_1train_a3881ea088d1a9bfa45c2a1e496b84fe4}\label{namespacegraph__world2_1_1train_a3881ea088d1a9bfa45c2a1e496b84fe4}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!input\+\_\+file@{input\+\_\+file}}
\index{input\+\_\+file@{input\+\_\+file}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{input\+\_\+file}{input\_file}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+input\+\_\+file}



Definition at line 426 of file train.\+py.

\mbox{\Hypertarget{namespacegraph__world2_1_1train_ae777b30e4de8f0cdfc26bfda0c01b316}\label{namespacegraph__world2_1_1train_ae777b30e4de8f0cdfc26bfda0c01b316}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!int@{int}}
\index{int@{int}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{int}{int}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+int}



Definition at line 384 of file train.\+py.

\mbox{\Hypertarget{namespacegraph__world2_1_1train_a0dbc2533a58165ecd79f668f2889cf3e}\label{namespacegraph__world2_1_1train_a0dbc2533a58165ecd79f668f2889cf3e}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!job\+\_\+in\+\_\+opt@{job\+\_\+in\+\_\+opt}}
\index{job\+\_\+in\+\_\+opt@{job\+\_\+in\+\_\+opt}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{job\+\_\+in\+\_\+opt}{job\_in\_opt}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+job\+\_\+in\+\_\+opt}



Definition at line 437 of file train.\+py.

\mbox{\Hypertarget{namespacegraph__world2_1_1train_af8a4335a70104bebca62cb53adba47f9}\label{namespacegraph__world2_1_1train_af8a4335a70104bebca62cb53adba47f9}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!job\+\_\+num@{job\+\_\+num}}
\index{job\+\_\+num@{job\+\_\+num}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{job\+\_\+num}{job\_num}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+job\+\_\+num}



Definition at line 425 of file train.\+py.

\mbox{\Hypertarget{namespacegraph__world2_1_1train_ab4fed977b76754e4f0d9b2593205e54b}\label{namespacegraph__world2_1_1train_ab4fed977b76754e4f0d9b2593205e54b}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!log\+\_\+file@{log\+\_\+file}}
\index{log\+\_\+file@{log\+\_\+file}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{log\+\_\+file}{log\_file}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+log\+\_\+file}



Definition at line 428 of file train.\+py.

\mbox{\Hypertarget{namespacegraph__world2_1_1train_a87df49e5955f1677c3d285abb83ad60d}\label{namespacegraph__world2_1_1train_a87df49e5955f1677c3d285abb83ad60d}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!new\+\_\+opt@{new\+\_\+opt}}
\index{new\+\_\+opt@{new\+\_\+opt}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{new\+\_\+opt}{new\_opt}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+new\+\_\+opt}



Definition at line 439 of file train.\+py.

\mbox{\Hypertarget{namespacegraph__world2_1_1train_a286634b8300deedee0924d4ecac34fa6}\label{namespacegraph__world2_1_1train_a286634b8300deedee0924d4ecac34fa6}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!opt@{opt}}
\index{opt@{opt}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{opt}{opt}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+opt}



Definition at line 414 of file train.\+py.

\mbox{\Hypertarget{namespacegraph__world2_1_1train_aaa28465c643e1e44899c580e3cb09469}\label{namespacegraph__world2_1_1train_aaa28465c643e1e44899c580e3cb09469}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!output\+\_\+file@{output\+\_\+file}}
\index{output\+\_\+file@{output\+\_\+file}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{output\+\_\+file}{output\_file}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+output\+\_\+file}



Definition at line 427 of file train.\+py.

\mbox{\Hypertarget{namespacegraph__world2_1_1train_ad6e658a468af9626e8b47490972d33a4}\label{namespacegraph__world2_1_1train_ad6e658a468af9626e8b47490972d33a4}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!str@{str}}
\index{str@{str}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{str}{str}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+str}



Definition at line 399 of file train.\+py.

\mbox{\Hypertarget{namespacegraph__world2_1_1train_a5483dc050b195034e046160fcc2155c5}\label{namespacegraph__world2_1_1train_a5483dc050b195034e046160fcc2155c5}} 
\index{graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}!type@{type}}
\index{type@{type}!graph\+\_\+world2\+::train@{graph\+\_\+world2\+::train}}
\subsubsection{\texorpdfstring{type}{type}}
{\footnotesize\ttfamily graph\+\_\+world2.\+train.\+type}



Definition at line 384 of file train.\+py.

