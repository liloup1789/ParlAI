\hypertarget{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker}{}\section{parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+modules\+\_\+v0.\+Ranker Class Reference}
\label{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker}\index{parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+modules\+\_\+v0.\+Ranker@{parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+modules\+\_\+v0.\+Ranker}}


Inheritance diagram for parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+modules\+\_\+v0.\+Ranker\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=211pt]{d3/d47/classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker__inherit__graph}
\end{center}
\end{figure}


Collaboration diagram for parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+modules\+\_\+v0.\+Ranker\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=211pt]{d4/d66/classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker__coll__graph}
\end{center}
\end{figure}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a79693c86fc7bebea2b197e1c168ec002}{\+\_\+\+\_\+init\+\_\+\+\_\+} (self, \hyperlink{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a5500f3bd094b3a3b19c992cbc1d42918}{decoder}, padding\+\_\+idx=0, \hyperlink{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a17f285352bdb89eea215c874a38bee02}{attn\+\_\+type}=\textquotesingle{}none\textquotesingle{})
\item 
def \hyperlink{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a48177b131d765ebd734d25f962c44f55}{forward} (self, cands, cand\+\_\+inds, decode\+\_\+params)
\end{DoxyCompactItemize}
\subsection*{Public Attributes}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a5500f3bd094b3a3b19c992cbc1d42918}{decoder}
\item 
\hyperlink{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a17d8139e8d7e9952f0f17e8884710744}{N\+U\+L\+L\+\_\+\+I\+DX}
\item 
\hyperlink{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a17f285352bdb89eea215c874a38bee02}{attn\+\_\+type}
\end{DoxyCompactItemize}


\subsection{Detailed Description}


Definition at line 554 of file modules\+\_\+v0.\+py.



\subsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a79693c86fc7bebea2b197e1c168ec002}\label{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a79693c86fc7bebea2b197e1c168ec002}} 
\index{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker}!\+\_\+\+\_\+init\+\_\+\+\_\+@{\+\_\+\+\_\+init\+\_\+\+\_\+}}
\index{\+\_\+\+\_\+init\+\_\+\+\_\+@{\+\_\+\+\_\+init\+\_\+\+\_\+}!parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker}}
\subsubsection{\texorpdfstring{\+\_\+\+\_\+init\+\_\+\+\_\+()}{\_\_init\_\_()}}
{\footnotesize\ttfamily def parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+modules\+\_\+v0.\+Ranker.\+\_\+\+\_\+init\+\_\+\+\_\+ (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{decoder,  }\item[{}]{padding\+\_\+idx = {\ttfamily 0},  }\item[{}]{attn\+\_\+type = {\ttfamily \textquotesingle{}none\textquotesingle{}} }\end{DoxyParamCaption})}



Definition at line 555 of file modules\+\_\+v0.\+py.


\begin{DoxyCode}
555     \textcolor{keyword}{def }\_\_init\_\_(self, decoder, padding\_idx=0, attn\_type='none'):
556         super().\_\_init\_\_()
557         self.decoder = decoder
558         self.NULL\_IDX = padding\_idx
559         self.attn\_type = attn\_type
560 
\end{DoxyCode}


\subsection{Member Function Documentation}
\mbox{\Hypertarget{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a48177b131d765ebd734d25f962c44f55}\label{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a48177b131d765ebd734d25f962c44f55}} 
\index{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker}!forward@{forward}}
\index{forward@{forward}!parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker}}
\subsubsection{\texorpdfstring{forward()}{forward()}}
{\footnotesize\ttfamily def parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+modules\+\_\+v0.\+Ranker.\+forward (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{cands,  }\item[{}]{cand\+\_\+inds,  }\item[{}]{decode\+\_\+params }\end{DoxyParamCaption})}



Definition at line 561 of file modules\+\_\+v0.\+py.


\begin{DoxyCode}
561     \textcolor{keyword}{def }forward(self, cands, cand\_inds, decode\_params):
562         start, hidden, enc\_out, attn\_mask = decode\_params
563 
564         hid, cell = (hidden, \textcolor{keywordtype}{None}) \textcolor{keywordflow}{if} isinstance(hidden, torch.Tensor) \textcolor{keywordflow}{else} hidden
565         \textcolor{keywordflow}{if} len(cand\_inds) != hid.size(1):
566             cand\_indices = start.detach().new(cand\_inds)
567             hid = hid.index\_select(1, cand\_indices)
568             \textcolor{keywordflow}{if} cell \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
569                 hidden = hid
570             \textcolor{keywordflow}{else}:
571                 cell = cell.index\_select(1, cand\_indices)
572                 hidden = (hid, cell)
573             enc\_out = enc\_out.index\_select(0, cand\_indices)
574             attn\_mask = attn\_mask.index\_select(0, cand\_indices)
575 
576         cand\_scores = []
577 
578         \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(len(cands)):
579             curr\_cs = cands[i]
580 
581             n\_cs = curr\_cs.size(0)
582             starts = start.expand(n\_cs).unsqueeze(1)
583             scores = 0
584             seqlens = 0
585             \textcolor{comment}{# select just the one hidden state}
586             \textcolor{keywordflow}{if} isinstance(hidden, torch.Tensor):
587                 nl = hidden.size(0)
588                 hsz = hidden.size(-1)
589                 cur\_hid = hidden.select(1, i).unsqueeze(1).expand(nl, n\_cs, hsz)
590             \textcolor{keywordflow}{else}:
591                 nl = hidden[0].size(0)
592                 hsz = hidden[0].size(-1)
593                 cur\_hid = (
594                     hidden[0]
595                     .select(1, i)
596                     .unsqueeze(1)
597                     .expand(nl, n\_cs, hsz)
598                     .contiguous(),
599                     hidden[1]
600                     .select(1, i)
601                     .unsqueeze(1)
602                     .expand(nl, n\_cs, hsz)
603                     .contiguous(),
604                 )
605 
606             cur\_enc, cur\_mask = \textcolor{keywordtype}{None}, \textcolor{keywordtype}{None}
607             \textcolor{keywordflow}{if} attn\_mask \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
608                 cur\_mask = attn\_mask[i].unsqueeze(0).expand(n\_cs, attn\_mask.size(-1))
609                 cur\_enc = enc\_out[i].unsqueeze(0).expand(n\_cs, enc\_out.size(1), hsz)
610             \textcolor{comment}{# this is pretty much copied from the training forward above}
611             \textcolor{keywordflow}{if} curr\_cs.size(1) > 1:
612                 c\_in = curr\_cs.narrow(1, 0, curr\_cs.size(1) - 1)
613                 xs = torch.cat([starts, c\_in], 1)
614             \textcolor{keywordflow}{else}:
615                 xs, c\_in = starts, curr\_cs
616             \textcolor{keywordflow}{if} self.attn\_type == \textcolor{stringliteral}{'none'}:
617                 preds, score, cur\_hid = self.decoder(xs, cur\_hid, cur\_enc, cur\_mask)
618                 true\_score = F.log\_softmax(score, dim=2).gather(2, curr\_cs.unsqueeze(2))
619                 nonzero = curr\_cs.ne(0).\hyperlink{namespaceprojects_1_1controllable__dialogue_1_1make__control__dataset_aa2b7207688c641dbc094ab44eca27113}{float}()
620                 scores = (true\_score.squeeze(2) * nonzero).sum(1)
621                 seqlens = nonzero.sum(1)
622             \textcolor{keywordflow}{else}:
623                 \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(curr\_cs.size(1)):
624                     xi = xs.select(1, i)
625                     ci = curr\_cs.select(1, i)
626                     preds, score, cur\_hid = self.decoder(xi, cur\_hid, cur\_enc, cur\_mask)
627                     true\_score = F.log\_softmax(score, dim=2).gather(
628                         2, ci.unsqueeze(1).unsqueeze(2)
629                     )
630                     nonzero = ci.ne(0).\hyperlink{namespaceprojects_1_1controllable__dialogue_1_1make__control__dataset_aa2b7207688c641dbc094ab44eca27113}{float}()
631                     scores += true\_score.squeeze(2).squeeze(1) * nonzero
632                     seqlens += nonzero
633 
634             scores /= seqlens  \textcolor{comment}{# **len\_penalty?}
635             cand\_scores.append(scores)
636 
637         max\_len = max(len(c) \textcolor{keywordflow}{for} c \textcolor{keywordflow}{in} cand\_scores)
638         cand\_scores = torch.cat([\hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_afab760d03d96d6a368953b7173ea189a}{pad}(c, max\_len).unsqueeze(0) \textcolor{keywordflow}{for} c \textcolor{keywordflow}{in} cand\_scores], 0)
639         preds = cand\_scores.sort(1, \textcolor{keyword}{True})[1]
640         \textcolor{keywordflow}{return} preds, cand\_scores
641 
642 
\end{DoxyCode}


\subsection{Member Data Documentation}
\mbox{\Hypertarget{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a17f285352bdb89eea215c874a38bee02}\label{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a17f285352bdb89eea215c874a38bee02}} 
\index{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker}!attn\+\_\+type@{attn\+\_\+type}}
\index{attn\+\_\+type@{attn\+\_\+type}!parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker}}
\subsubsection{\texorpdfstring{attn\+\_\+type}{attn\_type}}
{\footnotesize\ttfamily parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+modules\+\_\+v0.\+Ranker.\+attn\+\_\+type}



Definition at line 559 of file modules\+\_\+v0.\+py.

\mbox{\Hypertarget{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a5500f3bd094b3a3b19c992cbc1d42918}\label{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a5500f3bd094b3a3b19c992cbc1d42918}} 
\index{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker}!decoder@{decoder}}
\index{decoder@{decoder}!parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker}}
\subsubsection{\texorpdfstring{decoder}{decoder}}
{\footnotesize\ttfamily parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+modules\+\_\+v0.\+Ranker.\+decoder}



Definition at line 557 of file modules\+\_\+v0.\+py.

\mbox{\Hypertarget{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a17d8139e8d7e9952f0f17e8884710744}\label{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v0_1_1Ranker_a17d8139e8d7e9952f0f17e8884710744}} 
\index{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker}!N\+U\+L\+L\+\_\+\+I\+DX@{N\+U\+L\+L\+\_\+\+I\+DX}}
\index{N\+U\+L\+L\+\_\+\+I\+DX@{N\+U\+L\+L\+\_\+\+I\+DX}!parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::modules\+\_\+v0\+::\+Ranker}}
\subsubsection{\texorpdfstring{N\+U\+L\+L\+\_\+\+I\+DX}{NULL\_IDX}}
{\footnotesize\ttfamily parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+modules\+\_\+v0.\+Ranker.\+N\+U\+L\+L\+\_\+\+I\+DX}



Definition at line 558 of file modules\+\_\+v0.\+py.



The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
parlai/agents/legacy\+\_\+agents/seq2seq/\hyperlink{seq2seq_2modules__v0_8py}{modules\+\_\+v0.\+py}\end{DoxyCompactItemize}
