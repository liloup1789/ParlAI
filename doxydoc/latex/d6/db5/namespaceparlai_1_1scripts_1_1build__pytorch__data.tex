\hypertarget{namespaceparlai_1_1scripts_1_1build__pytorch__data}{}\section{parlai.\+scripts.\+build\+\_\+pytorch\+\_\+data Namespace Reference}
\label{namespaceparlai_1_1scripts_1_1build__pytorch__data}\index{parlai.\+scripts.\+build\+\_\+pytorch\+\_\+data@{parlai.\+scripts.\+build\+\_\+pytorch\+\_\+data}}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{namespaceparlai_1_1scripts_1_1build__pytorch__data_a6ec85a5842150af78f5178d75075b0cc}{get\+\_\+pyt\+\_\+dict\+\_\+file} (opt)
\item 
def \hyperlink{namespaceparlai_1_1scripts_1_1build__pytorch__data_afd88c85ffdbc233b56542e013352351a}{setup\+\_\+args} ()
\item 
def \hyperlink{namespaceparlai_1_1scripts_1_1build__pytorch__data_a1c8f4633b7dc8e990a3e1f6c3e92bd3f}{make\+\_\+serializable} (obj)
\item 
def \hyperlink{namespaceparlai_1_1scripts_1_1build__pytorch__data_a50d93b1dec37499085b9eafc6e425a1a}{build\+\_\+data} (opt)
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\mbox{\Hypertarget{namespaceparlai_1_1scripts_1_1build__pytorch__data_a50d93b1dec37499085b9eafc6e425a1a}\label{namespaceparlai_1_1scripts_1_1build__pytorch__data_a50d93b1dec37499085b9eafc6e425a1a}} 
\index{parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data@{parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data}!build\+\_\+data@{build\+\_\+data}}
\index{build\+\_\+data@{build\+\_\+data}!parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data@{parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data}}
\subsubsection{\texorpdfstring{build\+\_\+data()}{build\_data()}}
{\footnotesize\ttfamily def parlai.\+scripts.\+build\+\_\+pytorch\+\_\+data.\+build\+\_\+data (\begin{DoxyParamCaption}\item[{}]{opt }\end{DoxyParamCaption})}



Definition at line 70 of file build\+\_\+pytorch\+\_\+data.\+py.


\begin{DoxyCode}
70 \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1scripts_1_1build__pytorch__data_a50d93b1dec37499085b9eafc6e425a1a}{build\_data}(opt):
71     \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} opt.get(\textcolor{stringliteral}{'model'}, \textcolor{keyword}{False}):
72         opt[\textcolor{stringliteral}{'model'}] = \textcolor{stringliteral}{'repeat\_label'}
73     preprocess = opt.get(\textcolor{stringliteral}{'pytorch\_preprocess'}, \textcolor{keyword}{True})
74     opt[\textcolor{stringliteral}{'dict\_file'}] = \hyperlink{namespaceparlai_1_1scripts_1_1build__pytorch__data_a6ec85a5842150af78f5178d75075b0cc}{get\_pyt\_dict\_file}(opt)
75     dictionary = \textcolor{keywordtype}{None}
76     \textcolor{keywordflow}{if} \textcolor{stringliteral}{'dict\_maxexs'} \textcolor{keywordflow}{in} opt:
77         \textcolor{comment}{# Note: only build dictionary if dict loop args specified}
78         dictionary = \hyperlink{namespacebuild__dict}{build\_dict}(opt, skip\_if\_built=\textcolor{keyword}{True})
79     agent = \hyperlink{namespaceparlai_1_1core_1_1agents_ad0d54074d4bcc148bb415ab5515a53b5}{create\_agent}(opt)
80     \textcolor{comment}{# If build teacher not specified, we are simply looking for the file}
81     \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} opt.get(\textcolor{stringliteral}{'pytorch\_teacher\_task'}, \textcolor{keywordtype}{None}):
82         df = opt.get(\textcolor{stringliteral}{'pytorch\_datapath'})
83         \textcolor{comment}{# check if the user set a datafile}
84         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} df:
85             \textcolor{keywordflow}{raise} Exception(\textcolor{stringliteral}{'Tried to find data but `--pytorch-datapath` is not set'})
86         \textcolor{comment}{# check if the user provided the already built file}
87         \textcolor{keywordflow}{if} \textcolor{stringliteral}{'pytorch'} \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} df:
88             df += \textcolor{stringliteral}{'.pytorch'} + (
89                 agent.getID() \textcolor{keywordflow}{if} opt.get(\textcolor{stringliteral}{'pytorch\_preprocess'}, \textcolor{keyword}{True}) \textcolor{keywordflow}{else} \textcolor{stringliteral}{''}
90             )
91         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} os.path.isfile(df):
92             \textcolor{keywordflow}{raise} Exception(
93                 \textcolor{stringliteral}{'Tried to find data but it is not built, please'}
94                 \textcolor{stringliteral}{'specify `--pytorch-teacher-task`'}
95             )
96         \textcolor{keywordflow}{else}:
97             \textcolor{keywordflow}{return} df
98 
99     ordered\_opt = copy.deepcopy(opt)
100     \textcolor{comment}{# we use streaming to build the data}
101     dt = opt[\textcolor{stringliteral}{'datatype'}].split(\textcolor{stringliteral}{':'})[0]
102     ordered\_opt[\textcolor{stringliteral}{'datatype'}] = dt + \textcolor{stringliteral}{':ordered:stream'}
103     ordered\_opt[\textcolor{stringliteral}{'numthreads'}] = 1
104     ordered\_opt[\textcolor{stringliteral}{'batchsize'}] = 1
105     ordered\_opt[\textcolor{stringliteral}{'task'}] = ordered\_opt[\textcolor{stringliteral}{'pytorch\_teacher\_task'}]
106     ordered\_opt.pop(\textcolor{stringliteral}{'pytorch\_teacher\_dataset'})
107     ordered\_opt[\textcolor{stringliteral}{'no\_cuda'}] = \textcolor{keyword}{True}
108     world\_data = \hyperlink{namespaceparlai_1_1core_1_1worlds_a11923c10b545c7ecc1b08fe2242d9c2c}{create\_task}(ordered\_opt, agent)
109     teacher = world\_data.get\_task\_agent()
110     agent = world\_data.agents[1]
111     datapath = os.path.join(
112         opt.get(\textcolor{stringliteral}{'datapath'}, \textcolor{stringliteral}{'.'}),
113         \textcolor{stringliteral}{'\{\}\_pyt\_data'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(ordered\_opt[\textcolor{stringliteral}{'task'}].replace(\textcolor{stringliteral}{':'}, \textcolor{stringliteral}{'\_'})),
114         dt,
115     )
116     \textcolor{keywordflow}{if} preprocess:
117         datapath += \textcolor{stringliteral}{'\_\{\}\_preprocess'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(agent.getID().replace(\textcolor{stringliteral}{':'}, \textcolor{stringliteral}{'\_'}))
118     \textcolor{keywordflow}{if} os.path.isdir(datapath) \textcolor{keywordflow}{and} \textcolor{stringliteral}{'data\_length'} \textcolor{keywordflow}{in} os.listdir(datapath):
119         \textcolor{comment}{# Data already built}
120         print(\textcolor{stringliteral}{"[ pytorch data already built, at \{\}. ]"}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(datapath))
121         \textcolor{keywordflow}{return} datapath
122     print(
123         \textcolor{stringliteral}{'----------\(\backslash\)n[ setting up pytorch data, saving to \{\}/ ]\(\backslash\)n----------'}.
      \hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
124             datapath
125         )
126     )
127     os.makedirs(datapath, exist\_ok=\textcolor{keyword}{True})
128     num\_eps = 0
129     num\_exs = 0
130     current = []
131     episode\_done = \textcolor{keyword}{False}
132     include\_labels = opt.get(\textcolor{stringliteral}{'pytorch\_include\_labels'}, \textcolor{keyword}{True})
133     context\_length = opt.get(\textcolor{stringliteral}{'pytorch\_context\_length'}, -1)
134     context = deque(maxlen=context\_length \textcolor{keywordflow}{if} context\_length > 0 \textcolor{keywordflow}{else} \textcolor{keywordtype}{None})
135     total\_exs = world\_data.num\_examples()
136     pbar = tqdm.tqdm(
137         total=total\_exs, unit=\textcolor{stringliteral}{'ex'}, unit\_scale=\textcolor{keyword}{True}, desc=\textcolor{stringliteral}{'Building pytorch data'}
138     )
139     idx\_to\_char = []
140     cumulative\_char\_len = 0
141     \textcolor{comment}{# pass examples to dictionary}
142     with open(os.path.join(datapath, \textcolor{stringliteral}{'data'}), \textcolor{stringliteral}{'w'}) \textcolor{keyword}{as} pytorch\_data:
143         \textcolor{keywordflow}{while} num\_exs < total\_exs:
144             \textcolor{keywordflow}{while} \textcolor{keywordflow}{not} episode\_done:
145                 \textcolor{comment}{# TODO: eventually all teachers should return Messages, so}
146                 \textcolor{comment}{# we should assert this}
147                 action = Message(teacher.act())
148                 current.append(action)
149                 episode\_done = action.get(\textcolor{stringliteral}{'episode\_done'}, \textcolor{keyword}{False})
150 
151             \textcolor{comment}{# build separate episodes}
152             \textcolor{keywordflow}{for} ex \textcolor{keywordflow}{in} current:
153                 context.append(ex.get(\textcolor{stringliteral}{'text'}, \textcolor{stringliteral}{''}))
154                 \textcolor{keywordflow}{if} len(context) > 1:
155                     ex.force\_set(\textcolor{stringliteral}{'text'}, \textcolor{stringliteral}{'\(\backslash\)n'}.join(context))
156                 ex.force\_set(\textcolor{stringliteral}{'episode\_done'}, \textcolor{keyword}{True})
157                 labels = ex.get(\textcolor{stringliteral}{'labels'}, ex.get(\textcolor{stringliteral}{'eval\_labels'}, \textcolor{keywordtype}{None}))
158                 \textcolor{keywordflow}{if} labels \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None} \textcolor{keywordflow}{and} include\_labels:
159                     context.append(random.choice(labels))
160                 \textcolor{comment}{# generate observation from new example}
161                 \textcolor{keywordflow}{if} preprocess:
162                     ex = agent.observe(ex)
163                     ex.pop(\textcolor{stringliteral}{'label\_candidates'}, \textcolor{stringliteral}{''})
164                     ex[\textcolor{stringliteral}{'preprocessed'}] = \textcolor{keyword}{True}
165                 num\_eps += 1
166                 num\_exs += 1
167                 pbar.update(1)
168                 ex\_len = pytorch\_data.write(json.dumps(\hyperlink{namespaceparlai_1_1scripts_1_1build__pytorch__data_a1c8f4633b7dc8e990a3e1f6c3e92bd3f}{make\_serializable}(ex)) + \textcolor{stringliteral}{"\(\backslash\)n"})
169                 idx\_to\_char.append(cumulative\_char\_len)
170                 cumulative\_char\_len += ex\_len
171             \textcolor{comment}{# reset}
172             episode\_done = \textcolor{keyword}{False}
173             current.clear()
174             context.clear()
175     pbar.close()
176     with open(os.path.join(datapath, \textcolor{stringliteral}{'char\_index'}), \textcolor{stringliteral}{'w'}) \textcolor{keyword}{as} char\_index:
177         json.dump(idx\_to\_char, char\_index)
178     with open(os.path.join(datapath, \textcolor{stringliteral}{'data\_length'}), \textcolor{stringliteral}{'w'}) \textcolor{keyword}{as} pytorch\_data\_len:
179         pytorch\_data\_len.write(json.dumps(\{\textcolor{stringliteral}{'num\_eps'}: num\_eps, \textcolor{stringliteral}{'num\_exs'}: num\_exs\}))
180     \textcolor{keywordflow}{if} dictionary:
181         dictionary.save(\hyperlink{namespaceparlai_1_1scripts_1_1build__pytorch__data_a6ec85a5842150af78f5178d75075b0cc}{get\_pyt\_dict\_file}(opt), sort=\textcolor{keyword}{True})
182 
183     print(\textcolor{stringliteral}{'[ pytorch data built. ]'})
184     \textcolor{keywordflow}{return} datapath
185 
186 
\end{DoxyCode}
\mbox{\Hypertarget{namespaceparlai_1_1scripts_1_1build__pytorch__data_a6ec85a5842150af78f5178d75075b0cc}\label{namespaceparlai_1_1scripts_1_1build__pytorch__data_a6ec85a5842150af78f5178d75075b0cc}} 
\index{parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data@{parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data}!get\+\_\+pyt\+\_\+dict\+\_\+file@{get\+\_\+pyt\+\_\+dict\+\_\+file}}
\index{get\+\_\+pyt\+\_\+dict\+\_\+file@{get\+\_\+pyt\+\_\+dict\+\_\+file}!parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data@{parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data}}
\subsubsection{\texorpdfstring{get\+\_\+pyt\+\_\+dict\+\_\+file()}{get\_pyt\_dict\_file()}}
{\footnotesize\ttfamily def parlai.\+scripts.\+build\+\_\+pytorch\+\_\+data.\+get\+\_\+pyt\+\_\+dict\+\_\+file (\begin{DoxyParamCaption}\item[{}]{opt }\end{DoxyParamCaption})}



Definition at line 29 of file build\+\_\+pytorch\+\_\+data.\+py.


\begin{DoxyCode}
29 \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1scripts_1_1build__pytorch__data_a6ec85a5842150af78f5178d75075b0cc}{get\_pyt\_dict\_file}(opt):
30     \textcolor{keywordflow}{if} opt.get(\textcolor{stringliteral}{'dict\_file'}) \textcolor{keywordflow}{and} os.path.exists(opt.get(\textcolor{stringliteral}{'dict\_file'})):
31         \textcolor{keywordflow}{return} opt[\textcolor{stringliteral}{'dict\_file'}]
32     \textcolor{keywordflow}{if} opt.get(\textcolor{stringliteral}{'dict\_file'}) \textcolor{keywordflow}{is} \textcolor{keywordtype}{None} \textcolor{keywordflow}{and} opt.get(\textcolor{stringliteral}{'model\_file'}):
33         \textcolor{keywordflow}{return} opt[\textcolor{stringliteral}{'model\_file'}] + \textcolor{stringliteral}{'.dict'}
34     \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} opt[\textcolor{stringliteral}{'pytorch\_teacher\_task'}]:
35         opt[\textcolor{stringliteral}{'pytorch\_teacher\_task'}] = opt[\textcolor{stringliteral}{'task'}]
36     \textcolor{keywordflow}{return} os.path.join(
37         opt.get(\textcolor{stringliteral}{'datapath'}, \textcolor{stringliteral}{'.'}),
38         \textcolor{stringliteral}{'\{\}\_pyt\_data'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(opt[\textcolor{stringliteral}{'pytorch\_teacher\_task'}].replace(\textcolor{stringliteral}{':'}, \textcolor{stringliteral}{'\_'})),
39         opt[\textcolor{stringliteral}{'datatype'}].split(\textcolor{stringliteral}{':'})[0],
40         \textcolor{stringliteral}{'dict'},
41     )
42 
43 
\end{DoxyCode}
\mbox{\Hypertarget{namespaceparlai_1_1scripts_1_1build__pytorch__data_a1c8f4633b7dc8e990a3e1f6c3e92bd3f}\label{namespaceparlai_1_1scripts_1_1build__pytorch__data_a1c8f4633b7dc8e990a3e1f6c3e92bd3f}} 
\index{parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data@{parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data}!make\+\_\+serializable@{make\+\_\+serializable}}
\index{make\+\_\+serializable@{make\+\_\+serializable}!parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data@{parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data}}
\subsubsection{\texorpdfstring{make\+\_\+serializable()}{make\_serializable()}}
{\footnotesize\ttfamily def parlai.\+scripts.\+build\+\_\+pytorch\+\_\+data.\+make\+\_\+serializable (\begin{DoxyParamCaption}\item[{}]{obj }\end{DoxyParamCaption})}



Definition at line 52 of file build\+\_\+pytorch\+\_\+data.\+py.


\begin{DoxyCode}
52 \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1scripts_1_1build__pytorch__data_a1c8f4633b7dc8e990a3e1f6c3e92bd3f}{make\_serializable}(obj):
53     new\_obj = \{\}
54     \textcolor{keywordflow}{for} key, val \textcolor{keywordflow}{in} obj.items():
55         \textcolor{keywordflow}{if} isinstance(val, (int, str, bytes, dict, list, tuple, bool)):
56             new\_obj[key] = val
57         \textcolor{keywordflow}{elif} isinstance(val, collections.Mapping):
58             new\_obj[key] = dict(val)
59         \textcolor{keywordflow}{elif} isinstance(val, collections.Sequence):
60             new\_obj[key] = list(val)
61         \textcolor{keywordflow}{elif} torch.is\_tensor(val):
62             new\_obj[key] = \{
63                 \textcolor{stringliteral}{'value'}: val.tolist(),
64                 \textcolor{stringliteral}{'deserialized\_tensor'}: \textcolor{keyword}{True},
65                 \textcolor{stringliteral}{'type'}: \hyperlink{namespacegenerate__task__READMEs_a5b88452ffb87b78c8c85ececebafc09f}{str}(val.dtype),
66             \}
67     \textcolor{keywordflow}{return} new\_obj
68 
69 
\end{DoxyCode}
\mbox{\Hypertarget{namespaceparlai_1_1scripts_1_1build__pytorch__data_afd88c85ffdbc233b56542e013352351a}\label{namespaceparlai_1_1scripts_1_1build__pytorch__data_afd88c85ffdbc233b56542e013352351a}} 
\index{parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data@{parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data}!setup\+\_\+args@{setup\+\_\+args}}
\index{setup\+\_\+args@{setup\+\_\+args}!parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data@{parlai\+::scripts\+::build\+\_\+pytorch\+\_\+data}}
\subsubsection{\texorpdfstring{setup\+\_\+args()}{setup\_args()}}
{\footnotesize\ttfamily def parlai.\+scripts.\+build\+\_\+pytorch\+\_\+data.\+setup\+\_\+args (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Definition at line 44 of file build\+\_\+pytorch\+\_\+data.\+py.


\begin{DoxyCode}
44 \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1scripts_1_1build__pytorch__data_afd88c85ffdbc233b56542e013352351a}{setup\_args}():
45     \textcolor{keyword}{from} \hyperlink{namespaceparlai_1_1core_1_1params}{parlai.core.params} \textcolor{keyword}{import} ParlaiParser
46 
47     parser = ParlaiParser(\textcolor{keyword}{True}, \textcolor{keyword}{True}, \textcolor{stringliteral}{'Builds a pytorch data file.'})
48     parser.add\_pytorch\_datateacher\_args()
49     \textcolor{keywordflow}{return} dict\_setup(parser)
50 
51 
\end{DoxyCode}
