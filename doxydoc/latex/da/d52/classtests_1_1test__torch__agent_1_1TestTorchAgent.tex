\hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent}{}\section{tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent Class Reference}
\label{classtests_1_1test__torch__agent_1_1TestTorchAgent}\index{tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent@{tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent}}


Inheritance diagram for tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=217pt]{d0/d8e/classtests_1_1test__torch__agent_1_1TestTorchAgent__inherit__graph}
\end{center}
\end{figure}


Collaboration diagram for tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=217pt]{d2/d73/classtests_1_1test__torch__agent_1_1TestTorchAgent__coll__graph}
\end{center}
\end{figure}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_a0a7c1df7d947bdc260afa6dad21d78b9}{test\+\_\+mock} (self)
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_af3d1c7681a30a06684117464ccefb15d}{test\+\_\+share} (self)
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_a9bce672782a5d1408c104fd89d2d403f}{test\+\_\+\+\_\+vectorize\+\_\+text} (self)
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_ab5ef383cb36b970850bb3e171c832f36}{test\+\_\+\+\_\+check\+\_\+truncate} (self)
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_a551847086a9d8bf6bc04ea1efeacf608}{test\+\_\+vectorize} (self)
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_aad1075dad0c291b524d84ec9526177dd}{test\+\_\+batchify} (self)
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_abe59ca8c2f6927c0ba6f0e5ce7d3a4f2}{test\+\_\+match\+\_\+batch} (self)
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_a81c474c311d1825377b107d40d567d8a}{test\+\_\+\+\_\+add\+\_\+person\+\_\+tokens} (self)
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_a3c5504828399a2bb0d776baf1a744f71}{test\+\_\+history} (self)
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_ae3b6e4145176ba5d5e9179756d064332}{test\+\_\+observe} (self)
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_aed82743e884c933453d912cfa8c7ec7f}{test\+\_\+batch\+\_\+act} (self)
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_aadf263b222e27bfd83d568148683a8e0}{test\+\_\+interactive\+\_\+mode} (self)
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_a10ba6e3fdb49b540bc4663d9c7a30eab}{test\+\_\+use\+\_\+reply} (self)
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_a9954f92efc8cc7a9770f90f3a297d397}{test\+\_\+mturk\+\_\+racehistory} (self)
\item 
def \hyperlink{classtests_1_1test__torch__agent_1_1TestTorchAgent_a7135ee3421b1d0fc98f0202718910482}{test\+\_\+resume\+\_\+checkpoint} (self)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
\begin{DoxyVerb}Basic tests on the util functions in TorchAgent.
\end{DoxyVerb}
 

Definition at line 48 of file test\+\_\+torch\+\_\+agent.\+py.



\subsection{Member Function Documentation}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_a81c474c311d1825377b107d40d567d8a}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_a81c474c311d1825377b107d40d567d8a}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+\+\_\+add\+\_\+person\+\_\+tokens@{test\+\_\+\+\_\+add\+\_\+person\+\_\+tokens}}
\index{test\+\_\+\+\_\+add\+\_\+person\+\_\+tokens@{test\+\_\+\+\_\+add\+\_\+person\+\_\+tokens}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+\+\_\+add\+\_\+person\+\_\+tokens()}{test\_\_add\_person\_tokens()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+\+\_\+add\+\_\+person\+\_\+tokens (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Make sure person tokens are added to the write place in text.
\end{DoxyVerb}
 

Definition at line 594 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
594     \textcolor{keyword}{def }test\_\_add\_person\_tokens(self):
595         \textcolor{stringliteral}{"""}
596 \textcolor{stringliteral}{        Make sure person tokens are added to the write place in text.}
597 \textcolor{stringliteral}{        """}
598         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}()
599         text = (
600             \textcolor{stringliteral}{"I've seen things you people wouldn't believe.\(\backslash\)n"}
601             \textcolor{stringliteral}{"Attack ships on fire off the shoulder of Orion.\(\backslash\)n"}
602             \textcolor{stringliteral}{"I watched C-beams glitter in the dark near the Tannhauser gate.\(\backslash\)n"}
603             \textcolor{stringliteral}{"All those moments will be lost in time, like tears in rain."}
604         )
605         prefix = \textcolor{stringliteral}{'PRE'}
606         out = agent.history.\_add\_person\_tokens(text, prefix, add\_after\_newln=\textcolor{keyword}{False})
607         self.assertEqual(out, prefix + \textcolor{stringliteral}{' '} + text)
608         out = agent.history.\_add\_person\_tokens(text, prefix, add\_after\_newln=\textcolor{keyword}{True})
609         idx = text.rfind(\textcolor{stringliteral}{'\(\backslash\)n'}) + 1
610         self.assertEqual(out, text[:idx] + prefix + \textcolor{stringliteral}{' '} + text[idx:])
611 
\end{DoxyCode}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_ab5ef383cb36b970850bb3e171c832f36}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_ab5ef383cb36b970850bb3e171c832f36}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+\+\_\+check\+\_\+truncate@{test\+\_\+\+\_\+check\+\_\+truncate}}
\index{test\+\_\+\+\_\+check\+\_\+truncate@{test\+\_\+\+\_\+check\+\_\+truncate}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+\+\_\+check\+\_\+truncate()}{test\_\_check\_truncate()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+\+\_\+check\+\_\+truncate (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Make sure we are truncating when needed.
\end{DoxyVerb}
 

Definition at line 161 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
161     \textcolor{keyword}{def }test\_\_check\_truncate(self):
162         \textcolor{stringliteral}{"""}
163 \textcolor{stringliteral}{        Make sure we are truncating when needed.}
164 \textcolor{stringliteral}{        """}
165         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}()
166         inp = torch.LongTensor([1, 2, 3])
167         self.assertEqual(agent.\_check\_truncate(inp, \textcolor{keywordtype}{None}).tolist(), [1, 2, 3])
168         self.assertEqual(agent.\_check\_truncate(inp, 4).tolist(), [1, 2, 3])
169         self.assertEqual(agent.\_check\_truncate(inp, 3).tolist(), [1, 2, 3])
170         self.assertEqual(agent.\_check\_truncate(inp, 2).tolist(), [1, 2])
171         self.assertEqual(agent.\_check\_truncate(inp, 1).tolist(), [1])
172         self.assertEqual(agent.\_check\_truncate(inp, 0).tolist(), [])
173 
\end{DoxyCode}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_a9bce672782a5d1408c104fd89d2d403f}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_a9bce672782a5d1408c104fd89d2d403f}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+\+\_\+vectorize\+\_\+text@{test\+\_\+\+\_\+vectorize\+\_\+text}}
\index{test\+\_\+\+\_\+vectorize\+\_\+text@{test\+\_\+\+\_\+vectorize\+\_\+text}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+\+\_\+vectorize\+\_\+text()}{test\_\_vectorize\_text()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+\+\_\+vectorize\+\_\+text (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Test _vectorize_text and its different options.
\end{DoxyVerb}
 

Definition at line 68 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
68     \textcolor{keyword}{def }test\_\_vectorize\_text(self):
69         \textcolor{stringliteral}{"""}
70 \textcolor{stringliteral}{        Test \_vectorize\_text and its different options.}
71 \textcolor{stringliteral}{        """}
72         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}()
73         text = \textcolor{stringliteral}{"I'm sorry, Dave"}
74 
75         \textcolor{comment}{# test add\_start and add\_end}
76         vec = agent.\_vectorize\_text(text, add\_start=\textcolor{keyword}{False}, add\_end=\textcolor{keyword}{False})
77         self.assertEqual(len(vec), 3)
78         self.assertEqual(vec.tolist(), [1, 2, 3])
79         vec = agent.\_vectorize\_text(text, add\_start=\textcolor{keyword}{True}, add\_end=\textcolor{keyword}{False})
80         self.assertEqual(len(vec), 4)
81         self.assertEqual(vec.tolist(), [MockDict.BEG\_IDX, 1, 2, 3])
82         vec = agent.\_vectorize\_text(text, add\_start=\textcolor{keyword}{False}, add\_end=\textcolor{keyword}{True})
83         self.assertEqual(len(vec), 4)
84         self.assertEqual(vec.tolist(), [1, 2, 3, MockDict.END\_IDX])
85         vec = agent.\_vectorize\_text(text, add\_start=\textcolor{keyword}{True}, add\_end=\textcolor{keyword}{True})
86         self.assertEqual(len(vec), 5)
87         self.assertEqual(vec.tolist(), [MockDict.BEG\_IDX, 1, 2, 3, MockDict.END\_IDX])
88 
89         \textcolor{comment}{# now do it again with truncation=3}
90         vec = agent.\_vectorize\_text(text, add\_start=\textcolor{keyword}{False}, add\_end=\textcolor{keyword}{False}, truncate=3)
91         self.assertEqual(len(vec), 3)
92         self.assertEqual(vec.tolist(), [1, 2, 3])
93         vec = agent.\_vectorize\_text(text, add\_start=\textcolor{keyword}{True}, add\_end=\textcolor{keyword}{False}, truncate=3)
94         self.assertEqual(len(vec), 3)
95         self.assertEqual(vec.tolist(), [1, 2, 3])
96         vec = agent.\_vectorize\_text(text, add\_start=\textcolor{keyword}{False}, add\_end=\textcolor{keyword}{True}, truncate=3)
97         self.assertEqual(len(vec), 3)
98         self.assertEqual(vec.tolist(), [2, 3, MockDict.END\_IDX])
99         vec = agent.\_vectorize\_text(text, add\_start=\textcolor{keyword}{True}, add\_end=\textcolor{keyword}{True}, truncate=3)
100         self.assertEqual(len(vec), 3)
101         self.assertEqual(vec.tolist(), [2, 3, MockDict.END\_IDX])
102 
103         \textcolor{comment}{# now do it again with truncation=2}
104         vec = agent.\_vectorize\_text(text, add\_start=\textcolor{keyword}{False}, add\_end=\textcolor{keyword}{False}, truncate=2)
105         self.assertEqual(len(vec), 2)
106         self.assertEqual(vec.tolist(), [2, 3])
107         vec = agent.\_vectorize\_text(text, add\_start=\textcolor{keyword}{True}, add\_end=\textcolor{keyword}{False}, truncate=2)
108         self.assertEqual(len(vec), 2)
109         self.assertEqual(vec.tolist(), [2, 3])
110         vec = agent.\_vectorize\_text(text, add\_start=\textcolor{keyword}{False}, add\_end=\textcolor{keyword}{True}, truncate=2)
111         self.assertEqual(len(vec), 2)
112         self.assertEqual(vec.tolist(), [3, MockDict.END\_IDX])
113         vec = agent.\_vectorize\_text(text, add\_start=\textcolor{keyword}{True}, add\_end=\textcolor{keyword}{True}, truncate=2)
114         self.assertEqual(len(vec), 2)
115         self.assertEqual(vec.tolist(), [3, MockDict.END\_IDX])
116 
117         \textcolor{comment}{# now do it again with truncation=2, don't truncate\_left}
118         vec = agent.\_vectorize\_text(
119             text, add\_start=\textcolor{keyword}{False}, add\_end=\textcolor{keyword}{False}, truncate=2, truncate\_left=\textcolor{keyword}{False}
120         )
121         self.assertEqual(len(vec), 2)
122         self.assertEqual(vec.tolist(), [1, 2])
123         vec = agent.\_vectorize\_text(
124             text, add\_start=\textcolor{keyword}{True}, add\_end=\textcolor{keyword}{False}, truncate=2, truncate\_left=\textcolor{keyword}{False}
125         )
126         self.assertEqual(len(vec), 2)
127         self.assertEqual(vec.tolist(), [MockDict.BEG\_IDX, 1])
128         vec = agent.\_vectorize\_text(
129             text, add\_start=\textcolor{keyword}{False}, add\_end=\textcolor{keyword}{True}, truncate=2, truncate\_left=\textcolor{keyword}{False}
130         )
131         self.assertEqual(len(vec), 2)
132         self.assertEqual(vec.tolist(), [1, 2])
133         vec = agent.\_vectorize\_text(
134             text, add\_start=\textcolor{keyword}{True}, add\_end=\textcolor{keyword}{True}, truncate=2, truncate\_left=\textcolor{keyword}{False}
135         )
136         self.assertEqual(len(vec), 2)
137         self.assertEqual(vec.tolist(), [MockDict.BEG\_IDX, 1])
138 
139         \textcolor{comment}{# now do it again with truncation=3, don't truncate\_left}
140         vec = agent.\_vectorize\_text(
141             text, add\_start=\textcolor{keyword}{False}, add\_end=\textcolor{keyword}{False}, truncate=3, truncate\_left=\textcolor{keyword}{False}
142         )
143         self.assertEqual(len(vec), 3)
144         self.assertEqual(vec.tolist(), [1, 2, 3])
145         vec = agent.\_vectorize\_text(
146             text, add\_start=\textcolor{keyword}{True}, add\_end=\textcolor{keyword}{False}, truncate=3, truncate\_left=\textcolor{keyword}{False}
147         )
148         self.assertEqual(len(vec), 3)
149         self.assertEqual(vec.tolist(), [MockDict.BEG\_IDX, 1, 2])
150         vec = agent.\_vectorize\_text(
151             text, add\_start=\textcolor{keyword}{False}, add\_end=\textcolor{keyword}{True}, truncate=3, truncate\_left=\textcolor{keyword}{False}
152         )
153         self.assertEqual(len(vec), 3)
154         self.assertEqual(vec.tolist(), [1, 2, 3])
155         vec = agent.\_vectorize\_text(
156             text, add\_start=\textcolor{keyword}{True}, add\_end=\textcolor{keyword}{True}, truncate=3, truncate\_left=\textcolor{keyword}{False}
157         )
158         self.assertEqual(len(vec), 3)
159         self.assertEqual(vec.tolist(), [MockDict.BEG\_IDX, 1, 2])
160 
\end{DoxyCode}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_aed82743e884c933453d912cfa8c7ec7f}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_aed82743e884c933453d912cfa8c7ec7f}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+batch\+\_\+act@{test\+\_\+batch\+\_\+act}}
\index{test\+\_\+batch\+\_\+act@{test\+\_\+batch\+\_\+act}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+batch\+\_\+act()}{test\_batch\_act()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+batch\+\_\+act (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Make sure batch act calls the right step.
\end{DoxyVerb}
 

Definition at line 778 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
778     \textcolor{keyword}{def }test\_batch\_act(self):
779         \textcolor{stringliteral}{"""}
780 \textcolor{stringliteral}{        Make sure batch act calls the right step.}
781 \textcolor{stringliteral}{        """}
782         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}()
783 
784         obs\_labs = [
785             Message(
786                 \{
787                     \textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{"It's only a flesh wound."},
788                     \textcolor{stringliteral}{'labels'}: [\textcolor{stringliteral}{'Yield!'}],
789                     \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True},
790                 \}
791             ),
792             Message(
793                 \{
794                     \textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'The needs of the many outweigh...'},
795                     \textcolor{stringliteral}{'labels'}: [\textcolor{stringliteral}{'The needs of the few.'}],
796                     \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True},
797                 \}
798             ),
799             Message(
800                 \{
801                     \textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'Hello there.'},
802                     \textcolor{stringliteral}{'labels'}: [\textcolor{stringliteral}{'General Kenobi.'}],
803                     \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True},
804                 \}
805             ),
806         ]
807         obs\_labs\_vecs = []
808         \textcolor{keywordflow}{for} o \textcolor{keywordflow}{in} obs\_labs:
809             agent.history.reset()
810             agent.history.update\_history(o)
811             obs\_labs\_vecs.append(agent.vectorize(o, agent.history))
812         reply = agent.batch\_act(obs\_labs\_vecs)
813         \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(len(obs\_labs\_vecs)):
814             self.assertEqual(reply[i][\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{'Training \{\}!'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(i))
815 
816         obs\_elabs = [
817             Message(
818                 \{
819                     \textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{"It's only a flesh wound."},
820                     \textcolor{stringliteral}{'eval\_labels'}: [\textcolor{stringliteral}{'Yield!'}],
821                     \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True},
822                 \}
823             ),
824             Message(
825                 \{
826                     \textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'The needs of the many outweigh...'},
827                     \textcolor{stringliteral}{'eval\_labels'}: [\textcolor{stringliteral}{'The needs of the few.'}],
828                     \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True},
829                 \}
830             ),
831             Message(
832                 \{
833                     \textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'Hello there.'},
834                     \textcolor{stringliteral}{'eval\_labels'}: [\textcolor{stringliteral}{'General Kenobi.'}],
835                     \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True},
836                 \}
837             ),
838         ]
839         obs\_elabs\_vecs = []
840         \textcolor{keywordflow}{for} o \textcolor{keywordflow}{in} obs\_elabs:
841             agent.history.reset()
842             agent.history.update\_history(o)
843             obs\_elabs\_vecs.append(agent.vectorize(o, agent.history))
844         reply = agent.batch\_act(obs\_elabs\_vecs)
845         \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(len(obs\_elabs\_vecs)):
846             self.assertIn(\textcolor{stringliteral}{'Evaluating \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(i), reply[i][\textcolor{stringliteral}{'text'}])
847 
\end{DoxyCode}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_aad1075dad0c291b524d84ec9526177dd}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_aad1075dad0c291b524d84ec9526177dd}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+batchify@{test\+\_\+batchify}}
\index{test\+\_\+batchify@{test\+\_\+batchify}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+batchify()}{test\_batchify()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+batchify (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Make sure the batchify function sets up the right fields.
\end{DoxyVerb}
 

Definition at line 266 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
266     \textcolor{keyword}{def }test\_batchify(self):
267         \textcolor{stringliteral}{"""}
268 \textcolor{stringliteral}{        Make sure the batchify function sets up the right fields.}
269 \textcolor{stringliteral}{        """}
270         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(rank\_candidates=\textcolor{keyword}{True})
271         obs\_labs = [
272             Message(
273                 \{
274                     \textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'It\(\backslash\)'s only a flesh wound.'},
275                     \textcolor{stringliteral}{'labels'}: [\textcolor{stringliteral}{'Yield!'}],
276                     \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True},
277                 \}
278             ),
279             Message(
280                 \{
281                     \textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'The needs of the many outweigh...'},
282                     \textcolor{stringliteral}{'labels'}: [\textcolor{stringliteral}{'The needs of the few.'}],
283                     \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True},
284                 \}
285             ),
286             Message(
287                 \{
288                     \textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'Hello there.'},
289                     \textcolor{stringliteral}{'labels'}: [\textcolor{stringliteral}{'General Kenobi.'}],
290                     \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True},
291                 \}
292             ),
293         ]
294         obs\_elabs = [
295             Message(
296                 \{
297                     \textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'It\(\backslash\)'s only a flesh wound.'},
298                     \textcolor{stringliteral}{'eval\_labels'}: [\textcolor{stringliteral}{'Yield!'}],
299                     \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True},
300                 \}
301             ),
302             Message(
303                 \{
304                     \textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'The needs of the many outweigh...'},
305                     \textcolor{stringliteral}{'eval\_labels'}: [\textcolor{stringliteral}{'The needs of the few.'}],
306                     \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True},
307                 \}
308             ),
309             Message(
310                 \{
311                     \textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'Hello there.'},
312                     \textcolor{stringliteral}{'eval\_labels'}: [\textcolor{stringliteral}{'General Kenobi.'}],
313                     \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True},
314                 \}
315             ),
316         ]
317         \textcolor{keywordflow}{for} obs\_batch \textcolor{keywordflow}{in} (obs\_labs, obs\_elabs):
318             lab\_key = \textcolor{stringliteral}{'labels'} \textcolor{keywordflow}{if} \textcolor{stringliteral}{'labels'} \textcolor{keywordflow}{in} obs\_batch[0] \textcolor{keywordflow}{else} \textcolor{stringliteral}{'eval\_labels'}
319 
320             \textcolor{comment}{# nothing has been vectorized yet so should be empty}
321             batch = agent.batchify(obs\_batch)
322             self.assertIsNone(batch.text\_vec)
323             self.assertIsNone(batch.text\_lengths)
324             self.assertIsNone(batch.label\_vec)
325             self.assertIsNone(batch.label\_lengths)
326             self.assertIsNone(batch.labels)
327             self.assertIsNone(batch.valid\_indices)
328             self.assertIsNone(batch.candidates)
329             self.assertIsNone(batch.candidate\_vecs)
330             self.assertIsNone(batch.image)
331 
332             obs\_vecs = []
333             \textcolor{keywordflow}{for} o \textcolor{keywordflow}{in} obs\_batch:
334                 agent.history.reset()
335                 agent.history.update\_history(o)
336                 obs\_vecs.append(
337                     agent.vectorize(o, agent.history, add\_start=\textcolor{keyword}{False}, add\_end=\textcolor{keyword}{False})
338                 )
339 
340             \textcolor{comment}{# is\_valid should map to nothing}
341             \textcolor{keyword}{def }is\_valid(obs):
342                 \textcolor{keywordflow}{return} \textcolor{keyword}{False}
343 
344             agent.is\_valid = is\_valid
345 
346             batch = agent.batchify(obs\_batch)
347             self.assertIsNone(batch.text\_vec)
348             self.assertIsNone(batch.text\_lengths)
349             self.assertIsNone(batch.label\_vec)
350             self.assertIsNone(batch.label\_lengths)
351             self.assertIsNone(batch.labels)
352             self.assertIsNone(batch.valid\_indices)
353             self.assertIsNone(batch.candidates)
354             self.assertIsNone(batch.candidate\_vecs)
355             self.assertIsNone(batch.image)
356 
357             \textcolor{comment}{# is\_valid should check for text\_vec}
358             \textcolor{keyword}{def }is\_valid(obs):
359                 \textcolor{keywordflow}{return} \textcolor{stringliteral}{'text\_vec'} \textcolor{keywordflow}{in} obs
360 
361             agent.is\_valid = is\_valid
362 
363             batch = agent.batchify(obs\_vecs)
364             \textcolor{comment}{# which fields were filled vs should be empty?}
365             self.assertIsNotNone(batch.text\_vec)
366             self.assertIsNotNone(batch.text\_lengths)
367             self.assertIsNotNone(batch.label\_vec)
368             self.assertIsNotNone(batch.label\_lengths)
369             self.assertIsNotNone(batch.labels)
370             self.assertIsNotNone(batch.valid\_indices)
371             self.assertIsNone(batch.candidates)
372             self.assertIsNone(batch.candidate\_vecs)
373             self.assertIsNone(batch.image)
374 
375             \textcolor{comment}{# contents of certain fields:}
376             self.assertEqual(
377                 batch.text\_vec.tolist(),
378                 [[1, 2, 3, 4, 5, 0], [1, 2, 3, 4, 5, 6], [1, 2, 0, 0, 0, 0]],
379             )
380             self.assertEqual(batch.text\_lengths, [5, 6, 2])
381             self.assertEqual(
382                 batch.label\_vec.tolist(),
383                 [[1, 0, 0, 0, 0], [1, 2, 3, 4, 5], [1, 2, 0, 0, 0]],
384             )
385             self.assertEqual(batch.label\_lengths, [1, 5, 2])
386             self.assertEqual(batch.labels, [o[lab\_key][0] \textcolor{keywordflow}{for} o \textcolor{keywordflow}{in} obs\_batch])
387             self.assertEqual(list(batch.valid\_indices), [0, 1, 2])
388 
389             \textcolor{comment}{# now sort the batch, make sure fields are in sorted order}
390             batch = agent.batchify(obs\_vecs, sort=\textcolor{keyword}{True})
391             self.assertEqual(
392                 batch.text\_vec.tolist(),
393                 [[1, 2, 3, 4, 5, 6], [1, 2, 3, 4, 5, 0], [1, 2, 0, 0, 0, 0]],
394             )
395             self.assertEqual(batch.text\_lengths, [6, 5, 2])
396             self.assertEqual(
397                 batch.label\_vec.tolist(),
398                 [[1, 2, 3, 4, 5], [1, 0, 0, 0, 0], [1, 2, 0, 0, 0]],
399             )
400             self.assertEqual(batch.label\_lengths, [5, 1, 2])
401             labs = [o[lab\_key][0] \textcolor{keywordflow}{for} o \textcolor{keywordflow}{in} obs\_batch]
402             self.assertEqual(batch.labels, [labs[i] \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} [1, 0, 2]])
403             self.assertEqual(list(batch.valid\_indices), [1, 0, 2])
404 
405             \textcolor{comment}{# now sort just on ys}
406             new\_vecs = [vecs.copy() \textcolor{keywordflow}{for} vecs \textcolor{keywordflow}{in} obs\_vecs]
407             \textcolor{keywordflow}{for} vec \textcolor{keywordflow}{in} new\_vecs:
408                 vec.pop(\textcolor{stringliteral}{'text'})
409                 vec.pop(\textcolor{stringliteral}{'text\_vec'})
410 
411             \textcolor{keyword}{def }is\_valid(obs):
412                 \textcolor{keywordflow}{return} \textcolor{stringliteral}{'labels\_vec'} \textcolor{keywordflow}{in} obs \textcolor{keywordflow}{or} \textcolor{stringliteral}{'eval\_labels\_vec'} \textcolor{keywordflow}{in} obs
413 
414             agent.is\_valid = is\_valid
415 
416             batch = agent.batchify(new\_vecs, sort=\textcolor{keyword}{True})
417             self.assertIsNone(batch.text\_vec)
418             self.assertIsNone(batch.text\_lengths)
419             self.assertIsNotNone(batch.label\_vec)
420             self.assertIsNotNone(batch.label\_lengths)
421             self.assertEqual(
422                 batch.label\_vec.tolist(),
423                 [[1, 2, 3, 4, 5], [1, 2, 0, 0, 0], [1, 0, 0, 0, 0]],
424             )
425             self.assertEqual(batch.label\_lengths, [5, 2, 1])
426             labs = [o[lab\_key][0] \textcolor{keywordflow}{for} o \textcolor{keywordflow}{in} new\_vecs]
427             self.assertEqual(batch.labels, [labs[i] \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} [1, 2, 0]])
428             self.assertEqual(list(batch.valid\_indices), [1, 2, 0])
429 
430             \textcolor{comment}{# test is\_valid}
431             \textcolor{keyword}{def }is\_valid(obs):
432                 \textcolor{keywordflow}{return} \textcolor{stringliteral}{'text\_vec'} \textcolor{keywordflow}{in} obs \textcolor{keywordflow}{and} len(obs[\textcolor{stringliteral}{'text\_vec'}]) < 3
433 
434             agent.is\_valid = is\_valid
435 
436             batch = agent.batchify(obs\_vecs)
437             self.assertEqual(batch.text\_vec.tolist(), [[1, 2]])
438             self.assertEqual(batch.text\_lengths, [2])
439             self.assertEqual(batch.label\_vec.tolist(), [[1, 2]])
440             self.assertEqual(batch.label\_lengths, [2])
441             self.assertEqual(batch.labels, obs\_batch[2][lab\_key])
442             self.assertEqual(list(batch.valid\_indices), [2])
443 
444         agent.history.reset()
445         obs\_cands = [
446             agent.vectorize(
447                 Message(\{\textcolor{stringliteral}{'label\_candidates'}: [\textcolor{stringliteral}{'A'}, \textcolor{stringliteral}{'B'}, \textcolor{stringliteral}{'C'}]\}), agent.history
448             ),
449             agent.vectorize(
450                 Message(\{\textcolor{stringliteral}{'label\_candidates'}: [\textcolor{stringliteral}{'1'}, \textcolor{stringliteral}{'2'}, \textcolor{stringliteral}{'5'}, \textcolor{stringliteral}{'3'}, \textcolor{stringliteral}{'Sir'}]\}),
451                 agent.history,
452             ),
453             agent.vectorize(
454                 Message(\{\textcolor{stringliteral}{'label\_candidates'}: [\textcolor{stringliteral}{'Do'}, \textcolor{stringliteral}{'Re'}, \textcolor{stringliteral}{'Mi'}]\}), agent.history
455             ),
456             agent.vectorize(
457                 Message(\{\textcolor{stringliteral}{'label\_candidates'}: [\textcolor{stringliteral}{'Fa'}, \textcolor{stringliteral}{'So'}, \textcolor{stringliteral}{'La'}, \textcolor{stringliteral}{'Ti'}]\}), agent.history
458             ),
459         ]
460 
461         \textcolor{comment}{# is\_valid should check for label candidates vecs}
462         \textcolor{keyword}{def }is\_valid(obs):
463             \textcolor{keywordflow}{return} \textcolor{stringliteral}{'label\_candidates\_vecs'} \textcolor{keywordflow}{in} obs
464 
465         agent.is\_valid = is\_valid
466 
467         batch = agent.batchify(obs\_cands)
468         self.assertTrue(agent.rank\_candidates, \textcolor{stringliteral}{'Agent not set up to rank.'})
469         self.assertIsNone(batch.text\_vec)
470         self.assertIsNone(batch.text\_lengths)
471         self.assertIsNone(batch.label\_vec)
472         self.assertIsNone(batch.label\_lengths)
473         self.assertIsNone(batch.labels)
474         self.assertIsNotNone(batch.valid\_indices)
475         self.assertIsNotNone(batch.candidates)
476         self.assertIsNotNone(batch.candidate\_vecs)
477         self.assertEqual(list(batch.valid\_indices), [0, 1, 2, 3])
478         self.assertEqual(batch.candidates, [o[\textcolor{stringliteral}{'label\_candidates'}] \textcolor{keywordflow}{for} o \textcolor{keywordflow}{in} obs\_cands])
479         self.assertEqual(len(batch.candidate\_vecs), len(obs\_cands))
480         \textcolor{keywordflow}{for} i, cs \textcolor{keywordflow}{in} enumerate(batch.candidate\_vecs):
481             self.assertEqual(len(cs), len(obs\_cands[i][\textcolor{stringliteral}{'label\_candidates'}]))
482 
\end{DoxyCode}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_a3c5504828399a2bb0d776baf1a744f71}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_a3c5504828399a2bb0d776baf1a744f71}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+history@{test\+\_\+history}}
\index{test\+\_\+history@{test\+\_\+history}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+history()}{test\_history()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+history (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Test different dialog history settings.
\end{DoxyVerb}
 

Definition at line 612 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
612     \textcolor{keyword}{def }test\_history(self):
613         \textcolor{stringliteral}{"""}
614 \textcolor{stringliteral}{        Test different dialog history settings.}
615 \textcolor{stringliteral}{        """}
616         \textcolor{comment}{# try with unlimited history}
617         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(history\_size=-1)
618         obs = \{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'I am Groot.'}, \textcolor{stringliteral}{'labels'}: [\textcolor{stringliteral}{'I am Groot?'}], \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{False}\}
619 
620         \textcolor{comment}{# first exchange}
621         agent.history.update\_history(obs)
622         text = agent.history.get\_history\_str()
623         self.assertEqual(text, \textcolor{stringliteral}{'I am Groot.'})
624 
625         \textcolor{comment}{# second exchange, no reply}
626         agent.history.update\_history(obs)
627         text = agent.history.get\_history\_str()
628         self.assertEqual(text, \textcolor{stringliteral}{'I am Groot.\(\backslash\)nI am Groot.'})
629 
630         \textcolor{comment}{# include reply}
631         agent.history.add\_reply(\textcolor{stringliteral}{'I am Groot?'})
632         agent.history.update\_history(obs)
633         text = agent.history.get\_history\_str()
634         self.assertEqual(text, \textcolor{stringliteral}{'I am Groot.\(\backslash\)nI am Groot.\(\backslash\)nI am Groot?\(\backslash\)nI am Groot.'})
635 
636         \textcolor{comment}{# on reset should be same as first exchange}
637         agent.history.reset()
638         agent.history.update\_history(obs)
639         text = agent.history.get\_history\_str()
640         self.assertEqual(text, \textcolor{stringliteral}{'I am Groot.'})
641 
642         \textcolor{comment}{# now try with history size = 1}
643         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(history\_size=1)
644         \textcolor{comment}{# first exchange}
645         agent.history.update\_history(obs)
646         text = agent.history.get\_history\_str()
647         self.assertEqual(text, \textcolor{stringliteral}{'I am Groot.'})
648         \textcolor{comment}{# second exchange should change nothing}
649         agent.history.update\_history(obs)
650         text = agent.history.get\_history\_str()
651         self.assertEqual(text, \textcolor{stringliteral}{'I am Groot.'})
652         \textcolor{comment}{# third exchange with reply should change nothing}
653         agent.history.update\_history(obs)
654         text = agent.history.get\_history\_str()
655         self.assertEqual(text, \textcolor{stringliteral}{'I am Groot.'})
656         \textcolor{comment}{# now if we add the reply, we should only have the reply left}
657         agent.history.add\_reply(obs[\textcolor{stringliteral}{'labels'}][0])
658         text = agent.history.get\_history\_str()
659         self.assertEqual(text, \textcolor{stringliteral}{'I am Groot?'})
660 
661         \textcolor{comment}{# now try with history size = 2}
662         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(history\_size=2)
663 
664         \textcolor{comment}{# first exchange}
665         agent.history.update\_history(obs)
666         text = agent.history.get\_history\_str()
667         self.assertEqual(text, \textcolor{stringliteral}{'I am Groot.'})
668 
669         \textcolor{comment}{# second exchange with reply should contain reply}
670         agent.history.add\_reply(\textcolor{stringliteral}{'I am Groot?'})
671         agent.history.update\_history(obs)
672         text = agent.history.get\_history\_str()
673         self.assertEqual(text, \textcolor{stringliteral}{'I am Groot?\(\backslash\)nI am Groot.'})
674 
675         \textcolor{comment}{# now try with history size = 3}
676         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(history\_size=3)
677         \textcolor{comment}{# first exchange}
678         agent.history.update\_history(obs)
679         text = agent.history.get\_history\_str()
680         self.assertEqual(text, \textcolor{stringliteral}{'I am Groot.'})
681         \textcolor{comment}{# second exchange with reply should contain reply and input}
682         agent.history.add\_reply(\textcolor{stringliteral}{'I am Groot?'})
683         agent.history.update\_history(obs)
684         text = agent.history.get\_history\_str()
685         self.assertEqual(text, \textcolor{stringliteral}{'I am Groot.\(\backslash\)nI am Groot?\(\backslash\)nI am Groot.'})
686 
687         \textcolor{comment}{# now test add\_person\_tokens}
688         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(history\_size=3, person\_tokens=\textcolor{keyword}{True})
689         agent.history.update\_history(obs)
690         text = agent.history.get\_history\_str()
691         self.assertEqual(text, \textcolor{stringliteral}{'\{\} I am Groot.'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(agent.P1\_TOKEN))
692         \textcolor{comment}{# second exchange, history should still contain the tokens}
693         agent.history.add\_reply(\textcolor{stringliteral}{'I am Groot?'})
694         agent.history.update\_history(obs)
695         text = agent.history.get\_history\_str()
696         self.assertEqual(
697             text,
698             \textcolor{stringliteral}{'\{\} I am Groot.\(\backslash\)n\{\} I am Groot?\(\backslash\)n\{\} I am Groot.'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
699                 agent.P1\_TOKEN, agent.P2\_TOKEN, agent.P1\_TOKEN
700             ),
701         )
702 
703         \textcolor{comment}{# now add add\_p1\_after\_newln}
704         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(history\_size=3, person\_tokens=\textcolor{keyword}{True}, add\_p1\_after\_newln=\textcolor{keyword}{True})
705         ctx\_obs = obs.copy()  \textcolor{comment}{# context then utterance in this text field}
706         ctx\_obs[\textcolor{stringliteral}{'text'}] = \textcolor{stringliteral}{'Groot is Groot.\(\backslash\)nI am Groot.'}
707         agent.history.update\_history(ctx\_obs)
708         text = agent.history.get\_history\_str()
709         self.assertEqual(text, \textcolor{stringliteral}{'Groot is Groot.\(\backslash\)n\{\} I am Groot.'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(agent.P1\_TOKEN))
710         \textcolor{comment}{# second exchange, history should still contain context text}
711         agent.history.add\_reply(\textcolor{stringliteral}{'I am Groot?'})
712         agent.history.update\_history(obs)
713         text = agent.history.get\_history\_str()
714         self.assertEqual(
715             text,
716             \textcolor{stringliteral}{'Groot is Groot.\(\backslash\)n\{\} I am Groot.\(\backslash\)n\{\} I am Groot?\(\backslash\)n\{\} I am Groot.'}.
      \hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
717                 agent.P1\_TOKEN, agent.P2\_TOKEN, agent.P1\_TOKEN
718             ),
719         )
720 
721         \textcolor{comment}{# test history vecs}
722         agent.history.reset()
723         agent.history.update\_history(obs)
724         vec = agent.history.get\_history\_vec()
725         self.assertEqual(vec, deque([2001, 1, 2, 3]))
726 
727         \textcolor{comment}{# test history vec list}
728         agent.history.update\_history(obs)
729         vecs = agent.history.get\_history\_vec\_list()
730         self.assertEqual(vecs, [[2001, 1, 2, 3], [2001, 1, 2, 3]])
731 
732         \textcolor{comment}{# test clearing history}
733         agent.history.reset()
734         text = agent.history.get\_history\_str()
735         self.assertIsNone(text)
736         vecs = agent.history.get\_history\_vec\_list()
737         self.assertEqual(vecs, [])
738 
739         \textcolor{comment}{# test delimiter}
740         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(history\_size=-1, delimiter=\textcolor{stringliteral}{' Groot! '})
741         agent.history.update\_history(obs)
742         agent.history.update\_history(obs)
743         text = agent.history.get\_history\_str()
744         self.assertEqual(text, \textcolor{stringliteral}{'I am Groot. Groot! I am Groot.'})
745 
\end{DoxyCode}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_aadf263b222e27bfd83d568148683a8e0}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_aadf263b222e27bfd83d568148683a8e0}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+interactive\+\_\+mode@{test\+\_\+interactive\+\_\+mode}}
\index{test\+\_\+interactive\+\_\+mode@{test\+\_\+interactive\+\_\+mode}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+interactive\+\_\+mode()}{test\_interactive\_mode()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+interactive\+\_\+mode (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Test if conversation history is destroyed in MTurk mode.
\end{DoxyVerb}
 

Definition at line 848 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
848     \textcolor{keyword}{def }test\_interactive\_mode(self):
849         \textcolor{stringliteral}{"""}
850 \textcolor{stringliteral}{        Test if conversation history is destroyed in MTurk mode.}
851 \textcolor{stringliteral}{        """}
852         \textcolor{comment}{# both manually setting bs to 1 and interactive mode true}
853         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(batchsize=1, interactive\_mode=\textcolor{keyword}{True})
854         agent.observe(Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'foo'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True}\}))
855         response = agent.act()
856         self.assertIn(
857             \textcolor{stringliteral}{'Evaluating 0'}, response[\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{'Incorrect output in single act()'}
858         )
859         shared = \hyperlink{namespaceparlai_1_1core_1_1agents_aa5af5dd1d2f9da491b60348d479b849f}{create\_agent\_from\_shared}(agent.share())
860         shared.observe(Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'bar'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True}\}))
861         response = shared.act()
862         self.assertIn(
863             \textcolor{stringliteral}{'Evaluating 0'}, response[\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{'Incorrect output in single act()'}
864         )
865 
866         \textcolor{comment}{# now just bs 1}
867         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(batchsize=1, interactive\_mode=\textcolor{keyword}{False})
868         agent.observe(Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'foo'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True}\}))
869         response = agent.act()
870         self.assertIn(
871             \textcolor{stringliteral}{'Evaluating 0'}, response[\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{'Incorrect output in single act()'}
872         )
873         shared = \hyperlink{namespaceparlai_1_1core_1_1agents_aa5af5dd1d2f9da491b60348d479b849f}{create\_agent\_from\_shared}(agent.share())
874         shared.observe(Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'bar'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True}\}))
875         response = shared.act()
876         self.assertIn(
877             \textcolor{stringliteral}{'Evaluating 0'}, response[\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{'Incorrect output in single act()'}
878         )
879 
880         \textcolor{comment}{# now just interactive}
881         shared = \hyperlink{namespaceparlai_1_1core_1_1agents_aa5af5dd1d2f9da491b60348d479b849f}{create\_agent\_from\_shared}(agent.share())
882         agent.observe(Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'foo'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True}\}))
883         response = agent.act()
884         self.assertIn(
885             \textcolor{stringliteral}{'Evaluating 0'}, response[\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{'Incorrect output in single act()'}
886         )
887         shared = \hyperlink{namespaceparlai_1_1core_1_1agents_aa5af5dd1d2f9da491b60348d479b849f}{create\_agent\_from\_shared}(agent.share())
888         shared.observe(Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'bar'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True}\}))
889         response = shared.act()
890         self.assertIn(
891             \textcolor{stringliteral}{'Evaluating 0'}, response[\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{'Incorrect output in single act()'}
892         )
893 
894         \textcolor{comment}{# finally, actively attempt to sabotage}
895         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(batchsize=16, interactive\_mode=\textcolor{keyword}{False})
896         agent.observe(Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'foo'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True}\}))
897         response = agent.act()
898         self.assertIn(
899             \textcolor{stringliteral}{'Evaluating 0'}, response[\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{'Incorrect output in single act()'}
900         )
901         shared = \hyperlink{namespaceparlai_1_1core_1_1agents_aa5af5dd1d2f9da491b60348d479b849f}{create\_agent\_from\_shared}(agent.share())
902         shared.observe(Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'bar'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True}\}))
903         response = shared.act()
904         self.assertIn(
905             \textcolor{stringliteral}{'Evaluating 0'}, response[\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{'Incorrect output in single act()'}
906         )
907 
\end{DoxyCode}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_abe59ca8c2f6927c0ba6f0e5ce7d3a4f2}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_abe59ca8c2f6927c0ba6f0e5ce7d3a4f2}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+match\+\_\+batch@{test\+\_\+match\+\_\+batch}}
\index{test\+\_\+match\+\_\+batch@{test\+\_\+match\+\_\+batch}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+match\+\_\+batch()}{test\_match\_batch()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+match\+\_\+batch (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Make sure predictions are correctly aligned when available.
\end{DoxyVerb}
 

Definition at line 483 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
483     \textcolor{keyword}{def }test\_match\_batch(self):
484         \textcolor{stringliteral}{"""}
485 \textcolor{stringliteral}{        Make sure predictions are correctly aligned when available.}
486 \textcolor{stringliteral}{        """}
487         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}()
488 
489         \textcolor{comment}{# first try empty outputs}
490         reply = agent.match\_batch([\{\}, \{\}, \{\}], [0, 1, 2], \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1torch__agent__v1_a2689006ea97d09413fb242f984bd8016}{Output}())
491         self.assertEqual([\{\}, \{\}, \{\}], reply)
492         reply = agent.match\_batch([\{\}, \{\}, \{\}], [0, 1, 2], \textcolor{keywordtype}{None})
493         self.assertEqual([\{\}, \{\}, \{\}], reply)
494 
495         \textcolor{comment}{# try text in order}
496         reply = agent.match\_batch(
497             [\{\}, \{\}, \{\}], [0, 1, 2], \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1torch__agent__v1_a2689006ea97d09413fb242f984bd8016}{Output}([\textcolor{stringliteral}{'E.T.'}, \textcolor{stringliteral}{'Phone'}, \textcolor{stringliteral}{'Home'}])
498         )
499         self.assertEqual([\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'E.T.'}\}, \{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'Phone'}\}, \{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'Home'}\}], reply)
500 
501         \textcolor{comment}{# try text out of order}
502         reply = agent.match\_batch(
503             [\{\}, \{\}, \{\}], [2, 0, 1], \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1torch__agent__v1_a2689006ea97d09413fb242f984bd8016}{Output}([\textcolor{stringliteral}{'Home'}, \textcolor{stringliteral}{'E.T.'}, \textcolor{stringliteral}{'Phone'}])
504         )
505         self.assertEqual([\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'E.T.'}\}, \{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'Phone'}\}, \{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'Home'}\}], reply)
506 
507         \textcolor{comment}{# try text\_candidates in order}
508         reply = agent.match\_batch(
509             [\{\}, \{\}],
510             [0, 1],
511             \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1torch__agent__v1_a2689006ea97d09413fb242f984bd8016}{Output}(
512                 \textcolor{keywordtype}{None},
513                 [
514                     [\textcolor{stringliteral}{'More human than human.'}, \textcolor{stringliteral}{'Less human than human'}],
515                     [\textcolor{stringliteral}{'Just walk into Mordor'}, \textcolor{stringliteral}{'Just QWOP into Mordor.'}],
516                 ],
517             ),
518         )
519         self.assertEqual(
520             reply[0][\textcolor{stringliteral}{'text\_candidates'}],
521             [\textcolor{stringliteral}{'More human than human.'}, \textcolor{stringliteral}{'Less human than human'}],
522         )
523         self.assertEqual(
524             reply[1][\textcolor{stringliteral}{'text\_candidates'}],
525             [\textcolor{stringliteral}{'Just walk into Mordor'}, \textcolor{stringliteral}{'Just QWOP into Mordor.'}],
526         )
527         \textcolor{comment}{# try text\_candidates out of order}
528         reply = agent.match\_batch(
529             [\{\}, \{\}],
530             [1, 0],
531             \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1torch__agent__v1_a2689006ea97d09413fb242f984bd8016}{Output}(
532                 \textcolor{keywordtype}{None},
533                 [
534                     [\textcolor{stringliteral}{'More human than human.'}, \textcolor{stringliteral}{'Less human than human'}],
535                     [\textcolor{stringliteral}{'Just walk into Mordor'}, \textcolor{stringliteral}{'Just QWOP into Mordor.'}],
536                 ],
537             ),
538         )
539         self.assertEqual(
540             reply[0][\textcolor{stringliteral}{'text\_candidates'}],
541             [\textcolor{stringliteral}{'Just walk into Mordor'}, \textcolor{stringliteral}{'Just QWOP into Mordor.'}],
542         )
543         self.assertEqual(
544             reply[1][\textcolor{stringliteral}{'text\_candidates'}],
545             [\textcolor{stringliteral}{'More human than human.'}, \textcolor{stringliteral}{'Less human than human'}],
546         )
547 
548         \textcolor{comment}{# try both text and text\_candidates in order}
549         reply = agent.match\_batch(
550             [\{\}, \{\}],
551             [0, 1],
552             \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1torch__agent__v1_a2689006ea97d09413fb242f984bd8016}{Output}(
553                 [\textcolor{stringliteral}{'You shall be avenged...'}, \textcolor{stringliteral}{'Man creates dinosaurs...'}],
554                 [
555                     [\textcolor{stringliteral}{'By Grabthars hammer.'}, \textcolor{stringliteral}{'By the suns of Worvan.'}],
556                     [\textcolor{stringliteral}{'Dinosaurs eat man.'}, \textcolor{stringliteral}{'Woman inherits the earth.'}],
557                 ],
558             ),
559         )
560         self.assertEqual(reply[0][\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{'You shall be avenged...'})
561         self.assertEqual(
562             reply[0][\textcolor{stringliteral}{'text\_candidates'}],
563             [\textcolor{stringliteral}{'By Grabthars hammer.'}, \textcolor{stringliteral}{'By the suns of Worvan.'}],
564         )
565         self.assertEqual(reply[1][\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{'Man creates dinosaurs...'})
566         self.assertEqual(
567             reply[1][\textcolor{stringliteral}{'text\_candidates'}],
568             [\textcolor{stringliteral}{'Dinosaurs eat man.'}, \textcolor{stringliteral}{'Woman inherits the earth.'}],
569         )
570 
571         \textcolor{comment}{# try both text and text\_candidates out of order}
572         reply = agent.match\_batch(
573             [\{\}, \{\}],
574             [1, 0],
575             \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1torch__agent__v1_a2689006ea97d09413fb242f984bd8016}{Output}(
576                 [\textcolor{stringliteral}{'You shall be avenged...'}, \textcolor{stringliteral}{'Man creates dinosaurs...'}],
577                 [
578                     [\textcolor{stringliteral}{'By Grabthars hammer.'}, \textcolor{stringliteral}{'By the suns of Worvan.'}],
579                     [\textcolor{stringliteral}{'Dinosaurs eat man.'}, \textcolor{stringliteral}{'Woman inherits the earth.'}],
580                 ],
581             ),
582         )
583         self.assertEqual(reply[0][\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{'Man creates dinosaurs...'})
584         self.assertEqual(
585             reply[0][\textcolor{stringliteral}{'text\_candidates'}],
586             [\textcolor{stringliteral}{'Dinosaurs eat man.'}, \textcolor{stringliteral}{'Woman inherits the earth.'}],
587         )
588         self.assertEqual(reply[1][\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{'You shall be avenged...'})
589         self.assertEqual(
590             reply[1][\textcolor{stringliteral}{'text\_candidates'}],
591             [\textcolor{stringliteral}{'By Grabthars hammer.'}, \textcolor{stringliteral}{'By the suns of Worvan.'}],
592         )
593 
\end{DoxyCode}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_a0a7c1df7d947bdc260afa6dad21d78b9}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_a0a7c1df7d947bdc260afa6dad21d78b9}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+mock@{test\+\_\+mock}}
\index{test\+\_\+mock@{test\+\_\+mock}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+mock()}{test\_mock()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+mock (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Just make sure we can instantiate a mock agent.
\end{DoxyVerb}
 

Definition at line 53 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
53     \textcolor{keyword}{def }test\_mock(self):
54         \textcolor{stringliteral}{"""}
55 \textcolor{stringliteral}{        Just make sure we can instantiate a mock agent.}
56 \textcolor{stringliteral}{        """}
57         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}()
58         self.assertTrue(isinstance(agent.dict, MockDict))
59 
\end{DoxyCode}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_a9954f92efc8cc7a9770f90f3a297d397}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_a9954f92efc8cc7a9770f90f3a297d397}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+mturk\+\_\+racehistory@{test\+\_\+mturk\+\_\+racehistory}}
\index{test\+\_\+mturk\+\_\+racehistory@{test\+\_\+mturk\+\_\+racehistory}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+mturk\+\_\+racehistory()}{test\_mturk\_racehistory()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+mturk\+\_\+racehistory (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Emulate a setting where batch_act misappropriately handles mturk.
\end{DoxyVerb}
 

Definition at line 942 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
942     \textcolor{keyword}{def }test\_mturk\_racehistory(self):
943         \textcolor{stringliteral}{"""}
944 \textcolor{stringliteral}{        Emulate a setting where batch\_act misappropriately handles mturk.}
945 \textcolor{stringliteral}{        """}
946         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(batchsize=16, interactive\_mode=\textcolor{keyword}{True}, echo=\textcolor{keyword}{True})
947         share1 = \hyperlink{namespaceparlai_1_1core_1_1agents_aa5af5dd1d2f9da491b60348d479b849f}{create\_agent\_from\_shared}(agent.share())
948 
949         share1.observe(Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'thread1-msg1'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{False}\}))
950         share2 = \hyperlink{namespaceparlai_1_1core_1_1agents_aa5af5dd1d2f9da491b60348d479b849f}{create\_agent\_from\_shared}(agent.share())
951         share2.observe(Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'thread2-msg1'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{False}\}))
952         share1.act()
953         share2.act()
954 
955         share1.observe(Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'thread1-msg2'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{False}\}))
956         share2.observe(Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'thread2-msg2'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{False}\}))
957         share2.act()
958         share1.act()
959 
960         share2.observe(Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'thread2-msg3'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{False}\}))
961         share1.observe(Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'thread1-msg3'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{False}\}))
962 
963         self.assertNotIn(\textcolor{stringliteral}{'thread1-msg1'}, share2.history.get\_history\_str())
964         self.assertNotIn(\textcolor{stringliteral}{'thread2-msg1'}, share1.history.get\_history\_str())
965         self.assertNotIn(\textcolor{stringliteral}{'thread1-msg2'}, share2.history.get\_history\_str())
966         self.assertNotIn(\textcolor{stringliteral}{'thread2-msg2'}, share1.history.get\_history\_str())
967 
\end{DoxyCode}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_ae3b6e4145176ba5d5e9179756d064332}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_ae3b6e4145176ba5d5e9179756d064332}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+observe@{test\+\_\+observe}}
\index{test\+\_\+observe@{test\+\_\+observe}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+observe()}{test\_observe()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+observe (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Make sure agent stores and returns observation.
\end{DoxyVerb}
 

Definition at line 746 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
746     \textcolor{keyword}{def }test\_observe(self):
747         \textcolor{stringliteral}{"""}
748 \textcolor{stringliteral}{        Make sure agent stores and returns observation.}
749 \textcolor{stringliteral}{        """}
750         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}()
751         \textcolor{comment}{# text could be none}
752         obs = \{\textcolor{stringliteral}{'text'}: \textcolor{keywordtype}{None}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True}\}
753         out = agent.observe(obs.copy())
754         self.assertIsNotNone(out)
755         \textcolor{comment}{# make sure we throw an exception for having an episode done without a reset}
756         obs = \{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{"I'll be back."}, \textcolor{stringliteral}{'labels'}: [\textcolor{stringliteral}{"I'm back."}], \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True}\}
757         with self.assertRaises(RuntimeError):
758             agent.observe(obs.copy())
759         \textcolor{comment}{# okay, let's do it properly now}
760         agent.reset()
761         obs = \{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{"I'll be back."}, \textcolor{stringliteral}{'labels'}: [\textcolor{stringliteral}{"I'm back."}], \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True}\}
762         out = agent.observe(obs.copy())
763         self.assertIsNotNone(out)
764         self.assertIsNotNone(agent.observation)
765         self.assertEqual(out[\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{"I'll be back."})
766         \textcolor{comment}{# now try with episode not done}
767         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}()
768         obs[\textcolor{stringliteral}{'episode\_done'}] = \textcolor{keyword}{False}
769         out = agent.observe(obs.copy())
770         self.assertIsNotNone(out)
771         self.assertIsNotNone(agent.observation)
772         self.assertEqual(out[\textcolor{stringliteral}{'text'}], \textcolor{stringliteral}{"I'll be back."})
773         \textcolor{comment}{# should remember history}
774         agent.act()
775         out = agent.observe(obs.copy())
776         self.assertEqual(out[\textcolor{stringliteral}{'full\_text'}], \textcolor{stringliteral}{"I'll be back.\(\backslash\)nI'm back.\(\backslash\)nI'll be back."})
777 
\end{DoxyCode}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_a7135ee3421b1d0fc98f0202718910482}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_a7135ee3421b1d0fc98f0202718910482}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+resume\+\_\+checkpoint@{test\+\_\+resume\+\_\+checkpoint}}
\index{test\+\_\+resume\+\_\+checkpoint@{test\+\_\+resume\+\_\+checkpoint}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+resume\+\_\+checkpoint()}{test\_resume\_checkpoint()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+resume\+\_\+checkpoint (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Make sure when resuming training that model uses appropriate mf.

Copy train_model from testing_utils to directly access agent.
\end{DoxyVerb}
 

Definition at line 968 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
968     \textcolor{keyword}{def }test\_resume\_checkpoint(self):
969         \textcolor{stringliteral}{"""}
970 \textcolor{stringliteral}{        Make sure when resuming training that model uses appropriate mf.}
971 \textcolor{stringliteral}{}
972 \textcolor{stringliteral}{        Copy train\_model from testing\_utils to directly access agent.}
973 \textcolor{stringliteral}{        """}
974         \textcolor{keyword}{import} \hyperlink{namespaceparlai_1_1scripts_1_1train__model}{parlai.scripts.train\_model} \textcolor{keyword}{as} tms
975 
976         \textcolor{keyword}{def }get\_popt\_and\_tl(opt):
977             parser = tms.setup\_args()
978             parser.set\_params(**opt)
979             popt = parser.parse\_args(print\_args=\textcolor{keyword}{False})
980             \textcolor{keywordflow}{for} k, v \textcolor{keywordflow}{in} opt.items():
981                 popt[k] = v
982             \textcolor{keywordflow}{return} popt, tms.TrainLoop(popt)
983 
984         \textcolor{keyword}{def }get\_opt(init\_mf, mf):
985             \textcolor{keywordflow}{return} \{
986                 \textcolor{stringliteral}{'task'}: \textcolor{stringliteral}{'integration\_tests'},
987                 \textcolor{stringliteral}{'init\_model'}: init\_mf,
988                 \textcolor{stringliteral}{'model'}: \textcolor{stringliteral}{'parlai.agents.test\_agents.dummy\_torch\_agent:MockTorchAgent'},
989                 \textcolor{stringliteral}{'model\_file'}: mf,
990                 \textcolor{stringliteral}{'num\_epochs'}: 3,
991                 \textcolor{stringliteral}{'validation\_every\_n\_epochs'}: 1,
992                 \textcolor{stringliteral}{'save\_after\_valid'}: \textcolor{keyword}{True},
993                 \textcolor{stringliteral}{'log\_every\_n\_secs'}: 10,
994             \}
995 
996         with \hyperlink{namespaceparlai_1_1utils_1_1testing_ab00d4d693202afab92c06387aa50699b}{capture\_output}():
997             with \hyperlink{namespaceparlai_1_1utils_1_1testing_a0945b769a10c0c844b29c02ff26445a5}{tempdir}() \textcolor{keyword}{as} tmpdir:
998                 \textcolor{comment}{# First train model with init\_model path set}
999                 mf = os.path.join(tmpdir, \textcolor{stringliteral}{'model'})
1000                 init\_mf = os.path.join(tmpdir, \textcolor{stringliteral}{'init\_model'})
1001                 with open(init\_mf, \textcolor{stringliteral}{'w'}) \textcolor{keyword}{as} f:
1002                     f.write(\textcolor{stringliteral}{' '})
1003                 opt = get\_opt(init\_mf, mf)
1004                 popt, tl = get\_popt\_and\_tl(opt)
1005                 agent = tl.agent
1006                 \textcolor{comment}{# init model file should be set appropriately}
1007                 init\_model\_file, is\_finetune = agent.\_get\_init\_model(popt, \textcolor{keywordtype}{None})
1008                 self.assertEqual(init\_model\_file, init\_mf)
1009                 self.assertTrue(is\_finetune)
1010                 valid, test = tl.train()
1011                 \textcolor{comment}{# now, train the model for another epoch}
1012                 opt = get\_opt(\textcolor{stringliteral}{'\{\}.checkpoint'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(mf), mf)
1013                 opt[\textcolor{stringliteral}{'load\_from\_checkpoint'}] = \textcolor{keyword}{True}
1014                 popt, tl = get\_popt\_and\_tl(opt)
1015                 agent = tl.agent
1016                 init\_model\_file, is\_finetune = agent.\_get\_init\_model(popt, \textcolor{keywordtype}{None})
1017                 self.assertEqual(init\_model\_file, \textcolor{stringliteral}{'\{\}.checkpoint'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(mf))
1018                 self.assertFalse(is\_finetune)
1019 
1020 
\end{DoxyCode}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_af3d1c7681a30a06684117464ccefb15d}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_af3d1c7681a30a06684117464ccefb15d}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+share@{test\+\_\+share}}
\index{test\+\_\+share@{test\+\_\+share}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+share()}{test\_share()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+share (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Make sure share works and shares dictionary.
\end{DoxyVerb}
 

Definition at line 60 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
60     \textcolor{keyword}{def }test\_share(self):
61         \textcolor{stringliteral}{"""}
62 \textcolor{stringliteral}{        Make sure share works and shares dictionary.}
63 \textcolor{stringliteral}{        """}
64         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}()
65         shared = agent.share()
66         self.assertTrue(\textcolor{stringliteral}{'dict'} \textcolor{keywordflow}{in} shared)
67 
\end{DoxyCode}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_a10ba6e3fdb49b540bc4663d9c7a30eab}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_a10ba6e3fdb49b540bc4663d9c7a30eab}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+use\+\_\+reply@{test\+\_\+use\+\_\+reply}}
\index{test\+\_\+use\+\_\+reply@{test\+\_\+use\+\_\+reply}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+use\+\_\+reply()}{test\_use\_reply()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+use\+\_\+reply (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Check that self-observe is correctly acting on labels.
\end{DoxyVerb}
 

Definition at line 908 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
908     \textcolor{keyword}{def }test\_use\_reply(self):
909         \textcolor{stringliteral}{"""}
910 \textcolor{stringliteral}{        Check that self-observe is correctly acting on labels.}
911 \textcolor{stringliteral}{        """}
912         \textcolor{comment}{# default is hybrid label-model, which uses the label if it's available, and}
913         \textcolor{comment}{# otherwise the label}
914         \textcolor{comment}{# first check if there is a label available}
915         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}()
916         obs = Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'Call'}, \textcolor{stringliteral}{'labels'}: [\textcolor{stringliteral}{'Response'}], \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{False}\})
917         agent.observe(obs)
918         \_ = agent.act()
919         self.assertEqual(agent.history.get\_history\_str(), \textcolor{stringliteral}{'Call\(\backslash\)nResponse'})
920         \textcolor{comment}{# check if there is no label}
921         agent.reset()
922         obs = Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'Call'}, \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{False}\})
923         agent.observe(obs)
924         \_ = agent.act()
925         self.assertEqual(
926             agent.history.get\_history\_str(), \textcolor{stringliteral}{'Call\(\backslash\)nEvaluating 0 (responding to Call)!'}
927         )
928         \textcolor{comment}{# now some of the other possible values of --use-reply}
929         \textcolor{comment}{# --use-reply model. even if there is a label, we should see the model's out}
930         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(use\_reply=\textcolor{stringliteral}{'model'})
931         obs = Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'Call'}, \textcolor{stringliteral}{'labels'}: [\textcolor{stringliteral}{'Response'}], \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{False}\})
932         agent.observe(obs)
933         \_ = agent.act()
934         self.assertEqual(agent.history.get\_history\_str(), \textcolor{stringliteral}{'Call\(\backslash\)nTraining 0!'})
935         \textcolor{comment}{# --use-reply none doesn't hear itself}
936         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(use\_reply=\textcolor{stringliteral}{'none'})
937         obs = Message(\{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'Call'}, \textcolor{stringliteral}{'labels'}: [\textcolor{stringliteral}{'Response'}], \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{False}\})
938         agent.observe(obs)
939         agent.act()
940         self.assertEqual(agent.history.get\_history\_str(), \textcolor{stringliteral}{'Call'})
941 
\end{DoxyCode}
\mbox{\Hypertarget{classtests_1_1test__torch__agent_1_1TestTorchAgent_a551847086a9d8bf6bc04ea1efeacf608}\label{classtests_1_1test__torch__agent_1_1TestTorchAgent_a551847086a9d8bf6bc04ea1efeacf608}} 
\index{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}!test\+\_\+vectorize@{test\+\_\+vectorize}}
\index{test\+\_\+vectorize@{test\+\_\+vectorize}!tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent@{tests\+::test\+\_\+torch\+\_\+agent\+::\+Test\+Torch\+Agent}}
\subsubsection{\texorpdfstring{test\+\_\+vectorize()}{test\_vectorize()}}
{\footnotesize\ttfamily def tests.\+test\+\_\+torch\+\_\+agent.\+Test\+Torch\+Agent.\+test\+\_\+vectorize (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Test the vectorization of observations.

Make sure they do not recompute results, and respect the different param
options.
\end{DoxyVerb}
 

Definition at line 174 of file test\+\_\+torch\+\_\+agent.\+py.


\begin{DoxyCode}
174     \textcolor{keyword}{def }test\_vectorize(self):
175         \textcolor{stringliteral}{"""}
176 \textcolor{stringliteral}{        Test the vectorization of observations.}
177 \textcolor{stringliteral}{}
178 \textcolor{stringliteral}{        Make sure they do not recompute results, and respect the different param}
179 \textcolor{stringliteral}{        options.}
180 \textcolor{stringliteral}{        """}
181         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}()
182         obs\_labs = Message(
183             \{\textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'No. Try not.'}, \textcolor{stringliteral}{'labels'}: [\textcolor{stringliteral}{'Do.'}, \textcolor{stringliteral}{'Do not.'}], \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True}\}
184         )
185         obs\_elabs = Message(
186             \{
187                 \textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'No. Try not.'},
188                 \textcolor{stringliteral}{'eval\_labels'}: [\textcolor{stringliteral}{'Do.'}, \textcolor{stringliteral}{'Do not.'}],
189                 \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True},
190             \}
191         )
192 
193         \textcolor{keywordflow}{for} obs \textcolor{keywordflow}{in} (obs\_labs, obs\_elabs):
194             lab\_key = \textcolor{stringliteral}{'labels'} \textcolor{keywordflow}{if} \textcolor{stringliteral}{'labels'} \textcolor{keywordflow}{in} obs \textcolor{keywordflow}{else} \textcolor{stringliteral}{'eval\_labels'}
195             lab\_vec = lab\_key + \textcolor{stringliteral}{'\_vec'}
196             lab\_chc = lab\_key + \textcolor{stringliteral}{'\_choice'}
197 
198             inp = obs.copy()
199             \textcolor{comment}{# test add\_start=True, add\_end=True}
200             agent.history.reset()
201             agent.history.update\_history(inp)
202             out = agent.vectorize(inp, agent.history, add\_start=\textcolor{keyword}{True}, add\_end=\textcolor{keyword}{True})
203             self.assertEqual(out[\textcolor{stringliteral}{'text\_vec'}].tolist(), [1, 2, 3])
204             \textcolor{comment}{# note that label could be either label above}
205             self.assertEqual(out[lab\_vec][0].item(), MockDict.BEG\_IDX)
206             self.assertEqual(out[lab\_vec][1].item(), 1)
207             self.assertEqual(out[lab\_vec][-1].item(), MockDict.END\_IDX)
208             self.assertEqual(out[lab\_chc][:2], \textcolor{stringliteral}{'Do'})
209 
210             \textcolor{comment}{# test add\_start=True, add\_end=False}
211             inp = obs.copy()
212             out = agent.vectorize(inp, agent.history, add\_start=\textcolor{keyword}{True}, add\_end=\textcolor{keyword}{False})
213             self.assertEqual(out[\textcolor{stringliteral}{'text\_vec'}].tolist(), [1, 2, 3])
214             \textcolor{comment}{# note that label could be either label above}
215             self.assertEqual(out[lab\_vec][0].item(), MockDict.BEG\_IDX)
216             self.assertNotEqual(out[lab\_vec][-1].item(), MockDict.END\_IDX)
217             self.assertEqual(out[lab\_chc][:2], \textcolor{stringliteral}{'Do'})
218 
219             \textcolor{comment}{# test add\_start=False, add\_end=True}
220             inp = obs.copy()
221             out = agent.vectorize(inp, agent.history, add\_start=\textcolor{keyword}{False}, add\_end=\textcolor{keyword}{True})
222             self.assertEqual(out[\textcolor{stringliteral}{'text\_vec'}].tolist(), [1, 2, 3])
223             \textcolor{comment}{# note that label could be either label above}
224             self.assertNotEqual(out[lab\_vec][0].item(), MockDict.BEG\_IDX)
225             self.assertEqual(out[lab\_vec][-1].item(), MockDict.END\_IDX)
226             self.assertEqual(out[lab\_chc][:2], \textcolor{stringliteral}{'Do'})
227 
228             \textcolor{comment}{# test add\_start=False, add\_end=False}
229             inp = obs.copy()
230             out = agent.vectorize(inp, agent.history, add\_start=\textcolor{keyword}{False}, add\_end=\textcolor{keyword}{False})
231             self.assertEqual(out[\textcolor{stringliteral}{'text\_vec'}].tolist(), [1, 2, 3])
232             \textcolor{comment}{# note that label could be either label above}
233             self.assertNotEqual(out[lab\_vec][0].item(), MockDict.BEG\_IDX)
234             self.assertNotEqual(out[lab\_vec][-1].item(), MockDict.END\_IDX)
235             self.assertEqual(out[lab\_chc][:2], \textcolor{stringliteral}{'Do'})
236 
237             \textcolor{comment}{# test caching of tensors}
238             out\_again = agent.vectorize(out, agent.history)
239             \textcolor{comment}{# should have cached result from before}
240             self.assertIs(out[\textcolor{stringliteral}{'text\_vec'}], out\_again[\textcolor{stringliteral}{'text\_vec'}])
241             self.assertEqual(out[\textcolor{stringliteral}{'text\_vec'}].tolist(), [1, 2, 3])
242             \textcolor{comment}{# next: should truncate cached result}
243             prev\_vec = out[\textcolor{stringliteral}{'text\_vec'}]
244             out\_again = agent.vectorize(out, agent.history, text\_truncate=1)
245             self.assertIsNot(prev\_vec, out\_again[\textcolor{stringliteral}{'text\_vec'}])
246             self.assertEqual(out[\textcolor{stringliteral}{'text\_vec'}].tolist(), [3])
247 
248         \textcolor{comment}{# test split\_lines}
249         agent = \hyperlink{namespacetests_1_1test__torch__agent_ae929d109305aaea29fbfa13ecf1f32e9}{get\_agent}(split\_lines=\textcolor{keyword}{True})
250         obs = Message(
251             \{
252                 \textcolor{stringliteral}{'text'}: \textcolor{stringliteral}{'Hello.\(\backslash\)nMy name is Inogo Montoya.\(\backslash\)n'}
253                 \textcolor{stringliteral}{'You killed my father.\(\backslash\)nPrepare to die.'},
254                 \textcolor{stringliteral}{'episode\_done'}: \textcolor{keyword}{True},
255             \}
256         )
257         agent.history.update\_history(obs)
258         vecs = agent.history.get\_history\_vec\_list()
259         self.assertEqual(vecs, [[1], [1, 2, 3, 4, 5], [1, 2, 3, 4], [1, 2, 3]])
260 
261         \textcolor{comment}{# check cache}
262         out\_again = agent.vectorize(obs, agent.history)
263         vecs = agent.history.get\_history\_vec\_list()
264         self.assertEqual(vecs, [[1], [1, 2, 3, 4, 5], [1, 2, 3, 4], [1, 2, 3]])
265 
\end{DoxyCode}


The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
tests/\hyperlink{test__torch__agent_8py}{test\+\_\+torch\+\_\+agent.\+py}\end{DoxyCompactItemize}
