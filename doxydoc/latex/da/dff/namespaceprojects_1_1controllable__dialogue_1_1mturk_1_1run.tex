\hypertarget{namespaceprojects_1_1controllable__dialogue_1_1mturk_1_1run}{}\section{projects.\+controllable\+\_\+dialogue.\+mturk.\+run Namespace Reference}
\label{namespaceprojects_1_1controllable__dialogue_1_1mturk_1_1run}\index{projects.\+controllable\+\_\+dialogue.\+mturk.\+run@{projects.\+controllable\+\_\+dialogue.\+mturk.\+run}}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{namespaceprojects_1_1controllable__dialogue_1_1mturk_1_1run_a535cc92a62da8a5bd2541bac398e3c14}{main} ()
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{namespaceprojects_1_1controllable__dialogue_1_1mturk_1_1run_a64b64f72355020479b4a864813c0159c}{S\+E\+T\+T\+I\+N\+G\+S\+\_\+\+T\+O\+\_\+\+R\+UN}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\mbox{\Hypertarget{namespaceprojects_1_1controllable__dialogue_1_1mturk_1_1run_a535cc92a62da8a5bd2541bac398e3c14}\label{namespaceprojects_1_1controllable__dialogue_1_1mturk_1_1run_a535cc92a62da8a5bd2541bac398e3c14}} 
\index{projects\+::controllable\+\_\+dialogue\+::mturk\+::run@{projects\+::controllable\+\_\+dialogue\+::mturk\+::run}!main@{main}}
\index{main@{main}!projects\+::controllable\+\_\+dialogue\+::mturk\+::run@{projects\+::controllable\+\_\+dialogue\+::mturk\+::run}}
\subsubsection{\texorpdfstring{main()}{main()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+mturk.\+run.\+main (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}

\begin{DoxyVerb}This task consists of an MTurk agent evaluating a Controllable Dialog model.
\end{DoxyVerb}
 

Definition at line 77 of file run.\+py.


\begin{DoxyCode}
77 \textcolor{keyword}{def }\hyperlink{namespaceprojects_1_1wizard__of__wikipedia_1_1mturk__evaluation__task_1_1run_ad3ab2c71f8083c3112815c0b363d316b}{main}():
78     \textcolor{stringliteral}{"""}
79 \textcolor{stringliteral}{    This task consists of an MTurk agent evaluating a Controllable Dialog model.}
80 \textcolor{stringliteral}{    """}
81     start\_time = datetime.datetime.today().strftime(\textcolor{stringliteral}{'%Y-%m-%d-%H-%M'})
82     argparser = ParlaiParser(\textcolor{keyword}{False}, add\_model\_args=\textcolor{keyword}{True})
83     argparser.add\_parlai\_data\_path()
84     argparser.add\_mturk\_args()
85     argparser.add\_argument(
86         \textcolor{stringliteral}{'--max-resp-time'},
87         default=240,
88         type=int,
89         help=\textcolor{stringliteral}{'time limit for entering a dialog message'},
90     )
91     argparser.add\_argument(
92         \textcolor{stringliteral}{'--max-choice-time'},
93         type=int,
94         default=300,
95         help=\textcolor{stringliteral}{'time limit for turker'} \textcolor{stringliteral}{'choosing the topic'},
96     )
97     argparser.add\_argument(
98         \textcolor{stringliteral}{'--ag-shutdown-time'},
99         default=120,
100         type=int,
101         help=\textcolor{stringliteral}{'time limit for entering a dialog message'},
102     )
103     argparser.add\_argument(
104         \textcolor{stringliteral}{'--num-turns'}, default=6, type=int, help=\textcolor{stringliteral}{'number of turns of dialogue'}
105     )
106     argparser.add\_argument(
107         \textcolor{stringliteral}{'--human-eval'},
108         type=\textcolor{stringliteral}{'bool'},
109         default=\textcolor{keyword}{False},
110         help=\textcolor{stringliteral}{'human vs human eval, no models involved'},
111     )
112     argparser.add\_argument(
113         \textcolor{stringliteral}{'--auto-approve-delay'},
114         type=int,
115         default=3600 * 24 * 2,
116         help=\textcolor{stringliteral}{'how long to wait for auto approval'},
117     )
118     argparser.add\_argument(
119         \textcolor{stringliteral}{'--only-masters'},
120         type=\textcolor{stringliteral}{'bool'},
121         default=\textcolor{keyword}{False},
122         help=\textcolor{stringliteral}{'Set to true to use only master turks for '} \textcolor{stringliteral}{'this test eval'},
123     )
124     argparser.add\_argument(
125         \textcolor{stringliteral}{'--create-model-qualif'},
126         type=\textcolor{stringliteral}{'bool'},
127         default=\textcolor{keyword}{True},
128         help=\textcolor{stringliteral}{'Create model qualif so unique eval between'} \textcolor{stringliteral}{'models.'},
129     )
130     argparser.add\_argument(
131         \textcolor{stringliteral}{'--limit-workers'},
132         type=int,
133         default=len(SETTINGS\_TO\_RUN),
134         help=\textcolor{stringliteral}{'max HITs a worker can complete'},
135     )
136     argparser.add\_argument(
137         \textcolor{stringliteral}{'--mturk-log'},
138         type=str,
139         default=(\textcolor{stringliteral}{'data/mturklogs/controllable/\{\}.log'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(start\_time)),
140     )
141     argparser.add\_argument(
142         \textcolor{stringliteral}{'--short-eval'},
143         type=\textcolor{stringliteral}{'bool'},
144         default=\textcolor{keyword}{True},
145         help=\textcolor{stringliteral}{'Only ask engagingness question and persona'} \textcolor{stringliteral}{'question.'},
146     )
147     \textcolor{comment}{# persona specific arguments}
148     argparser.add\_argument(
149         \textcolor{stringliteral}{'--persona-type'}, type=str, default=\textcolor{stringliteral}{'self'}, choices=[\textcolor{stringliteral}{'self'}, \textcolor{stringliteral}{'other'}, \textcolor{stringliteral}{'none'}]
150     )
151     argparser.add\_argument(
152         \textcolor{stringliteral}{'--persona-datatype'},
153         type=str,
154         default=\textcolor{stringliteral}{'valid'},
155         choices=[\textcolor{stringliteral}{'train'}, \textcolor{stringliteral}{'test'}, \textcolor{stringliteral}{'valid'}],
156     )
157     argparser.add\_argument(
158         \textcolor{stringliteral}{'--max-persona-time'}, type=int, default=360, help=\textcolor{stringliteral}{'max time to view persona'}
159     )
160 
161     \textcolor{keyword}{def }get\_logger(opt):
162         fmt = \textcolor{stringliteral}{'%(asctime)s: [ %(message)s ]'}
163         logfn = \textcolor{keywordtype}{None}
164         \textcolor{keywordflow}{if} \textcolor{stringliteral}{'mturk\_log'} \textcolor{keywordflow}{in} opt:
165             logfn = opt[\textcolor{stringliteral}{'mturk\_log'}]
166             \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} os.path.isdir(os.path.dirname(logfn)):
167                 os.makedirs(os.path.dirname(logfn), exist\_ok=\textcolor{keyword}{True})
168         logger = ParlaiLogger(
169             name=\textcolor{stringliteral}{"mturk\_controllable"},
170             console\_level=INFO,
171             file\_level=INFO,
172             console\_format=fmt,
173             file\_format=fmt,
174             filename=logfn,
175         )
176         logger.info(\textcolor{stringliteral}{'COMMAND: %s'} % \textcolor{stringliteral}{' '}.join(sys.argv))
177         logger.info(\textcolor{stringliteral}{'-'} * 100)
178         logger.info(\textcolor{stringliteral}{'CONFIG:\(\backslash\)n%s'} % json.dumps(opt, indent=4, sort\_keys=\textcolor{keyword}{True}))
179 
180         \textcolor{keywordflow}{return} logger
181 
182     start\_opt = argparser.parse\_args()
183 
184     task\_config[\textcolor{stringliteral}{'task\_description'}] = task\_config[\textcolor{stringliteral}{'task\_description'}].\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
185         start\_opt[\textcolor{stringliteral}{'reward'}]
186     )
187 
188     \textcolor{comment}{# set options}
189     start\_opt[\textcolor{stringliteral}{'limit\_workers'}] = len(SETTINGS\_TO\_RUN)
190     start\_opt[\textcolor{stringliteral}{'allowed\_conversations'}] = 1
191     start\_opt[\textcolor{stringliteral}{'max\_hits\_per\_worker'}] = start\_opt[\textcolor{stringliteral}{'limit\_workers'}]
192     start\_opt[\textcolor{stringliteral}{'task'}] = os.path.basename(os.path.dirname(os.path.abspath(\_\_file\_\_)))
193 
194     start\_opt.update(task\_config)
195 
196     logger = get\_logger(start\_opt)
197 
198     model\_share\_params = \{\}
199     worker\_models\_seen = \{\}
200     model\_opts = \{\}
201     model\_counts = \{\}
202 
203     lock = Lock()
204 
205     \textcolor{keywordflow}{for} setup \textcolor{keywordflow}{in} SETTINGS\_TO\_RUN:
206         \textcolor{keyword}{assert} \textcolor{stringliteral}{'human'} \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} setup
207         model\_counts[setup] = 0
208         agent\_config = getattr(mcf, setup)
209         combined\_config = copy.deepcopy(start\_opt)
210         \textcolor{keywordflow}{for} k, v \textcolor{keywordflow}{in} agent\_config.items():
211             combined\_config[k] = v
212             combined\_config[\textcolor{stringliteral}{'override'}][k] = v
213         folder\_name = \textcolor{stringliteral}{'\{\}-\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(setup, start\_time)
214         combined\_config[\textcolor{stringliteral}{'save\_data\_path'}] = os.path.join(
215             start\_opt[\textcolor{stringliteral}{'datapath'}], \textcolor{stringliteral}{'local\_controllable\_dialogue'}, folder\_name
216         )
217         model\_opts[setup] = combined\_config
218         bot = \hyperlink{namespaceparlai_1_1core_1_1agents_a00d77a7e26fb89e8bd900f7b2a02982a}{create\_agent}(combined\_config, \textcolor{keyword}{True})
219         model\_share\_params[setup] = bot.share()
220 
221     \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} start\_opt.get(\textcolor{stringliteral}{'human\_eval'}):
222         mturk\_agent\_ids = [\textcolor{stringliteral}{'PERSON\_1'}]
223     \textcolor{keywordflow}{else}:
224         mturk\_agent\_ids = [\textcolor{stringliteral}{'PERSON\_1'}, \textcolor{stringliteral}{'PERSON\_2'}]
225 
226     mturk\_manager = MTurkManager(opt=start\_opt, mturk\_agent\_ids=mturk\_agent\_ids)
227 
228     personas\_generator = PersonasGenerator(start\_opt)
229 
230     directory\_path = os.path.dirname(os.path.abspath(\_\_file\_\_))
231 
232     mturk\_manager.setup\_server(task\_directory\_path=directory\_path)
233 
234     \textcolor{keywordflow}{try}:
235         mturk\_manager.start\_new\_run()
236         agent\_qualifications = []
237         \textcolor{comment}{# assign qualifications}
238         \textcolor{keywordflow}{if} start\_opt[\textcolor{stringliteral}{'create\_model\_qualif'}]:
239             qual\_name = \textcolor{stringliteral}{'ControlEvalRound2'}
240             qual\_desc = (
241                 \textcolor{stringliteral}{'Qualification to ensure workers complete only a certain'}
242                 \textcolor{stringliteral}{'number of these HITs'}
243             )
244             qualification\_id = mturk\_utils.find\_or\_create\_qualification(
245                 qual\_name, qual\_desc, \textcolor{keyword}{False}
246             )
247             print(\textcolor{stringliteral}{'Created qualification: '}, qualification\_id)
248             start\_opt[\textcolor{stringliteral}{'unique\_qualif\_id'}] = qualification\_id
249 
250         \textcolor{keyword}{def }run\_onboard(worker):
251             worker.personas\_generator = personas\_generator
252             world = PersonaAssignWorld(start\_opt, worker)
253             world.parley()
254             world.shutdown()
255 
256         \textcolor{keyword}{def }check\_worker\_eligibility(worker):
257             worker\_id = worker.worker\_id
258             lock.acquire()
259             retval = len(worker\_models\_seen.get(worker\_id, [])) < len(SETTINGS\_TO\_RUN)
260             lock.release()
261             \textcolor{keywordflow}{return} retval
262 
263         \textcolor{keyword}{def }assign\_worker\_roles(workers):
264             \textcolor{keywordflow}{for} index, worker \textcolor{keywordflow}{in} enumerate(workers):
265                 worker.id = mturk\_agent\_ids[index % len(mturk\_agent\_ids)]
266 
267         mturk\_manager.set\_onboard\_function(onboard\_function=run\_onboard)
268         mturk\_manager.ready\_to\_accept\_workers()
269         mturk\_manager.create\_hits(qualifications=agent\_qualifications)
270 
271         \textcolor{keyword}{def }run\_conversation(mturk\_manager, opt, workers):
272             conv\_idx = mturk\_manager.conversation\_index
273 
274             \textcolor{comment}{# gotta find a bot this worker hasn't seen yet}
275             \textcolor{keyword}{assert} len(workers) == 1
276             worker\_id = workers[0].worker\_id
277             lock.acquire()
278             \textcolor{keywordflow}{if} worker\_id \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} worker\_models\_seen:
279                 worker\_models\_seen[worker\_id] = set()
280             print(\textcolor{stringliteral}{"MODELCOUNTS:"})
281             print(pprint.pformat(model\_counts))
282             logger.info(\textcolor{stringliteral}{"MODELCOUNTS\(\backslash\)n"} + pprint.pformat(model\_counts))
283             model\_options = [
284                 (model\_counts[setup\_name] + 10 * random.random(), setup\_name)
285                 \textcolor{keywordflow}{for} setup\_name \textcolor{keywordflow}{in} SETTINGS\_TO\_RUN
286                 \textcolor{keywordflow}{if} setup\_name \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} worker\_models\_seen[worker\_id]
287             ]
288             \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} model\_options:
289                 lock.release()
290                 logger.error(
291                     \textcolor{stringliteral}{"Worker \{\} already finished all settings! Returning none"}.
      \hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
292                         worker\_id
293                     )
294                 )
295                 \textcolor{keywordflow}{return} \textcolor{keywordtype}{None}
296             \_, model\_choice = min(model\_options)
297 
298             worker\_models\_seen[worker\_id].add(model\_choice)
299             model\_counts[model\_choice] += 1
300             lock.release()
301 
302             world = ControllableDialogEval(
303                 opt=model\_opts[model\_choice],
304                 agents=workers,
305                 num\_turns=start\_opt[\textcolor{stringliteral}{'num\_turns'}],
306                 max\_resp\_time=start\_opt[\textcolor{stringliteral}{'max\_resp\_time'}],
307                 model\_agent\_opt=model\_share\_params[model\_choice],
308                 world\_tag=\textcolor{stringliteral}{'conversation t\_\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(conv\_idx),
309                 agent\_timeout\_shutdown=opt[\textcolor{stringliteral}{'ag\_shutdown\_time'}],
310                 model\_config=model\_choice,
311             )
312             world.reset\_random()
313             \textcolor{keywordflow}{while} \textcolor{keywordflow}{not} world.episode\_done():
314                 world.parley()
315             world.save\_data()
316 
317             lock.acquire()
318             \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} world.convo\_finished:
319                 model\_counts[model\_choice] -= 1
320                 worker\_models\_seen[worker\_id].remove(model\_choice)
321             lock.release()
322 
323             world.shutdown()
324             gc.collect()
325 
326         mturk\_manager.start\_task(
327             eligibility\_function=check\_worker\_eligibility,
328             assign\_role\_function=assign\_worker\_roles,
329             task\_function=run\_conversation,
330         )
331 
332     \textcolor{keywordflow}{except} BaseException:
333         \textcolor{keywordflow}{raise}
334     \textcolor{keywordflow}{finally}:
335         mturk\_manager.expire\_all\_unassigned\_hits()
336         mturk\_manager.shutdown()
337 
338 
\end{DoxyCode}


\subsection{Variable Documentation}
\mbox{\Hypertarget{namespaceprojects_1_1controllable__dialogue_1_1mturk_1_1run_a64b64f72355020479b4a864813c0159c}\label{namespaceprojects_1_1controllable__dialogue_1_1mturk_1_1run_a64b64f72355020479b4a864813c0159c}} 
\index{projects\+::controllable\+\_\+dialogue\+::mturk\+::run@{projects\+::controllable\+\_\+dialogue\+::mturk\+::run}!S\+E\+T\+T\+I\+N\+G\+S\+\_\+\+T\+O\+\_\+\+R\+UN@{S\+E\+T\+T\+I\+N\+G\+S\+\_\+\+T\+O\+\_\+\+R\+UN}}
\index{S\+E\+T\+T\+I\+N\+G\+S\+\_\+\+T\+O\+\_\+\+R\+UN@{S\+E\+T\+T\+I\+N\+G\+S\+\_\+\+T\+O\+\_\+\+R\+UN}!projects\+::controllable\+\_\+dialogue\+::mturk\+::run@{projects\+::controllable\+\_\+dialogue\+::mturk\+::run}}
\subsubsection{\texorpdfstring{S\+E\+T\+T\+I\+N\+G\+S\+\_\+\+T\+O\+\_\+\+R\+UN}{SETTINGS\_TO\_RUN}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+mturk.\+run.\+S\+E\+T\+T\+I\+N\+G\+S\+\_\+\+T\+O\+\_\+\+R\+UN}



Definition at line 45 of file run.\+py.

