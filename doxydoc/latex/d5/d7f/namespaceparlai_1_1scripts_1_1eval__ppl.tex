\hypertarget{namespaceparlai_1_1scripts_1_1eval__ppl}{}\section{parlai.\+scripts.\+eval\+\_\+ppl Namespace Reference}
\label{namespaceparlai_1_1scripts_1_1eval__ppl}\index{parlai.\+scripts.\+eval\+\_\+ppl@{parlai.\+scripts.\+eval\+\_\+ppl}}
\subsection*{Classes}
\begin{DoxyCompactItemize}
\item 
class \hyperlink{classparlai_1_1scripts_1_1eval__ppl_1_1PerplexityWorld}{Perplexity\+World}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{namespaceparlai_1_1scripts_1_1eval__ppl_a4ae22cc04e19c46ed621afeba6e85d67}{setup\+\_\+args} (\hyperlink{namespaceparlai_1_1scripts_1_1eval__ppl_a83ff19dbdfc8e059be5126ecfb0804ae}{parser}=None)
\item 
def \hyperlink{namespaceparlai_1_1scripts_1_1eval__ppl_ad1a8a8891f276136e82edc906ea58340}{eval\+\_\+ppl} (\hyperlink{namespaceparlai_1_1scripts_1_1eval__ppl_a0e79f76660ddfdf2c00a552f50edaec6}{opt}, build\+\_\+dict=None, \hyperlink{namespaceparlai_1_1scripts_1_1eval__ppl_a9f9177d01476851d8e9923f2c624fd4e}{dict\+\_\+file}=None)
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{namespaceparlai_1_1scripts_1_1eval__ppl_a83ff19dbdfc8e059be5126ecfb0804ae}{parser}
\item 
\hyperlink{namespaceparlai_1_1scripts_1_1eval__ppl_a0e79f76660ddfdf2c00a552f50edaec6}{opt}
\item 
\hyperlink{namespaceparlai_1_1scripts_1_1eval__ppl_a9f9177d01476851d8e9923f2c624fd4e}{dict\+\_\+file}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\mbox{\Hypertarget{namespaceparlai_1_1scripts_1_1eval__ppl_ad1a8a8891f276136e82edc906ea58340}\label{namespaceparlai_1_1scripts_1_1eval__ppl_ad1a8a8891f276136e82edc906ea58340}} 
\index{parlai\+::scripts\+::eval\+\_\+ppl@{parlai\+::scripts\+::eval\+\_\+ppl}!eval\+\_\+ppl@{eval\+\_\+ppl}}
\index{eval\+\_\+ppl@{eval\+\_\+ppl}!parlai\+::scripts\+::eval\+\_\+ppl@{parlai\+::scripts\+::eval\+\_\+ppl}}
\subsubsection{\texorpdfstring{eval\+\_\+ppl()}{eval\_ppl()}}
{\footnotesize\ttfamily def parlai.\+scripts.\+eval\+\_\+ppl.\+eval\+\_\+ppl (\begin{DoxyParamCaption}\item[{}]{opt,  }\item[{}]{build\+\_\+dict = {\ttfamily None},  }\item[{}]{dict\+\_\+file = {\ttfamily None} }\end{DoxyParamCaption})}

\begin{DoxyVerb}Evaluates the the perplexity of a model.

This uses a dictionary which implements the following functions:
- tokenize(text): splits string up into list of tokens
- __in__(text): checks whether dictionary contains a token
- keys(): returns an iterator over all tokens in the dictionary

:param opt: option dict
:param build_dict: function which returns a dictionary class implementing
    the functions above.
:param dict_file: file used when loading the dictionary class set via the
    "dictionary_class" argument (defaults to
    parlai.core.dict:DictionaryAgent).

Either build_dict or dict_file must be set (both default to None) to
determine the dictionary used for the evaluation.
\end{DoxyVerb}
 

Definition at line 182 of file eval\+\_\+ppl.\+py.


\begin{DoxyCode}
182 \textcolor{keyword}{def }\hyperlink{namespaceprojects_1_1convai2_1_1eval__ppl_a417da48148c825ed1f5d6897cef06819}{eval\_ppl}(opt, build\_dict=None, dict\_file=None):
183     \textcolor{stringliteral}{"""}
184 \textcolor{stringliteral}{    Evaluates the the perplexity of a model.}
185 \textcolor{stringliteral}{}
186 \textcolor{stringliteral}{    This uses a dictionary which implements the following functions:}
187 \textcolor{stringliteral}{    - tokenize(text): splits string up into list of tokens}
188 \textcolor{stringliteral}{    - \_\_in\_\_(text): checks whether dictionary contains a token}
189 \textcolor{stringliteral}{    - keys(): returns an iterator over all tokens in the dictionary}
190 \textcolor{stringliteral}{}
191 \textcolor{stringliteral}{    :param opt: option dict}
192 \textcolor{stringliteral}{    :param build\_dict: function which returns a dictionary class implementing}
193 \textcolor{stringliteral}{        the functions above.}
194 \textcolor{stringliteral}{    :param dict\_file: file used when loading the dictionary class set via the}
195 \textcolor{stringliteral}{        "dictionary\_class" argument (defaults to}
196 \textcolor{stringliteral}{        parlai.core.dict:DictionaryAgent).}
197 \textcolor{stringliteral}{}
198 \textcolor{stringliteral}{    Either build\_dict or dict\_file must be set (both default to None) to}
199 \textcolor{stringliteral}{    determine the dictionary used for the evaluation.}
200 \textcolor{stringliteral}{    """}
201     \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} build\_dict \textcolor{keywordflow}{and} \textcolor{keywordflow}{not} dict\_file:
202         \textcolor{keywordflow}{raise} RuntimeError(
203             \textcolor{stringliteral}{'eval\_ppl script either needs a dictionary build '}
204             \textcolor{stringliteral}{'function or a dictionary file.'}
205         )
206 
207     \textcolor{keywordflow}{if} build\_dict:
208         dict\_agent = \hyperlink{namespacebuild__dict}{build\_dict}()
209     \textcolor{keywordflow}{else}:
210         dict\_opt = copy.deepcopy(opt)
211         dict\_opt[\textcolor{stringliteral}{'model'}] = dict\_opt.get(
212             \textcolor{stringliteral}{'dictionary\_class'}, \textcolor{stringliteral}{'parlai.core.dict:DictionaryAgent'}
213         )
214         dict\_opt[\textcolor{stringliteral}{'model\_file'}] = dict\_file
215         \textcolor{keywordflow}{if} \textcolor{stringliteral}{'override'} \textcolor{keywordflow}{in} dict\_opt:
216             del dict\_opt[\textcolor{stringliteral}{'override'}]
217         dict\_agent = \hyperlink{namespaceparlai_1_1core_1_1agents_a00d77a7e26fb89e8bd900f7b2a02982a}{create\_agent}(dict\_opt, requireModelExists=\textcolor{keyword}{True})
218 
219     \textcolor{comment}{# create agents}
220     agent = \hyperlink{namespaceparlai_1_1core_1_1agents_a00d77a7e26fb89e8bd900f7b2a02982a}{create\_agent}(opt)
221     world = \hyperlink{namespaceparlai_1_1core_1_1worlds_a79969c7ba76d4b3c500f5bb776444dc6}{create\_task}(opt, [agent, dict\_agent], default\_world=PerplexityWorld)
222 
223     \textcolor{comment}{# set up logging}
224     log\_time = Timer()
225     tot\_time = 0
226 
227     \textcolor{keywordflow}{while} \textcolor{keywordflow}{not} world.epoch\_done():
228         world.parley()  \textcolor{comment}{# process an example}
229 
230         \textcolor{keywordflow}{if} log\_time.time() > 1:  \textcolor{comment}{# log every 1 sec}
231             tot\_time += log\_time.time()
232             report = world.report()
233             print(
234                 \textcolor{stringliteral}{'\{\}s elapsed, \{\}%% complete, \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
235                     \hyperlink{namespacelanguage__model_1_1eval__ppl_a7d12ee00479673c5c8d1f6d01faa272a}{int}(tot\_time),
236                     \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1utils__v0_af377ec61bfc0423461e7b409ffc883b9}{round\_sigfigs}(report[\textcolor{stringliteral}{'exs'}] / world.num\_examples() * 100, 3),
237                     report,
238                 )
239             )
240             log\_time.reset()
241     print(\textcolor{stringliteral}{'EPOCH DONE'})
242     tot\_time += log\_time.time()
243     final\_report = world.report()
244     print(\textcolor{stringliteral}{'\{\}s elapsed: \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(\hyperlink{namespacelanguage__model_1_1eval__ppl_a7d12ee00479673c5c8d1f6d01faa272a}{int}(tot\_time), final\_report))
245     print(\textcolor{stringliteral}{"============================"})
246     print(\textcolor{stringliteral}{"FINAL PPL: "} + \hyperlink{namespacegenerate__task__READMEs_a5b88452ffb87b78c8c85ececebafc09f}{str}(final\_report[\textcolor{stringliteral}{'ppl'}]))
247     \textcolor{keywordflow}{if} final\_report.get(\textcolor{stringliteral}{'ppl'}, 0) == \hyperlink{namespaceprojects_1_1controllable__dialogue_1_1make__control__dataset_aa2b7207688c641dbc094ab44eca27113}{float}(\textcolor{stringliteral}{'inf'}):
248         print(
249             \textcolor{stringliteral}{'Note: you got inf perplexity. Consider adding (or raising) the '}
250             \textcolor{stringliteral}{'minimum probability you assign to each possible word. If you '}
251             \textcolor{stringliteral}{'assign zero probability to the correct token in the evaluation '}
252             \textcolor{stringliteral}{'vocabulary, you get inf probability immediately.'}
253         )
254 
255 
\end{DoxyCode}
\mbox{\Hypertarget{namespaceparlai_1_1scripts_1_1eval__ppl_a4ae22cc04e19c46ed621afeba6e85d67}\label{namespaceparlai_1_1scripts_1_1eval__ppl_a4ae22cc04e19c46ed621afeba6e85d67}} 
\index{parlai\+::scripts\+::eval\+\_\+ppl@{parlai\+::scripts\+::eval\+\_\+ppl}!setup\+\_\+args@{setup\+\_\+args}}
\index{setup\+\_\+args@{setup\+\_\+args}!parlai\+::scripts\+::eval\+\_\+ppl@{parlai\+::scripts\+::eval\+\_\+ppl}}
\subsubsection{\texorpdfstring{setup\+\_\+args()}{setup\_args()}}
{\footnotesize\ttfamily def parlai.\+scripts.\+eval\+\_\+ppl.\+setup\+\_\+args (\begin{DoxyParamCaption}\item[{}]{parser = {\ttfamily None} }\end{DoxyParamCaption})}



Definition at line 47 of file eval\+\_\+ppl.\+py.


\begin{DoxyCode}
47 \textcolor{keyword}{def }\hyperlink{namespaceprojects_1_1convai2_1_1eval__ppl_ac83f1cd52a81f455fc2e726d76e1100e}{setup\_args}(parser=None):
48     \textcolor{keywordflow}{if} parser \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
49         parser = ParlaiParser(\textcolor{keyword}{True}, \textcolor{keyword}{True}, \textcolor{stringliteral}{'Evaluate perplexity'})
50     parser.add\_pytorch\_datateacher\_args()
51     parser.set\_defaults(datatype=\textcolor{stringliteral}{'valid'})
52     \textcolor{keywordflow}{return} parser
53 
54 
\end{DoxyCode}


\subsection{Variable Documentation}
\mbox{\Hypertarget{namespaceparlai_1_1scripts_1_1eval__ppl_a9f9177d01476851d8e9923f2c624fd4e}\label{namespaceparlai_1_1scripts_1_1eval__ppl_a9f9177d01476851d8e9923f2c624fd4e}} 
\index{parlai\+::scripts\+::eval\+\_\+ppl@{parlai\+::scripts\+::eval\+\_\+ppl}!dict\+\_\+file@{dict\+\_\+file}}
\index{dict\+\_\+file@{dict\+\_\+file}!parlai\+::scripts\+::eval\+\_\+ppl@{parlai\+::scripts\+::eval\+\_\+ppl}}
\subsubsection{\texorpdfstring{dict\+\_\+file}{dict\_file}}
{\footnotesize\ttfamily parlai.\+scripts.\+eval\+\_\+ppl.\+dict\+\_\+file}



Definition at line 260 of file eval\+\_\+ppl.\+py.

\mbox{\Hypertarget{namespaceparlai_1_1scripts_1_1eval__ppl_a0e79f76660ddfdf2c00a552f50edaec6}\label{namespaceparlai_1_1scripts_1_1eval__ppl_a0e79f76660ddfdf2c00a552f50edaec6}} 
\index{parlai\+::scripts\+::eval\+\_\+ppl@{parlai\+::scripts\+::eval\+\_\+ppl}!opt@{opt}}
\index{opt@{opt}!parlai\+::scripts\+::eval\+\_\+ppl@{parlai\+::scripts\+::eval\+\_\+ppl}}
\subsubsection{\texorpdfstring{opt}{opt}}
{\footnotesize\ttfamily parlai.\+scripts.\+eval\+\_\+ppl.\+opt}



Definition at line 259 of file eval\+\_\+ppl.\+py.

\mbox{\Hypertarget{namespaceparlai_1_1scripts_1_1eval__ppl_a83ff19dbdfc8e059be5126ecfb0804ae}\label{namespaceparlai_1_1scripts_1_1eval__ppl_a83ff19dbdfc8e059be5126ecfb0804ae}} 
\index{parlai\+::scripts\+::eval\+\_\+ppl@{parlai\+::scripts\+::eval\+\_\+ppl}!parser@{parser}}
\index{parser@{parser}!parlai\+::scripts\+::eval\+\_\+ppl@{parlai\+::scripts\+::eval\+\_\+ppl}}
\subsubsection{\texorpdfstring{parser}{parser}}
{\footnotesize\ttfamily parlai.\+scripts.\+eval\+\_\+ppl.\+parser}



Definition at line 257 of file eval\+\_\+ppl.\+py.

