\hypertarget{namespaceparlai_1_1mturk_1_1tasks_1_1convai2__model__eval_1_1run}{}\section{parlai.\+mturk.\+tasks.\+convai2\+\_\+model\+\_\+eval.\+run Namespace Reference}
\label{namespaceparlai_1_1mturk_1_1tasks_1_1convai2__model__eval_1_1run}\index{parlai.\+mturk.\+tasks.\+convai2\+\_\+model\+\_\+eval.\+run@{parlai.\+mturk.\+tasks.\+convai2\+\_\+model\+\_\+eval.\+run}}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{namespaceparlai_1_1mturk_1_1tasks_1_1convai2__model__eval_1_1run_a1624989606bd5fc34368102c32217178}{main} ()
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{namespaceparlai_1_1mturk_1_1tasks_1_1convai2__model__eval_1_1run_a63cb34690751acca7e0414826bc09a0b}{M\+A\+S\+T\+E\+R\+\_\+\+Q\+U\+A\+L\+IF}
\item 
\hyperlink{namespaceparlai_1_1mturk_1_1tasks_1_1convai2__model__eval_1_1run_a84e5489445f1458f929ce705e84edd4f}{M\+A\+S\+T\+E\+R\+\_\+\+Q\+U\+A\+L\+I\+F\+\_\+\+S\+D\+B\+OX}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1tasks_1_1convai2__model__eval_1_1run_a1624989606bd5fc34368102c32217178}\label{namespaceparlai_1_1mturk_1_1tasks_1_1convai2__model__eval_1_1run_a1624989606bd5fc34368102c32217178}} 
\index{parlai\+::mturk\+::tasks\+::convai2\+\_\+model\+\_\+eval\+::run@{parlai\+::mturk\+::tasks\+::convai2\+\_\+model\+\_\+eval\+::run}!main@{main}}
\index{main@{main}!parlai\+::mturk\+::tasks\+::convai2\+\_\+model\+\_\+eval\+::run@{parlai\+::mturk\+::tasks\+::convai2\+\_\+model\+\_\+eval\+::run}}
\subsubsection{\texorpdfstring{main()}{main()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+tasks.\+convai2\+\_\+model\+\_\+eval.\+run.\+main (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}

\begin{DoxyVerb}This task consists of an MTurk agent evaluating a chit-chat model.

They are asked to chat to the model adopting a specific persona. After their
conversation, they are asked to evaluate their partner on several metrics.
\end{DoxyVerb}
 

Definition at line 28 of file run.\+py.


\begin{DoxyCode}
28 \textcolor{keyword}{def }\hyperlink{namespaceprojects_1_1wizard__of__wikipedia_1_1mturk__evaluation__task_1_1run_ad3ab2c71f8083c3112815c0b363d316b}{main}():
29     \textcolor{stringliteral}{"""}
30 \textcolor{stringliteral}{    This task consists of an MTurk agent evaluating a chit-chat model.}
31 \textcolor{stringliteral}{}
32 \textcolor{stringliteral}{    They are asked to chat to the model adopting a specific persona. After their}
33 \textcolor{stringliteral}{    conversation, they are asked to evaluate their partner on several metrics.}
34 \textcolor{stringliteral}{    """}
35     argparser = ParlaiParser(\textcolor{keyword}{False}, add\_model\_args=\textcolor{keyword}{True})
36     argparser.add\_parlai\_data\_path()
37     argparser.add\_mturk\_args()
38     argparser.add\_argument(
39         \textcolor{stringliteral}{'-mt'}, \textcolor{stringliteral}{'--max-turns'}, default=10, type=int, help=\textcolor{stringliteral}{'maximal number of chat turns'}
40     )
41     argparser.add\_argument(
42         \textcolor{stringliteral}{'--max-resp-time'},
43         default=240,
44         type=int,
45         help=\textcolor{stringliteral}{'time limit for entering a dialog message'},
46     )
47     argparser.add\_argument(
48         \textcolor{stringliteral}{'--max-persona-time'},
49         type=int,
50         default=300,
51         help=\textcolor{stringliteral}{'time limit for turker'} \textcolor{stringliteral}{'entering the persona'},
52     )
53     argparser.add\_argument(
54         \textcolor{stringliteral}{'--ag-shutdown-time'},
55         default=120,
56         type=int,
57         help=\textcolor{stringliteral}{'time limit for entering a dialog message'},
58     )
59     argparser.add\_argument(
60         \textcolor{stringliteral}{'--persona-type'},
61         default=\textcolor{stringliteral}{'both'},
62         type=str,
63         choices=[\textcolor{stringliteral}{'both'}, \textcolor{stringliteral}{'self'}, \textcolor{stringliteral}{'other'}],
64         help=\textcolor{stringliteral}{'Which personas to load from personachat'},
65     )
66     argparser.add\_argument(
67         \textcolor{stringliteral}{'--revised'}, default=\textcolor{keyword}{False}, type=\textcolor{stringliteral}{'bool'}, help=\textcolor{stringliteral}{'Whether to use revised personas'}
68     )
69     argparser.add\_argument(
70         \textcolor{stringliteral}{'-rt'}, \textcolor{stringliteral}{'--range-turn'}, default=\textcolor{stringliteral}{'5,6'}, help=\textcolor{stringliteral}{'sample range of number of turns'}
71     )
72     argparser.add\_argument(
73         \textcolor{stringliteral}{'--auto-approve-delay'},
74         type=int,
75         default=3600 * 24 * 1,
76         help=\textcolor{stringliteral}{'how long to wait for auto approval'},
77     )
78     argparser.add\_argument(
79         \textcolor{stringliteral}{'--only-masters'},
80         type=\textcolor{stringliteral}{'bool'},
81         default=\textcolor{keyword}{False},
82         help=\textcolor{stringliteral}{'Set to True to use only master turks for this'}
83         + \textcolor{stringliteral}{' test eval, default is %(default)s'},
84     )
85 
86     \textcolor{comment}{# ADD MODEL ARGS HERE, UNCOMMENT TO USE KVMEMNN MODEL AS AN EXAMPLE}
87     \textcolor{comment}{# argparser.set\_defaults(}
88     \textcolor{comment}{#     model='projects.personachat.kvmemnn.kvmemnn:Kvmemnn',}
89     \textcolor{comment}{#     model\_file='models:convai2/kvmemnn/model',}
90     \textcolor{comment}{# )}
91 
92     opt = argparser.parse\_args()
93 
94     \textcolor{comment}{# add additional model args}
95     opt[\textcolor{stringliteral}{'override'}] = \{
96         \textcolor{stringliteral}{'no\_cuda'}: \textcolor{keyword}{True},
97         \textcolor{stringliteral}{'interactive\_mode'}: \textcolor{keyword}{True},
98         \textcolor{stringliteral}{'tensorboard\_log'}: \textcolor{keyword}{False},
99     \}
100 
101     bot = \hyperlink{namespaceparlai_1_1core_1_1agents_ad0d54074d4bcc148bb415ab5515a53b5}{create\_agent}(opt)
102     shared\_bot\_params = bot.share()
103     print(
104         \textcolor{stringliteral}{'=== Actual bot opt === :\(\backslash\)n \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
105             \textcolor{stringliteral}{'\(\backslash\)n'}.join([\textcolor{stringliteral}{"[\{\}] : \{\}"}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(k, v) \textcolor{keywordflow}{for} k, v \textcolor{keywordflow}{in} bot.opt.items()])
106         )
107     )
108     folder\_name = \textcolor{stringliteral}{'master\_\{\}\_YOURCOMMENT\_\_'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(opt[\textcolor{stringliteral}{'only\_masters'}]) + \textcolor{stringliteral}{'\_\_'}.join(
109         [\textcolor{stringliteral}{'\{\}\_\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(k, v) \textcolor{keywordflow}{for} k, v \textcolor{keywordflow}{in} opt[\textcolor{stringliteral}{'override'}].items()]
110     )
111 
112     \textcolor{comment}{#  this is mturk task, not convai2 task from ParlAI}
113     opt[\textcolor{stringliteral}{'task'}] = \textcolor{stringliteral}{'convai2:self'}
114     \textcolor{keywordflow}{if} \textcolor{stringliteral}{'data\_path'} \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} opt:
115         opt[\textcolor{stringliteral}{'data\_path'}] = os.getcwd() + \textcolor{stringliteral}{'/data/'} + folder\_name
116     opt.update(task\_config)
117 
118     mturk\_agent\_ids = [\textcolor{stringliteral}{'PERSON\_1'}]
119 
120     mturk\_manager = MTurkManager(opt=opt, mturk\_agent\_ids=mturk\_agent\_ids)
121 
122     persona\_generator = PersonasGenerator(opt)
123     mturk\_manager.setup\_server()
124 
125     \textcolor{keywordflow}{try}:
126         mturk\_manager.start\_new\_run()
127         agent\_qualifications = []
128         \textcolor{keywordflow}{if} opt[\textcolor{stringliteral}{'only\_masters'}]:
129             \textcolor{keywordflow}{if} opt[\textcolor{stringliteral}{'is\_sandbox'}]:
130                 agent\_qualifications.append(MASTER\_QUALIF\_SDBOX)
131             \textcolor{keywordflow}{else}:
132                 agent\_qualifications.append(MASTER\_QUALIF)
133         mturk\_manager.ready\_to\_accept\_workers()
134         mturk\_manager.create\_hits(qualifications=agent\_qualifications)
135 
136         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} opt[\textcolor{stringliteral}{'is\_sandbox'}]:
137             \textcolor{comment}{# ADD SOFT-BLOCKED WORKERS HERE}
138             \textcolor{comment}{# NOTE: blocking qual *must be* specified}
139             blocked\_worker\_list = []
140             \textcolor{keywordflow}{for} w \textcolor{keywordflow}{in} blocked\_worker\_list:
141                 print(\textcolor{stringliteral}{'Soft Blocking \{\}\(\backslash\)n'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(w))
142                 mturk\_manager.soft\_block\_worker(w)
143                 time.sleep(0.1)  \textcolor{comment}{# do the sleep to prevent amazon query drop}
144 
145         \textcolor{keyword}{def }run\_onboard(worker):
146             worker.persona\_generator = persona\_generator
147             world = PersonaProfileWorld(opt, worker)
148             world.parley()
149             world.shutdown()
150 
151         mturk\_manager.set\_onboard\_function(onboard\_function=run\_onboard)
152 
153         \textcolor{keyword}{def }check\_worker\_eligibility(worker):
154             \textcolor{keywordflow}{return} \textcolor{keyword}{True}
155 
156         \textcolor{keyword}{def }assign\_worker\_roles(workers):
157             \textcolor{keywordflow}{for} index, worker \textcolor{keywordflow}{in} enumerate(workers):
158                 worker.id = mturk\_agent\_ids[index % len(mturk\_agent\_ids)]
159 
160         \textcolor{keyword}{def }run\_conversation(mturk\_manager, opt, workers):
161             agents = workers[0]
162             conv\_idx = mturk\_manager.conversation\_index
163             world = Convai2EvalWorld(
164                 opt=opt,
165                 agents=[agents],
166                 range\_turn=[\hyperlink{namespaceprojects_1_1mastering__the__dungeon_1_1mturk_1_1tasks_1_1MTD_1_1run_a693eb03afbb820bbfe8b47b12e69e519}{int}(s) \textcolor{keywordflow}{for} s \textcolor{keywordflow}{in} opt[\textcolor{stringliteral}{'range\_turn'}].split(\textcolor{stringliteral}{','})],
167                 max\_turn=opt[\textcolor{stringliteral}{'max\_turns'}],
168                 max\_resp\_time=opt[\textcolor{stringliteral}{'max\_resp\_time'}],
169                 model\_agent\_opt=shared\_bot\_params,
170                 world\_tag=\textcolor{stringliteral}{'conversation t\_\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(conv\_idx),
171                 agent\_timeout\_shutdown=opt[\textcolor{stringliteral}{'ag\_shutdown\_time'}],
172             )
173             world.reset\_random()
174             \textcolor{keywordflow}{while} \textcolor{keywordflow}{not} world.episode\_done():
175                 world.parley()
176             world.save\_data()
177 
178             world.shutdown()
179 
180         mturk\_manager.start\_task(
181             eligibility\_function=check\_worker\_eligibility,
182             assign\_role\_function=assign\_worker\_roles,
183             task\_function=run\_conversation,
184         )
185 
186     \textcolor{keywordflow}{except} BaseException:
187         \textcolor{keywordflow}{raise}
188     \textcolor{keywordflow}{finally}:
189         mturk\_manager.expire\_all\_unassigned\_hits()
190         mturk\_manager.shutdown()
191 
192 
\end{DoxyCode}


\subsection{Variable Documentation}
\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1tasks_1_1convai2__model__eval_1_1run_a63cb34690751acca7e0414826bc09a0b}\label{namespaceparlai_1_1mturk_1_1tasks_1_1convai2__model__eval_1_1run_a63cb34690751acca7e0414826bc09a0b}} 
\index{parlai\+::mturk\+::tasks\+::convai2\+\_\+model\+\_\+eval\+::run@{parlai\+::mturk\+::tasks\+::convai2\+\_\+model\+\_\+eval\+::run}!M\+A\+S\+T\+E\+R\+\_\+\+Q\+U\+A\+L\+IF@{M\+A\+S\+T\+E\+R\+\_\+\+Q\+U\+A\+L\+IF}}
\index{M\+A\+S\+T\+E\+R\+\_\+\+Q\+U\+A\+L\+IF@{M\+A\+S\+T\+E\+R\+\_\+\+Q\+U\+A\+L\+IF}!parlai\+::mturk\+::tasks\+::convai2\+\_\+model\+\_\+eval\+::run@{parlai\+::mturk\+::tasks\+::convai2\+\_\+model\+\_\+eval\+::run}}
\subsubsection{\texorpdfstring{M\+A\+S\+T\+E\+R\+\_\+\+Q\+U\+A\+L\+IF}{MASTER\_QUALIF}}
{\footnotesize\ttfamily parlai.\+mturk.\+tasks.\+convai2\+\_\+model\+\_\+eval.\+run.\+M\+A\+S\+T\+E\+R\+\_\+\+Q\+U\+A\+L\+IF}



Definition at line 15 of file run.\+py.

\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1tasks_1_1convai2__model__eval_1_1run_a84e5489445f1458f929ce705e84edd4f}\label{namespaceparlai_1_1mturk_1_1tasks_1_1convai2__model__eval_1_1run_a84e5489445f1458f929ce705e84edd4f}} 
\index{parlai\+::mturk\+::tasks\+::convai2\+\_\+model\+\_\+eval\+::run@{parlai\+::mturk\+::tasks\+::convai2\+\_\+model\+\_\+eval\+::run}!M\+A\+S\+T\+E\+R\+\_\+\+Q\+U\+A\+L\+I\+F\+\_\+\+S\+D\+B\+OX@{M\+A\+S\+T\+E\+R\+\_\+\+Q\+U\+A\+L\+I\+F\+\_\+\+S\+D\+B\+OX}}
\index{M\+A\+S\+T\+E\+R\+\_\+\+Q\+U\+A\+L\+I\+F\+\_\+\+S\+D\+B\+OX@{M\+A\+S\+T\+E\+R\+\_\+\+Q\+U\+A\+L\+I\+F\+\_\+\+S\+D\+B\+OX}!parlai\+::mturk\+::tasks\+::convai2\+\_\+model\+\_\+eval\+::run@{parlai\+::mturk\+::tasks\+::convai2\+\_\+model\+\_\+eval\+::run}}
\subsubsection{\texorpdfstring{M\+A\+S\+T\+E\+R\+\_\+\+Q\+U\+A\+L\+I\+F\+\_\+\+S\+D\+B\+OX}{MASTER\_QUALIF\_SDBOX}}
{\footnotesize\ttfamily parlai.\+mturk.\+tasks.\+convai2\+\_\+model\+\_\+eval.\+run.\+M\+A\+S\+T\+E\+R\+\_\+\+Q\+U\+A\+L\+I\+F\+\_\+\+S\+D\+B\+OX}



Definition at line 21 of file run.\+py.

