\hypertarget{namespaceparlai_1_1mturk_1_1scripts_1_1delete__hits}{}\section{parlai.\+mturk.\+scripts.\+delete\+\_\+hits Namespace Reference}
\label{namespaceparlai_1_1mturk_1_1scripts_1_1delete__hits}\index{parlai.\+mturk.\+scripts.\+delete\+\_\+hits@{parlai.\+mturk.\+scripts.\+delete\+\_\+hits}}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{namespaceparlai_1_1mturk_1_1scripts_1_1delete__hits_a8dd24ac1eb6692d9295969d598138d05}{main} ()
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1scripts_1_1delete__hits_a8dd24ac1eb6692d9295969d598138d05}\label{namespaceparlai_1_1mturk_1_1scripts_1_1delete__hits_a8dd24ac1eb6692d9295969d598138d05}} 
\index{parlai\+::mturk\+::scripts\+::delete\+\_\+hits@{parlai\+::mturk\+::scripts\+::delete\+\_\+hits}!main@{main}}
\index{main@{main}!parlai\+::mturk\+::scripts\+::delete\+\_\+hits@{parlai\+::mturk\+::scripts\+::delete\+\_\+hits}}
\subsubsection{\texorpdfstring{main()}{main()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+scripts.\+delete\+\_\+hits.\+main (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}

\begin{DoxyVerb}This script should be used after some error occurs that leaves HITs live while the
ParlAI MTurk server down.

This will search through live HITs and list them by task ID, letting you close down
HITs that do not link to any server and are thus irrecoverable.
\end{DoxyVerb}
 

Definition at line 13 of file delete\+\_\+hits.\+py.


\begin{DoxyCode}
13 \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1mturk_1_1scripts_1_1delete__hits_a8dd24ac1eb6692d9295969d598138d05}{main}():
14     \textcolor{stringliteral}{"""}
15 \textcolor{stringliteral}{    This script should be used after some error occurs that leaves HITs live while the}
16 \textcolor{stringliteral}{    ParlAI MTurk server down.}
17 \textcolor{stringliteral}{}
18 \textcolor{stringliteral}{    This will search through live HITs and list them by task ID, letting you close down}
19 \textcolor{stringliteral}{    HITs that do not link to any server and are thus irrecoverable.}
20 \textcolor{stringliteral}{    """}
21     parser = argparse.ArgumentParser(description=\textcolor{stringliteral}{'Delete HITs by expiring'})
22     parser.add\_argument(
23         \textcolor{stringliteral}{'--sandbox'},
24         dest=\textcolor{stringliteral}{'sandbox'},
25         default=\textcolor{keyword}{False},
26         action=\textcolor{stringliteral}{'store\_true'},
27         help=\textcolor{stringliteral}{'Delete HITs from sandbox'},
28     )
29     parser.add\_argument(
30         \textcolor{stringliteral}{'--ignore-assigned'},
31         dest=\textcolor{stringliteral}{'ignore'},
32         default=\textcolor{keyword}{False},
33         action=\textcolor{stringliteral}{'store\_true'},
34         help=\textcolor{stringliteral}{'Ignore HITs that may already be completed or assigned'},
35     )
36     parser.add\_argument(
37         \textcolor{stringliteral}{'--approve'},
38         dest=\textcolor{stringliteral}{'approve'},
39         default=\textcolor{keyword}{False},
40         action=\textcolor{stringliteral}{'store\_true'},
41         help=\textcolor{stringliteral}{'Approve HITs that have been completed on deletion'},
42     )
43     parser.add\_argument(
44         \textcolor{stringliteral}{'--verbose'},
45         dest=\textcolor{stringliteral}{'verbose'},
46         default=\textcolor{keyword}{False},
47         action=\textcolor{stringliteral}{'store\_true'},
48         help=\textcolor{stringliteral}{'List actions to individual HITs'},
49     )
50     opt = parser.parse\_args()
51     sandbox = opt.sandbox
52     ignore = opt.ignore
53     approve = opt.approve
54     verbose = opt.verbose
55     task\_group\_ids = []
56     group\_to\_hit = \{\}
57     processed = 0
58     found = 0
59     spinner\_vals = [\textcolor{stringliteral}{'-'}, \textcolor{stringliteral}{'\(\backslash\)\(\backslash\)'}, \textcolor{stringliteral}{'|'}, \textcolor{stringliteral}{'/'}]
60     \textcolor{keywordflow}{if} sandbox:
61         print(
62             \textcolor{stringliteral}{'About to query the SANDBOX server, these HITs will be active HITs'}
63             \textcolor{stringliteral}{' from within the MTurk requester sandbox'}
64         )
65     \textcolor{keywordflow}{else}:
66         print(
67             \textcolor{stringliteral}{'About to query the LIVE server, these HITs will be active HITs '}
68             \textcolor{stringliteral}{'potentially being worked on by real Turkers right now'}
69         )
70 
71     print(
72         \textcolor{stringliteral}{'Getting HITs from amazon MTurk server, please wait...\(\backslash\)n'}
73         \textcolor{stringliteral}{'or use CTRL-C to skip to expiring some of what is found.\(\backslash\)n'}
74     )
75     mturk\_utils.setup\_aws\_credentials()
76     client = mturk\_utils.get\_mturk\_client(sandbox)
77     response = client.list\_hits(MaxResults=100)
78     \textcolor{keywordflow}{try}:
79         \textcolor{keywordflow}{while} \textcolor{keyword}{True}:
80             processed += response[\textcolor{stringliteral}{'NumResults'}]
81             \textcolor{keywordflow}{for} hit \textcolor{keywordflow}{in} response[\textcolor{stringliteral}{'HITs'}]:
82                 \textcolor{keywordflow}{if} ignore:
83                     \textcolor{keywordflow}{if} hit[\textcolor{stringliteral}{'NumberOfAssignmentsAvailable'}] == 0:
84                         \textcolor{comment}{# Ignore hits with no assignable assignments}
85                         \textcolor{keywordflow}{continue}
86                     \textcolor{keywordflow}{if} (
87                         hit[\textcolor{stringliteral}{'HITStatus'}] != \textcolor{stringliteral}{'Assignable'}
88                         \textcolor{keywordflow}{and} hit[\textcolor{stringliteral}{'HITStatus'}] != \textcolor{stringliteral}{'Unassignable'}
89                     ):
90                         \textcolor{comment}{# Ignore completed hits}
91                         \textcolor{keywordflow}{continue}
92                 question = hit[\textcolor{stringliteral}{'Question'}]
93                 \textcolor{keywordflow}{try}:
94                     \textcolor{keywordflow}{if} \textcolor{stringliteral}{'ExternalURL'} \textcolor{keywordflow}{in} question:
95                         url = question.split(\textcolor{stringliteral}{'ExternalURL'})[1]
96                         group\_id = url.split(\textcolor{stringliteral}{'task\_group\_id='})[1]
97                         group\_id = group\_id.split(\textcolor{stringliteral}{'&'})[0]
98                         group\_id = group\_id.split(\textcolor{stringliteral}{'<'})[0]
99                         \textcolor{keywordflow}{if} group\_id \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} task\_group\_ids:
100                             sys.stdout.write(
101                                 \textcolor{stringliteral}{'\(\backslash\)rFound group \{\}                         '}
102                                 \textcolor{stringliteral}{'                                         '}
103                                 \textcolor{stringliteral}{'\(\backslash\)n'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(group\_id)
104                             )
105                             group\_to\_hit[group\_id] = \{\}
106                             task\_group\_ids.append(group\_id)
107                         group\_to\_hit[group\_id][hit[\textcolor{stringliteral}{'HITId'}]] = hit[\textcolor{stringliteral}{'HITStatus'}]
108                         found += 1
109                 \textcolor{keywordflow}{except} IndexError:
110                     \textcolor{keywordflow}{pass}  \textcolor{comment}{# This wasn't the right HIT}
111 
112             sys.stdout.write(
113                 \textcolor{stringliteral}{'\(\backslash\)r\{\} HITs processed, \{\} active hits'}
114                 \textcolor{stringliteral}{' found amongst \{\} tasks. \{\}        '}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
115                     processed,
116                     found,
117                     len(task\_group\_ids),
118                     spinner\_vals[((int)(processed / 100)) % 4],
119                 )
120             )
121             \textcolor{keywordflow}{if} \textcolor{stringliteral}{'NextToken'} \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} response:
122                 \textcolor{keywordflow}{break}
123             response = client.list\_hits(NextToken=response[\textcolor{stringliteral}{'NextToken'}], MaxResults=100)
124 
125     \textcolor{keywordflow}{except} BaseException \textcolor{keyword}{as} e:
126         print(e)
127         \textcolor{keywordflow}{pass}
128 
129     \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} approve:
130         print(\textcolor{stringliteral}{'\(\backslash\)n\(\backslash\)nTask group id - Active HITs'})
131         \textcolor{keywordflow}{for} group\_id \textcolor{keywordflow}{in} task\_group\_ids:
132             print(\textcolor{stringliteral}{'\{\} - \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(group\_id, len(group\_to\_hit[group\_id])))
133     \textcolor{keywordflow}{else}:
134         print(\textcolor{stringliteral}{'\(\backslash\)n\(\backslash\)nTask group id - Active HITs - Reviewable'})
135         \textcolor{keywordflow}{for} group\_id \textcolor{keywordflow}{in} task\_group\_ids:
136             print(
137                 \textcolor{stringliteral}{'\{\} - \{\} - \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
138                     group\_id,
139                     len(group\_to\_hit[group\_id]),
140                     len(
141                         [
142                             s
143                             \textcolor{keywordflow}{for} s \textcolor{keywordflow}{in} group\_to\_hit[group\_id].values()
144                             \textcolor{keywordflow}{if} s == \textcolor{stringliteral}{'Reviewable'}
145                         ]
146                     ),
147                 )
148             )
149 
150     print(
151         \textcolor{stringliteral}{'To clear a task, please enter the task group id of the task that you '}
152         \textcolor{stringliteral}{'want to expire the HITs for. To exit, enter nothing'}
153     )
154 
155     \textcolor{keywordflow}{while} \textcolor{keyword}{True}:
156         task\_group\_id = input(\textcolor{stringliteral}{"Enter task group id: "})
157         \textcolor{keywordflow}{if} len(task\_group\_id) == 0:
158             \textcolor{keywordflow}{break}
159         \textcolor{keywordflow}{elif} task\_group\_id \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} task\_group\_ids:
160             print(\textcolor{stringliteral}{'Sorry, the id you entered was not found, try again'})
161         \textcolor{keywordflow}{else}:
162             num\_hits = input(
163                 \textcolor{stringliteral}{'Confirm by entering the number of HITs that will be deleted: '}
164             )
165             \textcolor{keywordflow}{if} \textcolor{stringliteral}{'\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(len(group\_to\_hit[task\_group\_id])) == num\_hits:
166                 hits\_expired = 0
167                 \textcolor{keywordflow}{for} hit\_id, status \textcolor{keywordflow}{in} group\_to\_hit[task\_group\_id].items():
168                     \textcolor{keywordflow}{if} approve:
169                         response = client.list\_assignments\_for\_hit(HITId=hit\_id)
170                         \textcolor{keywordflow}{if} response[\textcolor{stringliteral}{'NumResults'}] == 0:
171                             \textcolor{keywordflow}{if} verbose:
172                                 print(
173                                     \textcolor{stringliteral}{'No results for hit \{\} with status \{\}\(\backslash\)n'}
174                                     \textcolor{stringliteral}{''}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(hit\_id, status)
175                                 )
176                         \textcolor{keywordflow}{else}:
177                             assignment = response[\textcolor{stringliteral}{'Assignments'}][0]
178                             assignment\_id = assignment[\textcolor{stringliteral}{'AssignmentId'}]
179                             client.approve\_assignment(AssignmentId=assignment\_id)
180                             \textcolor{keywordflow}{if} verbose:
181                                 print(\textcolor{stringliteral}{'Approved assignment \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(assignment\_id))
182                     mturk\_utils.expire\_hit(sandbox, hit\_id)
183                     \textcolor{keywordflow}{if} verbose:
184                         print(\textcolor{stringliteral}{'Expired hit \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(hit\_id))
185                     hits\_expired += 1
186                     sys.stdout.write(\textcolor{stringliteral}{'\(\backslash\)rExpired hits \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(hits\_expired))
187                 print(
188                     \textcolor{stringliteral}{'\(\backslash\)nAll hits for group \{\} have been expired.'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(task\_group\_id)
189                 )
190             \textcolor{keywordflow}{else}:
191                 print(
192                     \textcolor{stringliteral}{'You entered \{\} but there are \{\} HITs to expire, please '}
193                     \textcolor{stringliteral}{"try again to confirm you're ending the right task"}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
194                         num\_hits, len(group\_to\_hit[task\_group\_id])
195                     )
196                 )
197 
198 
\end{DoxyCode}
