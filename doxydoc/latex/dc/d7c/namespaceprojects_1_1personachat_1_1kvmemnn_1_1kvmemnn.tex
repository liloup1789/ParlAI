\hypertarget{namespaceprojects_1_1personachat_1_1kvmemnn_1_1kvmemnn}{}\section{projects.\+personachat.\+kvmemnn.\+kvmemnn Namespace Reference}
\label{namespaceprojects_1_1personachat_1_1kvmemnn_1_1kvmemnn}\index{projects.\+personachat.\+kvmemnn.\+kvmemnn@{projects.\+personachat.\+kvmemnn.\+kvmemnn}}
\subsection*{Classes}
\begin{DoxyCompactItemize}
\item 
class \hyperlink{classprojects_1_1personachat_1_1kvmemnn_1_1kvmemnn_1_1KvmemnnAgent}{Kvmemnn\+Agent}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{namespaceprojects_1_1personachat_1_1kvmemnn_1_1kvmemnn_afe498b578d5df47bf521e2b38dd61605}{maintain\+\_\+dialog\+\_\+history} (history, observation, reply=\textquotesingle{}\textquotesingle{}, history\+Length=1, use\+Replies=\char`\"{}labels\char`\"{}, dict=None, use\+Start\+End\+Indices=True, use\+Personas=True)
\item 
def \hyperlink{namespaceprojects_1_1personachat_1_1kvmemnn_1_1kvmemnn_a7f44d8ff34857c26b87223a668c43724}{load\+\_\+cands} (path)
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\mbox{\Hypertarget{namespaceprojects_1_1personachat_1_1kvmemnn_1_1kvmemnn_a7f44d8ff34857c26b87223a668c43724}\label{namespaceprojects_1_1personachat_1_1kvmemnn_1_1kvmemnn_a7f44d8ff34857c26b87223a668c43724}} 
\index{projects\+::personachat\+::kvmemnn\+::kvmemnn@{projects\+::personachat\+::kvmemnn\+::kvmemnn}!load\+\_\+cands@{load\+\_\+cands}}
\index{load\+\_\+cands@{load\+\_\+cands}!projects\+::personachat\+::kvmemnn\+::kvmemnn@{projects\+::personachat\+::kvmemnn\+::kvmemnn}}
\subsubsection{\texorpdfstring{load\+\_\+cands()}{load\_cands()}}
{\footnotesize\ttfamily def projects.\+personachat.\+kvmemnn.\+kvmemnn.\+load\+\_\+cands (\begin{DoxyParamCaption}\item[{}]{path }\end{DoxyParamCaption})}

\begin{DoxyVerb}Load global fixed set of candidate labels that the teacher provides every example
(the true labels for a specific example are also added to this set, so that it's
possible to get the right answer).
\end{DoxyVerb}
 

Definition at line 101 of file kvmemnn.\+py.


\begin{DoxyCode}
101 \textcolor{keyword}{def }\hyperlink{namespaceprojects_1_1personachat_1_1kvmemnn_1_1kvmemnn_a7f44d8ff34857c26b87223a668c43724}{load\_cands}(path):
102     \textcolor{stringliteral}{"""}
103 \textcolor{stringliteral}{    Load global fixed set of candidate labels that the teacher provides every example}
104 \textcolor{stringliteral}{    (the true labels for a specific example are also added to this set, so that it's}
105 \textcolor{stringliteral}{    possible to get the right answer).}
106 \textcolor{stringliteral}{    """}
107     \textcolor{keywordflow}{if} path \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
108         \textcolor{keywordflow}{return} \textcolor{keywordtype}{None}
109     cands = []
110     lines\_have\_ids = \textcolor{keyword}{False}
111     cands\_are\_replies = \textcolor{keyword}{False}
112     cnt = 0
113     with open(path) \textcolor{keyword}{as} read:
114         \textcolor{keywordflow}{for} line \textcolor{keywordflow}{in} read:
115             line = line.strip().replace(\textcolor{stringliteral}{'\(\backslash\)\(\backslash\)n'}, \textcolor{stringliteral}{'\(\backslash\)n'})
116             \textcolor{keywordflow}{if} len(line) > 0:
117                 cnt = cnt + 1
118                 \textcolor{comment}{# If lines are numbered we strip them of numbers.}
119                 \textcolor{keywordflow}{if} cnt == 1 \textcolor{keywordflow}{and} line[0:2] == \textcolor{stringliteral}{'1 '}:
120                     lines\_have\_ids = \textcolor{keyword}{True}
121                 \textcolor{comment}{# If tabs then the label\_candidates are all the replies.}
122                 \textcolor{keywordflow}{if} \textcolor{stringliteral}{'\(\backslash\)t'} \textcolor{keywordflow}{in} line \textcolor{keywordflow}{and} \textcolor{keywordflow}{not} cands\_are\_replies:
123                     cands\_are\_replies = \textcolor{keyword}{True}
124                     cands = []
125                 \textcolor{keywordflow}{if} lines\_have\_ids:
126                     space\_idx = line.find(\textcolor{stringliteral}{' '})
127                     line = line[space\_idx + 1 :]
128                     \textcolor{keywordflow}{if} cands\_are\_replies:
129                         sp = line.split(\textcolor{stringliteral}{'\(\backslash\)t'})
130                         \textcolor{keywordflow}{if} len(sp) > 1 \textcolor{keywordflow}{and} sp[1] != \textcolor{stringliteral}{''}:
131                             cands.append(sp[1])
132                     \textcolor{keywordflow}{else}:
133                         cands.append(line)
134                 \textcolor{keywordflow}{else}:
135                     cands.append(line)
136     \textcolor{keywordflow}{return} cands
137 
138 
\end{DoxyCode}
\mbox{\Hypertarget{namespaceprojects_1_1personachat_1_1kvmemnn_1_1kvmemnn_afe498b578d5df47bf521e2b38dd61605}\label{namespaceprojects_1_1personachat_1_1kvmemnn_1_1kvmemnn_afe498b578d5df47bf521e2b38dd61605}} 
\index{projects\+::personachat\+::kvmemnn\+::kvmemnn@{projects\+::personachat\+::kvmemnn\+::kvmemnn}!maintain\+\_\+dialog\+\_\+history@{maintain\+\_\+dialog\+\_\+history}}
\index{maintain\+\_\+dialog\+\_\+history@{maintain\+\_\+dialog\+\_\+history}!projects\+::personachat\+::kvmemnn\+::kvmemnn@{projects\+::personachat\+::kvmemnn\+::kvmemnn}}
\subsubsection{\texorpdfstring{maintain\+\_\+dialog\+\_\+history()}{maintain\_dialog\_history()}}
{\footnotesize\ttfamily def projects.\+personachat.\+kvmemnn.\+kvmemnn.\+maintain\+\_\+dialog\+\_\+history (\begin{DoxyParamCaption}\item[{}]{history,  }\item[{}]{observation,  }\item[{}]{reply = {\ttfamily \textquotesingle{}\textquotesingle{}},  }\item[{}]{history\+Length = {\ttfamily 1},  }\item[{}]{use\+Replies = {\ttfamily \char`\"{}labels\char`\"{}},  }\item[{}]{dict = {\ttfamily None},  }\item[{}]{use\+Start\+End\+Indices = {\ttfamily True},  }\item[{}]{use\+Personas = {\ttfamily True} }\end{DoxyParamCaption})}

\begin{DoxyVerb}Keeps track of dialog history, up to a truncation length.

Either includes replies from the labels, model, or not all using param 'replies'.
\end{DoxyVerb}
 

Definition at line 35 of file kvmemnn.\+py.


\begin{DoxyCode}
35 ):
36     \textcolor{stringliteral}{"""}
37 \textcolor{stringliteral}{    Keeps track of dialog history, up to a truncation length.}
38 \textcolor{stringliteral}{}
39 \textcolor{stringliteral}{    Either includes replies from the labels, model, or not all using param 'replies'.}
40 \textcolor{stringliteral}{    """}
41 
42     \textcolor{keyword}{def }parse(txt):
43         txt = txt.lower()
44         txt = txt.replace(\textcolor{stringliteral}{"n't"}, \textcolor{stringliteral}{" not"})
45         \textcolor{keywordflow}{if} dict \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
46             vec = dict.txt2vec(txt)
47             \textcolor{keywordflow}{if} useStartEndIndices:
48                 parsed\_x = deque([dict[dict.start\_token]])
49                 parsed\_x.extend(vec)
50                 parsed\_x.append(dict[dict.end\_token])
51                 \textcolor{keywordflow}{return} parsed\_x
52             \textcolor{keywordflow}{else}:
53                 \textcolor{keywordflow}{return} vec
54         \textcolor{keywordflow}{else}:
55             \textcolor{keywordflow}{return} [txt]
56 
57     \textcolor{keywordflow}{if} \textcolor{stringliteral}{'dialog'} \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} history:
58         history[\textcolor{stringliteral}{'dialog'}] = deque(maxlen=historyLength)
59         history[\textcolor{stringliteral}{'persona'}] = []
60         history[\textcolor{stringliteral}{'episode\_done'}] = \textcolor{keyword}{False}
61         history[\textcolor{stringliteral}{'labels'}] = []
62 
63     \textcolor{keywordflow}{if} history[\textcolor{stringliteral}{'episode\_done'}]:
64         history[\textcolor{stringliteral}{'dialog'}].clear()
65         history[\textcolor{stringliteral}{'persona'}] = []
66         history[\textcolor{stringliteral}{'labels'}] = []
67         history[\textcolor{stringliteral}{'episode\_done'}] = \textcolor{keyword}{False}
68 
69     \textcolor{comment}{# we only keep the last one..that works well for IR model, so..}
70     history[\textcolor{stringliteral}{'dialog'}].clear()
71 
72     \textcolor{keywordflow}{if} useReplies != \textcolor{stringliteral}{'none'}:
73         \textcolor{keywordflow}{if} len(history[\textcolor{stringliteral}{'labels'}]) > 0:
74             r = history[\textcolor{stringliteral}{'labels'}][0]
75             history[\textcolor{stringliteral}{'dialog'}].extend(parse(r))
76         \textcolor{keywordflow}{else}:  \textcolor{comment}{# if useReplies == 'model':}
77             \textcolor{keywordflow}{if} reply != \textcolor{stringliteral}{''}:
78                 history[\textcolor{stringliteral}{'dialog'}].extend(parse(reply))
79 
80     \textcolor{keywordflow}{if} \textcolor{stringliteral}{'text'} \textcolor{keywordflow}{in} observation:
81         txts = observation[\textcolor{stringliteral}{'text'}].split(\textcolor{stringliteral}{'\(\backslash\)n'})
82         \textcolor{keywordflow}{for} txt \textcolor{keywordflow}{in} txts:
83             \textcolor{keywordflow}{if} usePersonas \textcolor{keywordflow}{and} \textcolor{stringliteral}{'persona:'} \textcolor{keywordflow}{in} txt:
84                 history[\textcolor{stringliteral}{'persona'}].append(
85                     Variable(torch.LongTensor(parse(txt)).unsqueeze(0))
86                 )
87             \textcolor{keywordflow}{else}:
88                 utt = parse(txt)
89                 history[\textcolor{stringliteral}{'dialog'}].extend(utt)
90                 history[\textcolor{stringliteral}{'last\_utterance'}] = utt
91 
92     history[\textcolor{stringliteral}{'episode\_done'}] = observation[\textcolor{stringliteral}{'episode\_done'}]
93     \textcolor{keywordflow}{if} \textcolor{stringliteral}{'labels'} \textcolor{keywordflow}{in} observation:
94         history[\textcolor{stringliteral}{'labels'}] = observation[\textcolor{stringliteral}{'labels'}]
95     \textcolor{keywordflow}{elif} \textcolor{stringliteral}{'eval\_labels'} \textcolor{keywordflow}{in} observation:
96         history[\textcolor{stringliteral}{'labels'}] = observation[\textcolor{stringliteral}{'eval\_labels'}]
97 
98     \textcolor{keywordflow}{return} history[\textcolor{stringliteral}{'dialog'}], history[\textcolor{stringliteral}{'persona'}]
99 
100 
\end{DoxyCode}
