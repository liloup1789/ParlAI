\hypertarget{namespacepersonachat__eval_1_1run}{}\section{personachat\+\_\+eval.\+run Namespace Reference}
\label{namespacepersonachat__eval_1_1run}\index{personachat\+\_\+eval.\+run@{personachat\+\_\+eval.\+run}}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{namespacepersonachat__eval_1_1run_a712c8823f07511abe11dce3e1e40f142}{main} ()
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\mbox{\Hypertarget{namespacepersonachat__eval_1_1run_a712c8823f07511abe11dce3e1e40f142}\label{namespacepersonachat__eval_1_1run_a712c8823f07511abe11dce3e1e40f142}} 
\index{personachat\+\_\+eval\+::run@{personachat\+\_\+eval\+::run}!main@{main}}
\index{main@{main}!personachat\+\_\+eval\+::run@{personachat\+\_\+eval\+::run}}
\subsubsection{\texorpdfstring{main()}{main()}}
{\footnotesize\ttfamily def personachat\+\_\+eval.\+run.\+main (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}

\begin{DoxyVerb}This task consists of one agent, model or MTurk worker, talking to an MTurk worker
to negotiate a deal.
\end{DoxyVerb}
 

Definition at line 14 of file run.\+py.


\begin{DoxyCode}
14 \textcolor{keyword}{def }\hyperlink{namespaceprojects_1_1wizard__of__wikipedia_1_1mturk__evaluation__task_1_1run_ad3ab2c71f8083c3112815c0b363d316b}{main}():
15     \textcolor{stringliteral}{"""}
16 \textcolor{stringliteral}{    This task consists of one agent, model or MTurk worker, talking to an MTurk worker}
17 \textcolor{stringliteral}{    to negotiate a deal.}
18 \textcolor{stringliteral}{    """}
19     argparser = ParlaiParser(\textcolor{keyword}{False}, \textcolor{keyword}{False})
20     argparser.add\_parlai\_data\_path()
21     argparser.add\_mturk\_args()
22     argparser.add\_argument(
23         \textcolor{stringliteral}{'-min\_t'}, \textcolor{stringliteral}{'--min\_turns'}, default=5, type=int, help=\textcolor{stringliteral}{'minimum number of turns'}
24     )
25     argparser.add\_argument(
26         \textcolor{stringliteral}{'-mt'}, \textcolor{stringliteral}{'--max\_turns'}, default=10, type=int, help=\textcolor{stringliteral}{'maximal number of chat turns'}
27     )
28     argparser.add\_argument(
29         \textcolor{stringliteral}{'-mx\_rsp\_time'},
30         \textcolor{stringliteral}{'--max\_resp\_time'},
31         default=150,
32         type=int,
33         help=\textcolor{stringliteral}{'time limit for entering a dialog message'},
34     )
35     argparser.add\_argument(
36         \textcolor{stringliteral}{'-mx\_psn\_time'},
37         \textcolor{stringliteral}{'--max\_persona\_time'},
38         type=int,
39         default=300,
40         help=\textcolor{stringliteral}{'time limit for turker'} \textcolor{stringliteral}{'entering the persona'},
41     )
42     argparser.add\_argument(
43         \textcolor{stringliteral}{'--ag\_shutdown\_time'},
44         default=120,
45         type=int,
46         help=\textcolor{stringliteral}{'time limit for entering a dialog message'},
47     )
48     argparser.add\_argument(
49         \textcolor{stringliteral}{'--persona-type'},
50         default=\textcolor{stringliteral}{'both'},
51         type=str,
52         choices=[\textcolor{stringliteral}{'both'}, \textcolor{stringliteral}{'self'}, \textcolor{stringliteral}{'other'}],
53         help=\textcolor{stringliteral}{'Which personas to load from personachat'},
54     )
55     argparser.add\_argument(
56         \textcolor{stringliteral}{'--revised'}, default=\textcolor{keyword}{True}, type=\textcolor{stringliteral}{'bool'}, help=\textcolor{stringliteral}{'Whether to use revised personas'}
57     )
58     argparser.add\_argument(
59         \textcolor{stringliteral}{'-rt'}, \textcolor{stringliteral}{'--range\_turn'}, default=\textcolor{stringliteral}{'5,7'}, help=\textcolor{stringliteral}{'sample range of number of turns'}
60     )
61     opt = argparser.parse\_args()
62     opt[\textcolor{stringliteral}{'task'}] = os.path.basename(os.path.dirname(os.path.abspath(\_\_file\_\_)))
63     \textcolor{keywordflow}{if} \textcolor{stringliteral}{'data\_path'} \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} opt:
64         opt[\textcolor{stringliteral}{'data\_path'}] = os.getcwd() + \textcolor{stringliteral}{'/data/'} + opt[\textcolor{stringliteral}{'task'}]
65     opt.update(task\_config)
66 
67     mturk\_agent\_ids = [\textcolor{stringliteral}{'PERSON\_1'}]
68 
69     mturk\_manager = MTurkManager(opt=opt, mturk\_agent\_ids=mturk\_agent\_ids)
70 
71     persona\_generator = PersonasGenerator(opt)
72     mturk\_manager.setup\_server()
73 
74     \textcolor{comment}{# SET MODEL AGENT OPT HERE}
75     model\_agent\_opt = \{\}
76 
77     \textcolor{keywordflow}{try}:
78         mturk\_manager.start\_new\_run()
79         mturk\_manager.create\_hits()
80 
81         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} opt[\textcolor{stringliteral}{'is\_sandbox'}]:
82             blocked\_worker\_list = []
83             \textcolor{keywordflow}{for} w \textcolor{keywordflow}{in} blocked\_worker\_list:
84                 mturk\_manager.block\_worker(
85                     w,
86                     \textcolor{stringliteral}{'We found that you have unexpected behaviors in our previous HITs. For more questions
       please email us.'},
87                 )
88 
89         \textcolor{keyword}{def }run\_onboard(worker):
90             worker.persona\_generator = persona\_generator
91             world = PersonaProfileWorld(opt, worker)
92             world.parley()
93             world.shutdown()
94 
95         mturk\_manager.set\_onboard\_function(onboard\_function=run\_onboard)
96         mturk\_manager.ready\_to\_accept\_workers()
97 
98         \textcolor{keyword}{def }check\_worker\_eligibility(worker):
99             \textcolor{keywordflow}{return} \textcolor{keyword}{True}
100 
101         \textcolor{keyword}{def }assign\_worker\_roles(workers):
102             \textcolor{keywordflow}{for} index, worker \textcolor{keywordflow}{in} enumerate(workers):
103                 worker.id = mturk\_agent\_ids[index % len(mturk\_agent\_ids)]
104 
105         \textcolor{keyword}{def }run\_conversation(mturk\_manager, opt, workers):
106             agents = workers[0]
107             conv\_idx = mturk\_manager.conversation\_index
108             world = PersonaChatEvalWorld(
109                 opt=opt,
110                 agents=[agents],
111                 range\_turn=[\hyperlink{namespaceprojects_1_1mastering__the__dungeon_1_1mturk_1_1tasks_1_1MTD_1_1run_a693eb03afbb820bbfe8b47b12e69e519}{int}(s) \textcolor{keywordflow}{for} s \textcolor{keywordflow}{in} opt[\textcolor{stringliteral}{'range\_turn'}].split(\textcolor{stringliteral}{','})],
112                 max\_turn=opt[\textcolor{stringliteral}{'max\_turns'}],
113                 max\_resp\_time=opt[\textcolor{stringliteral}{'max\_resp\_time'}],
114                 model\_agent\_opt=model\_agent\_opt,
115                 world\_tag=\textcolor{stringliteral}{'conversation t\_\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(conv\_idx),
116             )
117             world.reset\_random()
118             \textcolor{keywordflow}{while} \textcolor{keywordflow}{not} world.episode\_done():
119                 world.parley()
120             world.save\_data()
121 
122             world.shutdown()
123             world.review\_work()
124 
125         mturk\_manager.start\_task(
126             eligibility\_function=check\_worker\_eligibility,
127             assign\_role\_function=assign\_worker\_roles,
128             task\_function=run\_conversation,
129         )
130 
131     \textcolor{keywordflow}{except} BaseException:
132         \textcolor{keywordflow}{raise}
133     \textcolor{keywordflow}{finally}:
134         mturk\_manager.expire\_all\_unassigned\_hits()
135         mturk\_manager.shutdown()
136 
137 
\end{DoxyCode}
