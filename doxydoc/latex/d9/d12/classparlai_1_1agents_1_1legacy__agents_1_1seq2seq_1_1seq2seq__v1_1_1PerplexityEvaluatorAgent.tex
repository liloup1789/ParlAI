\hypertarget{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent}{}\section{parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+seq2seq\+\_\+v1.\+Perplexity\+Evaluator\+Agent Class Reference}
\label{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent}\index{parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+seq2seq\+\_\+v1.\+Perplexity\+Evaluator\+Agent@{parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+seq2seq\+\_\+v1.\+Perplexity\+Evaluator\+Agent}}


Inheritance diagram for parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+seq2seq\+\_\+v1.\+Perplexity\+Evaluator\+Agent\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=226pt]{d1/d6d/classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent__inherit__graph}
\end{center}
\end{figure}


Collaboration diagram for parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+seq2seq\+\_\+v1.\+Perplexity\+Evaluator\+Agent\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=226pt]{d5/d37/classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent__coll__graph}
\end{center}
\end{figure}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent_acf3daa1b1bfc893504efa07f3eb9b667}{\+\_\+\+\_\+init\+\_\+\+\_\+} (self, \hyperlink{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1torch__agent__v1_1_1TorchAgent_a4e938a91873bd6edde0ac7ed5299bc6a}{opt}, shared=None)
\item 
def \hyperlink{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent_a577da407eed3f8757efeab3522f2717b}{next\+\_\+word\+\_\+probability} (self, partial\+\_\+out)
\end{DoxyCompactItemize}
\subsection*{Public Attributes}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent_a8f896a71b1f4eef69d66f3ae48156937}{prev\+\_\+enc}
\item 
\hyperlink{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent_a637c8434588948fb0367cd749c18e690}{last\+\_\+xs}
\end{DoxyCompactItemize}
\subsection*{Additional Inherited Members}


\subsection{Detailed Description}
\begin{DoxyVerb}Subclass for doing standardized perplexity evaluation.

This is designed to be used in conjunction with the PerplexityWorld at
parlai/scripts/eval_ppl.py. It uses the `next_word_probability` function to
calculate the probability of tokens one token at a time.
\end{DoxyVerb}
 

Definition at line 862 of file seq2seq\+\_\+v1.\+py.



\subsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent_acf3daa1b1bfc893504efa07f3eb9b667}\label{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent_acf3daa1b1bfc893504efa07f3eb9b667}} 
\index{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent}!\+\_\+\+\_\+init\+\_\+\+\_\+@{\+\_\+\+\_\+init\+\_\+\+\_\+}}
\index{\+\_\+\+\_\+init\+\_\+\+\_\+@{\+\_\+\+\_\+init\+\_\+\+\_\+}!parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent}}
\subsubsection{\texorpdfstring{\+\_\+\+\_\+init\+\_\+\+\_\+()}{\_\_init\_\_()}}
{\footnotesize\ttfamily def parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+seq2seq\+\_\+v1.\+Perplexity\+Evaluator\+Agent.\+\_\+\+\_\+init\+\_\+\+\_\+ (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{opt,  }\item[{}]{shared = {\ttfamily None} }\end{DoxyParamCaption})}

\begin{DoxyVerb}Initialize evaluator.
\end{DoxyVerb}
 

Definition at line 871 of file seq2seq\+\_\+v1.\+py.


\begin{DoxyCode}
871     \textcolor{keyword}{def }\_\_init\_\_(self, opt, shared=None):
872         \textcolor{stringliteral}{"""}
873 \textcolor{stringliteral}{        Initialize evaluator.}
874 \textcolor{stringliteral}{        """}
875         \textcolor{keywordflow}{if} opt.get(\textcolor{stringliteral}{'multigpu'}):
876             print(
877                 \textcolor{stringliteral}{'| WARNING: Multi-GPU is not supported for the Perplexity '}
878                 + \textcolor{stringliteral}{'Evaluator Agent. Setting this option to False.'}
879             )
880             opt[\textcolor{stringliteral}{'multigpu'}] = \textcolor{keyword}{False}
881         super().\_\_init\_\_(opt, shared)
882         self.prev\_enc = \textcolor{keywordtype}{None}
883         self.last\_xs = \textcolor{keywordtype}{None}
884 
\end{DoxyCode}


\subsection{Member Function Documentation}
\mbox{\Hypertarget{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent_a577da407eed3f8757efeab3522f2717b}\label{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent_a577da407eed3f8757efeab3522f2717b}} 
\index{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent}!next\+\_\+word\+\_\+probability@{next\+\_\+word\+\_\+probability}}
\index{next\+\_\+word\+\_\+probability@{next\+\_\+word\+\_\+probability}!parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent}}
\subsubsection{\texorpdfstring{next\+\_\+word\+\_\+probability()}{next\_word\_probability()}}
{\footnotesize\ttfamily def parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+seq2seq\+\_\+v1.\+Perplexity\+Evaluator\+Agent.\+next\+\_\+word\+\_\+probability (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{partial\+\_\+out }\end{DoxyParamCaption})}

\begin{DoxyVerb}Return probability distribution over next words.

This probability is based on both nn input and partial true output.
This is used to calculate the per-word perplexity.

Arguments:
observation -- input observation dict
partial_out -- list of previous "true" words

Returns a dict, where each key is a word and each value is a
probability score for that word.
Unset keys will use a probability of 1e-7.

e.g.
{'text': 'Run test program.'}, ['hello'] => {'world': 1.0}
\end{DoxyVerb}
 

Definition at line 885 of file seq2seq\+\_\+v1.\+py.


\begin{DoxyCode}
885     \textcolor{keyword}{def }next\_word\_probability(self, partial\_out):
886         \textcolor{stringliteral}{"""}
887 \textcolor{stringliteral}{        Return probability distribution over next words.}
888 \textcolor{stringliteral}{}
889 \textcolor{stringliteral}{        This probability is based on both nn input and partial true output.}
890 \textcolor{stringliteral}{        This is used to calculate the per-word perplexity.}
891 \textcolor{stringliteral}{}
892 \textcolor{stringliteral}{        Arguments:}
893 \textcolor{stringliteral}{        observation -- input observation dict}
894 \textcolor{stringliteral}{        partial\_out -- list of previous "true" words}
895 \textcolor{stringliteral}{}
896 \textcolor{stringliteral}{        Returns a dict, where each key is a word and each value is a}
897 \textcolor{stringliteral}{        probability score for that word.}
898 \textcolor{stringliteral}{        Unset keys will use a probability of 1e-7.}
899 \textcolor{stringliteral}{}
900 \textcolor{stringliteral}{        e.g.}
901 \textcolor{stringliteral}{        \{'text': 'Run test program.'\}, ['hello'] => \{'world': 1.0\}}
902 \textcolor{stringliteral}{        """}
903         obs = self.observation
904         xs = obs[\textcolor{stringliteral}{'text\_vec'}].unsqueeze(0)
905         ys = self.\_vectorize\_text(
906             \textcolor{stringliteral}{' '}.join(partial\_out), \textcolor{keyword}{False}, \textcolor{keyword}{True}, self.truncate
907         ).unsqueeze(0)
908         \textcolor{keywordflow}{if} (
909             self.prev\_enc \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}
910             \textcolor{keywordflow}{and} self.last\_xs \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}
911             \textcolor{keywordflow}{and} (
912                 xs.shape[1] != self.last\_xs.shape[1]
913                 \textcolor{keywordflow}{or} (xs == self.last\_xs).sum().item() != xs.shape[1]
914             )
915         ):
916             \textcolor{comment}{# reset prev\_enc, this is a new input}
917             self.prev\_enc = \textcolor{keywordtype}{None}
918         self.last\_xs = xs
919 
920         self.model.eval()
921         out = self.model(
922             xs,
923             ys=(ys \textcolor{keywordflow}{if} len(partial\_out) > 0 \textcolor{keywordflow}{else} \textcolor{keywordtype}{None}),
924             prev\_enc=self.prev\_enc,
925             maxlen=1,
926         )
927         scores, self.prev\_enc = out[0], out[2]
928         \textcolor{comment}{# scores is bsz x seqlen x num\_words, so select probs of current index}
929         probs = F.softmax(scores.select(1, -1), dim=1).squeeze()
930         dist = mydefaultdict(\textcolor{keyword}{lambda}: 1e-7)  \textcolor{comment}{# default probability for any token}
931         \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(len(probs)):
932             dist[self.dict[i]] = probs[i].item()
933         \textcolor{keywordflow}{return} dist
934 \end{DoxyCode}


\subsection{Member Data Documentation}
\mbox{\Hypertarget{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent_a637c8434588948fb0367cd749c18e690}\label{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent_a637c8434588948fb0367cd749c18e690}} 
\index{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent}!last\+\_\+xs@{last\+\_\+xs}}
\index{last\+\_\+xs@{last\+\_\+xs}!parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent}}
\subsubsection{\texorpdfstring{last\+\_\+xs}{last\_xs}}
{\footnotesize\ttfamily parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+seq2seq\+\_\+v1.\+Perplexity\+Evaluator\+Agent.\+last\+\_\+xs}



Definition at line 883 of file seq2seq\+\_\+v1.\+py.

\mbox{\Hypertarget{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent_a8f896a71b1f4eef69d66f3ae48156937}\label{classparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1seq2seq__v1_1_1PerplexityEvaluatorAgent_a8f896a71b1f4eef69d66f3ae48156937}} 
\index{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent}!prev\+\_\+enc@{prev\+\_\+enc}}
\index{prev\+\_\+enc@{prev\+\_\+enc}!parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent@{parlai\+::agents\+::legacy\+\_\+agents\+::seq2seq\+::seq2seq\+\_\+v1\+::\+Perplexity\+Evaluator\+Agent}}
\subsubsection{\texorpdfstring{prev\+\_\+enc}{prev\_enc}}
{\footnotesize\ttfamily parlai.\+agents.\+legacy\+\_\+agents.\+seq2seq.\+seq2seq\+\_\+v1.\+Perplexity\+Evaluator\+Agent.\+prev\+\_\+enc}



Definition at line 882 of file seq2seq\+\_\+v1.\+py.



The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
parlai/agents/legacy\+\_\+agents/seq2seq/\hyperlink{seq2seq__v1_8py}{seq2seq\+\_\+v1.\+py}\end{DoxyCompactItemize}
