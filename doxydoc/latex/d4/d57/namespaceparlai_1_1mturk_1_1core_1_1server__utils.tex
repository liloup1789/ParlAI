\hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils}{}\section{parlai.\+mturk.\+core.\+server\+\_\+utils Namespace Reference}
\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils}\index{parlai.\+mturk.\+core.\+server\+\_\+utils@{parlai.\+mturk.\+core.\+server\+\_\+utils}}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_adff2f564896069e0b76ae1b007515a2b}{setup\+\_\+legacy\+\_\+heroku\+\_\+server} (task\+\_\+name, task\+\_\+files\+\_\+to\+\_\+copy=None, heroku\+\_\+team=None, use\+\_\+hobby=False, tmp\+\_\+dir=\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}{parent\+\_\+dir})
\item 
def \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_af1c97e9b93a403e200ac75b87a51c3c1}{setup\+\_\+heroku\+\_\+server} (task\+\_\+name, task\+\_\+files\+\_\+to\+\_\+copy=None, heroku\+\_\+team=None, use\+\_\+hobby=False, tmp\+\_\+dir=\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}{parent\+\_\+dir})
\item 
def \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a8dfde882f9d6ff492ca565ae2334fc70}{delete\+\_\+heroku\+\_\+server} (task\+\_\+name, tmp\+\_\+dir=\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}{parent\+\_\+dir})
\item 
def \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a9d4c4937ea60bd74630a44739e825ebf}{setup\+\_\+local\+\_\+server} (task\+\_\+name, task\+\_\+files\+\_\+to\+\_\+copy=None)
\item 
def \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a9b4f4c3f696be001c2fa96b3690af83c}{delete\+\_\+local\+\_\+server} (task\+\_\+name)
\item 
def \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_afe9361009645f245de2a07c18cd485bb}{setup\+\_\+legacy\+\_\+server} (task\+\_\+name, task\+\_\+files\+\_\+to\+\_\+copy, local=False, heroku\+\_\+team=None, use\+\_\+hobby=False, legacy=True, tmp\+\_\+dir=\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}{parent\+\_\+dir})
\item 
def \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a154e8cbb18375ff8fd6730154d312bbc}{setup\+\_\+server} (task\+\_\+name, task\+\_\+files\+\_\+to\+\_\+copy, local=False, heroku\+\_\+team=None, use\+\_\+hobby=False, legacy=True, tmp\+\_\+dir=\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}{parent\+\_\+dir})
\item 
def \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a3c7c1d82bd4d26eb98ce9711de3cca7c}{delete\+\_\+server} (task\+\_\+name, local=False, tmp\+\_\+dir=\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}{parent\+\_\+dir})
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a677cf88f4f2a1e0bc2c93c5d40c2e49d}{region\+\_\+name}
\item 
\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_aab8bab9c0a550608566b493173c8fd28}{user\+\_\+name}
\item 
\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}{parent\+\_\+dir}
\item 
\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a02e8688330df26d098d2c719583fb10c}{legacy\+\_\+server\+\_\+source\+\_\+directory\+\_\+name}
\item 
\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a6abce559cbe7e80bc5bbf32cc1fcff5a}{server\+\_\+source\+\_\+directory\+\_\+name}
\item 
\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_ab10051dadca0c79ca62cc3974302b38c}{heroku\+\_\+server\+\_\+directory\+\_\+name}
\item 
\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_ab9e3011a4cf2f86f4d520249eed8c77d}{local\+\_\+server\+\_\+directory\+\_\+name}
\item 
\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_ae9c1d985b98f823a2a479d519af0c06d}{task\+\_\+directory\+\_\+name}
\item 
\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a78acb12c579488b178c9815ce79f4018}{server\+\_\+process}
\item 
\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_af0a7a24b863dfa547099d64e3bc498a6}{heroku\+\_\+url}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a8dfde882f9d6ff492ca565ae2334fc70}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a8dfde882f9d6ff492ca565ae2334fc70}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!delete\+\_\+heroku\+\_\+server@{delete\+\_\+heroku\+\_\+server}}
\index{delete\+\_\+heroku\+\_\+server@{delete\+\_\+heroku\+\_\+server}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{delete\+\_\+heroku\+\_\+server()}{delete\_heroku\_server()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+server\+\_\+utils.\+delete\+\_\+heroku\+\_\+server (\begin{DoxyParamCaption}\item[{}]{task\+\_\+name,  }\item[{}]{tmp\+\_\+dir = {\ttfamily \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}{parent\+\_\+dir}} }\end{DoxyParamCaption})}



Definition at line 479 of file server\+\_\+utils.\+py.


\begin{DoxyCode}
479 \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a8dfde882f9d6ff492ca565ae2334fc70}{delete\_heroku\_server}(task\_name, tmp\_dir=parent\_dir):
480     heroku\_directory\_name = glob.glob(os.path.join(tmp\_dir, \textcolor{stringliteral}{'heroku-cli-*'}))[0]
481     heroku\_directory\_path = os.path.join(tmp\_dir, heroku\_directory\_name)
482     heroku\_executable\_path = os.path.join(heroku\_directory\_path, \textcolor{stringliteral}{'bin'}, \textcolor{stringliteral}{'heroku'})
483 
484     heroku\_user\_identifier = netrc.netrc(
485         os.path.join(os.path.expanduser(\textcolor{stringliteral}{"~"}), \textcolor{stringliteral}{'.netrc'})
486     ).hosts[\textcolor{stringliteral}{'api.heroku.com'}][0]
487 
488     heroku\_app\_name = (
489         \textcolor{stringliteral}{'\{\}-\{\}-\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
490             user\_name,
491             task\_name,
492             hashlib.md5(heroku\_user\_identifier.encode(\textcolor{stringliteral}{'utf-8'})).hexdigest(),
493         )
494     )[:30]
495     \textcolor{keywordflow}{while} heroku\_app\_name[-1] == \textcolor{stringliteral}{'-'}:
496         heroku\_app\_name = heroku\_app\_name[:-1]
497     print(\textcolor{stringliteral}{"Heroku: Deleting server: \{\}"}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_app\_name))
498     subprocess.check\_output(
499         shlex.split(
500             \textcolor{stringliteral}{'\{\} destroy \{\} --confirm \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
501                 heroku\_executable\_path, heroku\_app\_name, heroku\_app\_name
502             )
503         )
504     )
505 
506 
\end{DoxyCode}
\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a9b4f4c3f696be001c2fa96b3690af83c}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a9b4f4c3f696be001c2fa96b3690af83c}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!delete\+\_\+local\+\_\+server@{delete\+\_\+local\+\_\+server}}
\index{delete\+\_\+local\+\_\+server@{delete\+\_\+local\+\_\+server}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{delete\+\_\+local\+\_\+server()}{delete\_local\_server()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+server\+\_\+utils.\+delete\+\_\+local\+\_\+server (\begin{DoxyParamCaption}\item[{}]{task\+\_\+name }\end{DoxyParamCaption})}



Definition at line 560 of file server\+\_\+utils.\+py.


\begin{DoxyCode}
560 \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a9b4f4c3f696be001c2fa96b3690af83c}{delete\_local\_server}(task\_name):
561     \textcolor{keyword}{global} server\_process
562     print(\textcolor{stringliteral}{'Terminating server'})
563     server\_process.terminate()
564     server\_process.wait()
565     print(\textcolor{stringliteral}{'Cleaning temp directory'})
566 
567     local\_server\_directory\_path = os.path.join(
568         parent\_dir, \textcolor{stringliteral}{'\{\}\_\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(local\_server\_directory\_name, task\_name)
569     )
570     sh.rm(shlex.split(\textcolor{stringliteral}{'-rf \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(local\_server\_directory\_path)))
571 
572 
\end{DoxyCode}
\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a3c7c1d82bd4d26eb98ce9711de3cca7c}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a3c7c1d82bd4d26eb98ce9711de3cca7c}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!delete\+\_\+server@{delete\+\_\+server}}
\index{delete\+\_\+server@{delete\+\_\+server}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{delete\+\_\+server()}{delete\_server()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+server\+\_\+utils.\+delete\+\_\+server (\begin{DoxyParamCaption}\item[{}]{task\+\_\+name,  }\item[{}]{local = {\ttfamily False},  }\item[{}]{tmp\+\_\+dir = {\ttfamily \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}{parent\+\_\+dir}} }\end{DoxyParamCaption})}



Definition at line 613 of file server\+\_\+utils.\+py.


\begin{DoxyCode}
613 \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a3c7c1d82bd4d26eb98ce9711de3cca7c}{delete\_server}(task\_name, local=False, tmp\_dir=parent\_dir):
614     \textcolor{keywordflow}{if} local:
615         \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a9b4f4c3f696be001c2fa96b3690af83c}{delete\_local\_server}(task\_name)
616     \textcolor{keywordflow}{else}:
617         \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a8dfde882f9d6ff492ca565ae2334fc70}{delete\_heroku\_server}(task\_name, tmp\_dir)
618 \end{DoxyCode}
\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_af1c97e9b93a403e200ac75b87a51c3c1}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_af1c97e9b93a403e200ac75b87a51c3c1}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!setup\+\_\+heroku\+\_\+server@{setup\+\_\+heroku\+\_\+server}}
\index{setup\+\_\+heroku\+\_\+server@{setup\+\_\+heroku\+\_\+server}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{setup\+\_\+heroku\+\_\+server()}{setup\_heroku\_server()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+server\+\_\+utils.\+setup\+\_\+heroku\+\_\+server (\begin{DoxyParamCaption}\item[{}]{task\+\_\+name,  }\item[{}]{task\+\_\+files\+\_\+to\+\_\+copy = {\ttfamily None},  }\item[{}]{heroku\+\_\+team = {\ttfamily None},  }\item[{}]{use\+\_\+hobby = {\ttfamily False},  }\item[{}]{tmp\+\_\+dir = {\ttfamily \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}{parent\+\_\+dir}} }\end{DoxyParamCaption})}



Definition at line 224 of file server\+\_\+utils.\+py.


\begin{DoxyCode}
224 ):
225 
226     print(\textcolor{stringliteral}{"Heroku: Collecting files... for "}, tmp\_dir)
227     \textcolor{comment}{# Install Heroku CLI}
228     os\_name = \textcolor{keywordtype}{None}
229     bit\_architecture = \textcolor{keywordtype}{None}
230 
231     \textcolor{comment}{# Get the platform we are working on}
232     platform\_info = platform.platform()
233     \textcolor{keywordflow}{if} \textcolor{stringliteral}{'Darwin'} \textcolor{keywordflow}{in} platform\_info:  \textcolor{comment}{# Mac OS X}
234         os\_name = \textcolor{stringliteral}{'darwin'}
235     \textcolor{keywordflow}{elif} \textcolor{stringliteral}{'Linux'} \textcolor{keywordflow}{in} platform\_info:  \textcolor{comment}{# Linux}
236         os\_name = \textcolor{stringliteral}{'linux'}
237     \textcolor{keywordflow}{else}:
238         os\_name = \textcolor{stringliteral}{'windows'}
239 
240     \textcolor{comment}{# Find our architecture}
241     bit\_architecture\_info = platform.architecture()[0]
242     \textcolor{keywordflow}{if} \textcolor{stringliteral}{'64bit'} \textcolor{keywordflow}{in} bit\_architecture\_info:
243         bit\_architecture = \textcolor{stringliteral}{'x64'}
244     \textcolor{keywordflow}{else}:
245         bit\_architecture = \textcolor{stringliteral}{'x86'}
246 
247     \textcolor{comment}{# Remove existing heroku client files}
248     existing\_heroku\_directory\_names = glob.glob(os.path.join(tmp\_dir, \textcolor{stringliteral}{'heroku-cli-*'}))
249     \textcolor{keywordflow}{if} len(existing\_heroku\_directory\_names) == 0:
250         \textcolor{keywordflow}{if} os.path.exists(os.path.join(tmp\_dir, \textcolor{stringliteral}{'heroku.tar.gz'})):
251             os.remove(os.path.join(tmp\_dir, \textcolor{stringliteral}{'heroku.tar.gz'}))
252 
253         \textcolor{comment}{# Get the heroku client and unzip}
254         os.chdir(tmp\_dir)
255         sh.wget(
256             shlex.split(
257                 \textcolor{stringliteral}{'\{\}-\{\}-\{\}.tar.gz -O heroku.tar.gz'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
258                     heroku\_url, os\_name, bit\_architecture
259                 )
260             )
261         )
262         sh.tar(shlex.split(\textcolor{stringliteral}{'-xvzf heroku.tar.gz'}))
263 
264     heroku\_directory\_name = glob.glob(os.path.join(tmp\_dir, \textcolor{stringliteral}{'heroku-cli-*'}))[0]
265     heroku\_directory\_path = os.path.join(tmp\_dir, heroku\_directory\_name)
266     heroku\_executable\_path = os.path.join(heroku\_directory\_path, \textcolor{stringliteral}{'bin'}, \textcolor{stringliteral}{'heroku'})
267 
268     server\_source\_directory\_path = os.path.join(
269         parent\_dir, server\_source\_directory\_name
270     )
271     heroku\_server\_development\_path = os.path.join(
272         tmp\_dir, \textcolor{stringliteral}{'\{\}\_\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_server\_directory\_name, task\_name)
273     )
274 
275     \textcolor{comment}{# Delete old server files}
276     sh.rm(shlex.split(\textcolor{stringliteral}{'-rf '} + heroku\_server\_development\_path))
277 
278     \textcolor{comment}{# Copy over a clean copy into the server directory}
279     shutil.copytree(server\_source\_directory\_path, heroku\_server\_development\_path)
280 
281     \textcolor{comment}{# Check to see if we need to build}
282     custom\_component\_dir = os.path.join(
283         heroku\_server\_development\_path, \textcolor{stringliteral}{'dev'}, \textcolor{stringliteral}{'components'}, \textcolor{stringliteral}{'built\_custom\_components'}
284     )
285     \textcolor{keywordflow}{if} task\_files\_to\_copy[\textcolor{stringliteral}{'needs\_build'}] \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
286         \textcolor{comment}{# Build the directory, then pull the custom component out.}
287         print(\textcolor{stringliteral}{'Build: Detected custom package.json, prepping build'})
288         task\_files\_to\_copy[\textcolor{stringliteral}{'components'}] = []
289 
290         frontend\_dir = task\_files\_to\_copy[\textcolor{stringliteral}{'needs\_build'}]
291 
292         sh.rm(shlex.split(\textcolor{stringliteral}{'-rf '} + custom\_component\_dir))
293         shutil.copytree(frontend\_dir, custom\_component\_dir)
294 
295         os.chdir(heroku\_server\_development\_path)
296         packages\_installed = subprocess.call([\textcolor{stringliteral}{'npm'}, \textcolor{stringliteral}{'install'}, custom\_component\_dir])
297         \textcolor{keywordflow}{if} packages\_installed != 0:
298             \textcolor{keywordflow}{raise} Exception(
299                 \textcolor{stringliteral}{'please make sure npm is installed, otherwise view'}
300                 \textcolor{stringliteral}{' the above error for more info.'}
301             )
302 
303         os.chdir(custom\_component\_dir)
304 
305         webpack\_complete = subprocess.call([\textcolor{stringliteral}{'npm'}, \textcolor{stringliteral}{'run'}, \textcolor{stringliteral}{'dev'}])
306         \textcolor{keywordflow}{if} webpack\_complete != 0:
307             \textcolor{keywordflow}{raise} Exception(
308                 \textcolor{stringliteral}{'Webpack appears to have failed to build your '}
309                 \textcolor{stringliteral}{'custom components. See the above for more info.'}
310             )
311     \textcolor{keywordflow}{else}:
312         os.chdir(heroku\_server\_development\_path)
313         packages\_installed = subprocess.call([\textcolor{stringliteral}{'npm'}, \textcolor{stringliteral}{'install'}, custom\_component\_dir])
314         \textcolor{keywordflow}{if} packages\_installed != 0:
315             \textcolor{keywordflow}{raise} Exception(
316                 \textcolor{stringliteral}{'please make sure npm is installed, otherwise view'}
317                 \textcolor{stringliteral}{' the above error for more info.'}
318             )
319 
320     \textcolor{comment}{# Move dev resource files to their correct places}
321     \textcolor{keywordflow}{for} resource\_type \textcolor{keywordflow}{in} [\textcolor{stringliteral}{'css'}, \textcolor{stringliteral}{'components'}]:
322         target\_resource\_dir = os.path.join(
323             heroku\_server\_development\_path, \textcolor{stringliteral}{'dev'}, resource\_type
324         )
325         \textcolor{keywordflow}{for} file\_path \textcolor{keywordflow}{in} task\_files\_to\_copy[resource\_type]:
326             \textcolor{keywordflow}{try}:
327                 file\_name = os.path.basename(file\_path)
328                 target\_path = os.path.join(target\_resource\_dir, file\_name)
329                 print(\textcolor{stringliteral}{'copying \{\} to \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(file\_path, target\_path))
330                 shutil.copy2(file\_path, target\_path)
331             \textcolor{keywordflow}{except} IsADirectoryError:  \textcolor{comment}{# noqa: F821}
332                 dir\_name = os.path.basename(os.path.normpath(file\_path))
333                 shutil.copytree(file\_path, os.path.join(target\_resource\_dir, dir\_name))
334             \textcolor{keywordflow}{except} FileNotFoundError:  \textcolor{comment}{# noqa: F821}
335                 \textcolor{keywordflow}{pass}
336 
337     \textcolor{comment}{# Compile the frontend}
338     os.chdir(heroku\_server\_development\_path)
339 
340     packages\_installed = subprocess.call([\textcolor{stringliteral}{'npm'}, \textcolor{stringliteral}{'install'}])
341     \textcolor{keywordflow}{if} packages\_installed != 0:
342         \textcolor{keywordflow}{raise} Exception(
343             \textcolor{stringliteral}{'please make sure npm is installed, otherwise view '}
344             \textcolor{stringliteral}{'the above error for more info.'}
345         )
346 
347     webpack\_complete = subprocess.call([\textcolor{stringliteral}{'npm'}, \textcolor{stringliteral}{'run'}, \textcolor{stringliteral}{'dev'}])
348     \textcolor{keywordflow}{if} webpack\_complete != 0:
349         \textcolor{keywordflow}{raise} Exception(
350             \textcolor{stringliteral}{'Webpack appears to have failed to build your '}
351             \textcolor{stringliteral}{'frontend. See the above error for more information.'}
352         )
353 
354     \textcolor{comment}{# all the important files should've been moved to bundle.js in}
355     \textcolor{comment}{# server/static, now copy the rest into static}
356     target\_resource\_dir = os.path.join(
357         heroku\_server\_development\_path, \textcolor{stringliteral}{'server'}, \textcolor{stringliteral}{'static'}
358     )
359     \textcolor{keywordflow}{for} file\_path \textcolor{keywordflow}{in} task\_files\_to\_copy[\textcolor{stringliteral}{'static'}]:
360         \textcolor{keywordflow}{try}:
361             file\_name = os.path.basename(file\_path)
362             target\_path = os.path.join(target\_resource\_dir, file\_name)
363             shutil.copy2(file\_path, target\_path)
364         \textcolor{keywordflow}{except} IsADirectoryError:  \textcolor{comment}{# noqa: F821 we don't support python2}
365             dir\_name = os.path.basename(os.path.normpath(file\_path))
366             shutil.copytree(file\_path, os.path.join(target\_resource\_dir, dir\_name))
367         \textcolor{keywordflow}{except} FileNotFoundError:  \textcolor{comment}{# noqa: F821 we don't support python2}
368             \textcolor{keywordflow}{pass}
369 
370     hit\_config\_file\_path = os.path.join(tmp\_dir, \textcolor{stringliteral}{'hit\_config.json'})
371     sh.mv(hit\_config\_file\_path, target\_resource\_dir)
372 
373     print(\textcolor{stringliteral}{"Heroku: Starting server..."})
374 
375     heroku\_server\_directory\_path = os.path.join(
376         heroku\_server\_development\_path, \textcolor{stringliteral}{'server'}
377     )
378     os.chdir(heroku\_server\_directory\_path)
379     sh.git(\textcolor{stringliteral}{'init'})
380 
381     \textcolor{comment}{# get heroku credentials}
382     heroku\_user\_identifier = \textcolor{keywordtype}{None}
383     \textcolor{keywordflow}{while} \textcolor{keywordflow}{not} heroku\_user\_identifier:
384         \textcolor{keywordflow}{try}:
385             subprocess.check\_output(shlex.split(heroku\_executable\_path + \textcolor{stringliteral}{' auth:token'}))
386             heroku\_user\_identifier = netrc.netrc(
387                 os.path.join(os.path.expanduser(\textcolor{stringliteral}{"~"}), \textcolor{stringliteral}{'.netrc'})
388             ).hosts[\textcolor{stringliteral}{'api.heroku.com'}][0]
389         \textcolor{keywordflow}{except} subprocess.CalledProcessError:
390             \textcolor{keywordflow}{raise} SystemExit(
391                 \textcolor{stringliteral}{'A free Heroku account is required for launching MTurk tasks. '}
392                 \textcolor{stringliteral}{'Please register at https://signup.heroku.com/ and run `\{\} '}
393                 \textcolor{stringliteral}{'login` at the terminal to login to Heroku, and then run this '}
394                 \textcolor{stringliteral}{'program again.'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_executable\_path)
395             )
396 
397     heroku\_app\_name = (
398         \textcolor{stringliteral}{'\{\}-\{\}-\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
399             user\_name,
400             task\_name,
401             hashlib.md5(heroku\_user\_identifier.encode(\textcolor{stringliteral}{'utf-8'})).hexdigest(),
402         )
403     )[:30]
404 
405     \textcolor{keywordflow}{while} heroku\_app\_name[-1] == \textcolor{stringliteral}{'-'}:
406         heroku\_app\_name = heroku\_app\_name[:-1]
407 
408     \textcolor{comment}{# Create or attach to the server}
409     \textcolor{keywordflow}{try}:
410         \textcolor{keywordflow}{if} heroku\_team \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
411             subprocess.check\_output(
412                 shlex.split(
413                     \textcolor{stringliteral}{'\{\} create \{\} --team \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
414                         heroku\_executable\_path, heroku\_app\_name, heroku\_team
415                     )
416                 )
417             )
418         \textcolor{keywordflow}{else}:
419             subprocess.check\_output(
420                 shlex.split(
421                     \textcolor{stringliteral}{'\{\} create \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_executable\_path, heroku\_app\_name)
422                 )
423             )
424     \textcolor{keywordflow}{except} subprocess.CalledProcessError:  \textcolor{comment}{# User has too many apps}
425         sh.rm(shlex.split(\textcolor{stringliteral}{'-rf \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_server\_directory\_path)))
426         \textcolor{keywordflow}{raise} SystemExit(
427             \textcolor{stringliteral}{'You have hit your limit on concurrent apps with heroku, which are'}
428             \textcolor{stringliteral}{' required to run multiple concurrent tasks.\(\backslash\)nPlease wait for some'}
429             \textcolor{stringliteral}{' of your existing tasks to complete. If you have no tasks '}
430             \textcolor{stringliteral}{'running, login to heroku and delete some of the running apps or '}
431             \textcolor{stringliteral}{'verify your account to allow more concurrent apps'}
432         )
433 
434     \textcolor{comment}{# Enable WebSockets}
435     \textcolor{keywordflow}{try}:
436         subprocess.check\_output(
437             shlex.split(
438                 \textcolor{stringliteral}{'\{\} features:enable http-session-affinity'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
439                     heroku\_executable\_path
440                 )
441             )
442         )
443     \textcolor{keywordflow}{except} subprocess.CalledProcessError:  \textcolor{comment}{# Already enabled WebSockets}
444         \textcolor{keywordflow}{pass}
445 
446     \textcolor{comment}{# commit and push to the heroku server}
447     os.chdir(heroku\_server\_directory\_path)
448     sh.git(shlex.split(\textcolor{stringliteral}{'add -A'}))
449     sh.git(shlex.split(\textcolor{stringliteral}{'commit -m "app"'}))
450     sh.git(shlex.split(\textcolor{stringliteral}{'push -f heroku master'}))
451 
452     subprocess.check\_output(
453         shlex.split(\textcolor{stringliteral}{'\{\} ps:scale web=1'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_executable\_path))
454     )
455 
456     \textcolor{keywordflow}{if} use\_hobby:
457         \textcolor{keywordflow}{try}:
458             subprocess.check\_output(
459                 shlex.split(\textcolor{stringliteral}{'\{\} dyno:type Hobby'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_executable\_path))
460             )
461         \textcolor{keywordflow}{except} subprocess.CalledProcessError:  \textcolor{comment}{# User doesn't have hobby access}
462             \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a8dfde882f9d6ff492ca565ae2334fc70}{delete\_heroku\_server}(task\_name)
463             sh.rm(shlex.split(\textcolor{stringliteral}{'-rf \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_server\_directory\_path)))
464             \textcolor{keywordflow}{raise} SystemExit(
465                 \textcolor{stringliteral}{'Server launched with hobby flag but account cannot create '}
466                 \textcolor{stringliteral}{'hobby servers.'}
467             )
468     os.chdir(parent\_dir)
469 
470     \textcolor{comment}{# Clean up heroku files}
471     \textcolor{keywordflow}{if} os.path.exists(os.path.join(tmp\_dir, \textcolor{stringliteral}{'heroku.tar.gz'})):
472         os.remove(os.path.join(tmp\_dir, \textcolor{stringliteral}{'heroku.tar.gz'}))
473 
474     sh.rm(shlex.split(\textcolor{stringliteral}{'-rf \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_server\_development\_path)))
475 
476     \textcolor{keywordflow}{return} \textcolor{stringliteral}{'https://\{\}.herokuapp.com'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_app\_name)
477 
478 
\end{DoxyCode}
\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_adff2f564896069e0b76ae1b007515a2b}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_adff2f564896069e0b76ae1b007515a2b}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!setup\+\_\+legacy\+\_\+heroku\+\_\+server@{setup\+\_\+legacy\+\_\+heroku\+\_\+server}}
\index{setup\+\_\+legacy\+\_\+heroku\+\_\+server@{setup\+\_\+legacy\+\_\+heroku\+\_\+server}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{setup\+\_\+legacy\+\_\+heroku\+\_\+server()}{setup\_legacy\_heroku\_server()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+server\+\_\+utils.\+setup\+\_\+legacy\+\_\+heroku\+\_\+server (\begin{DoxyParamCaption}\item[{}]{task\+\_\+name,  }\item[{}]{task\+\_\+files\+\_\+to\+\_\+copy = {\ttfamily None},  }\item[{}]{heroku\+\_\+team = {\ttfamily None},  }\item[{}]{use\+\_\+hobby = {\ttfamily False},  }\item[{}]{tmp\+\_\+dir = {\ttfamily \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}{parent\+\_\+dir}} }\end{DoxyParamCaption})}



Definition at line 41 of file server\+\_\+utils.\+py.


\begin{DoxyCode}
41 ):
42     print(\textcolor{stringliteral}{"Heroku: Collecting files..."})
43     \textcolor{comment}{# Install Heroku CLI}
44     os\_name = \textcolor{keywordtype}{None}
45     bit\_architecture = \textcolor{keywordtype}{None}
46 
47     \textcolor{comment}{# Get the platform we are working on}
48     platform\_info = platform.platform()
49     \textcolor{keywordflow}{if} \textcolor{stringliteral}{'Darwin'} \textcolor{keywordflow}{in} platform\_info:  \textcolor{comment}{# Mac OS X}
50         os\_name = \textcolor{stringliteral}{'darwin'}
51     \textcolor{keywordflow}{elif} \textcolor{stringliteral}{'Linux'} \textcolor{keywordflow}{in} platform\_info:  \textcolor{comment}{# Linux}
52         os\_name = \textcolor{stringliteral}{'linux'}
53     \textcolor{keywordflow}{else}:
54         os\_name = \textcolor{stringliteral}{'windows'}
55 
56     \textcolor{comment}{# Find our architecture}
57     bit\_architecture\_info = platform.architecture()[0]
58     \textcolor{keywordflow}{if} \textcolor{stringliteral}{'64bit'} \textcolor{keywordflow}{in} bit\_architecture\_info:
59         bit\_architecture = \textcolor{stringliteral}{'x64'}
60     \textcolor{keywordflow}{else}:
61         bit\_architecture = \textcolor{stringliteral}{'x86'}
62 
63     \textcolor{comment}{# Remove existing heroku client files}
64     existing\_heroku\_directory\_names = glob.glob(os.path.join(tmp\_dir, \textcolor{stringliteral}{'heroku-cli-*'}))
65     \textcolor{keywordflow}{if} len(existing\_heroku\_directory\_names) == 0:
66         \textcolor{keywordflow}{if} os.path.exists(os.path.join(tmp\_dir, \textcolor{stringliteral}{'heroku.tar.gz'})):
67             os.remove(os.path.join(tmp\_dir, \textcolor{stringliteral}{'heroku.tar.gz'}))
68 
69         \textcolor{comment}{# Get the heroku client and unzip}
70         os.chdir(tmp\_dir)
71         sh.wget(
72             shlex.split(
73                 \textcolor{stringliteral}{'\{\}-\{\}-\{\}.tar.gz -O heroku.tar.gz'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
74                     heroku\_url, os\_name, bit\_architecture
75                 )
76             )
77         )
78         sh.tar(shlex.split(\textcolor{stringliteral}{'-xvzf heroku.tar.gz'}))
79 
80     heroku\_directory\_name = glob.glob(os.path.join(tmp\_dir, \textcolor{stringliteral}{'heroku-cli-*'}))[0]
81     heroku\_directory\_path = os.path.join(tmp\_dir, heroku\_directory\_name)
82     heroku\_executable\_path = os.path.join(heroku\_directory\_path, \textcolor{stringliteral}{'bin'}, \textcolor{stringliteral}{'heroku'})
83 
84     server\_source\_directory\_path = os.path.join(
85         parent\_dir, legacy\_server\_source\_directory\_name
86     )
87     heroku\_server\_directory\_path = os.path.join(
88         tmp\_dir, \textcolor{stringliteral}{'\{\}\_\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_server\_directory\_name, task\_name)
89     )
90 
91     \textcolor{comment}{# Delete old server files}
92     sh.rm(shlex.split(\textcolor{stringliteral}{'-rf '} + heroku\_server\_directory\_path))
93 
94     \textcolor{comment}{# Copy over a clean copy into the server directory}
95     shutil.copytree(server\_source\_directory\_path, heroku\_server\_directory\_path)
96 
97     \textcolor{comment}{# Consolidate task files}
98     task\_directory\_path = os.path.join(
99         heroku\_server\_directory\_path, task\_directory\_name
100     )
101     sh.mv(os.path.join(heroku\_server\_directory\_path, \textcolor{stringliteral}{'html'}), task\_directory\_path)
102 
103     hit\_config\_file\_path = os.path.join(tmp\_dir, \textcolor{stringliteral}{'hit\_config.json'})
104     sh.mv(hit\_config\_file\_path, task\_directory\_path)
105 
106     \textcolor{keywordflow}{for} file\_path \textcolor{keywordflow}{in} task\_files\_to\_copy:
107         \textcolor{keywordflow}{try}:
108             shutil.copy2(file\_path, task\_directory\_path)
109         \textcolor{keywordflow}{except} IsADirectoryError:  \textcolor{comment}{# noqa: F821 we don't support python2}
110             dir\_name = os.path.basename(os.path.normpath(file\_path))
111             shutil.copytree(file\_path, os.path.join(task\_directory\_path, dir\_name))
112         \textcolor{keywordflow}{except} FileNotFoundError:  \textcolor{comment}{# noqa: F821 we don't support python2}
113             \textcolor{keywordflow}{pass}
114 
115     print(\textcolor{stringliteral}{"Heroku: Starting server..."})
116 
117     os.chdir(heroku\_server\_directory\_path)
118     sh.git(\textcolor{stringliteral}{'init'})
119 
120     \textcolor{comment}{# get heroku credentials}
121     heroku\_user\_identifier = \textcolor{keywordtype}{None}
122     \textcolor{keywordflow}{while} \textcolor{keywordflow}{not} heroku\_user\_identifier:
123         \textcolor{keywordflow}{try}:
124             subprocess.check\_output(shlex.split(heroku\_executable\_path + \textcolor{stringliteral}{' auth:token'}))
125             heroku\_user\_identifier = netrc.netrc(
126                 os.path.join(os.path.expanduser(\textcolor{stringliteral}{"~"}), \textcolor{stringliteral}{'.netrc'})
127             ).hosts[\textcolor{stringliteral}{'api.heroku.com'}][0]
128         \textcolor{keywordflow}{except} subprocess.CalledProcessError:
129             \textcolor{keywordflow}{raise} SystemExit(
130                 \textcolor{stringliteral}{'A free Heroku account is required for launching MTurk tasks. '}
131                 \textcolor{stringliteral}{'Please register at https://signup.heroku.com/ and run `\{\} '}
132                 \textcolor{stringliteral}{'login` at the terminal to login to Heroku, and then run this '}
133                 \textcolor{stringliteral}{'program again.'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_executable\_path)
134             )
135 
136     heroku\_app\_name = (
137         \textcolor{stringliteral}{'\{\}-\{\}-\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
138             user\_name,
139             task\_name,
140             hashlib.md5(heroku\_user\_identifier.encode(\textcolor{stringliteral}{'utf-8'})).hexdigest(),
141         )
142     )[:30]
143 
144     \textcolor{keywordflow}{while} heroku\_app\_name[-1] == \textcolor{stringliteral}{'-'}:
145         heroku\_app\_name = heroku\_app\_name[:-1]
146 
147     \textcolor{comment}{# Create or attach to the server}
148     \textcolor{keywordflow}{try}:
149         \textcolor{keywordflow}{if} heroku\_team \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
150             subprocess.check\_output(
151                 shlex.split(
152                     \textcolor{stringliteral}{'\{\} create \{\} --team \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
153                         heroku\_executable\_path, heroku\_app\_name, heroku\_team
154                     )
155                 )
156             )
157         \textcolor{keywordflow}{else}:
158             subprocess.check\_output(
159                 shlex.split(
160                     \textcolor{stringliteral}{'\{\} create \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_executable\_path, heroku\_app\_name)
161                 )
162             )
163     \textcolor{keywordflow}{except} subprocess.CalledProcessError:  \textcolor{comment}{# User has too many apps}
164         sh.rm(shlex.split(\textcolor{stringliteral}{'-rf \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_server\_directory\_path)))
165         \textcolor{keywordflow}{raise} SystemExit(
166             \textcolor{stringliteral}{'You have hit your limit on concurrent apps with heroku, which are'}
167             \textcolor{stringliteral}{' required to run multiple concurrent tasks.\(\backslash\)nPlease wait for some'}
168             \textcolor{stringliteral}{' of your existing tasks to complete. If you have no tasks '}
169             \textcolor{stringliteral}{'running, login to heroku and delete some of the running apps or '}
170             \textcolor{stringliteral}{'verify your account to allow more concurrent apps'}
171         )
172 
173     \textcolor{comment}{# Enable WebSockets}
174     \textcolor{keywordflow}{try}:
175         subprocess.check\_output(
176             shlex.split(
177                 \textcolor{stringliteral}{'\{\} features:enable http-session-affinity'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
178                     heroku\_executable\_path
179                 )
180             )
181         )
182     \textcolor{keywordflow}{except} subprocess.CalledProcessError:  \textcolor{comment}{# Already enabled WebSockets}
183         \textcolor{keywordflow}{pass}
184 
185     \textcolor{comment}{# commit and push to the heroku server}
186     os.chdir(heroku\_server\_directory\_path)
187     sh.git(shlex.split(\textcolor{stringliteral}{'add -A'}))
188     sh.git(shlex.split(\textcolor{stringliteral}{'commit -m "app"'}))
189     sh.git(shlex.split(\textcolor{stringliteral}{'push -f heroku master'}))
190 
191     subprocess.check\_output(
192         shlex.split(\textcolor{stringliteral}{'\{\} ps:scale web=1'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_executable\_path))
193     )
194 
195     \textcolor{keywordflow}{if} use\_hobby:
196         \textcolor{keywordflow}{try}:
197             subprocess.check\_output(
198                 shlex.split(\textcolor{stringliteral}{'\{\} dyno:type Hobby'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_executable\_path))
199             )
200         \textcolor{keywordflow}{except} subprocess.CalledProcessError:  \textcolor{comment}{# User doesn't have hobby access}
201             \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a8dfde882f9d6ff492ca565ae2334fc70}{delete\_heroku\_server}(task\_name)
202             sh.rm(shlex.split(\textcolor{stringliteral}{'-rf \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_server\_directory\_path)))
203             \textcolor{keywordflow}{raise} SystemExit(
204                 \textcolor{stringliteral}{'Server launched with hobby flag but account cannot create '}
205                 \textcolor{stringliteral}{'hobby servers.'}
206             )
207     os.chdir(parent\_dir)
208 
209     \textcolor{comment}{# Clean up heroku files}
210     \textcolor{keywordflow}{if} os.path.exists(os.path.join(parent\_dir, \textcolor{stringliteral}{'heroku.tar.gz'})):
211         os.remove(os.path.join(parent\_dir, \textcolor{stringliteral}{'heroku.tar.gz'}))
212 
213     sh.rm(shlex.split(\textcolor{stringliteral}{'-rf \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_server\_directory\_path)))
214 
215     \textcolor{keywordflow}{return} \textcolor{stringliteral}{'https://\{\}.herokuapp.com'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(heroku\_app\_name)
216 
217 
\end{DoxyCode}
\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_afe9361009645f245de2a07c18cd485bb}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_afe9361009645f245de2a07c18cd485bb}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!setup\+\_\+legacy\+\_\+server@{setup\+\_\+legacy\+\_\+server}}
\index{setup\+\_\+legacy\+\_\+server@{setup\+\_\+legacy\+\_\+server}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{setup\+\_\+legacy\+\_\+server()}{setup\_legacy\_server()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+server\+\_\+utils.\+setup\+\_\+legacy\+\_\+server (\begin{DoxyParamCaption}\item[{}]{task\+\_\+name,  }\item[{}]{task\+\_\+files\+\_\+to\+\_\+copy,  }\item[{}]{local = {\ttfamily False},  }\item[{}]{heroku\+\_\+team = {\ttfamily None},  }\item[{}]{use\+\_\+hobby = {\ttfamily False},  }\item[{}]{legacy = {\ttfamily True},  }\item[{}]{tmp\+\_\+dir = {\ttfamily \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}{parent\+\_\+dir}} }\end{DoxyParamCaption})}



Definition at line 581 of file server\+\_\+utils.\+py.


\begin{DoxyCode}
581 ):
582     \textcolor{keywordflow}{if} local:
583         \textcolor{keywordflow}{return} \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a9d4c4937ea60bd74630a44739e825ebf}{setup\_local\_server}(task\_name, task\_files\_to\_copy=task\_files\_to\_copy)
584     \textcolor{keywordflow}{return} \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_adff2f564896069e0b76ae1b007515a2b}{setup\_legacy\_heroku\_server}(
585         task\_name,
586         task\_files\_to\_copy=task\_files\_to\_copy,
587         heroku\_team=heroku\_team,
588         use\_hobby=use\_hobby,
589         tmp\_dir=tmp\_dir,
590     )
591 
592 
\end{DoxyCode}
\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a9d4c4937ea60bd74630a44739e825ebf}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a9d4c4937ea60bd74630a44739e825ebf}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!setup\+\_\+local\+\_\+server@{setup\+\_\+local\+\_\+server}}
\index{setup\+\_\+local\+\_\+server@{setup\+\_\+local\+\_\+server}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{setup\+\_\+local\+\_\+server()}{setup\_local\_server()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+server\+\_\+utils.\+setup\+\_\+local\+\_\+server (\begin{DoxyParamCaption}\item[{}]{task\+\_\+name,  }\item[{}]{task\+\_\+files\+\_\+to\+\_\+copy = {\ttfamily None} }\end{DoxyParamCaption})}



Definition at line 507 of file server\+\_\+utils.\+py.


\begin{DoxyCode}
507 \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a9d4c4937ea60bd74630a44739e825ebf}{setup\_local\_server}(task\_name, task\_files\_to\_copy=None):
508     \textcolor{keyword}{global} server\_process
509     print(\textcolor{stringliteral}{"Local Server: Collecting files..."})
510 
511     server\_source\_directory\_path = os.path.join(
512         parent\_dir, legacy\_server\_source\_directory\_name
513     )
514     local\_server\_directory\_path = os.path.join(
515         parent\_dir, \textcolor{stringliteral}{'\{\}\_\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(local\_server\_directory\_name, task\_name)
516     )
517 
518     \textcolor{comment}{# Delete old server files}
519     sh.rm(shlex.split(\textcolor{stringliteral}{'-rf '} + local\_server\_directory\_path))
520 
521     \textcolor{comment}{# Copy over a clean copy into the server directory}
522     shutil.copytree(server\_source\_directory\_path, local\_server\_directory\_path)
523 
524     \textcolor{comment}{# Consolidate task files}
525     task\_directory\_path = os.path.join(local\_server\_directory\_path, task\_directory\_name)
526     sh.mv(os.path.join(local\_server\_directory\_path, \textcolor{stringliteral}{'html'}), task\_directory\_path)
527 
528     hit\_config\_file\_path = os.path.join(parent\_dir, \textcolor{stringliteral}{'hit\_config.json'})
529     sh.mv(hit\_config\_file\_path, task\_directory\_path)
530 
531     \textcolor{keywordflow}{for} file\_path \textcolor{keywordflow}{in} task\_files\_to\_copy:
532         \textcolor{keywordflow}{try}:
533             shutil.copy2(file\_path, task\_directory\_path)
534         \textcolor{keywordflow}{except} IsADirectoryError:  \textcolor{comment}{# noqa: F821 we don't support python2}
535             dir\_name = os.path.basename(os.path.normpath(file\_path))
536             shutil.copytree(file\_path, os.path.join(task\_directory\_path, dir\_name))
537         \textcolor{keywordflow}{except} FileNotFoundError:  \textcolor{comment}{# noqa: F821 we don't support python2}
538             \textcolor{keywordflow}{pass}
539 
540     print(\textcolor{stringliteral}{"Local: Starting server..."})
541 
542     os.chdir(local\_server\_directory\_path)
543 
544     packages\_installed = subprocess.call([\textcolor{stringliteral}{'npm'}, \textcolor{stringliteral}{'install'}])
545     \textcolor{keywordflow}{if} packages\_installed != 0:
546         \textcolor{keywordflow}{raise} Exception(
547             \textcolor{stringliteral}{'please make sure npm is installed, otherwise view '}
548             \textcolor{stringliteral}{'the above error for more info.'}
549         )
550 
551     server\_process = subprocess.Popen([\textcolor{stringliteral}{'node'}, \textcolor{stringliteral}{'server.js'}])
552 
553     time.sleep(1)
554     print(\textcolor{stringliteral}{'Server running locally with pid \{\}.'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(server\_process.pid))
555     host = \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1dev_1_1test_1_1test__full__system_a1e1817cd65688fb90f827834d1fb4567}{input}(\textcolor{stringliteral}{'Please enter the public server address, like https://hostname.com: '})
556     port = \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1dev_1_1test_1_1test__full__system_a1e1817cd65688fb90f827834d1fb4567}{input}(\textcolor{stringliteral}{'Please enter the port given above, likely 3000: '})
557     \textcolor{keywordflow}{return} \textcolor{stringliteral}{'\{\}:\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(host, port)
558 
559 
\end{DoxyCode}
\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a154e8cbb18375ff8fd6730154d312bbc}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a154e8cbb18375ff8fd6730154d312bbc}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!setup\+\_\+server@{setup\+\_\+server}}
\index{setup\+\_\+server@{setup\+\_\+server}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{setup\+\_\+server()}{setup\_server()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+server\+\_\+utils.\+setup\+\_\+server (\begin{DoxyParamCaption}\item[{}]{task\+\_\+name,  }\item[{}]{task\+\_\+files\+\_\+to\+\_\+copy,  }\item[{}]{local = {\ttfamily False},  }\item[{}]{heroku\+\_\+team = {\ttfamily None},  }\item[{}]{use\+\_\+hobby = {\ttfamily False},  }\item[{}]{legacy = {\ttfamily True},  }\item[{}]{tmp\+\_\+dir = {\ttfamily \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}{parent\+\_\+dir}} }\end{DoxyParamCaption})}



Definition at line 601 of file server\+\_\+utils.\+py.


\begin{DoxyCode}
601 ):
602     \textcolor{keywordflow}{if} local:
603         \textcolor{keywordflow}{raise} Exception(\textcolor{stringliteral}{'Local server not yet supported for non-legacy tasks'})
604     \textcolor{keywordflow}{return} \hyperlink{namespaceparlai_1_1mturk_1_1core_1_1server__utils_af1c97e9b93a403e200ac75b87a51c3c1}{setup\_heroku\_server}(
605         task\_name,
606         task\_files\_to\_copy=task\_files\_to\_copy,
607         heroku\_team=heroku\_team,
608         use\_hobby=use\_hobby,
609         tmp\_dir=tmp\_dir,
610     )
611 
612 
\end{DoxyCode}


\subsection{Variable Documentation}
\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_ab10051dadca0c79ca62cc3974302b38c}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_ab10051dadca0c79ca62cc3974302b38c}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!heroku\+\_\+server\+\_\+directory\+\_\+name@{heroku\+\_\+server\+\_\+directory\+\_\+name}}
\index{heroku\+\_\+server\+\_\+directory\+\_\+name@{heroku\+\_\+server\+\_\+directory\+\_\+name}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{heroku\+\_\+server\+\_\+directory\+\_\+name}{heroku\_server\_directory\_name}}
{\footnotesize\ttfamily parlai.\+mturk.\+core.\+server\+\_\+utils.\+heroku\+\_\+server\+\_\+directory\+\_\+name}



Definition at line 26 of file server\+\_\+utils.\+py.

\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_af0a7a24b863dfa547099d64e3bc498a6}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_af0a7a24b863dfa547099d64e3bc498a6}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!heroku\+\_\+url@{heroku\+\_\+url}}
\index{heroku\+\_\+url@{heroku\+\_\+url}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{heroku\+\_\+url}{heroku\_url}}
{\footnotesize\ttfamily parlai.\+mturk.\+core.\+server\+\_\+utils.\+heroku\+\_\+url}



Definition at line 32 of file server\+\_\+utils.\+py.

\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a02e8688330df26d098d2c719583fb10c}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a02e8688330df26d098d2c719583fb10c}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!legacy\+\_\+server\+\_\+source\+\_\+directory\+\_\+name@{legacy\+\_\+server\+\_\+source\+\_\+directory\+\_\+name}}
\index{legacy\+\_\+server\+\_\+source\+\_\+directory\+\_\+name@{legacy\+\_\+server\+\_\+source\+\_\+directory\+\_\+name}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{legacy\+\_\+server\+\_\+source\+\_\+directory\+\_\+name}{legacy\_server\_source\_directory\_name}}
{\footnotesize\ttfamily parlai.\+mturk.\+core.\+server\+\_\+utils.\+legacy\+\_\+server\+\_\+source\+\_\+directory\+\_\+name}



Definition at line 24 of file server\+\_\+utils.\+py.

\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_ab9e3011a4cf2f86f4d520249eed8c77d}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_ab9e3011a4cf2f86f4d520249eed8c77d}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!local\+\_\+server\+\_\+directory\+\_\+name@{local\+\_\+server\+\_\+directory\+\_\+name}}
\index{local\+\_\+server\+\_\+directory\+\_\+name@{local\+\_\+server\+\_\+directory\+\_\+name}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{local\+\_\+server\+\_\+directory\+\_\+name}{local\_server\_directory\_name}}
{\footnotesize\ttfamily parlai.\+mturk.\+core.\+server\+\_\+utils.\+local\+\_\+server\+\_\+directory\+\_\+name}



Definition at line 27 of file server\+\_\+utils.\+py.

\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a193439bdbc25a32b00f1a43e6f8532d8}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!parent\+\_\+dir@{parent\+\_\+dir}}
\index{parent\+\_\+dir@{parent\+\_\+dir}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{parent\+\_\+dir}{parent\_dir}}
{\footnotesize\ttfamily parlai.\+mturk.\+core.\+server\+\_\+utils.\+parent\+\_\+dir}



Definition at line 23 of file server\+\_\+utils.\+py.

\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a677cf88f4f2a1e0bc2c93c5d40c2e49d}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a677cf88f4f2a1e0bc2c93c5d40c2e49d}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!region\+\_\+name@{region\+\_\+name}}
\index{region\+\_\+name@{region\+\_\+name}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{region\+\_\+name}{region\_name}}
{\footnotesize\ttfamily parlai.\+mturk.\+core.\+server\+\_\+utils.\+region\+\_\+name}



Definition at line 20 of file server\+\_\+utils.\+py.

\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a78acb12c579488b178c9815ce79f4018}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a78acb12c579488b178c9815ce79f4018}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!server\+\_\+process@{server\+\_\+process}}
\index{server\+\_\+process@{server\+\_\+process}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{server\+\_\+process}{server\_process}}
{\footnotesize\ttfamily parlai.\+mturk.\+core.\+server\+\_\+utils.\+server\+\_\+process}



Definition at line 30 of file server\+\_\+utils.\+py.

\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a6abce559cbe7e80bc5bbf32cc1fcff5a}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_a6abce559cbe7e80bc5bbf32cc1fcff5a}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!server\+\_\+source\+\_\+directory\+\_\+name@{server\+\_\+source\+\_\+directory\+\_\+name}}
\index{server\+\_\+source\+\_\+directory\+\_\+name@{server\+\_\+source\+\_\+directory\+\_\+name}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{server\+\_\+source\+\_\+directory\+\_\+name}{server\_source\_directory\_name}}
{\footnotesize\ttfamily parlai.\+mturk.\+core.\+server\+\_\+utils.\+server\+\_\+source\+\_\+directory\+\_\+name}



Definition at line 25 of file server\+\_\+utils.\+py.

\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_ae9c1d985b98f823a2a479d519af0c06d}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_ae9c1d985b98f823a2a479d519af0c06d}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!task\+\_\+directory\+\_\+name@{task\+\_\+directory\+\_\+name}}
\index{task\+\_\+directory\+\_\+name@{task\+\_\+directory\+\_\+name}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{task\+\_\+directory\+\_\+name}{task\_directory\_name}}
{\footnotesize\ttfamily parlai.\+mturk.\+core.\+server\+\_\+utils.\+task\+\_\+directory\+\_\+name}



Definition at line 28 of file server\+\_\+utils.\+py.

\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1core_1_1server__utils_aab8bab9c0a550608566b493173c8fd28}\label{namespaceparlai_1_1mturk_1_1core_1_1server__utils_aab8bab9c0a550608566b493173c8fd28}} 
\index{parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}!user\+\_\+name@{user\+\_\+name}}
\index{user\+\_\+name@{user\+\_\+name}!parlai\+::mturk\+::core\+::server\+\_\+utils@{parlai\+::mturk\+::core\+::server\+\_\+utils}}
\subsubsection{\texorpdfstring{user\+\_\+name}{user\_name}}
{\footnotesize\ttfamily parlai.\+mturk.\+core.\+server\+\_\+utils.\+user\+\_\+name}



Definition at line 21 of file server\+\_\+utils.\+py.

