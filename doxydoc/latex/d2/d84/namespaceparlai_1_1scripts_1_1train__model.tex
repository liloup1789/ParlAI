\hypertarget{namespaceparlai_1_1scripts_1_1train__model}{}\section{parlai.\+scripts.\+train\+\_\+model Namespace Reference}
\label{namespaceparlai_1_1scripts_1_1train__model}\index{parlai.\+scripts.\+train\+\_\+model@{parlai.\+scripts.\+train\+\_\+model}}
\subsection*{Classes}
\begin{DoxyCompactItemize}
\item 
class \hyperlink{classparlai_1_1scripts_1_1train__model_1_1TrainLoop}{Train\+Loop}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{namespaceparlai_1_1scripts_1_1train__model_a5130cce2fb2a33694a2537d800ad9e9e}{setup\+\_\+args} (parser=None)
\item 
def \hyperlink{namespaceparlai_1_1scripts_1_1train__model_a70da71a6f4f9ad144666e6353d9278e3}{load\+\_\+eval\+\_\+worlds} (agent, opt, datatype)
\item 
def \hyperlink{namespaceparlai_1_1scripts_1_1train__model_a496dfe3bf04da9b55d261b4c8d6229a7}{run\+\_\+eval} (valid\+\_\+worlds, opt, datatype, max\+\_\+exs=-\/1, write\+\_\+log=False)
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\mbox{\Hypertarget{namespaceparlai_1_1scripts_1_1train__model_a70da71a6f4f9ad144666e6353d9278e3}\label{namespaceparlai_1_1scripts_1_1train__model_a70da71a6f4f9ad144666e6353d9278e3}} 
\index{parlai\+::scripts\+::train\+\_\+model@{parlai\+::scripts\+::train\+\_\+model}!load\+\_\+eval\+\_\+worlds@{load\+\_\+eval\+\_\+worlds}}
\index{load\+\_\+eval\+\_\+worlds@{load\+\_\+eval\+\_\+worlds}!parlai\+::scripts\+::train\+\_\+model@{parlai\+::scripts\+::train\+\_\+model}}
\subsubsection{\texorpdfstring{load\+\_\+eval\+\_\+worlds()}{load\_eval\_worlds()}}
{\footnotesize\ttfamily def parlai.\+scripts.\+train\+\_\+model.\+load\+\_\+eval\+\_\+worlds (\begin{DoxyParamCaption}\item[{}]{agent,  }\item[{}]{opt,  }\item[{}]{datatype }\end{DoxyParamCaption})}

\begin{DoxyVerb}Create a new eval world for the agent and the given opt.

Overrides the datatype options for doing this.  Handles some magic
overrides of other special options for the training script.

:param Agent agent:
    The model being trained.

:param Opt opt:
    The global CLI opts.

:param string datatype:
    The new datatype.
\end{DoxyVerb}
 

Definition at line 206 of file train\+\_\+model.\+py.


\begin{DoxyCode}
206 \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1scripts_1_1train__model_a70da71a6f4f9ad144666e6353d9278e3}{load\_eval\_worlds}(agent, opt, datatype):
207     \textcolor{stringliteral}{"""}
208 \textcolor{stringliteral}{    Create a new eval world for the agent and the given opt.}
209 \textcolor{stringliteral}{}
210 \textcolor{stringliteral}{    Overrides the datatype options for doing this.  Handles some magic}
211 \textcolor{stringliteral}{    overrides of other special options for the training script.}
212 \textcolor{stringliteral}{}
213 \textcolor{stringliteral}{    :param Agent agent:}
214 \textcolor{stringliteral}{        The model being trained.}
215 \textcolor{stringliteral}{}
216 \textcolor{stringliteral}{    :param Opt opt:}
217 \textcolor{stringliteral}{        The global CLI opts.}
218 \textcolor{stringliteral}{}
219 \textcolor{stringliteral}{    :param string datatype:}
220 \textcolor{stringliteral}{        The new datatype.}
221 \textcolor{stringliteral}{    """}
222     \textcolor{keywordflow}{if} \textcolor{stringliteral}{'stream'} \textcolor{keywordflow}{in} opt[\textcolor{stringliteral}{'datatype'}]:
223         datatype += \textcolor{stringliteral}{':stream'}
224     opt = opt.copy()
225     opt[\textcolor{stringliteral}{'datatype'}] = datatype
226     \textcolor{keywordflow}{if} opt.get(\textcolor{stringliteral}{'pytorch\_teacher\_task'}):
227         \textcolor{comment}{# never use pytorch teachers for evaluation}
228         \textcolor{comment}{# but don't forget what we were normally using}
229         opt[\textcolor{stringliteral}{'task'}] = opt[\textcolor{stringliteral}{'pytorch\_teacher\_task'}]
230         del opt[\textcolor{stringliteral}{'pytorch\_teacher\_task'}]
231     \textcolor{keywordflow}{if} opt.get(\textcolor{stringliteral}{'evaltask'}):
232         \textcolor{comment}{# if a different eval task is specified, use it.}
233         opt[\textcolor{stringliteral}{'task'}] = opt[\textcolor{stringliteral}{'evaltask'}]
234     \textcolor{keywordflow}{if} opt.get(\textcolor{stringliteral}{'eval\_batchsize'}):
235         \textcolor{comment}{# override eval time batchsize}
236         opt[\textcolor{stringliteral}{'batchsize'}] = opt[\textcolor{stringliteral}{'eval\_batchsize'}]
237 
238     tasks = opt[\textcolor{stringliteral}{'task'}].split(\textcolor{stringliteral}{','})
239     worlds = []
240     \textcolor{comment}{# possibly load agent}
241     \textcolor{keywordflow}{if} opt.get(\textcolor{stringliteral}{'validation\_share\_agent'}, \textcolor{keyword}{False}):
242         valid\_agent = \hyperlink{namespaceparlai_1_1core_1_1agents_aa5af5dd1d2f9da491b60348d479b849f}{create\_agent\_from\_shared}(agent.share())
243     \textcolor{keywordflow}{else}:
244         valid\_agent = agent
245     \textcolor{comment}{# create worlds}
246     \textcolor{keywordflow}{for} task \textcolor{keywordflow}{in} tasks:
247         task\_opt = opt.copy()  \textcolor{comment}{# copy opt since we edit the task}
248         task\_opt[\textcolor{stringliteral}{'task'}] = task
249         valid\_world = \hyperlink{namespaceparlai_1_1core_1_1worlds_a79969c7ba76d4b3c500f5bb776444dc6}{create\_task}(task\_opt, valid\_agent)
250         worlds.append(valid\_world)
251 
252     \textcolor{keywordflow}{return} worlds
253 
254 
\end{DoxyCode}
\mbox{\Hypertarget{namespaceparlai_1_1scripts_1_1train__model_a496dfe3bf04da9b55d261b4c8d6229a7}\label{namespaceparlai_1_1scripts_1_1train__model_a496dfe3bf04da9b55d261b4c8d6229a7}} 
\index{parlai\+::scripts\+::train\+\_\+model@{parlai\+::scripts\+::train\+\_\+model}!run\+\_\+eval@{run\+\_\+eval}}
\index{run\+\_\+eval@{run\+\_\+eval}!parlai\+::scripts\+::train\+\_\+model@{parlai\+::scripts\+::train\+\_\+model}}
\subsubsection{\texorpdfstring{run\+\_\+eval()}{run\_eval()}}
{\footnotesize\ttfamily def parlai.\+scripts.\+train\+\_\+model.\+run\+\_\+eval (\begin{DoxyParamCaption}\item[{}]{valid\+\_\+worlds,  }\item[{}]{opt,  }\item[{}]{datatype,  }\item[{}]{max\+\_\+exs = {\ttfamily -\/1},  }\item[{}]{write\+\_\+log = {\ttfamily False} }\end{DoxyParamCaption})}

\begin{DoxyVerb}Eval on validation/test data.

:param valid_world:
    list of the pre-created validation worlds.
:param opt:
    the options that specific the task, eval_task, etc
:param datatype:
    the datatype to use, such as "valid" or "test"
:param bool write_log:
    specifies to write metrics to file if the model_file is set
:param int max_exs:
    limits the number of examples if max_exs > 0
\end{DoxyVerb}
 

Definition at line 274 of file train\+\_\+model.\+py.


\begin{DoxyCode}
274 \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1scripts_1_1train__model_a496dfe3bf04da9b55d261b4c8d6229a7}{run\_eval}(valid\_worlds, opt, datatype, max\_exs=-1, write\_log=False):
275     \textcolor{stringliteral}{"""}
276 \textcolor{stringliteral}{    Eval on validation/test data.}
277 \textcolor{stringliteral}{}
278 \textcolor{stringliteral}{    :param valid\_world:}
279 \textcolor{stringliteral}{        list of the pre-created validation worlds.}
280 \textcolor{stringliteral}{    :param opt:}
281 \textcolor{stringliteral}{        the options that specific the task, eval\_task, etc}
282 \textcolor{stringliteral}{    :param datatype:}
283 \textcolor{stringliteral}{        the datatype to use, such as "valid" or "test"}
284 \textcolor{stringliteral}{    :param bool write\_log:}
285 \textcolor{stringliteral}{        specifies to write metrics to file if the model\_file is set}
286 \textcolor{stringliteral}{    :param int max\_exs:}
287 \textcolor{stringliteral}{        limits the number of examples if max\_exs > 0}
288 \textcolor{stringliteral}{    """}
289     \textcolor{keywordflow}{if} valid\_worlds \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
290         \textcolor{comment}{# This isn't the primary worker, so we can just skip evaluation}
291         \textcolor{keywordflow}{return} \textcolor{keywordtype}{None}
292 
293     print(\textcolor{stringliteral}{'[ running eval: '} + datatype + \textcolor{stringliteral}{' ]'})
294     timer = Timer()
295     reports = []
296     \textcolor{keywordflow}{for} v\_world \textcolor{keywordflow}{in} valid\_worlds:
297         task\_report = \_run\_single\_eval(opt, v\_world, max\_exs / len(valid\_worlds))
298         reports.append(task\_report)
299 
300     tasks = [world.getID() \textcolor{keywordflow}{for} world \textcolor{keywordflow}{in} valid\_worlds]
301     report = \hyperlink{namespaceparlai_1_1core_1_1metrics_ae323045c05ed03d93c260521ebb8bf71}{aggregate\_task\_reports}(
302         reports, tasks, micro=opt.get(\textcolor{stringliteral}{'aggregate\_micro'}, \textcolor{keyword}{True})
303     )
304 
305     metrics = f\textcolor{stringliteral}{'\{datatype\}:\{report\}'}
306     print(f\textcolor{stringliteral}{'[ eval completed in \{timer.time():.2f\}s ]'})
307     print(metrics)
308 
309     \textcolor{comment}{# write to file}
310     \textcolor{keywordflow}{if} write\_log \textcolor{keywordflow}{and} opt.get(\textcolor{stringliteral}{'model\_file'}):
311         \textcolor{comment}{# Write out metrics}
312         f = open(opt[\textcolor{stringliteral}{'model\_file'}] + \textcolor{stringliteral}{'.'} + datatype, \textcolor{stringliteral}{'a+'})
313         f.write(metrics + \textcolor{stringliteral}{'\(\backslash\)n'})
314         f.close()
315 
316     \textcolor{keywordflow}{return} report
317 
318 
\end{DoxyCode}
\mbox{\Hypertarget{namespaceparlai_1_1scripts_1_1train__model_a5130cce2fb2a33694a2537d800ad9e9e}\label{namespaceparlai_1_1scripts_1_1train__model_a5130cce2fb2a33694a2537d800ad9e9e}} 
\index{parlai\+::scripts\+::train\+\_\+model@{parlai\+::scripts\+::train\+\_\+model}!setup\+\_\+args@{setup\+\_\+args}}
\index{setup\+\_\+args@{setup\+\_\+args}!parlai\+::scripts\+::train\+\_\+model@{parlai\+::scripts\+::train\+\_\+model}}
\subsubsection{\texorpdfstring{setup\+\_\+args()}{setup\_args()}}
{\footnotesize\ttfamily def parlai.\+scripts.\+train\+\_\+model.\+setup\+\_\+args (\begin{DoxyParamCaption}\item[{}]{parser = {\ttfamily None},  }\item[{}]{Parlai\+Parser }\end{DoxyParamCaption})}

\begin{DoxyVerb}Build the ParlAI parser, adding command line args if necessary.

:param ParlaiParser parser:
    Preexisting parser to append options to. Will be created if needed.

:returns:
    the ParlaiParser with CLI options added.
\end{DoxyVerb}
 

Definition at line 51 of file train\+\_\+model.\+py.


\begin{DoxyCode}
51 \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1scripts_1_1train__model_a5130cce2fb2a33694a2537d800ad9e9e}{setup\_args}(parser=None) -> ParlaiParser:
52     \textcolor{stringliteral}{"""}
53 \textcolor{stringliteral}{    Build the ParlAI parser, adding command line args if necessary.}
54 \textcolor{stringliteral}{}
55 \textcolor{stringliteral}{    :param ParlaiParser parser:}
56 \textcolor{stringliteral}{        Preexisting parser to append options to. Will be created if needed.}
57 \textcolor{stringliteral}{}
58 \textcolor{stringliteral}{    :returns:}
59 \textcolor{stringliteral}{        the ParlaiParser with CLI options added.}
60 \textcolor{stringliteral}{    """}
61     \textcolor{keywordflow}{if} parser \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
62         parser = ParlaiParser(\textcolor{keyword}{True}, \textcolor{keyword}{True}, \textcolor{stringliteral}{'Train a model'})
63     parser.add\_pytorch\_datateacher\_args()
64     train = parser.add\_argument\_group(\textcolor{stringliteral}{'Training Loop Arguments'})
65     train.add\_argument(
66         \textcolor{stringliteral}{'-et'},
67         \textcolor{stringliteral}{'--evaltask'},
68         help=\textcolor{stringliteral}{'task to use for valid/test (defaults to the one used for training)'},
69     )
70     train.add\_argument(
71         \textcolor{stringliteral}{'--eval-batchsize'},
72         type=int,
73         hidden=\textcolor{keyword}{True},
74         help=\textcolor{stringliteral}{'Eval time batch size (defaults to same as -bs)'},
75     )
76     train.add\_argument(\textcolor{stringliteral}{'--display-examples'}, type=\textcolor{stringliteral}{'bool'}, default=\textcolor{keyword}{False}, hidden=\textcolor{keyword}{True})
77     train.add\_argument(\textcolor{stringliteral}{'-eps'}, \textcolor{stringliteral}{'--num-epochs'}, type=float, default=-1)
78     train.add\_argument(\textcolor{stringliteral}{'-ttim'}, \textcolor{stringliteral}{'--max-train-time'}, type=float, default=-1)
79     train.add\_argument(\textcolor{stringliteral}{'-ltim'}, \textcolor{stringliteral}{'--log-every-n-secs'}, type=float, default=2)
80     train.add\_argument(
81         \textcolor{stringliteral}{'-vtim'},
82         \textcolor{stringliteral}{'--validation-every-n-secs'},
83         type=float,
84         default=-1,
85         help=\textcolor{stringliteral}{'Validate every n seconds. Saves model to model\_file '}
86         \textcolor{stringliteral}{'(if set) whenever best val metric is found'},
87     )
88     train.add\_argument(
89         \textcolor{stringliteral}{'-stim'},
90         \textcolor{stringliteral}{'--save-every-n-secs'},
91         type=float,
92         default=-1,
93         help=\textcolor{stringliteral}{'Saves the model to model\_file.checkpoint after '}
94         \textcolor{stringliteral}{'every n seconds (default -1, never).'},
95     )
96     train.add\_argument(
97         \textcolor{stringliteral}{'-sval'},
98         \textcolor{stringliteral}{'--save-after-valid'},
99         type=\textcolor{stringliteral}{'bool'},
100         default=\textcolor{keyword}{False},
101         help=\textcolor{stringliteral}{'Saves the model to model\_file.checkpoint after '}
102         \textcolor{stringliteral}{'every validation (default %(default)s).'},
103     )
104     train.add\_argument(
105         \textcolor{stringliteral}{'-veps'},
106         \textcolor{stringliteral}{'--validation-every-n-epochs'},
107         type=float,
108         default=-1,
109         help=\textcolor{stringliteral}{'Validate every n epochs. Saves model to model\_file '}
110         \textcolor{stringliteral}{'(if set) whenever best val metric is found'},
111     )
112     train.add\_argument(
113         \textcolor{stringliteral}{'-vme'},
114         \textcolor{stringliteral}{'--validation-max-exs'},
115         type=int,
116         default=-1,
117         hidden=\textcolor{keyword}{True},
118         help=\textcolor{stringliteral}{'max examples to use during validation (default -1 uses all)'},
119     )
120     train.add\_argument(
121         \textcolor{stringliteral}{'--short-final-eval'},
122         default=\textcolor{keyword}{False},
123         hidden=\textcolor{keyword}{True},
124         type=\textcolor{stringliteral}{'bool'},
125         help=\textcolor{stringliteral}{'If true, obeys --validation-max-exs in the final '}
126         \textcolor{stringliteral}{'validation and test evaluations.'},
127     )
128     train.add\_argument(
129         \textcolor{stringliteral}{'-vp'},
130         \textcolor{stringliteral}{'--validation-patience'},
131         type=int,
132         default=10,
133         help=(
134             \textcolor{stringliteral}{'number of iterations of validation where result'}
135             \textcolor{stringliteral}{' does not improve before we stop training'}
136         ),
137     )
138     train.add\_argument(
139         \textcolor{stringliteral}{'-vmt'},
140         \textcolor{stringliteral}{'--validation-metric'},
141         default=\textcolor{stringliteral}{'accuracy'},
142         help=\textcolor{stringliteral}{'key into report table for selecting best validation'},
143     )
144     train.add\_argument(
145         \textcolor{stringliteral}{'-vmm'},
146         \textcolor{stringliteral}{'--validation-metric-mode'},
147         type=str,
148         choices=[\textcolor{stringliteral}{'max'}, \textcolor{stringliteral}{'min'}],
149         help=\textcolor{stringliteral}{'how to optimize validation metric (max or min)'},
150     )
151     train.add\_argument(
152         \textcolor{stringliteral}{'-vcut'},
153         \textcolor{stringliteral}{'--validation-cutoff'},
154         type=float,
155         default=1.0,
156         hidden=\textcolor{keyword}{True},
157         help=\textcolor{stringliteral}{'value at which training will stop if exceeded by metric'},
158     )
159     train.add\_argument(
160         \textcolor{stringliteral}{'-lfc'},
161         \textcolor{stringliteral}{'--load-from-checkpoint'},
162         type=\textcolor{stringliteral}{'bool'},
163         default=\textcolor{keyword}{False},
164         hidden=\textcolor{keyword}{True},
165         help=\textcolor{stringliteral}{'load model from checkpoint if available'},
166     )
167     train.add\_argument(
168         \textcolor{stringliteral}{'-vshare'},
169         \textcolor{stringliteral}{'--validation-share-agent'},
170         default=\textcolor{keyword}{False},
171         hidden=\textcolor{keyword}{True},
172         help=\textcolor{stringliteral}{'use a shared copy of the agent for validation. '}
173         \textcolor{stringliteral}{'this will eventually default to True, but '}
174         \textcolor{stringliteral}{'currently defaults to False.'},
175     )
176     train.add\_argument(
177         \textcolor{stringliteral}{'-micro'},
178         \textcolor{stringliteral}{'--aggregate-micro'},
179         type=\textcolor{stringliteral}{'bool'},
180         default=\textcolor{keyword}{False},
181         help=\textcolor{stringliteral}{'If multitasking, average metrics over the number of examples. '}
182         \textcolor{stringliteral}{'If false, averages over the number of tasks.'},
183     )
184     train.add\_argument(
185         \textcolor{stringliteral}{'-mcs'},
186         \textcolor{stringliteral}{'--metrics'},
187         type=str,
188         default=\textcolor{stringliteral}{'default'},
189         help=\textcolor{stringliteral}{'list of metrics to show/compute, e.g. all, default,'}
190         \textcolor{stringliteral}{'or give a list split by , like '}
191         \textcolor{stringliteral}{'ppl,f1,accuracy,hits@1,rouge,bleu'}
192         \textcolor{stringliteral}{'the rouge metrics will be computed as rouge-1, rouge-2 and rouge-l'},
193     )
194     TensorboardLogger.add\_cmdline\_args(parser)
195     parser = setup\_dict\_args(parser)
196     \textcolor{keywordflow}{return} parser
197 
198 
\end{DoxyCode}
