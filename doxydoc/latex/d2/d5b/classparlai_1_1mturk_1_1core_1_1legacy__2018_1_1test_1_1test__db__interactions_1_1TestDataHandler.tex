\hypertarget{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler}{}\section{parlai.\+mturk.\+core.\+legacy\+\_\+2018.\+test.\+test\+\_\+db\+\_\+interactions.\+Test\+Data\+Handler Class Reference}
\label{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler}\index{parlai.\+mturk.\+core.\+legacy\+\_\+2018.\+test.\+test\+\_\+db\+\_\+interactions.\+Test\+Data\+Handler@{parlai.\+mturk.\+core.\+legacy\+\_\+2018.\+test.\+test\+\_\+db\+\_\+interactions.\+Test\+Data\+Handler}}


Inheritance diagram for parlai.\+mturk.\+core.\+legacy\+\_\+2018.\+test.\+test\+\_\+db\+\_\+interactions.\+Test\+Data\+Handler\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=236pt]{da/dce/classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler__inherit__graph}
\end{center}
\end{figure}


Collaboration diagram for parlai.\+mturk.\+core.\+legacy\+\_\+2018.\+test.\+test\+\_\+db\+\_\+interactions.\+Test\+Data\+Handler\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=236pt]{df/de7/classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler__coll__graph}
\end{center}
\end{figure}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_ae4a243a3b7e3c5422f0ce0c4dc46c78e}{set\+Up} (self)
\item 
def \hyperlink{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a3df8c585d2e6f30b5ebbc40a51da5bbd}{tear\+Down} (self)
\item 
def \hyperlink{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a4b6e2a2603dfb8ae8dfb74c84bb57c1b}{create\+\_\+hit} (self)
\item 
def \hyperlink{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a437b199b892112761fd6171663658c06}{assert\+H\+I\+T\+Equal} (self, mturk\+\_\+hit, db\+\_\+hit, run\+\_\+id)
\item 
def \hyperlink{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a0292af13ed4697ccbfad99f645993419}{test\+\_\+init\+\_\+db} (self)
\item 
def \hyperlink{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_adf5eafa20070803452355ece938df7f8}{test\+\_\+create\+\_\+get\+\_\+run} (self)
\item 
def \hyperlink{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a93e30b36f98cdee7239ad00e79db7354}{test\+\_\+create\+\_\+update\+\_\+hits} (self)
\item 
def \hyperlink{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a080ec5d7ca57e836021f7d7464807e26}{test\+\_\+worker\+\_\+workflows} (self)
\end{DoxyCompactItemize}
\subsection*{Static Public Attributes}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a589903c95be5f0914c1b276026522095}{D\+B\+\_\+\+N\+A\+ME}
\end{DoxyCompactItemize}


\subsection{Detailed Description}
\begin{DoxyVerb}Various unit tests for the SQLite database.
\end{DoxyVerb}
 

Definition at line 22 of file test\+\_\+db\+\_\+interactions.\+py.



\subsection{Member Function Documentation}
\mbox{\Hypertarget{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a437b199b892112761fd6171663658c06}\label{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a437b199b892112761fd6171663658c06}} 
\index{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}!assert\+H\+I\+T\+Equal@{assert\+H\+I\+T\+Equal}}
\index{assert\+H\+I\+T\+Equal@{assert\+H\+I\+T\+Equal}!parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}}
\subsubsection{\texorpdfstring{assert\+H\+I\+T\+Equal()}{assertHITEqual()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+legacy\+\_\+2018.\+test.\+test\+\_\+db\+\_\+interactions.\+Test\+Data\+Handler.\+assert\+H\+I\+T\+Equal (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{mturk\+\_\+hit,  }\item[{}]{db\+\_\+hit,  }\item[{}]{run\+\_\+id }\end{DoxyParamCaption})}



Definition at line 49 of file test\+\_\+db\+\_\+interactions.\+py.


\begin{DoxyCode}
49     \textcolor{keyword}{def }assertHITEqual(self, mturk\_hit, db\_hit, run\_id):
50         self.assertEqual(mturk\_hit[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}], db\_hit[\textcolor{stringliteral}{'hit\_id'}])
51         self.assertEqual(
52             mturk\_hit[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'Expiration'}], datetime.fromtimestamp(db\_hit[\textcolor{stringliteral}{'expiration'}])
53         )
54         self.assertEqual(mturk\_hit[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITStatus'}], db\_hit[\textcolor{stringliteral}{'hit\_status'}])
55         self.assertEqual(
56             mturk\_hit[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'NumberOfAssignmentsPending'}],
57             db\_hit[\textcolor{stringliteral}{'assignments\_pending'}],
58         )
59         self.assertEqual(
60             mturk\_hit[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'NumberOfAssignmentsAvailable'}],
61             db\_hit[\textcolor{stringliteral}{'assignments\_available'}],
62         )
63         self.assertEqual(
64             mturk\_hit[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'NumberOfAssignmentsCompleted'}],
65             db\_hit[\textcolor{stringliteral}{'assignments\_complete'}],
66         )
67         self.assertEqual(run\_id, db\_hit[\textcolor{stringliteral}{'run\_id'}])
68 
\end{DoxyCode}
\mbox{\Hypertarget{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a4b6e2a2603dfb8ae8dfb74c84bb57c1b}\label{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a4b6e2a2603dfb8ae8dfb74c84bb57c1b}} 
\index{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}!create\+\_\+hit@{create\+\_\+hit}}
\index{create\+\_\+hit@{create\+\_\+hit}!parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}}
\subsubsection{\texorpdfstring{create\+\_\+hit()}{create\_hit()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+legacy\+\_\+2018.\+test.\+test\+\_\+db\+\_\+interactions.\+Test\+Data\+Handler.\+create\+\_\+hit (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}



Definition at line 37 of file test\+\_\+db\+\_\+interactions.\+py.


\begin{DoxyCode}
37     \textcolor{keyword}{def }create\_hit(self):
38         \textcolor{keywordflow}{return} \{
39             \textcolor{stringliteral}{'HIT'}: \{
40                 \textcolor{stringliteral}{'HITId'}: \hyperlink{namespacegenerate__task__READMEs_a5b88452ffb87b78c8c85ececebafc09f}{str}(uuid.uuid4()),
41                 \textcolor{stringliteral}{'Expiration'}: datetime.today().replace(microsecond=0),
42                 \textcolor{stringliteral}{'HITStatus'}: \hyperlink{namespacegenerate__task__READMEs_a5b88452ffb87b78c8c85ececebafc09f}{str}(uuid.uuid4()),
43                 \textcolor{stringliteral}{'NumberOfAssignmentsPending'}: 1,
44                 \textcolor{stringliteral}{'NumberOfAssignmentsAvailable'}: 2,
45                 \textcolor{stringliteral}{'NumberOfAssignmentsCompleted'}: 3,
46             \}
47         \}
48 
\end{DoxyCode}
\mbox{\Hypertarget{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_ae4a243a3b7e3c5422f0ce0c4dc46c78e}\label{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_ae4a243a3b7e3c5422f0ce0c4dc46c78e}} 
\index{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}!set\+Up@{set\+Up}}
\index{set\+Up@{set\+Up}!parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}}
\subsubsection{\texorpdfstring{set\+Up()}{setUp()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+legacy\+\_\+2018.\+test.\+test\+\_\+db\+\_\+interactions.\+Test\+Data\+Handler.\+set\+Up (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}



Definition at line 29 of file test\+\_\+db\+\_\+interactions.\+py.


\begin{DoxyCode}
29     \textcolor{keyword}{def }setUp(self):
30         \textcolor{keywordflow}{if} os.path.exists(os.path.join(data\_dir, self.DB\_NAME)):
31             os.remove(os.path.join(data\_dir, self.DB\_NAME))
32 
\end{DoxyCode}
\mbox{\Hypertarget{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a3df8c585d2e6f30b5ebbc40a51da5bbd}\label{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a3df8c585d2e6f30b5ebbc40a51da5bbd}} 
\index{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}!tear\+Down@{tear\+Down}}
\index{tear\+Down@{tear\+Down}!parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}}
\subsubsection{\texorpdfstring{tear\+Down()}{tearDown()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+legacy\+\_\+2018.\+test.\+test\+\_\+db\+\_\+interactions.\+Test\+Data\+Handler.\+tear\+Down (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}



Definition at line 33 of file test\+\_\+db\+\_\+interactions.\+py.


\begin{DoxyCode}
33     \textcolor{keyword}{def }tearDown(self):
34         \textcolor{keywordflow}{if} os.path.exists(os.path.join(data\_dir, self.DB\_NAME)):
35             os.remove(os.path.join(data\_dir, self.DB\_NAME))
36 
\end{DoxyCode}
\mbox{\Hypertarget{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_adf5eafa20070803452355ece938df7f8}\label{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_adf5eafa20070803452355ece938df7f8}} 
\index{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}!test\+\_\+create\+\_\+get\+\_\+run@{test\+\_\+create\+\_\+get\+\_\+run}}
\index{test\+\_\+create\+\_\+get\+\_\+run@{test\+\_\+create\+\_\+get\+\_\+run}!parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}}
\subsubsection{\texorpdfstring{test\+\_\+create\+\_\+get\+\_\+run()}{test\_create\_get\_run()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+legacy\+\_\+2018.\+test.\+test\+\_\+db\+\_\+interactions.\+Test\+Data\+Handler.\+test\+\_\+create\+\_\+get\+\_\+run (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}



Definition at line 84 of file test\+\_\+db\+\_\+interactions.\+py.


\begin{DoxyCode}
84     \textcolor{keyword}{def }test\_create\_get\_run(self):
85         run\_id = \textcolor{stringliteral}{'Test\_run\_1'}
86         hits\_created = 10
87         db\_logger = MTurkDataHandler(\textcolor{stringliteral}{'test2'}, file\_name=self.DB\_NAME)
88 
89         \textcolor{comment}{# Ensure a run logged can be retrieved}
90         db\_logger.log\_new\_run(hits\_created, \textcolor{stringliteral}{'testing'}, run\_id)
91         run\_data = db\_logger.get\_run\_data(run\_id)
92         self.assertEqual(run\_data[\textcolor{stringliteral}{'run\_id'}], run\_id)
93         self.assertEqual(run\_data[\textcolor{stringliteral}{'created'}], 0)
94         self.assertEqual(run\_data[\textcolor{stringliteral}{'completed'}], 0)
95         self.assertEqual(run\_data[\textcolor{stringliteral}{'maximum'}], hits\_created)
96         self.assertEqual(run\_data[\textcolor{stringliteral}{'failed'}], 0)
97 
98         \textcolor{comment}{# Assert missed entries are None}
99         self.assertIsNone(db\_logger.get\_run\_data(\textcolor{stringliteral}{'fake\_id'}))
100 
\end{DoxyCode}
\mbox{\Hypertarget{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a93e30b36f98cdee7239ad00e79db7354}\label{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a93e30b36f98cdee7239ad00e79db7354}} 
\index{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}!test\+\_\+create\+\_\+update\+\_\+hits@{test\+\_\+create\+\_\+update\+\_\+hits}}
\index{test\+\_\+create\+\_\+update\+\_\+hits@{test\+\_\+create\+\_\+update\+\_\+hits}!parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}}
\subsubsection{\texorpdfstring{test\+\_\+create\+\_\+update\+\_\+hits()}{test\_create\_update\_hits()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+legacy\+\_\+2018.\+test.\+test\+\_\+db\+\_\+interactions.\+Test\+Data\+Handler.\+test\+\_\+create\+\_\+update\+\_\+hits (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}



Definition at line 101 of file test\+\_\+db\+\_\+interactions.\+py.


\begin{DoxyCode}
101     \textcolor{keyword}{def }test\_create\_update\_hits(self):
102         run\_id = \textcolor{stringliteral}{'Test\_run\_2'}
103         hits\_created = 10
104         db\_logger = MTurkDataHandler(file\_name=self.DB\_NAME)
105         db\_logger.log\_new\_run(hits\_created, \textcolor{stringliteral}{'testing'}, run\_id)
106         HIT1 = self.create\_hit()
107         HIT2 = self.create\_hit()
108         HIT3 = self.create\_hit()
109 
110         \textcolor{comment}{# Ensure logging without group id fails}
111         with self.assertRaises(AssertionError):
112             db\_logger.log\_hit\_status(HIT1)
113 
114         \textcolor{comment}{# Log created hits through one logger}
115         db\_logger.log\_hit\_status(HIT1, run\_id)
116         db\_logger.log\_hit\_status(HIT2, run\_id)
117 
118         \textcolor{comment}{# Create new handler, this one with the group id created, ensure}
119         \textcolor{comment}{# the log works fine}
120         db\_logger = MTurkDataHandler(run\_id, file\_name=self.DB\_NAME)
121         db\_logger.log\_hit\_status(HIT3)
122 
123         \textcolor{comment}{# Ensure all of the expected hits are there}
124         run\_data = db\_logger.get\_run\_data(run\_id)
125         self.assertEqual(run\_data[\textcolor{stringliteral}{'run\_id'}], run\_id)
126         self.assertEqual(run\_data[\textcolor{stringliteral}{'created'}], 3)
127         self.assertEqual(run\_data[\textcolor{stringliteral}{'completed'}], 0)
128         self.assertEqual(run\_data[\textcolor{stringliteral}{'maximum'}], hits\_created)
129         self.assertEqual(run\_data[\textcolor{stringliteral}{'failed'}], 0)
130 
131         \textcolor{comment}{# Ensure the hit details are correct}
132         \textcolor{keywordflow}{for} hit \textcolor{keywordflow}{in} [HIT1, HIT2, HIT3]:
133             hit\_db\_data = db\_logger.get\_hit\_data(hit[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}])
134             self.assertHITEqual(hit, hit\_db\_data, run\_id)
135 
136         \textcolor{comment}{# Update the data on a HIT, ensure that the run data stays the same}
137         \textcolor{comment}{# but the HIT data updates}
138         test\_status = \textcolor{stringliteral}{'TEST\_STATUS'}
139         HIT2[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITStatus'}] = test\_status
140         db\_logger.log\_hit\_status(HIT2)
141 
142         \textcolor{comment}{# Ensure all of the expected hits are there}
143         run\_data = db\_logger.get\_run\_data(run\_id)
144         self.assertEqual(run\_data[\textcolor{stringliteral}{'run\_id'}], run\_id)
145         self.assertEqual(run\_data[\textcolor{stringliteral}{'created'}], 3)
146         self.assertEqual(run\_data[\textcolor{stringliteral}{'completed'}], 0)
147         self.assertEqual(run\_data[\textcolor{stringliteral}{'maximum'}], hits\_created)
148         self.assertEqual(run\_data[\textcolor{stringliteral}{'failed'}], 0)
149 
150         \textcolor{comment}{# Ensure the hit details are correct}
151         \textcolor{keywordflow}{for} hit \textcolor{keywordflow}{in} [HIT1, HIT2, HIT3]:
152             hit\_db\_data = db\_logger.get\_hit\_data(hit[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}])
153             self.assertHITEqual(hit, hit\_db\_data, run\_id)
154 
155         \textcolor{comment}{# Ensure requesting a hit that doesn't exist returns none}
156         self.assertIsNone(db\_logger.get\_hit\_data(\textcolor{stringliteral}{'fake\_id'}))
157 
\end{DoxyCode}
\mbox{\Hypertarget{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a0292af13ed4697ccbfad99f645993419}\label{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a0292af13ed4697ccbfad99f645993419}} 
\index{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}!test\+\_\+init\+\_\+db@{test\+\_\+init\+\_\+db}}
\index{test\+\_\+init\+\_\+db@{test\+\_\+init\+\_\+db}!parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}}
\subsubsection{\texorpdfstring{test\+\_\+init\+\_\+db()}{test\_init\_db()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+legacy\+\_\+2018.\+test.\+test\+\_\+db\+\_\+interactions.\+Test\+Data\+Handler.\+test\+\_\+init\+\_\+db (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}



Definition at line 69 of file test\+\_\+db\+\_\+interactions.\+py.


\begin{DoxyCode}
69     \textcolor{keyword}{def }test\_init\_db(self):
70         db\_logger = MTurkDataHandler(\textcolor{stringliteral}{'test1'}, file\_name=self.DB\_NAME)
71         conn = db\_logger.\_get\_connection()
72         c = conn.cursor()
73         c.execute(\textcolor{stringliteral}{'SELECT COUNT(*) FROM runs;'})
74         self.assertEqual(c.fetchone()[0], 0)
75         c.execute(\textcolor{stringliteral}{'SELECT COUNT(*) FROM hits;'})
76         self.assertEqual(c.fetchone()[0], 0)
77         c.execute(\textcolor{stringliteral}{'SELECT COUNT(*) FROM assignments;'})
78         self.assertEqual(c.fetchone()[0], 0)
79         c.execute(\textcolor{stringliteral}{'SELECT COUNT(*) FROM workers;'})
80         self.assertEqual(c.fetchone()[0], 0)
81         c.execute(\textcolor{stringliteral}{'SELECT COUNT(*) FROM pairings;'})
82         self.assertEqual(c.fetchone()[0], 0)
83 
\end{DoxyCode}
\mbox{\Hypertarget{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a080ec5d7ca57e836021f7d7464807e26}\label{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a080ec5d7ca57e836021f7d7464807e26}} 
\index{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}!test\+\_\+worker\+\_\+workflows@{test\+\_\+worker\+\_\+workflows}}
\index{test\+\_\+worker\+\_\+workflows@{test\+\_\+worker\+\_\+workflows}!parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}}
\subsubsection{\texorpdfstring{test\+\_\+worker\+\_\+workflows()}{test\_worker\_workflows()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+core.\+legacy\+\_\+2018.\+test.\+test\+\_\+db\+\_\+interactions.\+Test\+Data\+Handler.\+test\+\_\+worker\+\_\+workflows (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}



Definition at line 158 of file test\+\_\+db\+\_\+interactions.\+py.


\begin{DoxyCode}
158     \textcolor{keyword}{def }test\_worker\_workflows(self):
159         run\_id = \textcolor{stringliteral}{'Test\_run\_3'}
160         hits\_created = 10
161         db\_logger = MTurkDataHandler(run\_id, file\_name=self.DB\_NAME)
162         db\_logger.log\_new\_run(hits\_created, \textcolor{stringliteral}{'testing'}, run\_id)
163         HIT1 = self.create\_hit()
164         HIT2 = self.create\_hit()
165         HIT3 = self.create\_hit()
166         db\_logger.log\_hit\_status(HIT1)
167         db\_logger.log\_hit\_status(HIT2)
168         db\_logger.log\_hit\_status(HIT3)
169 
170         worker\_id\_1 = \textcolor{stringliteral}{'TEST\_WORKER\_ID\_1'}
171         worker\_id\_2 = \textcolor{stringliteral}{'TEST\_WORKER\_ID\_2'}
172         assignment\_id\_1 = \textcolor{stringliteral}{'TEST\_ASSIGNMENT\_ID\_1'}
173         assignment\_id\_2 = \textcolor{stringliteral}{'TEST\_ASSIGNMENT\_ID\_2'}
174         assignment\_id\_3 = \textcolor{stringliteral}{'TEST\_ASSIGNMENT\_ID\_3'}
175 
176         \textcolor{comment}{# Create two workers and assign the 3 assignments to them}
177         db\_logger.log\_worker\_accept\_assignment(
178             worker\_id\_1, assignment\_id\_1, HIT1[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}]
179         )
180         db\_logger.log\_worker\_accept\_assignment(
181             worker\_id\_2, assignment\_id\_2, HIT2[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}]
182         )
183         db\_logger.log\_worker\_accept\_assignment(
184             worker\_id\_2, assignment\_id\_3, HIT3[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}]
185         )
186 
187         \textcolor{comment}{# Ensure two workers have been created}
188         conn = db\_logger.\_get\_connection()
189         c = conn.cursor()
190         c.execute(\textcolor{stringliteral}{'SELECT COUNT(*) FROM workers;'})
191         self.assertEqual(c.fetchone()[0], 2)
192 
193         \textcolor{comment}{# Ensure non-existent worker is None}
194         self.assertIsNone(db\_logger.get\_worker\_data(\textcolor{stringliteral}{'fake\_id'}))
195 
196         \textcolor{comment}{# Ensure the two workers have the correct expected values}
197         worker\_1\_data = db\_logger.get\_worker\_data(worker\_id\_1)
198         worker\_2\_data = db\_logger.get\_worker\_data(worker\_id\_2)
199         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_1)
200         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'accepted'}], 1)
201         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'disconnected'}], 0)
202         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'completed'}], 0)
203         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'approved'}], 0)
204         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'rejected'}], 0)
205         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
206         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'accepted'}], 2)
207         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'disconnected'}], 0)
208         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'completed'}], 0)
209         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'approved'}], 0)
210         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'rejected'}], 0)
211 
212         \textcolor{comment}{# Ensure all the assignments are marked as accepted}
213         c.execute(\textcolor{stringliteral}{'SELECT COUNT(*) FROM assignments WHERE status = ?;'}, (\textcolor{stringliteral}{'Accepted'},))
214         self.assertEqual(c.fetchone()[0], 3)
215 
216         \textcolor{comment}{# Ensure non-existing assign is None}
217         self.assertIsNone(db\_logger.get\_assignment\_data(\textcolor{stringliteral}{'fake\_id'}))
218 
219         \textcolor{comment}{# Check each of the assignments}
220         assignment\_1\_data = db\_logger.get\_assignment\_data(assignment\_id\_1)
221         assignment\_2\_data = db\_logger.get\_assignment\_data(assignment\_id\_2)
222         assignment\_3\_data = db\_logger.get\_assignment\_data(assignment\_id\_3)
223         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_1)
224         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'status'}], \textcolor{stringliteral}{'Accepted'})
225         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'approve\_time'}], \textcolor{keywordtype}{None})
226         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_1)
227         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'hit\_id'}], HIT1[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}])
228         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_2)
229         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'status'}], \textcolor{stringliteral}{'Accepted'})
230         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'approve\_time'}], \textcolor{keywordtype}{None})
231         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
232         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'hit\_id'}], HIT2[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}])
233         self.assertEqual(assignment\_3\_data[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_3)
234         self.assertEqual(assignment\_3\_data[\textcolor{stringliteral}{'status'}], \textcolor{stringliteral}{'Accepted'})
235         self.assertEqual(assignment\_3\_data[\textcolor{stringliteral}{'approve\_time'}], \textcolor{keywordtype}{None})
236         self.assertEqual(assignment\_3\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
237         self.assertEqual(assignment\_3\_data[\textcolor{stringliteral}{'hit\_id'}], HIT3[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}])
238 
239         \textcolor{comment}{# Ensure three pairings have been created, one for each assignment}
240         c.execute(\textcolor{stringliteral}{'SELECT COUNT(*) FROM pairings'})
241         self.assertEqual(c.fetchone()[0], 3)
242 
243         \textcolor{comment}{# Ensure pairings are accurate}
244         self.assertIsNone(
245             db\_logger.get\_worker\_assignment\_pairing(worker\_id\_1, assignment\_id\_3)
246         )
247 
248         pair\_1 = db\_logger.get\_worker\_assignment\_pairing(worker\_id\_1, assignment\_id\_1)
249         pair\_2 = db\_logger.get\_worker\_assignment\_pairing(worker\_id\_2, assignment\_id\_2)
250         pair\_3 = db\_logger.get\_worker\_assignment\_pairing(worker\_id\_2, assignment\_id\_3)
251         \textcolor{keywordflow}{for} f \textcolor{keywordflow}{in} [
252             \textcolor{stringliteral}{'onboarding\_start'},
253             \textcolor{stringliteral}{'onboarding\_end'},
254             \textcolor{stringliteral}{'task\_start'},
255             \textcolor{stringliteral}{'task\_end'},
256             \textcolor{stringliteral}{'conversation\_id'},
257         ]:
258             \textcolor{keywordflow}{for} pair \textcolor{keywordflow}{in} [pair\_1, pair\_2, pair\_3]:
259                 self.assertIsNone(pair[f])
260         self.assertEqual(pair\_1[\textcolor{stringliteral}{'status'}], AssignState.STATUS\_NONE)
261         self.assertEqual(pair\_2[\textcolor{stringliteral}{'status'}], AssignState.STATUS\_NONE)
262         self.assertEqual(pair\_3[\textcolor{stringliteral}{'status'}], AssignState.STATUS\_NONE)
263         self.assertEqual(pair\_1[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_1)
264         self.assertEqual(pair\_2[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
265         self.assertEqual(pair\_3[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
266         self.assertEqual(pair\_1[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_1)
267         self.assertEqual(pair\_2[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_2)
268         self.assertEqual(pair\_3[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_3)
269         self.assertEqual(pair\_1[\textcolor{stringliteral}{'run\_id'}], run\_id)
270         self.assertEqual(pair\_2[\textcolor{stringliteral}{'run\_id'}], run\_id)
271         self.assertEqual(pair\_3[\textcolor{stringliteral}{'run\_id'}], run\_id)
272         self.assertEqual(pair\_1[\textcolor{stringliteral}{'bonus\_amount'}], 0)
273         self.assertEqual(pair\_2[\textcolor{stringliteral}{'bonus\_amount'}], 0)
274         self.assertEqual(pair\_3[\textcolor{stringliteral}{'bonus\_amount'}], 0)
275         self.assertEqual(pair\_1[\textcolor{stringliteral}{'bonus\_text'}], \textcolor{stringliteral}{''})
276         self.assertEqual(pair\_2[\textcolor{stringliteral}{'bonus\_text'}], \textcolor{stringliteral}{''})
277         self.assertEqual(pair\_3[\textcolor{stringliteral}{'bonus\_text'}], \textcolor{stringliteral}{''})
278         self.assertFalse(pair\_1[\textcolor{stringliteral}{'bonus\_paid'}])
279         self.assertFalse(pair\_2[\textcolor{stringliteral}{'bonus\_paid'}])
280         self.assertFalse(pair\_3[\textcolor{stringliteral}{'bonus\_paid'}])
281 
282         \textcolor{comment}{# Ensure get\_pairings\_for\_assignment works}
283         pair\_4 = db\_logger.get\_pairings\_for\_assignment(assignment\_id\_2)[0]
284         self.assertEqual(pair\_2, pair\_4)
285         self.assertListEqual([], db\_logger.get\_pairings\_for\_assignment(\textcolor{stringliteral}{'fake\_id'}))
286 
287         \textcolor{comment}{# Ensure get\_all\_<thing>\_for\_worker works}
288         self.assertListEqual([], db\_logger.get\_all\_assignments\_for\_worker(\textcolor{stringliteral}{'fake\_id'}))
289         self.assertListEqual([], db\_logger.get\_all\_pairings\_for\_worker(\textcolor{stringliteral}{'fake\_id'}))
290         self.assertEqual(
291             db\_logger.get\_all\_assignments\_for\_worker(worker\_id\_1)[0], assignment\_1\_data
292         )
293         self.assertEqual(len(db\_logger.get\_all\_assignments\_for\_worker(worker\_id\_2)), 2)
294         self.assertEqual(db\_logger.get\_all\_pairings\_for\_worker(worker\_id\_1)[0], pair\_1)
295         self.assertEqual(len(db\_logger.get\_all\_pairings\_for\_worker(worker\_id\_2)), 2)
296 
297         \textcolor{comment}{# test task\_restricted gets}
298         self.assertEqual(
299             db\_logger.get\_all\_task\_assignments\_for\_worker(worker\_id\_1)[0],
300             assignment\_1\_data,
301         )
302         self.assertEqual(
303             len(db\_logger.get\_all\_task\_assignments\_for\_worker(worker\_id\_2)), 2
304         )
305         self.assertEqual(
306             len(db\_logger.get\_all\_task\_assignments\_for\_worker(worker\_id\_1, \textcolor{stringliteral}{'fake\_id'})),
307             0,
308         )
309         self.assertEqual(
310             db\_logger.get\_all\_task\_pairings\_for\_worker(worker\_id\_1)[0], pair\_1
311         )
312         self.assertEqual(
313             len(db\_logger.get\_all\_task\_pairings\_for\_worker(worker\_id\_2)), 2
314         )
315         self.assertEqual(
316             len(db\_logger.get\_all\_task\_pairings\_for\_worker(worker\_id\_1, \textcolor{stringliteral}{'fake\_id'})), 0
317         )
318 
319         conversation\_id\_1 = \textcolor{stringliteral}{"CONV\_ID\_1"}
320         conversation\_id\_2 = \textcolor{stringliteral}{"CONV\_ID\_2"}
321 
322         onboarding\_id\_1 = \textcolor{stringliteral}{'onboard\_1'}
323         onboarding\_id\_2 = \textcolor{stringliteral}{'onboard\_2'}
324         onboarding\_id\_3 = \textcolor{stringliteral}{'onboard\_3'}
325 
326         db\_logger.log\_start\_onboard(worker\_id\_1, assignment\_id\_1, onboarding\_id\_1)
327         db\_logger.log\_start\_onboard(worker\_id\_2, assignment\_id\_2, onboarding\_id\_2)
328         db\_logger.log\_start\_onboard(worker\_id\_2, assignment\_id\_3, onboarding\_id\_3)
329         db\_logger.log\_finish\_onboard(worker\_id\_1, assignment\_id\_1)
330         db\_logger.log\_finish\_onboard(worker\_id\_2, assignment\_id\_2)
331         db\_logger.log\_finish\_onboard(worker\_id\_2, assignment\_id\_3)
332         db\_logger.log\_start\_task(worker\_id\_1, assignment\_id\_1, conversation\_id\_1)
333         db\_logger.log\_start\_task(worker\_id\_2, assignment\_id\_2, conversation\_id\_1)
334         db\_logger.log\_start\_task(worker\_id\_2, assignment\_id\_3, conversation\_id\_2)
335 
336         \textcolor{comment}{# Check to see retrieval by conversation}
337         pairs\_1 = db\_logger.get\_pairings\_for\_conversation(conversation\_id\_1)
338         pairs\_2 = db\_logger.get\_pairings\_for\_conversation(conversation\_id\_2)
339         pairs\_3 = db\_logger.get\_pairings\_for\_conversation(\textcolor{stringliteral}{'fake\_id'})
340         pair\_1 = db\_logger.get\_worker\_assignment\_pairing(worker\_id\_1, assignment\_id\_1)
341         pair\_2 = db\_logger.get\_worker\_assignment\_pairing(worker\_id\_2, assignment\_id\_2)
342         pair\_3 = db\_logger.get\_worker\_assignment\_pairing(worker\_id\_2, assignment\_id\_3)
343         self.assertEqual(pairs\_1[0], pair\_1)
344         self.assertEqual(pairs\_1[1], pair\_2)
345         self.assertEqual(pairs\_2[0], pair\_3)
346         self.assertEqual(len(pairs\_3), 0)
347 
348         \textcolor{comment}{# Do some final processing on assignments}
349         db\_logger.log\_complete\_assignment(
350             worker\_id\_1,
351             assignment\_id\_1,
352             time.time(),
353             AssignState.STATUS\_PARTNER\_DISCONNECT,
354         )
355         db\_logger.log\_disconnect\_assignment(
356             worker\_id\_2, assignment\_id\_2, time.time(), AssignState.STATUS\_DISCONNECT
357         )
358         db\_logger.log\_complete\_assignment(
359             worker\_id\_2, assignment\_id\_3, time.time(), AssignState.STATUS\_DONE
360         )
361 
362         \textcolor{comment}{# Assignment state consistent}
363         assignment\_1\_data = db\_logger.get\_assignment\_data(assignment\_id\_1)
364         assignment\_2\_data = db\_logger.get\_assignment\_data(assignment\_id\_2)
365         assignment\_3\_data = db\_logger.get\_assignment\_data(assignment\_id\_3)
366         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_1)
367         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'status'}], \textcolor{stringliteral}{'Completed'})
368         self.assertIsNotNone(assignment\_1\_data[\textcolor{stringliteral}{'approve\_time'}])
369         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_1)
370         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'hit\_id'}], HIT1[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}])
371         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_2)
372         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'status'}], \textcolor{stringliteral}{'Disconnected'})
373         self.assertIsNotNone(assignment\_2\_data[\textcolor{stringliteral}{'approve\_time'}])
374         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
375         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'hit\_id'}], HIT2[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}])
376         self.assertEqual(assignment\_3\_data[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_3)
377         self.assertEqual(assignment\_3\_data[\textcolor{stringliteral}{'status'}], \textcolor{stringliteral}{'Completed'})
378         self.assertIsNotNone(assignment\_3\_data[\textcolor{stringliteral}{'approve\_time'}])
379         self.assertEqual(assignment\_3\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
380         self.assertEqual(assignment\_3\_data[\textcolor{stringliteral}{'hit\_id'}], HIT3[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}])
381 
382         \textcolor{comment}{# Worker state consistent}
383         worker\_1\_data = db\_logger.get\_worker\_data(worker\_id\_1)
384         worker\_2\_data = db\_logger.get\_worker\_data(worker\_id\_2)
385         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_1)
386         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'accepted'}], 1)
387         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'disconnected'}], 0)
388         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'completed'}], 1)
389         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'approved'}], 0)
390         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'rejected'}], 0)
391         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
392         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'accepted'}], 2)
393         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'disconnected'}], 1)
394         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'completed'}], 1)
395         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'approved'}], 0)
396         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'rejected'}], 0)
397 
398         \textcolor{comment}{# Ensure Pairing state is consistent}
399         pair\_1 = db\_logger.get\_worker\_assignment\_pairing(worker\_id\_1, assignment\_id\_1)
400         pair\_2 = db\_logger.get\_worker\_assignment\_pairing(worker\_id\_2, assignment\_id\_2)
401         pair\_3 = db\_logger.get\_worker\_assignment\_pairing(worker\_id\_2, assignment\_id\_3)
402         self.assertEqual(pair\_1[\textcolor{stringliteral}{'status'}], AssignState.STATUS\_PARTNER\_DISCONNECT)
403         self.assertEqual(pair\_2[\textcolor{stringliteral}{'status'}], AssignState.STATUS\_DISCONNECT)
404         self.assertEqual(pair\_3[\textcolor{stringliteral}{'status'}], AssignState.STATUS\_DONE)
405         self.assertEqual(pair\_1[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_1)
406         self.assertEqual(pair\_2[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
407         self.assertEqual(pair\_3[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
408         self.assertEqual(pair\_1[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_1)
409         self.assertEqual(pair\_2[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_2)
410         self.assertEqual(pair\_3[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_3)
411         self.assertEqual(pair\_1[\textcolor{stringliteral}{'conversation\_id'}], conversation\_id\_1)
412         self.assertEqual(pair\_2[\textcolor{stringliteral}{'conversation\_id'}], conversation\_id\_1)
413         self.assertEqual(pair\_3[\textcolor{stringliteral}{'conversation\_id'}], conversation\_id\_2)
414         self.assertGreaterEqual(pair\_1[\textcolor{stringliteral}{'onboarding\_end'}], pair\_1[\textcolor{stringliteral}{'onboarding\_start'}])
415         self.assertGreaterEqual(pair\_2[\textcolor{stringliteral}{'onboarding\_end'}], pair\_2[\textcolor{stringliteral}{'onboarding\_start'}])
416         self.assertGreaterEqual(pair\_3[\textcolor{stringliteral}{'onboarding\_end'}], pair\_3[\textcolor{stringliteral}{'onboarding\_start'}])
417         self.assertGreaterEqual(pair\_1[\textcolor{stringliteral}{'task\_start'}], pair\_1[\textcolor{stringliteral}{'onboarding\_end'}])
418         self.assertGreaterEqual(pair\_2[\textcolor{stringliteral}{'task\_start'}], pair\_2[\textcolor{stringliteral}{'onboarding\_end'}])
419         self.assertGreaterEqual(pair\_3[\textcolor{stringliteral}{'task\_start'}], pair\_3[\textcolor{stringliteral}{'onboarding\_end'}])
420         self.assertGreaterEqual(pair\_1[\textcolor{stringliteral}{'task\_end'}], pair\_1[\textcolor{stringliteral}{'onboarding\_start'}])
421         self.assertGreaterEqual(pair\_2[\textcolor{stringliteral}{'task\_end'}], pair\_2[\textcolor{stringliteral}{'onboarding\_start'}])
422         self.assertGreaterEqual(pair\_3[\textcolor{stringliteral}{'task\_end'}], pair\_3[\textcolor{stringliteral}{'onboarding\_start'}])
423         self.assertEqual(pair\_1[\textcolor{stringliteral}{'run\_id'}], run\_id)
424         self.assertEqual(pair\_2[\textcolor{stringliteral}{'run\_id'}], run\_id)
425         self.assertEqual(pair\_3[\textcolor{stringliteral}{'run\_id'}], run\_id)
426         self.assertEqual(pair\_1[\textcolor{stringliteral}{'bonus\_amount'}], 0)
427         self.assertEqual(pair\_2[\textcolor{stringliteral}{'bonus\_amount'}], 0)
428         self.assertEqual(pair\_3[\textcolor{stringliteral}{'bonus\_amount'}], 0)
429         self.assertEqual(pair\_1[\textcolor{stringliteral}{'bonus\_text'}], \textcolor{stringliteral}{''})
430         self.assertEqual(pair\_2[\textcolor{stringliteral}{'bonus\_text'}], \textcolor{stringliteral}{''})
431         self.assertEqual(pair\_3[\textcolor{stringliteral}{'bonus\_text'}], \textcolor{stringliteral}{''})
432         self.assertFalse(pair\_1[\textcolor{stringliteral}{'bonus\_paid'}])
433         self.assertFalse(pair\_2[\textcolor{stringliteral}{'bonus\_paid'}])
434         self.assertFalse(pair\_3[\textcolor{stringliteral}{'bonus\_paid'}])
435 
436         \textcolor{comment}{# Ensure run state is consistent}
437         run\_data = db\_logger.get\_run\_data(run\_id)
438         self.assertEqual(run\_data[\textcolor{stringliteral}{'run\_id'}], run\_id)
439         self.assertEqual(run\_data[\textcolor{stringliteral}{'created'}], 3)
440         self.assertEqual(run\_data[\textcolor{stringliteral}{'completed'}], 2)
441         self.assertEqual(run\_data[\textcolor{stringliteral}{'maximum'}], hits\_created)
442         self.assertEqual(run\_data[\textcolor{stringliteral}{'failed'}], 1)
443 
444         \textcolor{comment}{# Test "submitting" and abandoning hits}
445         db\_logger.log\_submit\_assignment(worker\_id\_1, assignment\_id\_1)
446         db\_logger.log\_abandon\_assignment(worker\_id\_2, assignment\_id\_2)
447         db\_logger.log\_expire\_assignment(worker\_id\_2, assignment\_id\_3)
448         assignment\_1\_data = db\_logger.get\_assignment\_data(assignment\_id\_1)
449         assignment\_2\_data = db\_logger.get\_assignment\_data(assignment\_id\_2)
450         assignment\_3\_data = db\_logger.get\_assignment\_data(assignment\_id\_3)
451         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_1)
452         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'status'}], \textcolor{stringliteral}{'Reviewable'})
453         self.assertIsNotNone(assignment\_1\_data[\textcolor{stringliteral}{'approve\_time'}])
454         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_1)
455         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'hit\_id'}], HIT1[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}])
456         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_2)
457         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'status'}], \textcolor{stringliteral}{'Abandoned'})
458         self.assertIsNotNone(assignment\_2\_data[\textcolor{stringliteral}{'approve\_time'}])
459         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
460         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'hit\_id'}], HIT2[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}])
461         self.assertEqual(assignment\_3\_data[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_3)
462         self.assertEqual(assignment\_3\_data[\textcolor{stringliteral}{'status'}], \textcolor{stringliteral}{'Expired'})
463         self.assertIsNotNone(assignment\_3\_data[\textcolor{stringliteral}{'approve\_time'}])
464         self.assertEqual(assignment\_3\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
465         self.assertEqual(assignment\_3\_data[\textcolor{stringliteral}{'hit\_id'}], HIT3[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}])
466 
467         \textcolor{comment}{# Test approving and rejecting}
468         test\_dollars = 3
469         test\_cents = 100 * test\_dollars
470         reason\_use = \textcolor{stringliteral}{'Just because'}
471         out\_reason = \textcolor{stringliteral}{'$\{\} for \{\}\(\backslash\)n'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(test\_dollars, reason\_use)
472         db\_logger.log\_award\_amount(
473             worker\_id\_1, assignment\_id\_1, test\_dollars, reason\_use
474         )
475         db\_logger.log\_award\_amount(
476             worker\_id\_2, assignment\_id\_2, test\_dollars, reason\_use
477         )
478         db\_logger.log\_bonus\_paid(worker\_id\_1, assignment\_id\_1)
479         db\_logger.log\_approve\_assignment(assignment\_id\_1)
480         db\_logger.log\_reject\_assignment(assignment\_id\_2)
481 
482         \textcolor{comment}{# Ensure state is valid again}
483         assignment\_1\_data = db\_logger.get\_assignment\_data(assignment\_id\_1)
484         assignment\_2\_data = db\_logger.get\_assignment\_data(assignment\_id\_2)
485         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_1)
486         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'status'}], \textcolor{stringliteral}{'Approved'})
487         self.assertIsNotNone(assignment\_1\_data[\textcolor{stringliteral}{'approve\_time'}])
488         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_1)
489         self.assertEqual(assignment\_1\_data[\textcolor{stringliteral}{'hit\_id'}], HIT1[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}])
490         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_2)
491         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'status'}], \textcolor{stringliteral}{'Rejected'})
492         self.assertIsNotNone(assignment\_2\_data[\textcolor{stringliteral}{'approve\_time'}])
493         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
494         self.assertEqual(assignment\_2\_data[\textcolor{stringliteral}{'hit\_id'}], HIT2[\textcolor{stringliteral}{'HIT'}][\textcolor{stringliteral}{'HITId'}])
495 
496         worker\_1\_data = db\_logger.get\_worker\_data(worker\_id\_1)
497         worker\_2\_data = db\_logger.get\_worker\_data(worker\_id\_2)
498         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_1)
499         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'accepted'}], 1)
500         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'disconnected'}], 0)
501         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'expired'}], 0)
502         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'completed'}], 1)
503         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'approved'}], 1)
504         self.assertEqual(worker\_1\_data[\textcolor{stringliteral}{'rejected'}], 0)
505         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
506         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'accepted'}], 2)
507         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'disconnected'}], 2)
508         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'expired'}], 1)
509         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'completed'}], 1)
510         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'approved'}], 0)
511         self.assertEqual(worker\_2\_data[\textcolor{stringliteral}{'rejected'}], 1)
512 
513         pair\_1 = db\_logger.get\_worker\_assignment\_pairing(worker\_id\_1, assignment\_id\_1)
514         pair\_2 = db\_logger.get\_worker\_assignment\_pairing(worker\_id\_2, assignment\_id\_2)
515         pair\_3 = db\_logger.get\_worker\_assignment\_pairing(worker\_id\_2, assignment\_id\_3)
516         self.assertEqual(pair\_1[\textcolor{stringliteral}{'status'}], AssignState.STATUS\_PARTNER\_DISCONNECT)
517         self.assertEqual(pair\_2[\textcolor{stringliteral}{'status'}], AssignState.STATUS\_DISCONNECT)
518         self.assertEqual(pair\_3[\textcolor{stringliteral}{'status'}], AssignState.STATUS\_EXPIRED)
519         self.assertEqual(pair\_1[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_1)
520         self.assertEqual(pair\_2[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
521         self.assertEqual(pair\_3[\textcolor{stringliteral}{'worker\_id'}], worker\_id\_2)
522         self.assertEqual(pair\_1[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_1)
523         self.assertEqual(pair\_2[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_2)
524         self.assertEqual(pair\_3[\textcolor{stringliteral}{'assignment\_id'}], assignment\_id\_3)
525         self.assertEqual(pair\_1[\textcolor{stringliteral}{'conversation\_id'}], conversation\_id\_1)
526         self.assertEqual(pair\_2[\textcolor{stringliteral}{'conversation\_id'}], conversation\_id\_1)
527         self.assertEqual(pair\_3[\textcolor{stringliteral}{'conversation\_id'}], conversation\_id\_2)
528         self.assertGreaterEqual(pair\_1[\textcolor{stringliteral}{'onboarding\_end'}], pair\_1[\textcolor{stringliteral}{'onboarding\_start'}])
529         self.assertGreaterEqual(pair\_2[\textcolor{stringliteral}{'onboarding\_end'}], pair\_2[\textcolor{stringliteral}{'onboarding\_start'}])
530         self.assertGreaterEqual(pair\_3[\textcolor{stringliteral}{'onboarding\_end'}], pair\_3[\textcolor{stringliteral}{'onboarding\_start'}])
531         self.assertGreaterEqual(pair\_1[\textcolor{stringliteral}{'task\_start'}], pair\_1[\textcolor{stringliteral}{'onboarding\_end'}])
532         self.assertGreaterEqual(pair\_2[\textcolor{stringliteral}{'task\_start'}], pair\_2[\textcolor{stringliteral}{'onboarding\_end'}])
533         self.assertGreaterEqual(pair\_3[\textcolor{stringliteral}{'task\_start'}], pair\_3[\textcolor{stringliteral}{'onboarding\_end'}])
534         self.assertGreaterEqual(pair\_1[\textcolor{stringliteral}{'task\_end'}], pair\_1[\textcolor{stringliteral}{'onboarding\_start'}])
535         self.assertGreaterEqual(pair\_2[\textcolor{stringliteral}{'task\_end'}], pair\_2[\textcolor{stringliteral}{'onboarding\_start'}])
536         self.assertGreaterEqual(pair\_3[\textcolor{stringliteral}{'task\_end'}], pair\_3[\textcolor{stringliteral}{'onboarding\_start'}])
537         self.assertEqual(pair\_1[\textcolor{stringliteral}{'run\_id'}], run\_id)
538         self.assertEqual(pair\_2[\textcolor{stringliteral}{'run\_id'}], run\_id)
539         self.assertEqual(pair\_3[\textcolor{stringliteral}{'run\_id'}], run\_id)
540         self.assertEqual(pair\_1[\textcolor{stringliteral}{'bonus\_amount'}], test\_cents)
541         self.assertEqual(pair\_2[\textcolor{stringliteral}{'bonus\_amount'}], test\_cents)
542         self.assertEqual(pair\_3[\textcolor{stringliteral}{'bonus\_amount'}], 0)
543         self.assertEqual(pair\_1[\textcolor{stringliteral}{'bonus\_text'}], out\_reason)
544         self.assertEqual(pair\_2[\textcolor{stringliteral}{'bonus\_text'}], out\_reason)
545         self.assertEqual(pair\_3[\textcolor{stringliteral}{'bonus\_text'}], \textcolor{stringliteral}{''})
546         self.assertTrue(pair\_1[\textcolor{stringliteral}{'bonus\_paid'}])
547         self.assertFalse(pair\_2[\textcolor{stringliteral}{'bonus\_paid'}])
548         self.assertFalse(pair\_3[\textcolor{stringliteral}{'bonus\_paid'}])
549 
550 
\end{DoxyCode}


\subsection{Member Data Documentation}
\mbox{\Hypertarget{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a589903c95be5f0914c1b276026522095}\label{classparlai_1_1mturk_1_1core_1_1legacy__2018_1_1test_1_1test__db__interactions_1_1TestDataHandler_a589903c95be5f0914c1b276026522095}} 
\index{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}!D\+B\+\_\+\+N\+A\+ME@{D\+B\+\_\+\+N\+A\+ME}}
\index{D\+B\+\_\+\+N\+A\+ME@{D\+B\+\_\+\+N\+A\+ME}!parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler@{parlai\+::mturk\+::core\+::legacy\+\_\+2018\+::test\+::test\+\_\+db\+\_\+interactions\+::\+Test\+Data\+Handler}}
\subsubsection{\texorpdfstring{D\+B\+\_\+\+N\+A\+ME}{DB\_NAME}}
{\footnotesize\ttfamily parlai.\+mturk.\+core.\+legacy\+\_\+2018.\+test.\+test\+\_\+db\+\_\+interactions.\+Test\+Data\+Handler.\+D\+B\+\_\+\+N\+A\+ME\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 27 of file test\+\_\+db\+\_\+interactions.\+py.



The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
parlai/mturk/core/legacy\+\_\+2018/test/\hyperlink{legacy__2018_2test_2test__db__interactions_8py}{test\+\_\+db\+\_\+interactions.\+py}\end{DoxyCompactItemize}
