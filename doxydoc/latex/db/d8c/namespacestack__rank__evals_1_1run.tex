\hypertarget{namespacestack__rank__evals_1_1run}{}\section{stack\+\_\+rank\+\_\+evals.\+run Namespace Reference}
\label{namespacestack__rank__evals_1_1run}\index{stack\+\_\+rank\+\_\+evals.\+run@{stack\+\_\+rank\+\_\+evals.\+run}}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{namespacestack__rank__evals_1_1run_a5e968ebe737f4f8e703b5be5bec893bf}{main} ()
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{namespacestack__rank__evals_1_1run_a7da608ae54872ed1fb55c4c87600cf99}{round\+\_\+choices}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\mbox{\Hypertarget{namespacestack__rank__evals_1_1run_a5e968ebe737f4f8e703b5be5bec893bf}\label{namespacestack__rank__evals_1_1run_a5e968ebe737f4f8e703b5be5bec893bf}} 
\index{stack\+\_\+rank\+\_\+evals\+::run@{stack\+\_\+rank\+\_\+evals\+::run}!main@{main}}
\index{main@{main}!stack\+\_\+rank\+\_\+evals\+::run@{stack\+\_\+rank\+\_\+evals\+::run}}
\subsubsection{\texorpdfstring{main()}{main()}}
{\footnotesize\ttfamily def stack\+\_\+rank\+\_\+evals.\+run.\+main (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}

\begin{DoxyVerb}Human Evaluation of various responses to comments on images.

A turker is shown an image and some dialog history. Then, the
turker is asked to choose which response they think is more engaging.

If no `--eval-data-path` is given, the data from the original
Image-Chat dataset is used.

To use your own data, please specify `--eval-data-path`, a path to an
appropriate json file with a list of examples, where each example
has the following structure:
    {
        'image_hash': <hash of image>,
        'dialog': [(personality, text), ...] - list of personality, text tuples
        'personality': <personality of responses to compare>
        '<compare_key_1>': <first response to compare>,
        '<compare_key_2>': <second option to compare>,
        .
        .
        .
    }
Note that compare_key_1 and compare_key_2 can be any field, as long as they
map to a string response.

Example Scenario:
    Suppose you have the original Image-Chat dataset, and
    you would like to compare the outputs of your model called `model`.

    Your data may look like the following:
    [{
        'image_hash': hashforimageofcat,
        'dialog': [
            ('Sweet', 'What a cute cat!'),
            ('Neutral', 'Just looks like a plain cat to me')
        ]
        'personality': 'Sweet',
        'comment': 'It really is adorable if you look!', # Human Comment
        'model_comment': 'You'll love it if you pet it!' # Model Comment
    }, ...]

    Thus, you would specify `-ck1 comment -ck2 model_comment` to evaluate
    the outputs of the model vs. the human comments from Personality-Captions
\end{DoxyVerb}


\begin{DoxyVerb}Human Evaluation of various image captions/comments.

A turker is shown an image and two possible comments/captions, and
optionally the personality used to create these captions. Then, the
turker is asked to choose which caption they think is more engaging.

In this example, we will just be comparing the original comment twice
(this is just to demonstrate the task for future use).

To use your own data, please specify `--eval-data-path` to an
appropriate json file with a list of examples, where each example
has the following structure:
    {
        'image_hash': <hash of image>,
        'personality': <personality, if applicable>,
        '<compare_key_1>': <first option to compare>,
        '<compare_key_2>': <second option to compare>,
        .
        .
        .
    }
Note that compare_key_1 and compare_key_2 can be any field, as long as they
map to a string comment/caption.

Example Scenario:
    Suppose you have the original Personality-Captions dataset, and
    you would like to compare the outputs of your model called `model`.

    Your data may look like the following:
    [{
        'image_hash': hashforimageofcat,
        'personality': 'Sweet',
        'comment': 'Look at the cute cat!', # Human Comment
        'model_comment': 'That's a weird looking dog' # Model Comment
    }, ...]

    Thus, you would specify `-ck1 comment -ck2 model_comment` to evaluate
    the outputs of the model vs. the human comments from Personality-Captions
\end{DoxyVerb}
 

Definition at line 22 of file run.\+py.


\begin{DoxyCode}
22 \textcolor{keyword}{def }\hyperlink{namespaceprojects_1_1wizard__of__wikipedia_1_1mturk__evaluation__task_1_1run_ad3ab2c71f8083c3112815c0b363d316b}{main}():
23     \textcolor{stringliteral}{"""}
24 \textcolor{stringliteral}{    Human Evaluation of various responses to comments on images.}
25 \textcolor{stringliteral}{}
26 \textcolor{stringliteral}{    A turker is shown an image and some dialog history. Then, the}
27 \textcolor{stringliteral}{    turker is asked to choose which response they think is more engaging.}
28 \textcolor{stringliteral}{}
29 \textcolor{stringliteral}{    If no `--eval-data-path` is given, the data from the original}
30 \textcolor{stringliteral}{    Image-Chat dataset is used.}
31 \textcolor{stringliteral}{}
32 \textcolor{stringliteral}{    To use your own data, please specify `--eval-data-path`, a path to an}
33 \textcolor{stringliteral}{    appropriate json file with a list of examples, where each example}
34 \textcolor{stringliteral}{    has the following structure:}
35 \textcolor{stringliteral}{        \{}
36 \textcolor{stringliteral}{            'image\_hash': <hash of image>,}
37 \textcolor{stringliteral}{            'dialog': [(personality, text), ...] - list of personality, text tuples}
38 \textcolor{stringliteral}{            'personality': <personality of responses to compare>}
39 \textcolor{stringliteral}{            '<compare\_key\_1>': <first response to compare>,}
40 \textcolor{stringliteral}{            '<compare\_key\_2>': <second option to compare>,}
41 \textcolor{stringliteral}{            .}
42 \textcolor{stringliteral}{            .}
43 \textcolor{stringliteral}{            .}
44 \textcolor{stringliteral}{        \}}
45 \textcolor{stringliteral}{    Note that compare\_key\_1 and compare\_key\_2 can be any field, as long as they}
46 \textcolor{stringliteral}{    map to a string response.}
47 \textcolor{stringliteral}{}
48 \textcolor{stringliteral}{    Example Scenario:}
49 \textcolor{stringliteral}{        Suppose you have the original Image-Chat dataset, and}
50 \textcolor{stringliteral}{        you would like to compare the outputs of your model called `model`.}
51 \textcolor{stringliteral}{}
52 \textcolor{stringliteral}{        Your data may look like the following:}
53 \textcolor{stringliteral}{        [\{}
54 \textcolor{stringliteral}{            'image\_hash': hashforimageofcat,}
55 \textcolor{stringliteral}{            'dialog': [}
56 \textcolor{stringliteral}{                ('Sweet', 'What a cute cat!'),}
57 \textcolor{stringliteral}{                ('Neutral', 'Just looks like a plain cat to me')}
58 \textcolor{stringliteral}{            ]}
59 \textcolor{stringliteral}{            'personality': 'Sweet',}
60 \textcolor{stringliteral}{            'comment': 'It really is adorable if you look!', # Human Comment}
61 \textcolor{stringliteral}{            'model\_comment': 'You'll love it if you pet it!' # Model Comment}
62 \textcolor{stringliteral}{        \}, ...]}
63 \textcolor{stringliteral}{}
64 \textcolor{stringliteral}{        Thus, you would specify `-ck1 comment -ck2 model\_comment` to evaluate}
65 \textcolor{stringliteral}{        the outputs of the model vs. the human comments from Personality-Captions}
66 \textcolor{stringliteral}{    """}
67     argparser = ParlaiParser(\textcolor{keyword}{False}, \textcolor{keyword}{False})
68     argparser.add\_parlai\_data\_path()
69     argparser.add\_mturk\_args()
70     argparser.add\_argument(
71         \textcolor{stringliteral}{'-min\_t'}, \textcolor{stringliteral}{'--min\_turns'}, default=3, type=int, help=\textcolor{stringliteral}{'minimum number of turns'}
72     )
73     argparser.add\_argument(
74         \textcolor{stringliteral}{'-mt'}, \textcolor{stringliteral}{'--max\_turns'}, default=5, type=int, help=\textcolor{stringliteral}{'maximal number of chat turns'}
75     )
76     argparser.add\_argument(
77         \textcolor{stringliteral}{'-mx\_rsp\_time'},
78         \textcolor{stringliteral}{'--max\_resp\_time'},
79         default=1800,
80         type=int,
81         help=\textcolor{stringliteral}{'time limit for entering a dialog message'},
82     )
83     argparser.add\_argument(
84         \textcolor{stringliteral}{'-mx\_onb\_time'},
85         \textcolor{stringliteral}{'--max\_onboard\_time'},
86         type=int,
87         default=300,
88         help=\textcolor{stringliteral}{'time limit for turker'} \textcolor{stringliteral}{'in onboarding'},
89     )
90     argparser.add\_argument(
91         \textcolor{stringliteral}{'-ni'},
92         \textcolor{stringliteral}{'--num\_images'},
93         type=int,
94         default=10,
95         help=\textcolor{stringliteral}{'number of images to show \(\backslash\)}
96 \textcolor{stringliteral}{                           to turker'},
97     )
98     argparser.add\_argument(
99         \textcolor{stringliteral}{'--auto-approve-delay'},
100         type=int,
101         default=3600 * 24,
102         help=\textcolor{stringliteral}{'how long to wait for  \(\backslash\)}
103 \textcolor{stringliteral}{                           auto approval'},
104     )
105     argparser.add\_argument(
106         \textcolor{stringliteral}{'--data-path'}, type=str, default=\textcolor{stringliteral}{''}, help=\textcolor{stringliteral}{'where to save data'}
107     )
108     argparser.add\_argument(
109         \textcolor{stringliteral}{'--eval-data-path'},
110         type=str,
111         default=\textcolor{stringliteral}{''},
112         help=\textcolor{stringliteral}{'where to load data to rank from. Leave '} \textcolor{stringliteral}{'blank to use Image-Chat data'},
113     )
114     argparser.add\_argument(
115         \textcolor{stringliteral}{'-ck1'},
116         \textcolor{stringliteral}{'--compare-key-1'},
117         type=str,
118         default=\textcolor{stringliteral}{'comment'},
119         help=\textcolor{stringliteral}{'key of first comparable'},
120     )
121     argparser.add\_argument(
122         \textcolor{stringliteral}{'-ck2'},
123         \textcolor{stringliteral}{'--compare-key-2'},
124         type=str,
125         default=\textcolor{stringliteral}{'comment'},
126         help=\textcolor{stringliteral}{'key of first comparable'},
127     )
128     argparser.add\_argument(
129         \textcolor{stringliteral}{'-rnd'},
130         \textcolor{stringliteral}{'--dialog-round'},
131         type=str,
132         default=\textcolor{stringliteral}{'first\_response'},
133         choices=round\_choices,
134         help=\textcolor{stringliteral}{'which dialog round to show'},
135     )
136     argparser.add\_argument(
137         \textcolor{stringliteral}{'--show-personality'},
138         default=\textcolor{keyword}{True},
139         type=\textcolor{stringliteral}{'bool'},
140         help=\textcolor{stringliteral}{'whether to show the personality'},
141     )
142     ImageChatTeacher.add\_cmdline\_args(argparser)
143     opt = argparser.parse\_args()
144     build\_ic(opt)
145     directory\_path = os.path.dirname(os.path.abspath(\_\_file\_\_))
146     opt[\textcolor{stringliteral}{'task'}] = os.path.basename(directory\_path)
147     \textcolor{keywordflow}{if} \textcolor{stringliteral}{'data\_path'} \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} opt \textcolor{keywordflow}{or} opt[\textcolor{stringliteral}{'data\_path'}] == \textcolor{stringliteral}{''}:
148         opt[\textcolor{stringliteral}{'data\_path'}] = os.getcwd() + \textcolor{stringliteral}{'/data/'} + opt[\textcolor{stringliteral}{'task'}]
149     \textcolor{keywordflow}{if} opt.get(\textcolor{stringliteral}{'eval\_data\_path'}) == \textcolor{stringliteral}{''}:
150         opt[\textcolor{stringliteral}{'eval\_data\_path'}] = os.path.join(opt[\textcolor{stringliteral}{'datapath'}], \textcolor{stringliteral}{'image\_chat/test.json'})
151     config = config\_first \textcolor{keywordflow}{if} opt[\textcolor{stringliteral}{'dialog\_round'}] == \textcolor{stringliteral}{'first\_response'} \textcolor{keywordflow}{else} config\_second
152     opt.update(config)
153 
154     mturk\_agent\_ids = [CHOOSER]
155     mturk\_manager = MTurkManager(opt=opt, mturk\_agent\_ids=mturk\_agent\_ids)
156 
157     example\_generator = ExampleGenerator(opt)
158     mturk\_manager.setup\_server(task\_directory\_path=directory\_path)
159 
160     \textcolor{keywordflow}{try}:
161         mturk\_manager.start\_new\_run()
162 
163         \textcolor{keyword}{def }run\_onboard(worker):
164             worker.example\_generator = example\_generator
165             world = RoleOnboardWorld(opt, worker)
166             world.parley()
167             world.shutdown()
168 
169         mturk\_manager.set\_onboard\_function(onboard\_function=run\_onboard)
170         mturk\_manager.ready\_to\_accept\_workers()
171         mturk\_manager.create\_hits()
172 
173         \textcolor{keyword}{def }check\_worker\_eligibility(worker):
174             \textcolor{keywordflow}{return} \textcolor{keyword}{True}
175 
176         \textcolor{keyword}{def }assign\_worker\_roles(workers):
177             \textcolor{keywordflow}{for} w \textcolor{keywordflow}{in} workers:
178                 w.id = mturk\_agent\_ids[0]
179 
180         \textcolor{keyword}{def }run\_conversation(mturk\_manager, opt, workers):
181             agents = workers[:]
182             conv\_idx = mturk\_manager.conversation\_index
183             world = MTurkImageChatStackRankWorld(
184                 opt, agents=agents, world\_tag=\textcolor{stringliteral}{'conversation t\_\{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(conv\_idx)
185             )
186             \textcolor{keywordflow}{while} \textcolor{keywordflow}{not} world.episode\_done():
187                 world.parley()
188             world.save\_data()
189 
190             world.shutdown()
191             world.review\_work()
192 
193         mturk\_manager.start\_task(
194             eligibility\_function=check\_worker\_eligibility,
195             assign\_role\_function=assign\_worker\_roles,
196             task\_function=run\_conversation,
197         )
198 
199     \textcolor{keywordflow}{except} BaseException:
200         \textcolor{keywordflow}{raise}
201     \textcolor{keywordflow}{finally}:
202         mturk\_manager.expire\_all\_unassigned\_hits()
203         mturk\_manager.shutdown()
204 
205 
\end{DoxyCode}


\subsection{Variable Documentation}
\mbox{\Hypertarget{namespacestack__rank__evals_1_1run_a7da608ae54872ed1fb55c4c87600cf99}\label{namespacestack__rank__evals_1_1run_a7da608ae54872ed1fb55c4c87600cf99}} 
\index{stack\+\_\+rank\+\_\+evals\+::run@{stack\+\_\+rank\+\_\+evals\+::run}!round\+\_\+choices@{round\+\_\+choices}}
\index{round\+\_\+choices@{round\+\_\+choices}!stack\+\_\+rank\+\_\+evals\+::run@{stack\+\_\+rank\+\_\+evals\+::run}}
\subsubsection{\texorpdfstring{round\+\_\+choices}{round\_choices}}
{\footnotesize\ttfamily stack\+\_\+rank\+\_\+evals.\+run.\+round\+\_\+choices}



Definition at line 19 of file run.\+py.

