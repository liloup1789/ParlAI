\hypertarget{namespaceparlai_1_1mturk_1_1tasks_1_1react__task__demo_1_1react__custom__with__deps_1_1run}{}\section{parlai.\+mturk.\+tasks.\+react\+\_\+task\+\_\+demo.\+react\+\_\+custom\+\_\+with\+\_\+deps.\+run Namespace Reference}
\label{namespaceparlai_1_1mturk_1_1tasks_1_1react__task__demo_1_1react__custom__with__deps_1_1run}\index{parlai.\+mturk.\+tasks.\+react\+\_\+task\+\_\+demo.\+react\+\_\+custom\+\_\+with\+\_\+deps.\+run@{parlai.\+mturk.\+tasks.\+react\+\_\+task\+\_\+demo.\+react\+\_\+custom\+\_\+with\+\_\+deps.\+run}}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{namespaceparlai_1_1mturk_1_1tasks_1_1react__task__demo_1_1react__custom__with__deps_1_1run_a50f23070329d468b1499c88037338007}{main} ()
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\mbox{\Hypertarget{namespaceparlai_1_1mturk_1_1tasks_1_1react__task__demo_1_1react__custom__with__deps_1_1run_a50f23070329d468b1499c88037338007}\label{namespaceparlai_1_1mturk_1_1tasks_1_1react__task__demo_1_1react__custom__with__deps_1_1run_a50f23070329d468b1499c88037338007}} 
\index{parlai\+::mturk\+::tasks\+::react\+\_\+task\+\_\+demo\+::react\+\_\+custom\+\_\+with\+\_\+deps\+::run@{parlai\+::mturk\+::tasks\+::react\+\_\+task\+\_\+demo\+::react\+\_\+custom\+\_\+with\+\_\+deps\+::run}!main@{main}}
\index{main@{main}!parlai\+::mturk\+::tasks\+::react\+\_\+task\+\_\+demo\+::react\+\_\+custom\+\_\+with\+\_\+deps\+::run@{parlai\+::mturk\+::tasks\+::react\+\_\+task\+\_\+demo\+::react\+\_\+custom\+\_\+with\+\_\+deps\+::run}}
\subsubsection{\texorpdfstring{main()}{main()}}
{\footnotesize\ttfamily def parlai.\+mturk.\+tasks.\+react\+\_\+task\+\_\+demo.\+react\+\_\+custom\+\_\+with\+\_\+deps.\+run.\+main (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}

\begin{DoxyVerb}Handles setting up and running a ParlAI-MTurk task by instantiating an MTurk manager
and configuring it for the qa_data_collection task.
\end{DoxyVerb}
 

Definition at line 20 of file run.\+py.


\begin{DoxyCode}
20 \textcolor{keyword}{def }\hyperlink{namespaceprojects_1_1wizard__of__wikipedia_1_1mturk__evaluation__task_1_1run_ad3ab2c71f8083c3112815c0b363d316b}{main}():
21     \textcolor{stringliteral}{"""}
22 \textcolor{stringliteral}{    Handles setting up and running a ParlAI-MTurk task by instantiating an MTurk manager}
23 \textcolor{stringliteral}{    and configuring it for the qa\_data\_collection task.}
24 \textcolor{stringliteral}{    """}
25     \textcolor{comment}{# Get relevant arguments}
26     argparser = ParlaiParser(\textcolor{keyword}{False}, \textcolor{keyword}{False})
27     argparser.add\_parlai\_data\_path()
28     argparser.add\_mturk\_args()
29     opt = argparser.parse\_args()
30 
31     \textcolor{comment}{# Set the task name to be the folder name}
32     opt[\textcolor{stringliteral}{'task'}] = os.path.basename(os.path.dirname(os.path.abspath(\_\_file\_\_)))
33 
34     \textcolor{comment}{# append the contents of task\_config.py to the configuration}
35     opt.update(task\_config)
36 
37     \textcolor{comment}{# Select an agent\_id that worker agents will be assigned in their world}
38     mturk\_agent\_roles = [\textcolor{stringliteral}{'Asker'}, \textcolor{stringliteral}{'Answerer'}, \textcolor{stringliteral}{'Evaluator'}]
39 
40     \textcolor{comment}{# Instantiate an MTurkManager with the given options and a maximum number}
41     \textcolor{comment}{# of agents per world of 1 (based on the length of mturk\_agent\_ids)}
42     mturk\_manager = MTurkManager(
43         opt=opt, mturk\_agent\_ids=mturk\_agent\_roles, use\_db=\textcolor{keyword}{True}
44     )
45     mturk\_manager.setup\_server(
46         task\_directory\_path=os.path.dirname(os.path.abspath(\_\_file\_\_))
47     )
48 
49     role\_index = 0
50 
51     \textcolor{comment}{# Create an onboard\_function, which will be run for workers who have}
52     \textcolor{comment}{# accepted your task and must be completed before they are put in the}
53     \textcolor{comment}{# queue for a task world.}
54     \textcolor{keyword}{def }run\_onboard(worker):
55         nonlocal role\_index
56         role = mturk\_agent\_roles[role\_index % 3]
57         role\_index += 1
58         worker.update\_agent\_id(\textcolor{stringliteral}{'Onboarding \{\}'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(role))
59         worker.demo\_role = role
60         \textcolor{keywordflow}{if} role == \textcolor{stringliteral}{'Asker'}:
61             world = AskerOnboardingWorld(opt=opt, mturk\_agent=worker)
62         \textcolor{keywordflow}{elif} role == \textcolor{stringliteral}{'Answerer'}:
63             world = AnswererOnboardingWorld(opt=opt, mturk\_agent=worker)
64         \textcolor{keywordflow}{else}:
65             world = EvaluatorOnboardingWorld(opt=opt, mturk\_agent=worker)
66         \textcolor{keywordflow}{while} \textcolor{keywordflow}{not} world.episode\_done():
67             world.parley()
68         world.shutdown()
69         \textcolor{keywordflow}{return} world.prep\_save\_data([worker])
70 
71     \textcolor{comment}{# If we want to use the above onboard function, we can replace the below}
72     \textcolor{comment}{# with set\_onboard\_function(onboard\_function=run\_onboard)}
73     mturk\_manager.set\_onboard\_function(onboard\_function=run\_onboard)
74 
75     \textcolor{keywordflow}{try}:
76         \textcolor{comment}{# Initialize run information}
77         mturk\_manager.start\_new\_run()
78 
79         \textcolor{comment}{# Set up the sockets and threads to recieve workers}
80         mturk\_manager.ready\_to\_accept\_workers()
81 
82         \textcolor{comment}{# Create the hits as specified by command line arguments}
83         mturk\_manager.create\_hits()
84 
85         \textcolor{comment}{# Check workers eligiblity acts as a filter, and should return}
86         \textcolor{comment}{# the list of all workers currently eligible to work on the task}
87         \textcolor{comment}{# Can be used to pair workers that meet certain criterea}
88         \textcolor{keyword}{def }check\_workers\_eligibility(workers):
89             filled\_roles = []
90             use\_workers = []
91             \textcolor{keywordflow}{for} worker \textcolor{keywordflow}{in} workers:
92                 \textcolor{keywordflow}{if} worker.demo\_role \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} filled\_roles:
93                     use\_workers.append(worker)
94                     filled\_roles.append(worker.demo\_role)
95             \textcolor{keywordflow}{return} use\_workers
96 
97         eligibility\_function = \{\textcolor{stringliteral}{'func'}: check\_workers\_eligibility, \textcolor{stringliteral}{'multiple'}: \textcolor{keyword}{True}\}
98 
99         \textcolor{comment}{# Assign worker roles is used to determine what the role each worker}
100         \textcolor{comment}{# in the given worker list will play. Setting `id` to None will return}
101         \textcolor{comment}{# the worker to the pool rather than putting them in a given task,}
102         \textcolor{comment}{# which is useful for having tasks with different possible worker}
103         \textcolor{comment}{# counts.}
104         \textcolor{keyword}{def }assign\_worker\_roles(workers):
105             \textcolor{keywordflow}{for} worker \textcolor{keywordflow}{in} workers:
106                 worker.id = worker.demo\_role
107 
108         \textcolor{comment}{# Define the task function, which will be run with workers that are}
109         \textcolor{comment}{# as the main task.}
110         \textcolor{keyword}{global} run\_conversation
111 
112         \textcolor{keyword}{def }run\_conversation(mturk\_manager, opt, workers):
113             \textcolor{comment}{# Create the task world}
114             world = MultiRoleAgentWorld(opt=opt, mturk\_agents=workers)
115             \textcolor{comment}{# run the world to completion}
116             \textcolor{keywordflow}{while} \textcolor{keywordflow}{not} world.episode\_done():
117                 world.parley()
118 
119             \textcolor{comment}{# shutdown and review the work}
120             world.shutdown()
121             world.review\_work()
122 
123             \textcolor{comment}{# Return the contents for saving}
124             \textcolor{keywordflow}{return} world.prep\_save\_data(workers)
125 
126         \textcolor{comment}{# Begin the task, allowing mturk\_manager to start running the task}
127         \textcolor{comment}{# world on any workers who connect}
128         mturk\_manager.start\_task(
129             eligibility\_function=eligibility\_function,
130             assign\_role\_function=assign\_worker\_roles,
131             task\_function=run\_conversation,
132         )
133     \textcolor{keywordflow}{except} BaseException:
134         \textcolor{keywordflow}{raise}
135     \textcolor{keywordflow}{finally}:
136         \textcolor{comment}{# Any hits that aren't claimed or completed have to be shut down. Must}
137         \textcolor{comment}{# keep the world running until that point.}
138         mturk\_manager.expire\_all\_unassigned\_hits()
139         \textcolor{comment}{# Shutdown the manager and free all related resources}
140         mturk\_manager.shutdown()
141 
142 
\end{DoxyCode}
