\hypertarget{classparlai_1_1utils_1_1misc_1_1PaddingUtils}{}\section{parlai.\+utils.\+misc.\+Padding\+Utils Class Reference}
\label{classparlai_1_1utils_1_1misc_1_1PaddingUtils}\index{parlai.\+utils.\+misc.\+Padding\+Utils@{parlai.\+utils.\+misc.\+Padding\+Utils}}


Inheritance diagram for parlai.\+utils.\+misc.\+Padding\+Utils\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=203pt]{d0/dec/classparlai_1_1utils_1_1misc_1_1PaddingUtils__inherit__graph}
\end{center}
\end{figure}


Collaboration diagram for parlai.\+utils.\+misc.\+Padding\+Utils\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=203pt]{d9/dda/classparlai_1_1utils_1_1misc_1_1PaddingUtils__coll__graph}
\end{center}
\end{figure}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{classparlai_1_1utils_1_1misc_1_1PaddingUtils_acd7178452139c55dc56e9889b10347cc}{pad\+\_\+text} (cls, observations, dictionary, end\+\_\+idx=None, null\+\_\+idx=0, dq=False, eval\+\_\+labels=True, truncate=None)
\item 
def \hyperlink{classparlai_1_1utils_1_1misc_1_1PaddingUtils_ae862960e8f261ff4088d5dedbe42a25c}{map\+\_\+predictions} (cls, predictions, valid\+\_\+inds, batch\+\_\+reply, observations, dictionary, end\+\_\+idx, report\+\_\+freq=0.\+1, labels=None, answers=None, ys=None)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
\begin{DoxyVerb}Helps with padding input and target tensors.

DEPRECATED. USE PARLAI.CORE.TORCH_AGENT INSTEAD.
\end{DoxyVerb}
 

Definition at line 381 of file misc.\+py.



\subsection{Member Function Documentation}
\mbox{\Hypertarget{classparlai_1_1utils_1_1misc_1_1PaddingUtils_ae862960e8f261ff4088d5dedbe42a25c}\label{classparlai_1_1utils_1_1misc_1_1PaddingUtils_ae862960e8f261ff4088d5dedbe42a25c}} 
\index{parlai\+::utils\+::misc\+::\+Padding\+Utils@{parlai\+::utils\+::misc\+::\+Padding\+Utils}!map\+\_\+predictions@{map\+\_\+predictions}}
\index{map\+\_\+predictions@{map\+\_\+predictions}!parlai\+::utils\+::misc\+::\+Padding\+Utils@{parlai\+::utils\+::misc\+::\+Padding\+Utils}}
\subsubsection{\texorpdfstring{map\+\_\+predictions()}{map\_predictions()}}
{\footnotesize\ttfamily def parlai.\+utils.\+misc.\+Padding\+Utils.\+map\+\_\+predictions (\begin{DoxyParamCaption}\item[{}]{cls,  }\item[{}]{predictions,  }\item[{}]{valid\+\_\+inds,  }\item[{}]{batch\+\_\+reply,  }\item[{}]{observations,  }\item[{}]{dictionary,  }\item[{}]{end\+\_\+idx,  }\item[{}]{report\+\_\+freq = {\ttfamily 0.1},  }\item[{}]{labels = {\ttfamily None},  }\item[{}]{answers = {\ttfamily None},  }\item[{}]{ys = {\ttfamily None} }\end{DoxyParamCaption})}

\begin{DoxyVerb}Match predictions to original index in the batch.

Predictions are mapped back to appropriate indices in the batch_reply
using valid_inds.

report_freq -- how often we report predictions

DEPRECATED. USE PARLAI.CORE.TORCH_AGENT INSTEAD.
\end{DoxyVerb}
 

Definition at line 527 of file misc.\+py.


\begin{DoxyCode}
527     ):
528         \textcolor{stringliteral}{"""}
529 \textcolor{stringliteral}{        Match predictions to original index in the batch.}
530 \textcolor{stringliteral}{}
531 \textcolor{stringliteral}{        Predictions are mapped back to appropriate indices in the batch\_reply}
532 \textcolor{stringliteral}{        using valid\_inds.}
533 \textcolor{stringliteral}{}
534 \textcolor{stringliteral}{        report\_freq -- how often we report predictions}
535 \textcolor{stringliteral}{}
536 \textcolor{stringliteral}{        DEPRECATED. USE PARLAI.CORE.TORCH\_AGENT INSTEAD.}
537 \textcolor{stringliteral}{        """}
538         \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(len(predictions)):
539             \textcolor{comment}{# map the predictions back to non-empty examples in the batch}
540             \textcolor{comment}{# we join with spaces since we produce tokens one at a timelab}
541             curr = batch\_reply[valid\_inds[i]]
542             output\_tokens = []
543             j = 0
544             \textcolor{keywordflow}{for} c \textcolor{keywordflow}{in} predictions[i]:
545                 \textcolor{keywordflow}{if} c == end\_idx \textcolor{keywordflow}{and} j != 0:
546                     \textcolor{keywordflow}{break}
547                 \textcolor{keywordflow}{else}:
548                     output\_tokens.append(c)
549                 j += 1
550             curr\_pred = dictionary.vec2txt(output\_tokens)
551             curr[\textcolor{stringliteral}{'text'}] = curr\_pred
552 
553             \textcolor{keywordflow}{if} labels \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None} \textcolor{keywordflow}{and} answers \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None} \textcolor{keywordflow}{and} ys \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
554                 y = []
555                 \textcolor{keywordflow}{for} c \textcolor{keywordflow}{in} ys[i]:
556                     \textcolor{keywordflow}{if} c == end\_idx:
557                         \textcolor{keywordflow}{break}
558                     \textcolor{keywordflow}{else}:
559                         y.append(c)
560                 answers[valid\_inds[i]] = y
561             \textcolor{keywordflow}{elif} answers \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
562                 answers[valid\_inds[i]] = curr\_pred
563 
564             \textcolor{keywordflow}{if} random.random() > (1 - report\_freq):
565                 \textcolor{comment}{# log sometimes}
566                 print(\textcolor{stringliteral}{'TEXT: '}, observations[valid\_inds[i]][\textcolor{stringliteral}{'text'}])
567                 print(\textcolor{stringliteral}{'PREDICTION: '}, curr\_pred, \textcolor{stringliteral}{'\(\backslash\)n~'})
568         \textcolor{keywordflow}{return}
569 
570 
\end{DoxyCode}
\mbox{\Hypertarget{classparlai_1_1utils_1_1misc_1_1PaddingUtils_acd7178452139c55dc56e9889b10347cc}\label{classparlai_1_1utils_1_1misc_1_1PaddingUtils_acd7178452139c55dc56e9889b10347cc}} 
\index{parlai\+::utils\+::misc\+::\+Padding\+Utils@{parlai\+::utils\+::misc\+::\+Padding\+Utils}!pad\+\_\+text@{pad\+\_\+text}}
\index{pad\+\_\+text@{pad\+\_\+text}!parlai\+::utils\+::misc\+::\+Padding\+Utils@{parlai\+::utils\+::misc\+::\+Padding\+Utils}}
\subsubsection{\texorpdfstring{pad\+\_\+text()}{pad\_text()}}
{\footnotesize\ttfamily def parlai.\+utils.\+misc.\+Padding\+Utils.\+pad\+\_\+text (\begin{DoxyParamCaption}\item[{}]{cls,  }\item[{}]{observations,  }\item[{}]{dictionary,  }\item[{}]{end\+\_\+idx = {\ttfamily None},  }\item[{}]{null\+\_\+idx = {\ttfamily 0},  }\item[{}]{dq = {\ttfamily False},  }\item[{}]{eval\+\_\+labels = {\ttfamily True},  }\item[{}]{truncate = {\ttfamily None} }\end{DoxyParamCaption})}

\begin{DoxyVerb}Pad observations to max width.

We check that examples are valid, pad with zeros, and sort by length
so that we can use the pack_padded function. The list valid_inds
keeps track of which indices are valid and the order in which we sort
the examples.

dq -- whether we should use deque or list
eval_labels -- whether or not we want to consider eval labels
truncate -- truncate input and output lengths

DEPRECATED. USE PARLAI.CORE.TORCH_AGENT INSTEAD.
\end{DoxyVerb}
 

Definition at line 400 of file misc.\+py.


\begin{DoxyCode}
400     ):
401         \textcolor{stringliteral}{"""}
402 \textcolor{stringliteral}{        Pad observations to max width.}
403 \textcolor{stringliteral}{}
404 \textcolor{stringliteral}{        We check that examples are valid, pad with zeros, and sort by length}
405 \textcolor{stringliteral}{        so that we can use the pack\_padded function. The list valid\_inds}
406 \textcolor{stringliteral}{        keeps track of which indices are valid and the order in which we sort}
407 \textcolor{stringliteral}{        the examples.}
408 \textcolor{stringliteral}{}
409 \textcolor{stringliteral}{        dq -- whether we should use deque or list}
410 \textcolor{stringliteral}{        eval\_labels -- whether or not we want to consider eval labels}
411 \textcolor{stringliteral}{        truncate -- truncate input and output lengths}
412 \textcolor{stringliteral}{}
413 \textcolor{stringliteral}{        DEPRECATED. USE PARLAI.CORE.TORCH\_AGENT INSTEAD.}
414 \textcolor{stringliteral}{        """}
415 
416         \textcolor{keyword}{def }valid(obs):
417             \textcolor{comment}{# check if this is an example our model should actually process}
418             \textcolor{keywordflow}{return} \textcolor{stringliteral}{'text'} \textcolor{keywordflow}{in} obs \textcolor{keywordflow}{and} len(obs[\textcolor{stringliteral}{'text'}]) > 0
419 
420         \textcolor{keywordflow}{try}:
421             \textcolor{comment}{# valid examples and their indices}
422             valid\_inds, exs = zip(
423                 *[(i, ex) \textcolor{keywordflow}{for} i, ex \textcolor{keywordflow}{in} enumerate(observations) \textcolor{keywordflow}{if} valid(ex)]
424             )
425         \textcolor{keywordflow}{except} ValueError:
426             \textcolor{comment}{# zero examples to process in this batch, so zip failed to unpack}
427             \textcolor{keywordflow}{return} \textcolor{keywordtype}{None}, \textcolor{keywordtype}{None}, \textcolor{keywordtype}{None}, \textcolor{keywordtype}{None}, \textcolor{keywordtype}{None}, \textcolor{keywordtype}{None}
428 
429         \textcolor{comment}{# `x` text is already tokenized and truncated}
430         \textcolor{comment}{# sort by length so we can use pack\_padded}
431         \textcolor{keywordflow}{if} any([\textcolor{stringliteral}{'text2vec'} \textcolor{keywordflow}{in} ex \textcolor{keywordflow}{for} ex \textcolor{keywordflow}{in} exs]):
432             parsed\_x = [ex[\textcolor{stringliteral}{'text2vec'}] \textcolor{keywordflow}{for} ex \textcolor{keywordflow}{in} exs]
433         \textcolor{keywordflow}{else}:
434             parsed\_x = [dictionary.txt2vec(ex[\textcolor{stringliteral}{'text'}]) \textcolor{keywordflow}{for} ex \textcolor{keywordflow}{in} exs]
435 
436         \textcolor{keywordflow}{if} len(parsed\_x) > 0 \textcolor{keywordflow}{and} \textcolor{keywordflow}{not} isinstance(parsed\_x[0], deque):
437             \textcolor{keywordflow}{if} dq:
438                 parsed\_x = [deque(x, maxlen=truncate) \textcolor{keywordflow}{for} x \textcolor{keywordflow}{in} parsed\_x]
439             \textcolor{keywordflow}{elif} truncate \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None} \textcolor{keywordflow}{and} truncate > 0:
440                 parsed\_x = [x[-truncate:] \textcolor{keywordflow}{for} x \textcolor{keywordflow}{in} parsed\_x]
441 
442         x\_lens = [len(x) \textcolor{keywordflow}{for} x \textcolor{keywordflow}{in} parsed\_x]
443         ind\_sorted = sorted(range(len(x\_lens)), key=\textcolor{keyword}{lambda} k: -x\_lens[k])
444 
445         exs = [exs[k] \textcolor{keywordflow}{for} k \textcolor{keywordflow}{in} ind\_sorted]
446         valid\_inds = [valid\_inds[k] \textcolor{keywordflow}{for} k \textcolor{keywordflow}{in} ind\_sorted]
447         parsed\_x = [parsed\_x[k] \textcolor{keywordflow}{for} k \textcolor{keywordflow}{in} ind\_sorted]
448         end\_idxs = [x\_lens[k] \textcolor{keywordflow}{for} k \textcolor{keywordflow}{in} ind\_sorted]
449 
450         eval\_labels\_avail = any([\textcolor{stringliteral}{'eval\_labels'} \textcolor{keywordflow}{in} ex \textcolor{keywordflow}{for} ex \textcolor{keywordflow}{in} exs])
451         labels\_avail = any([\textcolor{stringliteral}{'labels'} \textcolor{keywordflow}{in} ex \textcolor{keywordflow}{for} ex \textcolor{keywordflow}{in} exs])
452         \textcolor{keywordflow}{if} eval\_labels:
453             some\_labels\_avail = eval\_labels\_avail \textcolor{keywordflow}{or} labels\_avail
454         \textcolor{keywordflow}{else}:
455             some\_labels\_avail = labels\_avail
456 
457         max\_x\_len = max(x\_lens)
458 
459         \textcolor{comment}{# pad with zeros}
460         \textcolor{keywordflow}{if} dq:
461             parsed\_x = [
462                 x
463                 \textcolor{keywordflow}{if} len(x) == max\_x\_len
464                 \textcolor{keywordflow}{else} x + deque((null\_idx,)) * (max\_x\_len - len(x))
465                 \textcolor{keywordflow}{for} x \textcolor{keywordflow}{in} parsed\_x
466             ]
467         \textcolor{keywordflow}{else}:
468             parsed\_x = [
469                 x \textcolor{keywordflow}{if} len(x) == max\_x\_len \textcolor{keywordflow}{else} x + [null\_idx] * (max\_x\_len - len(x))
470                 \textcolor{keywordflow}{for} x \textcolor{keywordflow}{in} parsed\_x
471             ]
472         xs = parsed\_x
473 
474         \textcolor{comment}{# set up the target tensors}
475         ys = \textcolor{keywordtype}{None}
476         labels = \textcolor{keywordtype}{None}
477         y\_lens = \textcolor{keywordtype}{None}
478         \textcolor{keywordflow}{if} some\_labels\_avail:
479             \textcolor{comment}{# randomly select one of the labels to update on (if multiple)}
480             \textcolor{keywordflow}{if} labels\_avail:
481                 labels = [random.choice(ex.get(\textcolor{stringliteral}{'labels'}, [\textcolor{stringliteral}{''}])) \textcolor{keywordflow}{for} ex \textcolor{keywordflow}{in} exs]
482             \textcolor{keywordflow}{else}:
483                 labels = [random.choice(ex.get(\textcolor{stringliteral}{'eval\_labels'}, [\textcolor{stringliteral}{''}])) \textcolor{keywordflow}{for} ex \textcolor{keywordflow}{in} exs]
484             \textcolor{comment}{# parse each label and append END}
485             \textcolor{keywordflow}{if} dq:
486                 parsed\_y = [deque(maxlen=truncate) \textcolor{keywordflow}{for} \_ \textcolor{keywordflow}{in} labels]
487                 \textcolor{keywordflow}{for} deq, y \textcolor{keywordflow}{in} zip(parsed\_y, labels):
488                     deq.extendleft(reversed(dictionary.txt2vec(y)))
489             \textcolor{keywordflow}{else}:
490                 parsed\_y = [dictionary.txt2vec(label) \textcolor{keywordflow}{for} label \textcolor{keywordflow}{in} labels]
491             \textcolor{keywordflow}{if} end\_idx \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
492                 \textcolor{keywordflow}{for} y \textcolor{keywordflow}{in} parsed\_y:
493                     y.append(end\_idx)
494 
495             y\_lens = [len(y) \textcolor{keywordflow}{for} y \textcolor{keywordflow}{in} parsed\_y]
496             max\_y\_len = max(y\_lens)
497 
498             \textcolor{keywordflow}{if} dq:
499                 parsed\_y = [
500                     y
501                     \textcolor{keywordflow}{if} len(y) == max\_y\_len
502                     \textcolor{keywordflow}{else} y + deque((null\_idx,)) * (max\_y\_len - len(y))
503                     \textcolor{keywordflow}{for} y \textcolor{keywordflow}{in} parsed\_y
504                 ]
505             \textcolor{keywordflow}{else}:
506                 parsed\_y = [
507                     y \textcolor{keywordflow}{if} len(y) == max\_y\_len \textcolor{keywordflow}{else} y + [null\_idx] * (max\_y\_len - len(y))
508                     \textcolor{keywordflow}{for} y \textcolor{keywordflow}{in} parsed\_y
509                 ]
510             ys = parsed\_y
511 
512         \textcolor{keywordflow}{return} xs, ys, labels, valid\_inds, end\_idxs, y\_lens
513 
\end{DoxyCode}


The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
parlai/utils/\hyperlink{misc_8py}{misc.\+py}\end{DoxyCompactItemize}
