\hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent}{}\section{projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent Class Reference}
\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent}\index{projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent@{projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent}}


Inheritance diagram for projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=268pt]{db/dd8/classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1Con3e957b093bb3d849abaffa3476033c2c}
\end{center}
\end{figure}


Collaboration diagram for projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=318pt]{de/d6e/classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1Con19d93f1a2a924e8b6c8b2d9d045183f4}
\end{center}
\end{figure}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ae8ed82e741a4ff840a398857945e28e6}{add\+\_\+cmdline\+\_\+args} (cls, argparser)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a0b06e6eba29a724b49b08cc9267f0862}{\+\_\+\+\_\+init\+\_\+\+\_\+} (self, \hyperlink{classparlai_1_1core_1_1torch__agent_1_1TorchAgent_a785bb920cf8c8afc3e9bf6a8b77e335a}{opt}, shared=None)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a4cecd20886ef127bbab1a756bb49fb75}{build\+\_\+model} (self, states=None)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a72b442a0dfa9d106f7a82624823cb73e}{zero\+\_\+grad} (self)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a9d5a1ac61fa3ebf363a8b15106a7e08b}{update\+\_\+params} (self)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a14bac616741ac0249f9c469db915ebd1}{reset\+\_\+metrics} (self)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_aa976447be9a59cdba202d947bb5dafbb}{report} (self)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ae9da32042638a1a69fe2911ad42d4d08}{share} (self)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_aae1b61b5d838205753a872e34e0c8c34}{vectorize} (self, args, kwargs)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a9d31c040b479d9cfeaeecc19a98985ee}{batchify} (self, args, kwargs)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a656ea2270ec3d407d67782754ead5f87}{train\+\_\+step} (self, batch)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ac416a9eb7ee7b0b1984468a4ec0b057c}{greedy\+\_\+search} (self, batch)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a836e91446f995a74cce113051991711a}{extend\+\_\+input} (self, batch)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ab3039a805f06b601cb1116702cbca7c2}{truncate\+\_\+input} (self, batch)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a4b656f8d8634a71088b3cb9e719f3629}{truncate\+\_\+output} (self, out)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a531943b5d1caee714bba77decbc93161}{eval\+\_\+step} (self, batch)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ad219fac39e0fb97c881c65d1ddfc6c32}{save} (self, path=None)
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a938d6646b76eaf838ddcd54ee71aa5d9}{load} (self, path)
\end{DoxyCompactItemize}
\subsection*{Static Public Member Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ab10efe928769fe5a7d398930e1d5174c}{model\+\_\+version} ()
\item 
def \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_aabb638a2dd4fd89320f1904d5b0579f1}{beam\+\_\+search} (\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ad3004224cdb878412a74b89f7f00412e}{model}, batch, \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a3bdf0be087cbd26a34badd3cb619e480}{beam\+\_\+size}, dictionary, start=1, end=2, pad=0, min\+\_\+length=3, min\+\_\+n\+\_\+best=5, max\+\_\+ts=40, block\+\_\+ngram=0, \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ae7d42c61a184691bb15d1ea65aee4c72}{wd\+\_\+features}=None, \hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a74800af89333cc27f221ed70dff41e4e}{wd\+\_\+wts}=None)
\end{DoxyCompactItemize}
\subsection*{Public Attributes}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a812e52cf25c679d7e6868eab04fb7da8}{id}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_af2988d23c581d2d186ec2ce527e92a6d}{multigpu}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_aaa40c3f61f6b3c343af814b66e337fd1}{beam\+\_\+dot\+\_\+log}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a3bdf0be087cbd26a34badd3cb619e480}{beam\+\_\+size}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_af48faf0b6fd7baa960fba7f90a4a1503}{beam\+\_\+min\+\_\+n\+\_\+best}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ad3d2699ffde7252a8a817e286937f75c}{beam\+\_\+min\+\_\+length}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ac1510ceaeecddc8d1b612e79e5125fd0}{beam\+\_\+block\+\_\+ngram}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ad3004224cdb878412a74b89f7f00412e}{model}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a5f37636e9f8eda06f6393bb21072a516}{metrics}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a5979974bea74f03b178f1e060c068f7e}{beam\+\_\+dot\+\_\+dir}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a883779e425cddd8e9c960d0e60b03de1}{criterion}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a60964f1450ffcd6b3ab7696a64e48cd5}{control\+\_\+vars}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a10e17fad8f2e68b1610f64dc7d262d1a}{control\+\_\+settings}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ae7d42c61a184691bb15d1ea65aee4c72}{wd\+\_\+features}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a74800af89333cc27f221ed70dff41e4e}{wd\+\_\+wts}
\item 
\hyperlink{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_af675df0b6aa0c683d5da13151a82abe4}{buffer\+\_\+initialized}
\end{DoxyCompactItemize}
\subsection*{Additional Inherited Members}


\subsection{Detailed Description}
\begin{DoxyVerb}Seq2Seq withattribute control via Conditional Training and/or Weighted Decoding.

See the paper: "What makes a good conversation? How controllable attributes affect
human judgments" https://arxiv.org/pdf/1902.08654.pdf
\end{DoxyVerb}
 

Definition at line 49 of file controllable\+\_\+seq2seq.\+py.



\subsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a0b06e6eba29a724b49b08cc9267f0862}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a0b06e6eba29a724b49b08cc9267f0862}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!\+\_\+\+\_\+init\+\_\+\+\_\+@{\+\_\+\+\_\+init\+\_\+\+\_\+}}
\index{\+\_\+\+\_\+init\+\_\+\+\_\+@{\+\_\+\+\_\+init\+\_\+\+\_\+}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{\+\_\+\+\_\+init\+\_\+\+\_\+()}{\_\_init\_\_()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+\_\+\+\_\+init\+\_\+\+\_\+ (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{opt,  }\item[{}]{shared = {\ttfamily None} }\end{DoxyParamCaption})}

\begin{DoxyVerb}Set up model.
\end{DoxyVerb}
 

Definition at line 272 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
272     \textcolor{keyword}{def }\_\_init\_\_(self, opt, shared=None):
273         \textcolor{stringliteral}{"""}
274 \textcolor{stringliteral}{        Set up model.}
275 \textcolor{stringliteral}{        """}
276         init\_model = \textcolor{keywordtype}{None}
277         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} shared:  \textcolor{comment}{# only do this on first setup}
278             \hyperlink{namespaceprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controls_aafbe257df1791349439cc63c99de8b5e}{initialize\_control\_information}(opt)
279             \textcolor{comment}{# first check load path in case we need to override paths}
280             \textcolor{keywordflow}{if} opt.get(\textcolor{stringliteral}{'init\_model'}) \textcolor{keywordflow}{and} os.path.isfile(opt[\textcolor{stringliteral}{'init\_model'}]):
281                 \textcolor{comment}{# check first for 'init\_model' for loading model from file}
282                 init\_model = opt[\textcolor{stringliteral}{'init\_model'}]
283             \textcolor{keywordflow}{if} opt.get(\textcolor{stringliteral}{'model\_file'}) \textcolor{keywordflow}{and} os.path.isfile(opt[\textcolor{stringliteral}{'model\_file'}]):
284                 \textcolor{comment}{# next check for 'model\_file', this would override init\_model}
285                 init\_model = opt[\textcolor{stringliteral}{'model\_file'}]
286 
287             \textcolor{keywordflow}{if} init\_model \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
288                 \textcolor{comment}{# if we are loading a model, should load its dict too}
289                 \textcolor{keywordflow}{if} os.path.isfile(init\_model + \textcolor{stringliteral}{'.dict'}) \textcolor{keywordflow}{or} opt[\textcolor{stringliteral}{'dict\_file'}] \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
290                     opt[\textcolor{stringliteral}{'dict\_file'}] = init\_model + \textcolor{stringliteral}{'.dict'}
291         super().\_\_init\_\_(opt, shared)
292         opt = self.opt
293         \textcolor{keyword}{assert} opt[\textcolor{stringliteral}{'person\_tokens'}]  \textcolor{comment}{# want this for ConvAI2}
294         \textcolor{keyword}{assert} opt[\textcolor{stringliteral}{'add\_p1\_after\_newln'}]  \textcolor{comment}{# want this for ConvAI2}
295 
296         \textcolor{comment}{# all instances may need some params}
297         self.id = \textcolor{stringliteral}{'Seq2Seq'}
298         self.multigpu = (
299             opt.get(\textcolor{stringliteral}{'multigpu'}) \textcolor{keywordflow}{and} self.use\_cuda \textcolor{keywordflow}{and} (opt.get(\textcolor{stringliteral}{'batchsize'}) > 1)
300         )
301         states = \{\}
302 
303         self.beam\_dot\_log = opt.get(\textcolor{stringliteral}{'beam\_dot\_log'}, \textcolor{keyword}{False})
304         self.beam\_size = opt.get(\textcolor{stringliteral}{'beam\_size'}, 1)
305         self.beam\_min\_n\_best = opt.get(\textcolor{stringliteral}{'beam\_min\_n\_best'}, 3)
306         self.beam\_min\_length = opt.get(\textcolor{stringliteral}{'beam\_min\_length'}, 3)
307         self.beam\_block\_ngram = opt.get(\textcolor{stringliteral}{'beam\_block\_ngram'}, 0)
308 
309         self.\_init\_controls()
310 
311         \textcolor{keywordflow}{if} shared:
312             \textcolor{comment}{# set up shared properties}
313             self.model = shared[\textcolor{stringliteral}{'model'}]
314             self.metrics = shared[\textcolor{stringliteral}{'metrics'}]
315             states = shared.get(\textcolor{stringliteral}{'states'}, \{\})
316         \textcolor{keywordflow}{else}:
317             self.metrics = \{
318                 \textcolor{stringliteral}{'loss'}: 0.0,
319                 \textcolor{stringliteral}{'num\_tokens'}: 0,
320                 \textcolor{stringliteral}{'correct\_tokens'}: 0,
321                 \textcolor{stringliteral}{'total\_skipped\_batches'}: 0,
322             \}
323             \textcolor{comment}{# this is not a shared instance of this class, so do full init}
324             \textcolor{keywordflow}{if} self.beam\_dot\_log:
325                 self.beam\_dot\_dir = tempfile.mkdtemp(
326                     prefix=\textcolor{stringliteral}{'\{\}-beamdot-beamsize-\{\}-'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(
327                         os.path.basename(opt.get(\textcolor{stringliteral}{'model\_file'})), self.beam\_size
328                     )
329                 )
330                 print(\textcolor{stringliteral}{'[ Saving dot beam logs in \{\} ]'}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(self.beam\_dot\_dir))
331             \textcolor{keywordflow}{if} init\_model \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
332                 \textcolor{comment}{# load model parameters if available}
333                 print(\textcolor{stringliteral}{'[ Loading existing model params from \{\} ]'} \textcolor{stringliteral}{''}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(init\_model))
334                 states = self.load(init\_model)
335 
336             self.model = self.build\_model(states=states)
337             \textcolor{keywordflow}{if} self.use\_cuda:
338                 self.model.cuda()
339                 \textcolor{keywordflow}{if} self.multigpu:
340                     self.model = torch.nn.DataParallel(self.model)
341                     self.model.encoder = self.model.module.encoder
342                     self.model.decoder = self.model.module.decoder
343                     self.model.longest\_label = self.model.module.longest\_label
344                     self.model.output = self.model.module.output
345 
346         \textcolor{comment}{# set up criteria}
347         \textcolor{keywordflow}{if} opt.get(\textcolor{stringliteral}{'numsoftmax'}, 1) > 1:
348             self.criterion = nn.NLLLoss(ignore\_index=self.NULL\_IDX, reduction=\textcolor{stringliteral}{'sum'})
349         \textcolor{keywordflow}{else}:
350             self.criterion = nn.CrossEntropyLoss(
351                 ignore\_index=self.NULL\_IDX, reduction=\textcolor{stringliteral}{'sum'}
352             )
353 
354         \textcolor{keywordflow}{if} self.use\_cuda:
355             self.criterion.cuda()
356 
357         \textcolor{keywordflow}{if} \textcolor{stringliteral}{'train'} \textcolor{keywordflow}{in} opt.get(\textcolor{stringliteral}{'datatype'}, \textcolor{stringliteral}{''}):
358             self.init\_optim(
359                 [p \textcolor{keywordflow}{for} p \textcolor{keywordflow}{in} self.model.parameters() \textcolor{keywordflow}{if} p.requires\_grad],
360                 optim\_states=states.get(\textcolor{stringliteral}{'optimizer'}),
361                 saved\_optim\_type=states.get(\textcolor{stringliteral}{'optimizer\_type'}),
362             )
363 
364         self.reset()
365 
366         \textcolor{comment}{# If we are adding parameters for new CT controls, save and exit}
367         \textcolor{keywordflow}{if} self.opt[\textcolor{stringliteral}{'add\_control'}]:
368             self.save()
369             print(\textcolor{stringliteral}{'Finished adding CT control parameters. Saved model. Quitting.'})
370             exit()
371 
\end{DoxyCode}


\subsection{Member Function Documentation}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ae8ed82e741a4ff840a398857945e28e6}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ae8ed82e741a4ff840a398857945e28e6}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!add\+\_\+cmdline\+\_\+args@{add\+\_\+cmdline\+\_\+args}}
\index{add\+\_\+cmdline\+\_\+args@{add\+\_\+cmdline\+\_\+args}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{add\+\_\+cmdline\+\_\+args()}{add\_cmdline\_args()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+add\+\_\+cmdline\+\_\+args (\begin{DoxyParamCaption}\item[{}]{cls,  }\item[{}]{argparser }\end{DoxyParamCaption})}

\begin{DoxyVerb}Add command-line arguments specifically for this agent.
\end{DoxyVerb}
 

Definition at line 58 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
58     \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1agents_1_1drqa_1_1config_a62fdd5554f1da6be0cba185271058320}{add\_cmdline\_args}(cls, argparser):
59         \textcolor{stringliteral}{"""}
60 \textcolor{stringliteral}{        Add command-line arguments specifically for this agent.}
61 \textcolor{stringliteral}{        """}
62         agent = argparser.add\_argument\_group(\textcolor{stringliteral}{'ControllableSeq2seqAgent Arguments'})
63         agent.add\_argument(
64             \textcolor{stringliteral}{'--init-model'},
65             type=str,
66             default=\textcolor{keywordtype}{None},
67             help=\textcolor{stringliteral}{'load dict/model/opts from this path'},
68         )
69         agent.add\_argument(
70             \textcolor{stringliteral}{'-hs'},
71             \textcolor{stringliteral}{'--hiddensize'},
72             type=int,
73             default=128,
74             help=\textcolor{stringliteral}{'size of the hidden layers'},
75         )
76         agent.add\_argument(
77             \textcolor{stringliteral}{'-esz'},
78             \textcolor{stringliteral}{'--embeddingsize'},
79             type=int,
80             default=128,
81             help=\textcolor{stringliteral}{'size of the token embeddings'},
82         )
83         agent.add\_argument(
84             \textcolor{stringliteral}{'-nl'}, \textcolor{stringliteral}{'--numlayers'}, type=int, default=2, help=\textcolor{stringliteral}{'number of hidden layers'}
85         )
86         agent.add\_argument(
87             \textcolor{stringliteral}{'-dr'}, \textcolor{stringliteral}{'--dropout'}, type=float, default=0.1, help=\textcolor{stringliteral}{'dropout rate'}
88         )
89         agent.add\_argument(
90             \textcolor{stringliteral}{'-bi'},
91             \textcolor{stringliteral}{'--bidirectional'},
92             type=\textcolor{stringliteral}{'bool'},
93             default=\textcolor{keyword}{False},
94             help=\textcolor{stringliteral}{'whether to encode the context with a '} \textcolor{stringliteral}{'bidirectional rnn'},
95         )
96         agent.add\_argument(
97             \textcolor{stringliteral}{'-att'},
98             \textcolor{stringliteral}{'--attention'},
99             default=\textcolor{stringliteral}{'none'},
100             choices=[\textcolor{stringliteral}{'none'}, \textcolor{stringliteral}{'concat'}, \textcolor{stringliteral}{'general'}, \textcolor{stringliteral}{'dot'}, \textcolor{stringliteral}{'local'}],
101             help=\textcolor{stringliteral}{'Choices: none, concat, general, local. '}
102             \textcolor{stringliteral}{'If set local, also set attention-length. '}
103             \textcolor{stringliteral}{'(see arxiv.org/abs/1508.04025)'},
104         )
105         agent.add\_argument(
106             \textcolor{stringliteral}{'-attl'},
107             \textcolor{stringliteral}{'--attention-length'},
108             default=48,
109             type=int,
110             help=\textcolor{stringliteral}{'Length of local attention.'},
111         )
112         agent.add\_argument(
113             \textcolor{stringliteral}{'--attention-time'},
114             default=\textcolor{stringliteral}{'post'},
115             choices=[\textcolor{stringliteral}{'pre'}, \textcolor{stringliteral}{'post'}],
116             help=\textcolor{stringliteral}{'Whether to apply attention before or after '} \textcolor{stringliteral}{'decoding.'},
117         )
118         agent.add\_argument(
119             \textcolor{stringliteral}{'-rnn'},
120             \textcolor{stringliteral}{'--rnn-class'},
121             default=\textcolor{stringliteral}{'lstm'},
122             choices=Seq2seq.RNN\_OPTS.keys(),
123             help=\textcolor{stringliteral}{'Choose between different types of RNNs.'},
124         )
125         agent.add\_argument(
126             \textcolor{stringliteral}{'-dec'},
127             \textcolor{stringliteral}{'--decoder'},
128             default=\textcolor{stringliteral}{'same'},
129             choices=[\textcolor{stringliteral}{'same'}, \textcolor{stringliteral}{'shared'}],
130             help=\textcolor{stringliteral}{'Choose between different decoder modules. '}
131             \textcolor{stringliteral}{'Default "same" uses same class as encoder, '}
132             \textcolor{stringliteral}{'while "shared" also uses the same weights. '}
133             \textcolor{stringliteral}{'Note that shared disabled some encoder '}
134             \textcolor{stringliteral}{'options--in particular, bidirectionality.'},
135         )
136         agent.add\_argument(
137             \textcolor{stringliteral}{'-lt'},
138             \textcolor{stringliteral}{'--lookuptable'},
139             default=\textcolor{stringliteral}{'unique'},
140             choices=[\textcolor{stringliteral}{'unique'}, \textcolor{stringliteral}{'enc\_dec'}, \textcolor{stringliteral}{'dec\_out'}, \textcolor{stringliteral}{'all'}],
141             help=\textcolor{stringliteral}{'The encoder, decoder, and output modules can '}
142             \textcolor{stringliteral}{'share weights, or not. '}
143             \textcolor{stringliteral}{'Unique has independent embeddings for each. '}
144             \textcolor{stringliteral}{'Enc\_dec shares the embedding for the encoder '}
145             \textcolor{stringliteral}{'and decoder. '}
146             \textcolor{stringliteral}{'Dec\_out shares decoder embedding and output '}
147             \textcolor{stringliteral}{'weights. '}
148             \textcolor{stringliteral}{'All shares all three weights.'},
149         )
150         agent.add\_argument(
151             \textcolor{stringliteral}{'-soft'},
152             \textcolor{stringliteral}{'--numsoftmax'},
153             default=1,
154             type=int,
155             help=\textcolor{stringliteral}{'default 1, if greater then uses mixture of '}
156             \textcolor{stringliteral}{'softmax (see arxiv.org/abs/1711.03953).'},
157         )
158         agent.add\_argument(
159             \textcolor{stringliteral}{'--beam-size'},
160             type=int,
161             default=1,
162             help=\textcolor{stringliteral}{'Beam size, if 1 then greedy search'},
163         )
164         agent.add\_argument(
165             \textcolor{stringliteral}{'--beam-dot-log'},
166             type=\textcolor{stringliteral}{'bool'},
167             default=\textcolor{keyword}{False},
168             help=\textcolor{stringliteral}{'Dump beam trees as png dot images into /tmp folder'},
169         )
170         agent.add\_argument(
171             \textcolor{stringliteral}{'--beam-min-n-best'},
172             type=int,
173             default=3,
174             help=\textcolor{stringliteral}{'Minimum number of nbest candidates to achieve '}
175             \textcolor{stringliteral}{'during the beam search'},
176         )
177         agent.add\_argument(
178             \textcolor{stringliteral}{'--beam-min-length'},
179             type=int,
180             default=3,
181             help=\textcolor{stringliteral}{'Minimum length of prediction to be generated by '} \textcolor{stringliteral}{'the beam search'},
182         )
183         agent.add\_argument(
184             \textcolor{stringliteral}{'-idr'},
185             \textcolor{stringliteral}{'--input-dropout'},
186             type=float,
187             default=0.0,
188             help=\textcolor{stringliteral}{'Each token from the input will be masked with'}
189             \textcolor{stringliteral}{' \_\_unk\_\_ token with this probability.'},
190         )
191         agent.add\_argument(
192             \textcolor{stringliteral}{'--beam-block-ngram'},
193             type=int,
194             default=0,
195             help=\textcolor{stringliteral}{'Block all repeating ngrams up to history length n-1'},
196         )
197         agent.add\_argument(
198             \textcolor{stringliteral}{'-cv'},
199             \textcolor{stringliteral}{'--control-vars'},
200             type=str,
201             default=\textcolor{stringliteral}{''},
202             help=\textcolor{stringliteral}{'Comma-separated list of control variables to use'},
203         )
204         agent.add\_argument(
205             \textcolor{stringliteral}{'-cnb'},
206             \textcolor{stringliteral}{'--control-num-buckets'},
207             type=str,
208             default=\textcolor{stringliteral}{''},
209             help=\textcolor{stringliteral}{'Number of buckets for each of the control variables'},
210         )
211         agent.add\_argument(
212             \textcolor{stringliteral}{'-cesz'},
213             \textcolor{stringliteral}{'--control-embeddingsize'},
214             type=str,
215             default=\textcolor{stringliteral}{''},
216             help=\textcolor{stringliteral}{'Sizes for the control variable embeddings'},
217         )
218         agent.add\_argument(
219             \textcolor{stringliteral}{'--add-control'},
220             type=\textcolor{stringliteral}{'bool'},
221             default=\textcolor{keyword}{False},
222             help=\textcolor{stringliteral}{'If True, takes an existing saved model, adds necessary'}
223             \textcolor{stringliteral}{'parameters for new CT controls, and saves in a new model '}
224             \textcolor{stringliteral}{'file'},
225         )
226         agent.add\_argument(
227             \textcolor{stringliteral}{'--set-controls'},
228             type=str,
229             default=\textcolor{stringliteral}{''},
230             help=\textcolor{stringliteral}{'Specify fixed settings for CT control variables. '}
231             \textcolor{stringliteral}{'For example, avg\_niwf:6'},
232         )
233         agent.add\_argument(
234             \textcolor{stringliteral}{'--beam-reorder'},
235             default=\textcolor{stringliteral}{'none'},
236             choices=[\textcolor{stringliteral}{'none'}, \textcolor{stringliteral}{'best\_extrep2gram\_qn'}],
237             help=\textcolor{stringliteral}{'Choices: none, best\_extrep2gram\_qn.'}
238             \textcolor{stringliteral}{'Apply the specified function for reordering the '}
239             \textcolor{stringliteral}{'n-best beam search candidates. '}
240             \textcolor{stringliteral}{'If best\_extrep2gram\_qn, then pick candidate which '}
241             \textcolor{stringliteral}{'contains question mark and has lowest extrep\_2gram'},
242         )
243         agent.add\_argument(
244             \textcolor{stringliteral}{'-wd'},
245             \textcolor{stringliteral}{'--weighted-decoding'},
246             type=str,
247             default=\textcolor{stringliteral}{''},
248             help=\textcolor{stringliteral}{'List of WD features and their corresponding weights '}
249             \textcolor{stringliteral}{'For example, intrep\_word:-1,extrep\_2gram:-1,nidf:3'},
250         )
251         agent.add\_argument(
252             \textcolor{stringliteral}{'--verbose'},
253             type=\textcolor{stringliteral}{'bool'},
254             default=\textcolor{keyword}{False},
255             help=\textcolor{stringliteral}{'If true, print out beam search info'},
256         )
257         TorchAgent.add\_cmdline\_args(argparser)
258         ControllableSeq2seqAgent.dictionary\_class().\hyperlink{namespaceparlai_1_1agents_1_1drqa_1_1config_a62fdd5554f1da6be0cba185271058320}{add\_cmdline\_args}(argparser)
259         \textcolor{keywordflow}{return} agent
260 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a9d31c040b479d9cfeaeecc19a98985ee}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a9d31c040b479d9cfeaeecc19a98985ee}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!batchify@{batchify}}
\index{batchify@{batchify}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{batchify()}{batchify()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+batchify (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{args,  }\item[{}]{kwargs }\end{DoxyParamCaption})}

\begin{DoxyVerb}Override batchify options for seq2seq.
\end{DoxyVerb}
 

Definition at line 652 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
652     \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1agents_1_1drqa_1_1utils_aca22dd97c5b6dcda2a7479c1cb22ef1e}{batchify}(self, *args, **kwargs):
653         \textcolor{stringliteral}{"""}
654 \textcolor{stringliteral}{        Override batchify options for seq2seq.}
655 \textcolor{stringliteral}{        """}
656         kwargs[\textcolor{stringliteral}{'sort'}] = \textcolor{keyword}{True}  \textcolor{comment}{# need sorted for pack\_padded}
657         batch = super().\hyperlink{namespaceparlai_1_1agents_1_1drqa_1_1utils_aca22dd97c5b6dcda2a7479c1cb22ef1e}{batchify}(*args, **kwargs)
658 
659         \textcolor{comment}{# Get some args needed for batchify}
660         obs\_batch = args[0]
661         sort = kwargs[\textcolor{stringliteral}{'sort'}]
662         is\_valid = (
663             \textcolor{keyword}{lambda} obs: \textcolor{stringliteral}{'text\_vec'} \textcolor{keywordflow}{in} obs \textcolor{keywordflow}{or} \textcolor{stringliteral}{'image'} \textcolor{keywordflow}{in} obs
664         )  \textcolor{comment}{# from TorchAgent.batchify}
665 
666         \textcolor{comment}{# Run this part of TorchAgent's batchify to get exs in correct order}
667 
668         \textcolor{comment}{# ==================== START COPIED FROM TORCHAGENT ===================}
669         \textcolor{keywordflow}{if} len(obs\_batch) == 0:
670             \textcolor{keywordflow}{return} \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1torch__agent__v1_a74cfde390a2b9861179ac0fcd59da28c}{Batch}()
671 
672         valid\_obs = [(i, ex) \textcolor{keywordflow}{for} i, ex \textcolor{keywordflow}{in} enumerate(obs\_batch) \textcolor{keywordflow}{if} is\_valid(ex)]
673 
674         \textcolor{keywordflow}{if} len(valid\_obs) == 0:
675             \textcolor{keywordflow}{return} \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1torch__agent__v1_a74cfde390a2b9861179ac0fcd59da28c}{Batch}()
676 
677         valid\_inds, exs = zip(*valid\_obs)
678 
679         \textcolor{comment}{# TEXT}
680         xs, x\_lens = \textcolor{keywordtype}{None}, \textcolor{keywordtype}{None}
681         \textcolor{keywordflow}{if} any(\textcolor{stringliteral}{'text\_vec'} \textcolor{keywordflow}{in} ex \textcolor{keywordflow}{for} ex \textcolor{keywordflow}{in} exs):
682             \_xs = [ex.get(\textcolor{stringliteral}{'text\_vec'}, self.EMPTY) \textcolor{keywordflow}{for} ex \textcolor{keywordflow}{in} exs]
683             xs, x\_lens = \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1utils__v1_adb5a414ae439f14c54e8c760b91cc4c8}{padded\_tensor}(\_xs, self.NULL\_IDX, self.use\_cuda)
684             \textcolor{keywordflow}{if} sort:
685                 sort = \textcolor{keyword}{False}  \textcolor{comment}{# now we won't sort on labels}
686                 xs, x\_lens, valid\_inds, exs = \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1utils__v1_a1521e559b740f741ebb47b8755202bb2}{argsort}(
687                     x\_lens, xs, x\_lens, valid\_inds, exs, descending=\textcolor{keyword}{True}
688                 )
689 
690         \textcolor{comment}{# ======== END COPIED FROM TORCHAGENT ========}
691 
692         \textcolor{comment}{# Add history to the batch}
693         history = [ConvAI2History(ex[\textcolor{stringliteral}{'full\_text'}], dictionary=self.dict) \textcolor{keywordflow}{for} ex \textcolor{keywordflow}{in} exs]
694 
695         \textcolor{comment}{# Add CT control vars to batch}
696         ctrl\_vec = \hyperlink{namespaceprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controls_a3057eb90e6aeff3fbf2c89c7e003aea0}{get\_ctrl\_vec}(exs, history, self.control\_settings)  \textcolor{comment}{# tensor or None}
697         \textcolor{keywordflow}{if} self.use\_cuda \textcolor{keywordflow}{and} ctrl\_vec \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
698             ctrl\_vec = ctrl\_vec.cuda()
699 
700         \textcolor{comment}{# Replace the old namedtuple with a new one that includes ctrl\_vec and history}
701         ControlBatch = namedtuple(
702             \textcolor{stringliteral}{'Batch'}, tuple(batch.keys()) + (\textcolor{stringliteral}{'ctrl\_vec'}, \textcolor{stringliteral}{'history'})
703         )
704         batch = ControlBatch(ctrl\_vec=ctrl\_vec, history=history, **dict(batch))
705 
706         \textcolor{keywordflow}{return} batch
707 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_aabb638a2dd4fd89320f1904d5b0579f1}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_aabb638a2dd4fd89320f1904d5b0579f1}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!beam\+\_\+search@{beam\+\_\+search}}
\index{beam\+\_\+search@{beam\+\_\+search}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{beam\+\_\+search()}{beam\_search()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+beam\+\_\+search (\begin{DoxyParamCaption}\item[{}]{model,  }\item[{}]{batch,  }\item[{}]{beam\+\_\+size,  }\item[{}]{dictionary,  }\item[{}]{start = {\ttfamily 1},  }\item[{}]{end = {\ttfamily 2},  }\item[{}]{pad = {\ttfamily 0},  }\item[{}]{min\+\_\+length = {\ttfamily 3},  }\item[{}]{min\+\_\+n\+\_\+best = {\ttfamily 5},  }\item[{}]{max\+\_\+ts = {\ttfamily 40},  }\item[{}]{block\+\_\+ngram = {\ttfamily 0},  }\item[{}]{wd\+\_\+features = {\ttfamily None},  }\item[{}]{wd\+\_\+wts = {\ttfamily None} }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}

\begin{DoxyVerb}Beam search given the model and Batch.

This function uses model with the following reqs:

- model.encoder takes input returns tuple (enc_out, enc_hidden, attn_mask)
- model.decoder takes decoder params and returns decoder outputs after attn
- model.output takes decoder outputs and returns distr over dictionary

:param model: nn.Module, here defined in modules.py
:param batch: Batch structure with input and labels
:param beam_size: Size of each beam during the search
:param start: start of sequence token
:param end: end of sequence token
:param pad: padding token
:param min_length: minimum length of the decoded sequence
:param min_n_best: minimum number of completed hypothesis generated
    from each beam
:param max_ts: the maximum length of the decoded sequence
:param wd_features: list of strings, the WD features to use
:param wd_weights: list of floats, the WD weights to use

:return:
    - beam_preds_scores : list of tuples (prediction, score) for each
      sample in Batch
    - n_best_preds_scores : list of n_best list of tuples (prediction,
      score) for each sample from Batch
    - beams : list of Beam instances defined in Beam class, can be used
      for any following postprocessing, e.g. dot logging.
\end{DoxyVerb}
 

Definition at line 839 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
839     ):
840         \textcolor{stringliteral}{"""}
841 \textcolor{stringliteral}{        Beam search given the model and Batch.}
842 \textcolor{stringliteral}{}
843 \textcolor{stringliteral}{        This function uses model with the following reqs:}
844 \textcolor{stringliteral}{}
845 \textcolor{stringliteral}{        - model.encoder takes input returns tuple (enc\_out, enc\_hidden, attn\_mask)}
846 \textcolor{stringliteral}{        - model.decoder takes decoder params and returns decoder outputs after attn}
847 \textcolor{stringliteral}{        - model.output takes decoder outputs and returns distr over dictionary}
848 \textcolor{stringliteral}{}
849 \textcolor{stringliteral}{        :param model: nn.Module, here defined in modules.py}
850 \textcolor{stringliteral}{        :param batch: Batch structure with input and labels}
851 \textcolor{stringliteral}{        :param beam\_size: Size of each beam during the search}
852 \textcolor{stringliteral}{        :param start: start of sequence token}
853 \textcolor{stringliteral}{        :param end: end of sequence token}
854 \textcolor{stringliteral}{        :param pad: padding token}
855 \textcolor{stringliteral}{        :param min\_length: minimum length of the decoded sequence}
856 \textcolor{stringliteral}{        :param min\_n\_best: minimum number of completed hypothesis generated}
857 \textcolor{stringliteral}{            from each beam}
858 \textcolor{stringliteral}{        :param max\_ts: the maximum length of the decoded sequence}
859 \textcolor{stringliteral}{        :param wd\_features: list of strings, the WD features to use}
860 \textcolor{stringliteral}{        :param wd\_weights: list of floats, the WD weights to use}
861 \textcolor{stringliteral}{}
862 \textcolor{stringliteral}{        :return:}
863 \textcolor{stringliteral}{            - beam\_preds\_scores : list of tuples (prediction, score) for each}
864 \textcolor{stringliteral}{              sample in Batch}
865 \textcolor{stringliteral}{            - n\_best\_preds\_scores : list of n\_best list of tuples (prediction,}
866 \textcolor{stringliteral}{              score) for each sample from Batch}
867 \textcolor{stringliteral}{            - beams : list of Beam instances defined in Beam class, can be used}
868 \textcolor{stringliteral}{              for any following postprocessing, e.g. dot logging.}
869 \textcolor{stringliteral}{        """}
870         \textcolor{keywordflow}{if} wd\_features \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
871             wd\_features = []
872         \textcolor{keywordflow}{if} wd\_wts \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
873             wd\_wts = []
874         encoder\_states = model.encoder(batch.text\_vec)
875         enc\_out = encoder\_states[0]
876         enc\_hidden = encoder\_states[1]
877         attn\_mask = encoder\_states[2]
878         current\_device = encoder\_states[0][0].device
879         vocab\_size = len(dictionary)
880 
881         batch\_size = len(batch.text\_lengths)
882         beams = [
883             Beam(
884                 beam\_size,
885                 min\_length=min\_length,
886                 padding\_token=pad,
887                 bos\_token=start,
888                 eos\_token=end,
889                 min\_n\_best=min\_n\_best,
890                 cuda=current\_device,
891                 block\_ngram=block\_ngram,
892             )
893             \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(batch\_size)
894         ]
895         decoder\_input = (
896             torch.Tensor([start])
897             .detach()
898             .expand(batch\_size, 1)
899             .long()
900             .to(current\_device)
901         )
902         \textcolor{comment}{# repeat encoder\_outputs, hiddens, attn\_mask}
903         decoder\_input = decoder\_input.repeat(1, beam\_size).view(
904             beam\_size * batch\_size, -1
905         )
906 
907         \textcolor{comment}{# ctrl\_input is shape (bsz, num\_controls)}
908         \textcolor{comment}{# we want it to be (bsz*beam\_size, num\_controls)}
909         ctrl\_input = batch.ctrl\_vec
910         \textcolor{keywordflow}{if} batch.ctrl\_vec \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
911             ctrl\_input = batch.ctrl\_vec.repeat(beam\_size, 1)
912 
913         enc\_out = (
914             enc\_out.unsqueeze(1)
915             .\hyperlink{namespacerepeat}{repeat}(1, beam\_size, 1, 1)
916             .view(batch\_size * beam\_size, -1, enc\_out.size(-1))
917         )
918         attn\_mask = (
919             encoder\_states[2]
920             .\hyperlink{namespacerepeat}{repeat}(1, beam\_size)
921             .view(attn\_mask.size(0) * beam\_size, -1)
922         )
923         repeated\_hiddens = []
924         \textcolor{keywordflow}{if} isinstance(enc\_hidden, tuple):  \textcolor{comment}{# LSTM}
925             \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(len(enc\_hidden)):
926                 repeated\_hiddens.append(
927                     enc\_hidden[i].unsqueeze(2).\hyperlink{namespacerepeat}{repeat}(1, 1, beam\_size, 1)
928                 )
929             num\_layers = enc\_hidden[0].size(0)
930             hidden\_size = enc\_hidden[0].size(-1)
931             enc\_hidden = tuple(
932                 [
933                     repeated\_hiddens[i].view(
934                         num\_layers, batch\_size * beam\_size, hidden\_size
935                     )
936                     \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(len(repeated\_hiddens))
937                 ]
938             )
939         \textcolor{keywordflow}{else}:  \textcolor{comment}{# GRU}
940             num\_layers = enc\_hidden.size(0)
941             hidden\_size = enc\_hidden.size(-1)
942             enc\_hidden = (
943                 enc\_hidden.unsqueeze(2)
944                 .\hyperlink{namespacerepeat}{repeat}(1, 1, beam\_size, 1)
945                 .view(num\_layers, batch\_size * beam\_size, hidden\_size)
946             )
947 
948         hidden = enc\_hidden
949         \textcolor{keywordflow}{for} ts \textcolor{keywordflow}{in} range(max\_ts):
950             \textcolor{keywordflow}{if} all((b.done() \textcolor{keywordflow}{for} b \textcolor{keywordflow}{in} beams)):
951                 \textcolor{keywordflow}{break}
952             output, hidden = model.decoder(
953                 decoder\_input, ctrl\_input, hidden, (enc\_out, attn\_mask)
954             )
955             score = model.output(output)
956             \textcolor{comment}{# score contains softmax scores for batch\_size * beam\_size samples}
957             score = score.view(batch\_size, beam\_size, -1)
958             score = F.log\_softmax(score, dim=-1)
959             \textcolor{keywordflow}{for} i, b \textcolor{keywordflow}{in} enumerate(beams):
960                 \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} b.done():
961                     scores\_in = score[i]
962 
963                     \textcolor{comment}{# If using WD, update scores\_in to reflect the WD features}
964                     \textcolor{keywordflow}{if} len(wd\_features) > 0:
965 
966                         \textcolor{comment}{# Obtain wd\_feat\_vecs, the sum of the weighted features}
967                         \textcolor{comment}{# across the whole vocabulary}
968                         wd\_feat\_vecs = torch.zeros((beam\_size, vocab\_size))
969                         \textcolor{keywordflow}{for} hyp\_idx \textcolor{keywordflow}{in} range(beam\_size):  \textcolor{comment}{# For each hypothesis}
970 
971                             \textcolor{comment}{# Get the partial hypothesis (None if first timestep)}
972                             partial\_hyp = b.partial\_hyps[hyp\_idx] \textcolor{keywordflow}{if} ts > 0 \textcolor{keywordflow}{else} \textcolor{keywordtype}{None}
973 
974                             \textcolor{comment}{# Get the WD feature vector (a tensor) for this hypothesis}
975                             wd\_feat\_vec = \hyperlink{namespaceprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controls_a0324491b8ecb07aaf415e47d6575cbac}{get\_wd\_features}(
976                                 dictionary,
977                                 partial\_hyp,
978                                 batch.history[i],
979                                 wd\_features,
980                                 wd\_wts,
981                             )  \textcolor{comment}{# shape (vocab\_size)}
982 
983                             wd\_feat\_vecs[hyp\_idx, :] = wd\_feat\_vec
984                         wd\_feat\_vecs = wd\_feat\_vecs.to(current\_device)
985 
986                         \textcolor{comment}{# Add the WD features to the log probability scores}
987                         scores\_in = scores\_in + wd\_feat\_vecs
988 
989                     \textcolor{comment}{# Update the beam as usual}
990                     b.advance(scores\_in)
991 
992             decoder\_input = torch.cat(
993                 [b.get\_output\_from\_current\_step() \textcolor{keywordflow}{for} b \textcolor{keywordflow}{in} beams]
994             ).unsqueeze(-1)
995             permute\_hidden\_idx = torch.cat(
996                 [
997                     beam\_size * i + b.get\_backtrack\_from\_current\_step()
998                     \textcolor{keywordflow}{for} i, b \textcolor{keywordflow}{in} enumerate(beams)
999                 ]
1000             )
1001             \textcolor{comment}{# permute decoder hiddens with respect to chosen hypothesis now}
1002             \textcolor{keywordflow}{if} isinstance(hidden, tuple):  \textcolor{comment}{# LSTM}
1003                 \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(len(hidden)):
1004                     hidden[i].data.copy\_(
1005                         hidden[i].data.index\_select(dim=1, index=permute\_hidden\_idx)
1006                     )
1007             \textcolor{keywordflow}{else}:  \textcolor{comment}{# GRU}
1008                 hidden.data.copy\_(
1009                     hidden.data.index\_select(dim=1, index=permute\_hidden\_idx)
1010                 )
1011         \textcolor{keywordflow}{for} b \textcolor{keywordflow}{in} beams:
1012             b.check\_finished()
1013 
1014         beam\_preds\_scores = [list(b.get\_top\_hyp()) \textcolor{keywordflow}{for} b \textcolor{keywordflow}{in} beams]
1015         \textcolor{keywordflow}{for} pair \textcolor{keywordflow}{in} beam\_preds\_scores:
1016             pair[0] = Beam.get\_pretty\_hypothesis(pair[0])
1017 
1018         n\_best\_beams = [b.get\_rescored\_finished(n\_best=min\_n\_best) \textcolor{keywordflow}{for} b \textcolor{keywordflow}{in} beams]
1019         n\_best\_beam\_preds\_scores = []
1020         \textcolor{keywordflow}{for} i, beamhyp \textcolor{keywordflow}{in} enumerate(n\_best\_beams):
1021             this\_beam = []
1022             \textcolor{keywordflow}{for} hyp \textcolor{keywordflow}{in} beamhyp:
1023                 pred = beams[i].get\_pretty\_hypothesis(
1024                     beams[i].get\_hyp\_from\_finished(hyp)
1025                 )
1026                 score = hyp.score
1027                 this\_beam.append((pred, score))
1028             n\_best\_beam\_preds\_scores.append(this\_beam)
1029 
1030         \textcolor{keywordflow}{return} beam\_preds\_scores, n\_best\_beam\_preds\_scores, beams
1031 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a4cecd20886ef127bbab1a756bb49fb75}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a4cecd20886ef127bbab1a756bb49fb75}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!build\+\_\+model@{build\+\_\+model}}
\index{build\+\_\+model@{build\+\_\+model}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{build\+\_\+model()}{build\_model()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+build\+\_\+model (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{states = {\ttfamily None} }\end{DoxyParamCaption})}

\begin{DoxyVerb}Initialize model, override to change model setup.
\end{DoxyVerb}
 

Definition at line 397 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
397     \textcolor{keyword}{def }build\_model(self, states=None):
398         \textcolor{stringliteral}{"""}
399 \textcolor{stringliteral}{        Initialize model, override to change model setup.}
400 \textcolor{stringliteral}{        """}
401         opt = self.opt
402 
403         kwargs = \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1modules__v1_af13e3733abb5828b0c0a75d95833441c}{opt\_to\_kwargs}(opt)
404         model = Seq2seq(
405             len(self.dict),
406             opt[\textcolor{stringliteral}{'embeddingsize'}],
407             opt[\textcolor{stringliteral}{'hiddensize'}],
408             padding\_idx=self.NULL\_IDX,
409             start\_idx=self.START\_IDX,
410             unknown\_idx=self.dict[self.dict.unk\_token],
411             longest\_label=states.get(\textcolor{stringliteral}{'longest\_label'}, 1),
412             control\_settings=self.control\_settings,
413             **kwargs,
414         )
415 
416         \textcolor{keywordflow}{if} opt.get(\textcolor{stringliteral}{'dict\_tokenizer'}) == \textcolor{stringliteral}{'bpe'} \textcolor{keywordflow}{and} opt[\textcolor{stringliteral}{'embedding\_type'}] != \textcolor{stringliteral}{'random'}:
417             print(\textcolor{stringliteral}{'skipping preinitialization of embeddings for bpe'})
418         \textcolor{keywordflow}{elif} \textcolor{keywordflow}{not} states \textcolor{keywordflow}{and} opt[\textcolor{stringliteral}{'embedding\_type'}] != \textcolor{stringliteral}{'random'}:
419             \textcolor{comment}{# `not states`: only set up embeddings if not loading model}
420             self.\_copy\_embeddings(model.decoder.lt.weight, opt[\textcolor{stringliteral}{'embedding\_type'}])
421             \textcolor{keywordflow}{if} opt[\textcolor{stringliteral}{'lookuptable'}] \textcolor{keywordflow}{in} [\textcolor{stringliteral}{'unique'}, \textcolor{stringliteral}{'dec\_out'}]:
422                 \textcolor{comment}{# also set encoder lt, since it's not shared}
423                 self.\_copy\_embeddings(
424                     model.encoder.lt.weight, opt[\textcolor{stringliteral}{'embedding\_type'}], log=\textcolor{keyword}{False}
425                 )
426 
427         \textcolor{keywordflow}{if} states:
428             \textcolor{keywordflow}{if} self.opt[\textcolor{stringliteral}{'add\_control'}]:  \textcolor{comment}{# Add parameters for new CT controls}
429                 self.\_add\_control(states)
430 
431             \textcolor{comment}{# set loaded states if applicable}
432             model.load\_state\_dict(states[\textcolor{stringliteral}{'model'}])
433 
434         \textcolor{keywordflow}{if} opt[\textcolor{stringliteral}{'embedding\_type'}].endswith(\textcolor{stringliteral}{'fixed'}):
435             print(\textcolor{stringliteral}{'Seq2seq: fixing embedding weights.'})
436             model.decoder.lt.weight.requires\_grad = \textcolor{keyword}{False}
437             model.encoder.lt.weight.requires\_grad = \textcolor{keyword}{False}
438             \textcolor{keywordflow}{if} opt[\textcolor{stringliteral}{'lookuptable'}] \textcolor{keywordflow}{in} [\textcolor{stringliteral}{'dec\_out'}, \textcolor{stringliteral}{'all'}]:
439                 model.decoder.output.e2s.weight.requires\_grad = \textcolor{keyword}{False}
440 
441         \textcolor{keywordflow}{return} model
442 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a531943b5d1caee714bba77decbc93161}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a531943b5d1caee714bba77decbc93161}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!eval\+\_\+step@{eval\+\_\+step}}
\index{eval\+\_\+step@{eval\+\_\+step}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{eval\+\_\+step()}{eval\_step()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+eval\+\_\+step (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{batch }\end{DoxyParamCaption})}

\begin{DoxyVerb}Evaluate a single batch of examples.
\end{DoxyVerb}
 

Definition at line 1077 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
1077     \textcolor{keyword}{def }eval\_step(self, batch):
1078         \textcolor{stringliteral}{"""}
1079 \textcolor{stringliteral}{        Evaluate a single batch of examples.}
1080 \textcolor{stringliteral}{        """}
1081         \textcolor{keywordflow}{if} batch.text\_vec \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
1082             \textcolor{keywordflow}{return}
1083         orig\_batch = batch  \textcolor{comment}{# save for evaluation}
1084         needs\_truncation = self.multigpu \textcolor{keywordflow}{and} batch.text\_vec.size(0) % 2 != 0
1085         \textcolor{keywordflow}{if} needs\_truncation:
1086             \textcolor{comment}{# for multigpu, we need to split evenly across gpus}
1087             batch = self.extend\_input(batch)
1088         self.model.eval()
1089         cand\_scores = \textcolor{keywordtype}{None}
1090         \textcolor{keywordflow}{if} self.beam\_size == 1:
1091             out, cand\_params = self.greedy\_search(batch)
1092             \textcolor{keywordflow}{if} needs\_truncation:
1093                 out = self.truncate\_output(out)
1094                 \textcolor{keywordflow}{if} cand\_params[0] \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
1095                     cand\_params = (cand\_params[0][:-1], cand\_params[1][:-1])
1096             scores, cand\_scores = out[0], out[1]
1097             \_, preds = scores.max(2)
1098         \textcolor{keywordflow}{elif} self.beam\_size > 1:
1099             out = ControllableSeq2seqAgent.beam\_search(
1100                 self.model,
1101                 batch,
1102                 self.beam\_size,
1103                 self.dict,
1104                 start=self.START\_IDX,
1105                 end=self.END\_IDX,
1106                 pad=self.NULL\_IDX,
1107                 min\_length=self.beam\_min\_length,
1108                 min\_n\_best=self.beam\_min\_n\_best,
1109                 block\_ngram=self.beam\_block\_ngram,
1110                 wd\_features=self.wd\_features,
1111                 wd\_wts=self.wd\_wts,
1112             )
1113             \textcolor{keywordflow}{if} needs\_truncation:
1114                 out = self.truncate\_output(out)
1115             beam\_preds\_scores, n\_best\_preds\_scores, beams = out
1116 
1117             \textcolor{comment}{# Optionally print out the n-best beam search candidates}
1118             \textcolor{keywordflow}{if} self.opt[\textcolor{stringliteral}{'verbose'}]:
1119                 \textcolor{keywordflow}{for} cands, hist \textcolor{keywordflow}{in} zip(n\_best\_preds\_scores, batch.history):
1120                     \hyperlink{namespaceprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1util_ad8bee76107b49379c621746db6fd7d4e}{show\_beam\_cands}(cands, hist, self.dict)
1121 
1122             \textcolor{comment}{# If we have a special reordering function, apply it to choose the best}
1123             \textcolor{comment}{# one of the candidates.}
1124             \textcolor{keywordflow}{if} self.opt[\textcolor{stringliteral}{'beam\_reorder'}] == \textcolor{stringliteral}{'best\_extrep2gram\_qn'}:
1125                 beam\_preds\_scores = [
1126                     \hyperlink{namespaceprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1util_aa1ba917d170af0191d23b033358bc9eb}{reorder\_extrep2gram\_qn}(cands, hist, self.dict, self.opt[\textcolor{stringliteral}{'verbose'}
      ])
1127                     \textcolor{keywordflow}{for} cands, hist \textcolor{keywordflow}{in} zip(n\_best\_preds\_scores, batch.history)
1128                 ]
1129 
1130             preds, scores = (
1131                 [p[0] \textcolor{keywordflow}{for} p \textcolor{keywordflow}{in} beam\_preds\_scores],
1132                 [p[1] \textcolor{keywordflow}{for} p \textcolor{keywordflow}{in} beam\_preds\_scores],
1133             )
1134             \textcolor{keywordflow}{if} self.beam\_dot\_log \textcolor{keywordflow}{is} \textcolor{keyword}{True}:
1135                 \textcolor{keywordflow}{for} i, b \textcolor{keywordflow}{in} enumerate(beams):
1136                     dot\_graph = b.get\_beam\_dot(dictionary=self.dict, n\_best=3)
1137                     image\_name = (
1138                         self.\_v2t(batch.text\_vec[i, -20:])
1139                         .replace(\textcolor{stringliteral}{' '}, \textcolor{stringliteral}{'-'})
1140                         .replace(\textcolor{stringliteral}{'\_\_null\_\_'}, \textcolor{stringliteral}{''})
1141                     )
1142                     dot\_graph.write\_png(
1143                         os.path.join(self.beam\_dot\_dir, \textcolor{stringliteral}{"\{\}.png"}.\hyperlink{namespaceparlai_1_1chat__service_1_1services_1_1messenger_1_1shared__utils_a32e2e2022b824fbaf80c747160b52a76}{format}(image\_name))
1144                     )
1145 
1146         \textcolor{keywordflow}{if} batch.label\_vec \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
1147             \textcolor{comment}{# calculate loss on targets with teacher forcing}
1148             seq\_len = \textcolor{keywordtype}{None} \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} self.multigpu \textcolor{keywordflow}{else} batch.text\_vec.size(1)
1149             out = self.model(
1150                 batch.text\_vec, batch.ctrl\_vec, batch.label\_vec, seq\_len=seq\_len
1151             )
1152             \textcolor{keywordflow}{if} needs\_truncation:
1153                 out = self.truncate\_output(out)
1154             f\_scores = out[0]  \textcolor{comment}{# forced scores}
1155             \_, f\_preds = f\_scores.max(2)  \textcolor{comment}{# forced preds}
1156             score\_view = f\_scores.view(-1, f\_scores.size(-1))
1157             loss = self.criterion(score\_view, orig\_batch.label\_vec.view(-1))
1158             \textcolor{comment}{# save loss to metrics}
1159             notnull = orig\_batch.label\_vec.ne(self.NULL\_IDX)
1160             target\_tokens = notnull.long().sum().item()
1161             correct = ((orig\_batch.label\_vec == f\_preds) * notnull).sum().item()
1162             self.metrics[\textcolor{stringliteral}{'correct\_tokens'}] += correct
1163             self.metrics[\textcolor{stringliteral}{'loss'}] += loss.item()
1164             self.metrics[\textcolor{stringliteral}{'num\_tokens'}] += target\_tokens
1165 
1166         cand\_choices = \textcolor{keywordtype}{None}
1167         \textcolor{keywordflow}{if} cand\_scores \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
1168             cand\_preds = cand\_scores.sort(1, descending=\textcolor{keyword}{True})[1]
1169             \textcolor{comment}{# now select the text of the cands based on their scores}
1170             cand\_choices = self.\_pick\_cands(
1171                 cand\_preds, cand\_params[1], orig\_batch.candidates
1172             )
1173 
1174         text = [self.\_v2t(p) \textcolor{keywordflow}{for} p \textcolor{keywordflow}{in} preds]
1175 
1176         \textcolor{keywordflow}{return} \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1torch__agent__v1_a2689006ea97d09413fb242f984bd8016}{Output}(text, cand\_choices)
1177 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a836e91446f995a74cce113051991711a}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a836e91446f995a74cce113051991711a}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!extend\+\_\+input@{extend\+\_\+input}}
\index{extend\+\_\+input@{extend\+\_\+input}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{extend\+\_\+input()}{extend\_input()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+extend\+\_\+input (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{batch }\end{DoxyParamCaption})}

\begin{DoxyVerb}Extend the input.
\end{DoxyVerb}
 

Definition at line 1032 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
1032     \textcolor{keyword}{def }extend\_input(self, batch):
1033         \textcolor{stringliteral}{"""}
1034 \textcolor{stringliteral}{        Extend the input.}
1035 \textcolor{stringliteral}{        """}
1036         \textcolor{comment}{# add pad tensor to text vec}
1037         pad\_tensor = torch.zeros(1, batch.text\_vec.size(1)).long().cuda()
1038         text\_vec = torch.cat([batch.text\_vec, pad\_tensor], 0)
1039         batch = batch.\_replace(text\_vec=text\_vec)
1040         \textcolor{keywordflow}{if} batch.label\_vec \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
1041             \textcolor{comment}{# add pad tensor to label vec}
1042             pad\_tensor = torch.zeros(1, batch.label\_vec.size(1)).long().cuda()
1043             label\_vec = torch.cat([batch.label\_vec, pad\_tensor], 0)
1044             batch = batch.\_replace(label\_vec=label\_vec)
1045         \textcolor{keywordflow}{if} batch.candidates \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
1046             \textcolor{comment}{# add dummy candidates list}
1047             dummy\_list = [[\textcolor{stringliteral}{'None'}] \textcolor{keywordflow}{for} \_ \textcolor{keywordflow}{in} range(len(batch.candidates[0]))]
1048             batch = batch.\_replace(candidates=batch.candidates + [dummy\_list])
1049             \textcolor{comment}{# add pad tensor to candidate\_vecs}
1050             new\_vecs = batch.candidate\_vecs + [
1051                 [torch.zeros(1).long() \textcolor{keywordflow}{for} \_ \textcolor{keywordflow}{in} range(len(batch.candidate\_vecs[0]))]
1052             ]
1053             batch = batch.\_replace(candidate\_vecs=new\_vecs)
1054         \textcolor{keywordflow}{return} batch
1055 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ac416a9eb7ee7b0b1984468a4ec0b057c}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ac416a9eb7ee7b0b1984468a4ec0b057c}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!greedy\+\_\+search@{greedy\+\_\+search}}
\index{greedy\+\_\+search@{greedy\+\_\+search}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{greedy\+\_\+search()}{greedy\_search()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+greedy\+\_\+search (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{batch }\end{DoxyParamCaption})}

\begin{DoxyVerb}Perform greedy search.
\end{DoxyVerb}
 

Definition at line 809 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
809     \textcolor{keyword}{def }greedy\_search(self, batch):
810         \textcolor{stringliteral}{"""}
811 \textcolor{stringliteral}{        Perform greedy search.}
812 \textcolor{stringliteral}{        """}
813         cand\_params = self.\_build\_cands(batch)
814         seq\_len = \textcolor{keywordtype}{None} \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} self.multigpu \textcolor{keywordflow}{else} batch.text\_vec.size(1)
815         out = self.model(
816             batch.text\_vec,
817             batch.ctrl\_vec,
818             ys=\textcolor{keywordtype}{None},
819             cands=cand\_params[0],
820             seq\_len=seq\_len,
821         )
822         \textcolor{keywordflow}{return} out, cand\_params
823 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a938d6646b76eaf838ddcd54ee71aa5d9}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a938d6646b76eaf838ddcd54ee71aa5d9}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!load@{load}}
\index{load@{load}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{load()}{load()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+load (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{path }\end{DoxyParamCaption})}

\begin{DoxyVerb}Return opt and model states.
\end{DoxyVerb}
 

Definition at line 1200 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
1200     \textcolor{keyword}{def }load(self, path):
1201         \textcolor{stringliteral}{"""}
1202 \textcolor{stringliteral}{        Return opt and model states.}
1203 \textcolor{stringliteral}{        """}
1204         states = torch.load(path, map\_location=\textcolor{keyword}{lambda} cpu, \_: cpu)
1205 
1206         \textcolor{comment}{# check opt file for multigpu}
1207         with open(path + \textcolor{stringliteral}{".opt"}, \textcolor{stringliteral}{'r') as handle:}
1208 \textcolor{stringliteral}{            saved\_opt = json.load(handle)}
1209 \textcolor{stringliteral}{        }\textcolor{keywordflow}{if} saved\_opt.get(\textcolor{stringliteral}{'multigpu'}):
1210             \textcolor{comment}{# create new OrderedDict that does not contain `module.`}
1211             \textcolor{keyword}{from} collections \textcolor{keyword}{import} OrderedDict
1212 
1213             new\_state\_dict = OrderedDict()
1214             \textcolor{keywordflow}{for} k, v \textcolor{keywordflow}{in} states[\textcolor{stringliteral}{'model'}].items():
1215                 \textcolor{keywordflow}{if} k.startswith(\textcolor{stringliteral}{'module'}):
1216                     name = k[7:]  \textcolor{comment}{# remove `module.`}
1217                     new\_state\_dict[name] = v
1218             states[\textcolor{stringliteral}{'model'}] = new\_state\_dict
1219 
1220         \textcolor{keywordflow}{return} states
1221 
1222 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ab10efe928769fe5a7d398930e1d5174c}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ab10efe928769fe5a7d398930e1d5174c}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!model\+\_\+version@{model\+\_\+version}}
\index{model\+\_\+version@{model\+\_\+version}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{model\+\_\+version()}{model\_version()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+model\+\_\+version (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}

\begin{DoxyVerb}Return current version of this model, counting up from 0.

Models may not be backwards-compatible with older versions. Version 1 split from
version 0 on Aug 29, 2018. To use version 0, use --model legacy:seq2seq:0
(legacy agent code is located in parlai/agents/legacy_agents).
\end{DoxyVerb}
 

Definition at line 262 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
262     \textcolor{keyword}{def }model\_version():
263         \textcolor{stringliteral}{"""}
264 \textcolor{stringliteral}{        Return current version of this model, counting up from 0.}
265 \textcolor{stringliteral}{}
266 \textcolor{stringliteral}{        Models may not be backwards-compatible with older versions. Version 1 split from}
267 \textcolor{stringliteral}{        version 0 on Aug 29, 2018. To use version 0, use --model legacy:seq2seq:0}
268 \textcolor{stringliteral}{        (legacy agent code is located in parlai/agents/legacy\_agents).}
269 \textcolor{stringliteral}{        """}
270         \textcolor{keywordflow}{return} 1
271 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_aa976447be9a59cdba202d947bb5dafbb}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_aa976447be9a59cdba202d947bb5dafbb}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!report@{report}}
\index{report@{report}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{report()}{report()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+report (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Report loss and perplexity from model's perspective.

Note that this includes predicting __END__ and __UNK__ tokens and may differ
from a truly independent measurement.
\end{DoxyVerb}
 

Definition at line 600 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
600     \textcolor{keyword}{def }\hyperlink{namespaceprojects_1_1convai2_1_1eval__f1_a01a47b9c08dad189837a51f085defc45}{report}(self):
601         \textcolor{stringliteral}{"""}
602 \textcolor{stringliteral}{        Report loss and perplexity from model's perspective.}
603 \textcolor{stringliteral}{}
604 \textcolor{stringliteral}{        Note that this includes predicting \_\_END\_\_ and \_\_UNK\_\_ tokens and may differ}
605 \textcolor{stringliteral}{        from a truly independent measurement.}
606 \textcolor{stringliteral}{        """}
607         m = \{\}
608         num\_tok = self.metrics[\textcolor{stringliteral}{'num\_tokens'}]
609         \textcolor{keywordflow}{if} num\_tok > 0:
610             \textcolor{keywordflow}{if} self.metrics[\textcolor{stringliteral}{'correct\_tokens'}] > 0:
611                 m[\textcolor{stringliteral}{'token\_acc'}] = self.metrics[\textcolor{stringliteral}{'correct\_tokens'}] / num\_tok
612             m[\textcolor{stringliteral}{'loss'}] = self.metrics[\textcolor{stringliteral}{'loss'}] / num\_tok
613             \textcolor{keywordflow}{try}:
614                 m[\textcolor{stringliteral}{'ppl'}] = math.exp(m[\textcolor{stringliteral}{'loss'}])
615             \textcolor{keywordflow}{except} OverflowError:
616                 m[\textcolor{stringliteral}{'ppl'}] = \hyperlink{namespaceprojects_1_1controllable__dialogue_1_1make__control__dataset_aa2b7207688c641dbc094ab44eca27113}{float}(\textcolor{stringliteral}{'inf'})
617         \textcolor{keywordflow}{if} self.metrics[\textcolor{stringliteral}{'total\_skipped\_batches'}] > 0:
618             m[\textcolor{stringliteral}{'total\_skipped\_batches'}] = self.metrics[\textcolor{stringliteral}{'total\_skipped\_batches'}]
619         \textcolor{keywordflow}{for} k, v \textcolor{keywordflow}{in} m.items():
620             \textcolor{comment}{# clean up: rounds to sigfigs and converts tensors to floats}
621             m[k] = \hyperlink{namespaceparlai_1_1agents_1_1legacy__agents_1_1seq2seq_1_1utils__v0_af377ec61bfc0423461e7b409ffc883b9}{round\_sigfigs}(v, 4)
622         \textcolor{keywordflow}{return} m
623 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a14bac616741ac0249f9c469db915ebd1}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a14bac616741ac0249f9c469db915ebd1}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!reset\+\_\+metrics@{reset\+\_\+metrics}}
\index{reset\+\_\+metrics@{reset\+\_\+metrics}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{reset\+\_\+metrics()}{reset\_metrics()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+reset\+\_\+metrics (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Reset metrics for reporting loss and perplexity.
\end{DoxyVerb}
 

Definition at line 591 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
591     \textcolor{keyword}{def }reset\_metrics(self):
592         \textcolor{stringliteral}{"""}
593 \textcolor{stringliteral}{        Reset metrics for reporting loss and perplexity.}
594 \textcolor{stringliteral}{        """}
595         super().reset\_metrics()
596         self.metrics[\textcolor{stringliteral}{'loss'}] = 0.0
597         self.metrics[\textcolor{stringliteral}{'num\_tokens'}] = 0
598         self.metrics[\textcolor{stringliteral}{'correct\_tokens'}] = 0
599 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ad219fac39e0fb97c881c65d1ddfc6c32}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ad219fac39e0fb97c881c65d1ddfc6c32}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!save@{save}}
\index{save@{save}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{save()}{save()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+save (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{path = {\ttfamily None} }\end{DoxyParamCaption})}

\begin{DoxyVerb}Save model parameters if model_file is set.
\end{DoxyVerb}
 

Definition at line 1178 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
1178     \textcolor{keyword}{def }save(self, path=None):
1179         \textcolor{stringliteral}{"""}
1180 \textcolor{stringliteral}{        Save model parameters if model\_file is set.}
1181 \textcolor{stringliteral}{        """}
1182         path = self.opt.get(\textcolor{stringliteral}{'model\_file'}, \textcolor{keywordtype}{None}) \textcolor{keywordflow}{if} path \textcolor{keywordflow}{is} \textcolor{keywordtype}{None} \textcolor{keywordflow}{else} path
1183 
1184         \textcolor{keywordflow}{if} path \textcolor{keywordflow}{and} hasattr(self, \textcolor{stringliteral}{'model'}):
1185             model = \{\}
1186             model[\textcolor{stringliteral}{'model'}] = self.model.state\_dict()
1187             model[\textcolor{stringliteral}{'longest\_label'}] = self.model.longest\_label
1188             model[\textcolor{stringliteral}{'optimizer'}] = self.optimizer.state\_dict()
1189             model[\textcolor{stringliteral}{'optimizer\_type'}] = self.opt[\textcolor{stringliteral}{'optimizer'}]
1190 
1191             with open(path, \textcolor{stringliteral}{'wb'}) \textcolor{keyword}{as} write:
1192                 torch.save(model, write)
1193 
1194             \textcolor{comment}{# save opt file}
1195             with open(path + \textcolor{stringliteral}{'.opt'}, \textcolor{stringliteral}{'w'}) \textcolor{keyword}{as} handle:
1196                 \textcolor{comment}{# save version string}
1197                 self.opt[\textcolor{stringliteral}{'model\_version'}] = self.model\_version()
1198                 json.dump(self.opt, handle)
1199 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ae9da32042638a1a69fe2911ad42d4d08}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ae9da32042638a1a69fe2911ad42d4d08}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!share@{share}}
\index{share@{share}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{share()}{share()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+share (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Share internal states between parent and child instances.
\end{DoxyVerb}
 

Definition at line 624 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
624     \textcolor{keyword}{def }share(self):
625         \textcolor{stringliteral}{"""}
626 \textcolor{stringliteral}{        Share internal states between parent and child instances.}
627 \textcolor{stringliteral}{        """}
628         shared = super().share()
629         shared[\textcolor{stringliteral}{'model'}] = self.model
630         \textcolor{keywordflow}{if} self.opt.get(\textcolor{stringliteral}{'numthreads'}, 1) > 1:
631             \textcolor{comment}{# we're doing hogwild so share the model too}
632             \textcolor{keywordflow}{if} isinstance(self.metrics, dict):
633                 \textcolor{comment}{# move metrics and model to shared memory}
634                 self.metrics = SharedTable(self.metrics)
635                 self.model.share\_memory()
636             shared[\textcolor{stringliteral}{'states'}] = \{  \textcolor{comment}{# don't share optimizer states}
637                 \textcolor{stringliteral}{'optimizer\_type'}: self.opt[\textcolor{stringliteral}{'optimizer'}]
638             \}
639         shared[\textcolor{stringliteral}{'metrics'}] = self.metrics  \textcolor{comment}{# do after numthreads check}
640         \textcolor{keywordflow}{if} self.beam\_dot\_log \textcolor{keywordflow}{is} \textcolor{keyword}{True}:
641             shared[\textcolor{stringliteral}{'beam\_dot\_dir'}] = self.beam\_dot\_dir
642         \textcolor{keywordflow}{return} shared
643 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a656ea2270ec3d407d67782754ead5f87}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a656ea2270ec3d407d67782754ead5f87}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!train\+\_\+step@{train\+\_\+step}}
\index{train\+\_\+step@{train\+\_\+step}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{train\+\_\+step()}{train\_step()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+train\+\_\+step (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{batch }\end{DoxyParamCaption})}

\begin{DoxyVerb}Train on a single batch of examples.
\end{DoxyVerb}
 

Definition at line 738 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
738     \textcolor{keyword}{def }train\_step(self, batch):
739         \textcolor{stringliteral}{"""}
740 \textcolor{stringliteral}{        Train on a single batch of examples.}
741 \textcolor{stringliteral}{        """}
742         batchsize = batch.text\_vec.size(0)
743         \textcolor{keywordflow}{if} self.multigpu \textcolor{keywordflow}{and} batchsize % 2 != 0:
744             \textcolor{comment}{# throw out one training example}
745             batch = self.truncate\_input(batch)
746         \textcolor{comment}{# helps with memory usage}
747         self.\_init\_cuda\_buffer(
748             self.model, self.criterion, batchsize, self.truncate \textcolor{keywordflow}{or} 180
749         )
750         self.model.\hyperlink{namespaceprojects_1_1mastering__the__dungeon_1_1mturk_1_1tasks_1_1MTD_1_1run_a36a5f4f6f9df0611a6818610518d2cf0}{train}()
751         self.zero\_grad()
752 
753         \textcolor{keywordflow}{try}:
754             seq\_len = \textcolor{keywordtype}{None} \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} self.multigpu \textcolor{keywordflow}{else} batch.text\_vec.size(1)
755             out = self.model(
756                 batch.text\_vec, batch.ctrl\_vec, batch.label\_vec, seq\_len=seq\_len
757             )
758 
759             \textcolor{comment}{# generated response}
760             scores = out[0]
761             \_, preds = scores.max(2)
762 
763             score\_view = scores.view(-1, scores.size(-1))
764             loss = self.criterion(score\_view, batch.label\_vec.view(-1))
765             \textcolor{comment}{# save loss to metrics}
766             notnull = batch.label\_vec.ne(self.NULL\_IDX)
767             target\_tokens = notnull.long().sum().item()
768             correct = ((batch.label\_vec == preds) * notnull).sum().item()
769             self.metrics[\textcolor{stringliteral}{'correct\_tokens'}] += correct
770             self.metrics[\textcolor{stringliteral}{'loss'}] += loss.item()
771             self.metrics[\textcolor{stringliteral}{'num\_tokens'}] += target\_tokens
772             loss /= target\_tokens  \textcolor{comment}{# average loss per token}
773             loss.backward()
774             self.update\_params()
775         \textcolor{keywordflow}{except} RuntimeError \textcolor{keyword}{as} e:
776             \textcolor{comment}{# catch out of memory exceptions during fwd/bck (skip batch)}
777             \textcolor{keywordflow}{if} \textcolor{stringliteral}{'out of memory'} \textcolor{keywordflow}{in} \hyperlink{namespacegenerate__task__READMEs_a5b88452ffb87b78c8c85ececebafc09f}{str}(e):
778                 print(
779                     \textcolor{stringliteral}{'| WARNING: ran out of memory, skipping batch. '}
780                     \textcolor{stringliteral}{'if this happens frequently, decrease batchsize or '}
781                     \textcolor{stringliteral}{'truncate the inputs to the model.'}
782                 )
783                 self.metrics[\textcolor{stringliteral}{'total\_skipped\_batches'}] += 1
784             \textcolor{keywordflow}{else}:
785                 \textcolor{keywordflow}{raise} e
786 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ab3039a805f06b601cb1116702cbca7c2}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ab3039a805f06b601cb1116702cbca7c2}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!truncate\+\_\+input@{truncate\+\_\+input}}
\index{truncate\+\_\+input@{truncate\+\_\+input}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{truncate\+\_\+input()}{truncate\_input()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+truncate\+\_\+input (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{batch }\end{DoxyParamCaption})}

\begin{DoxyVerb}Truncate the input.
\end{DoxyVerb}
 

Definition at line 1056 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
1056     \textcolor{keyword}{def }truncate\_input(self, batch):
1057         \textcolor{stringliteral}{"""}
1058 \textcolor{stringliteral}{        Truncate the input.}
1059 \textcolor{stringliteral}{        """}
1060         \textcolor{comment}{# truncate batch for multigpu}
1061         text\_vec = batch.text\_vec[:-1]
1062         batch = batch.\_replace(text\_vec=text\_vec)
1063         \textcolor{keywordflow}{if} batch.label\_vec \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
1064             label\_vec = batch.label\_vec[:-1]
1065             batch = batch.\_replace(label\_vec=label\_vec)
1066         \textcolor{keywordflow}{return} batch
1067 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a4b656f8d8634a71088b3cb9e719f3629}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a4b656f8d8634a71088b3cb9e719f3629}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!truncate\+\_\+output@{truncate\+\_\+output}}
\index{truncate\+\_\+output@{truncate\+\_\+output}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{truncate\+\_\+output()}{truncate\_output()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+truncate\+\_\+output (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{out }\end{DoxyParamCaption})}

\begin{DoxyVerb}Truncate the output.
\end{DoxyVerb}
 

Definition at line 1068 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
1068     \textcolor{keyword}{def }truncate\_output(self, out):
1069         \textcolor{stringliteral}{"""}
1070 \textcolor{stringliteral}{        Truncate the output.}
1071 \textcolor{stringliteral}{        """}
1072         new\_out\_0 = out[0][:-1]
1073         new\_out\_1 = \textcolor{keywordtype}{None} \textcolor{keywordflow}{if} out[1] \textcolor{keywordflow}{is} \textcolor{keywordtype}{None} \textcolor{keywordflow}{else} out[1][:-1]
1074         new\_out\_2 = [vec[:-1] \textcolor{keywordflow}{for} vec \textcolor{keywordflow}{in} out[2]]
1075         \textcolor{keywordflow}{return} tuple([new\_out\_0, new\_out\_1, new\_out\_2])
1076 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a9d5a1ac61fa3ebf363a8b15106a7e08b}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a9d5a1ac61fa3ebf363a8b15106a7e08b}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!update\+\_\+params@{update\+\_\+params}}
\index{update\+\_\+params@{update\+\_\+params}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{update\+\_\+params()}{update\_params()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+update\+\_\+params (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Do one optimization step.
\end{DoxyVerb}
 

Definition at line 581 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
581     \textcolor{keyword}{def }update\_params(self):
582         \textcolor{stringliteral}{"""}
583 \textcolor{stringliteral}{        Do one optimization step.}
584 \textcolor{stringliteral}{        """}
585         \textcolor{keywordflow}{if} self.opt[\textcolor{stringliteral}{'gradient\_clip'}] > 0:
586             torch.nn.utils.clip\_grad\_norm\_(
587                 self.model.parameters(), self.opt[\textcolor{stringliteral}{'gradient\_clip'}]
588             )
589         self.optimizer.step()
590 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_aae1b61b5d838205753a872e34e0c8c34}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_aae1b61b5d838205753a872e34e0c8c34}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!vectorize@{vectorize}}
\index{vectorize@{vectorize}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{vectorize()}{vectorize()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+vectorize (\begin{DoxyParamCaption}\item[{}]{self,  }\item[{}]{args,  }\item[{}]{kwargs }\end{DoxyParamCaption})}

\begin{DoxyVerb}Override vectorize for seq2seq.
\end{DoxyVerb}
 

Definition at line 644 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
644     \textcolor{keyword}{def }\hyperlink{namespaceparlai_1_1agents_1_1drqa_1_1utils_a5c76cc39e3014c7bcf9199d566dbdc0f}{vectorize}(self, *args, **kwargs):
645         \textcolor{stringliteral}{"""}
646 \textcolor{stringliteral}{        Override vectorize for seq2seq.}
647 \textcolor{stringliteral}{        """}
648         kwargs[\textcolor{stringliteral}{'add\_start'}] = \textcolor{keyword}{False}  \textcolor{comment}{# model does this in module code}
649         kwargs[\textcolor{stringliteral}{'add\_end'}] = \textcolor{keyword}{True}  \textcolor{comment}{# we do want this}
650         \textcolor{keywordflow}{return} super().\hyperlink{namespaceparlai_1_1agents_1_1drqa_1_1utils_a5c76cc39e3014c7bcf9199d566dbdc0f}{vectorize}(*args, **kwargs)
651 
\end{DoxyCode}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a72b442a0dfa9d106f7a82624823cb73e}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a72b442a0dfa9d106f7a82624823cb73e}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!zero\+\_\+grad@{zero\+\_\+grad}}
\index{zero\+\_\+grad@{zero\+\_\+grad}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{zero\+\_\+grad()}{zero\_grad()}}
{\footnotesize\ttfamily def projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+zero\+\_\+grad (\begin{DoxyParamCaption}\item[{}]{self }\end{DoxyParamCaption})}

\begin{DoxyVerb}Zero out optimizer.
\end{DoxyVerb}
 

Definition at line 575 of file controllable\+\_\+seq2seq.\+py.


\begin{DoxyCode}
575     \textcolor{keyword}{def }zero\_grad(self):
576         \textcolor{stringliteral}{"""}
577 \textcolor{stringliteral}{        Zero out optimizer.}
578 \textcolor{stringliteral}{        """}
579         self.optimizer.zero\_grad()
580 
\end{DoxyCode}


\subsection{Member Data Documentation}
\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ac1510ceaeecddc8d1b612e79e5125fd0}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ac1510ceaeecddc8d1b612e79e5125fd0}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!beam\+\_\+block\+\_\+ngram@{beam\+\_\+block\+\_\+ngram}}
\index{beam\+\_\+block\+\_\+ngram@{beam\+\_\+block\+\_\+ngram}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{beam\+\_\+block\+\_\+ngram}{beam\_block\_ngram}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+beam\+\_\+block\+\_\+ngram}



Definition at line 307 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a5979974bea74f03b178f1e060c068f7e}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a5979974bea74f03b178f1e060c068f7e}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!beam\+\_\+dot\+\_\+dir@{beam\+\_\+dot\+\_\+dir}}
\index{beam\+\_\+dot\+\_\+dir@{beam\+\_\+dot\+\_\+dir}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{beam\+\_\+dot\+\_\+dir}{beam\_dot\_dir}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+beam\+\_\+dot\+\_\+dir}



Definition at line 325 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_aaa40c3f61f6b3c343af814b66e337fd1}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_aaa40c3f61f6b3c343af814b66e337fd1}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!beam\+\_\+dot\+\_\+log@{beam\+\_\+dot\+\_\+log}}
\index{beam\+\_\+dot\+\_\+log@{beam\+\_\+dot\+\_\+log}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{beam\+\_\+dot\+\_\+log}{beam\_dot\_log}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+beam\+\_\+dot\+\_\+log}



Definition at line 303 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ad3d2699ffde7252a8a817e286937f75c}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ad3d2699ffde7252a8a817e286937f75c}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!beam\+\_\+min\+\_\+length@{beam\+\_\+min\+\_\+length}}
\index{beam\+\_\+min\+\_\+length@{beam\+\_\+min\+\_\+length}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{beam\+\_\+min\+\_\+length}{beam\_min\_length}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+beam\+\_\+min\+\_\+length}



Definition at line 306 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_af48faf0b6fd7baa960fba7f90a4a1503}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_af48faf0b6fd7baa960fba7f90a4a1503}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!beam\+\_\+min\+\_\+n\+\_\+best@{beam\+\_\+min\+\_\+n\+\_\+best}}
\index{beam\+\_\+min\+\_\+n\+\_\+best@{beam\+\_\+min\+\_\+n\+\_\+best}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{beam\+\_\+min\+\_\+n\+\_\+best}{beam\_min\_n\_best}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+beam\+\_\+min\+\_\+n\+\_\+best}



Definition at line 305 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a3bdf0be087cbd26a34badd3cb619e480}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a3bdf0be087cbd26a34badd3cb619e480}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!beam\+\_\+size@{beam\+\_\+size}}
\index{beam\+\_\+size@{beam\+\_\+size}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{beam\+\_\+size}{beam\_size}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+beam\+\_\+size}



Definition at line 304 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_af675df0b6aa0c683d5da13151a82abe4}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_af675df0b6aa0c683d5da13151a82abe4}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!buffer\+\_\+initialized@{buffer\+\_\+initialized}}
\index{buffer\+\_\+initialized@{buffer\+\_\+initialized}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{buffer\+\_\+initialized}{buffer\_initialized}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+buffer\+\_\+initialized}



Definition at line 726 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a10e17fad8f2e68b1610f64dc7d262d1a}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a10e17fad8f2e68b1610f64dc7d262d1a}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!control\+\_\+settings@{control\+\_\+settings}}
\index{control\+\_\+settings@{control\+\_\+settings}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{control\+\_\+settings}{control\_settings}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+control\+\_\+settings}



Definition at line 510 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a60964f1450ffcd6b3ab7696a64e48cd5}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a60964f1450ffcd6b3ab7696a64e48cd5}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!control\+\_\+vars@{control\+\_\+vars}}
\index{control\+\_\+vars@{control\+\_\+vars}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{control\+\_\+vars}{control\_vars}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+control\+\_\+vars}



Definition at line 464 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a883779e425cddd8e9c960d0e60b03de1}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a883779e425cddd8e9c960d0e60b03de1}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!criterion@{criterion}}
\index{criterion@{criterion}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{criterion}{criterion}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+criterion}



Definition at line 348 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a812e52cf25c679d7e6868eab04fb7da8}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a812e52cf25c679d7e6868eab04fb7da8}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!id@{id}}
\index{id@{id}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{id}{id}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+id}



Definition at line 297 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a5f37636e9f8eda06f6393bb21072a516}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a5f37636e9f8eda06f6393bb21072a516}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!metrics@{metrics}}
\index{metrics@{metrics}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{metrics}{metrics}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+metrics}



Definition at line 314 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ad3004224cdb878412a74b89f7f00412e}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ad3004224cdb878412a74b89f7f00412e}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!model@{model}}
\index{model@{model}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{model}{model}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+model}



Definition at line 313 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_af2988d23c581d2d186ec2ce527e92a6d}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_af2988d23c581d2d186ec2ce527e92a6d}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!multigpu@{multigpu}}
\index{multigpu@{multigpu}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{multigpu}{multigpu}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+multigpu}



Definition at line 298 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ae7d42c61a184691bb15d1ea65aee4c72}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_ae7d42c61a184691bb15d1ea65aee4c72}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!wd\+\_\+features@{wd\+\_\+features}}
\index{wd\+\_\+features@{wd\+\_\+features}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{wd\+\_\+features}{wd\_features}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+wd\+\_\+features}



Definition at line 550 of file controllable\+\_\+seq2seq.\+py.

\mbox{\Hypertarget{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a74800af89333cc27f221ed70dff41e4e}\label{classprojects_1_1controllable__dialogue_1_1controllable__seq2seq_1_1controllable__seq2seq_1_1ControllableSeq2seqAgent_a74800af89333cc27f221ed70dff41e4e}} 
\index{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}!wd\+\_\+wts@{wd\+\_\+wts}}
\index{wd\+\_\+wts@{wd\+\_\+wts}!projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent@{projects\+::controllable\+\_\+dialogue\+::controllable\+\_\+seq2seq\+::controllable\+\_\+seq2seq\+::\+Controllable\+Seq2seq\+Agent}}
\subsubsection{\texorpdfstring{wd\+\_\+wts}{wd\_wts}}
{\footnotesize\ttfamily projects.\+controllable\+\_\+dialogue.\+controllable\+\_\+seq2seq.\+controllable\+\_\+seq2seq.\+Controllable\+Seq2seq\+Agent.\+wd\+\_\+wts}



Definition at line 557 of file controllable\+\_\+seq2seq.\+py.



The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
projects/controllable\+\_\+dialogue/controllable\+\_\+seq2seq/\hyperlink{controllable__seq2seq_8py}{controllable\+\_\+seq2seq.\+py}\end{DoxyCompactItemize}
